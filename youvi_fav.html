<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="favorites.pageTitle">Избранное | Youvi</title>
    <script>
        (function() {
            var theme = localStorage.getItem('youvi-theme');
            var sidebar = localStorage.getItem('sidebarCollapsed');
            
            var htmlClasses = [];
            if (theme === 'dark') htmlClasses.push('dark-theme');
            else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
            if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
            if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
        })();
    </script>
    <link rel="stylesheet" href="youvi/header/youvi-header.css">
    <link rel="stylesheet" href="youvi/sidebar.css">
    <link rel="stylesheet" href="youvi/sidebar-scroll.css">
    <link rel="stylesheet" href="youvi/themes/dark-theme.css">
    <link rel="stylesheet" href="youvi/themes/theme-dropdown.css">
    <link rel="stylesheet" href="youvi/sticky-video.css">
    <link rel="stylesheet" href="youvi/pagination.css">
    <script src="youvi/sidebar-toggle.js"></script>
    <script src="youvi/sidebar-scroll.js"></script>
    <script src="youvi/header/youvi-header.js"></script>
    
    <!-- Video ID System -->
    <script src="youvi/video-id.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #111;
            --header-height: 88px; 
            --footer-height: 220px; 
        }

        .top-nav {
            background: #d94b88;
            border-bottom: 1px solid #c2185b;
            padding: 4px 0;
        }

        .top-nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 0;
            transition: color 0.2s;
        }

        .top-nav a:hover {
            color: #ffd6ea;
        }

        .top-nav a.active {
            color: #ffd6ea;
            font-weight: 600;
        }

        .lang-switcher {
            margin-left: auto;
        }
        
        .lang-select {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            outline: none;
        }
        
        .lang-select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-select option {
            background: #d94b88;
            color: #fff;
        }

        .header {
            background: #FFE7F4; 
            padding: 0;
            border-bottom: 1px solid #f2cfe1;
            min-height: 40px;
            width: 100%; 
        }

        .header-content-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            box-sizing: border-box;
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 0 20px; 
            width: 100%; 
            min-height: 40px; 
        }

        .nav-bar {
            display: flex;
            align-items: center;
            width: 100%; 
            justify-content: space-between;
            height: 100%;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-left: calc(200px + 20px + 20px); 
        }

        .nav-right-actions {
            display: flex;
            align-items: center;
            gap: 15px; 
        }

        .nav-links a {
            color: #111; 
            text-decoration: none;
            font-size: 13px;
            padding: 5px 0;
        }



        .search-btn {
            padding: 8px 15px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .user-actions a {
            color: #111; 
            text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }
        
        .user-actions a:hover {
            color: #ff69b4;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: stretch;
            min-height: calc(100vh - 200px);
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }
        
        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
        }
        
        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
        }
        
        .header-content-wrapper,
        .top-nav-content {
            max-width: none !important;
            margin: 0 !important;
        }

        .sidebar-collapsed .sidebar,
        html.sidebar-collapsed .sidebar {
            width: 60px !important;
            padding: 10px 8px !important;
            display: block !important;
            position: sticky !important;
            top: 40px !important;
            max-height: calc(var(--sidebar-max-height, 100vh) - 75px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .sidebar-collapsed .container,
        html.sidebar-collapsed .container {
            padding-left: 20px;
        }

        .sidebar-collapsed .content-wrapper,
        html.sidebar-collapsed .content-wrapper {
            max-width: 1500px;
        }

        .sidebar-collapsed .sidebar-title,
        html.sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-item,
        html.sidebar-collapsed .sidebar-item {
            padding: 8px !important;
            padding-left: 5px !important;
            padding-right: 8px !important;
            justify-content: center !important;
            border-left: 3px solid transparent !important;
            border-radius: 4px;
            font-size: 0 !important;
        }

        .sidebar-collapsed .sidebar-item:hover,
        html.sidebar-collapsed .sidebar-item:hover {
            background: rgba(255, 105, 180, 0.1);
        }

        .sidebar-collapsed .sidebar-item.active,
        html.sidebar-collapsed .sidebar-item.active {
            background: rgba(255, 105, 180, 0.15);
        }

        .sidebar-collapsed .sidebar-item svg,
        .sidebar-collapsed .sidebar-item img,
        html.sidebar-collapsed .sidebar-item svg,
        html.sidebar-collapsed .sidebar-item img {
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
            font-size: 16px !important;
        }

        .sidebar-collapsed #subscribedChannelsContainer .sidebar-item,
        html.sidebar-collapsed #subscribedChannelsContainer .sidebar-item {
            justify-content: center !important;
        }

        .sidebar-collapsed #subscribedChannelsContainer .sidebar-item span,
        html.sidebar-collapsed #subscribedChannelsContainer .sidebar-item span {
            display: none !important;
        }

        .sidebar-collapsed #subscribedChannelsContainer .sidebar-item div,
        html.sidebar-collapsed #subscribedChannelsContainer .sidebar-item div {
            margin: 0 !important;
        }

        .sidebar-collapsed .library-item,
        .sidebar-collapsed .nav-item,
        html.sidebar-collapsed .library-item,
        html.sidebar-collapsed .nav-item {
            justify-content: center !important;
            gap: 0 !important;
        }

        .sidebar-collapsed .library-item span,
        .sidebar-collapsed .nav-item span,
        html.sidebar-collapsed .library-item span,
        html.sidebar-collapsed .nav-item span {
            display: none !important;
        }

        .sidebar-collapsed .library-item svg,
        .sidebar-collapsed .nav-item svg,
        html.sidebar-collapsed .library-item svg,
        html.sidebar-collapsed .nav-item svg {
            margin: 0 !important;
        }

        .sidebar {
            width: 200px;
            flex-shrink: 0;
            background: #f5f5f5;
            margin-left: -20px;
            padding-left: 20px;
            padding-top: 10px;
            padding-bottom: 0;
            align-self: stretch;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }
        
        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 14px;
            color: #999;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .sidebar-item {
            display: block;
            color: #333;
            text-decoration: none;
            padding: 6px 0;
            font-size: 13px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .sidebar-item:hover {
            color: #c2185b; 
            border-left-color: #ff85b4; 
        }

        .sidebar-item.active {
            color: #000;
            border-left-color: #ff69b4;
        }

        .main-content {
            flex: 1;
            display: flex; 
            flex-direction: column; 
            min-height: 0; 
            padding-top: 5px; 
        }

        .main-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            margin-top: 5px; 
        }
        .section-title { font-size: 24px; color: #111; margin: 0; }
        .fav-stats { font-size: 14px; color: #666; }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-left: 0;
            flex: 1;
            min-height: 0;
        }
        
        .history-list .video-card {
            display: flex;
            gap: 10px;
            align-items: stretch;
            cursor: pointer;
            padding-bottom: 12px;
        }
        
        .history-list .video-thumbnail {
            flex: 0 0 280px;
            height: 158px;
            background: #eee;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .history-list .video-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        
        .video-duration { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8); padding: 2px 4px; border-radius: 2px; font-size: 11px; color: #fff; z-index: 2; }

        .history-list .video-info {
            padding: 0 0 0 4px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: hidden;
            min-width: 0;
            flex: 1;
        }
        
        .history-list .video-card-title {
            font-size: 18px;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #111;
            line-height: 1.3;
        }
        
        .history-list .video-card-title a { color: inherit; text-decoration: none; }
        .history-list .video-card-title a:hover { color: #ff69b4; }
        
        .history-list .video-meta-line,
        .history-list .video-dates-line {
            font-size: 13px;
            color: #666;
        }
        
        .history-list .video-desc {
            font-size: 13px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            color: #444;
        }
        
        .history-list .video-channel-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
        }
        
        .history-list .video-channel-row .channel-avatar-mini {
            width: 20px;
            height: 20px;
            font-size: 12px;
            background: #ff69b4;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: 0;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        
        .history-list .video-channel-row .playlist-channel-link {
            font-size: 14px;
            color: #ff69b4;
            text-decoration: none;
            font-weight: 500;
        }
        
        .history-list .video-channel-row .playlist-channel-link:hover { text-decoration: underline; }

        .history-actions { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; width: 30px; flex-shrink: 0; }
        .remove-btn { width: 22px; height: 22px; line-height: 22px; text-align: center; padding: 0; background: #f0f0f0; color: #666; border: none; border-radius: 50%; font-size: 14px; cursor: pointer; transition: background-color 0.2s; }
        .remove-btn:hover { background: #ff69b4; color: white; }
        .watch-count { font-size: 10px; color: #999; text-align: right; }


        .action-btn { 
            display:block; 
            width:100%; 
            background:transparent; 
            color:#333; 
            text-decoration:none; 
            border:none; 
            border-radius:0; 
            font-size:13px; 
            padding:8px 0; 
            padding-left:10px; 
            text-align:left; 
            cursor:pointer; 
            transition:color .15s ease; 
        }
        .action-btn:hover { color:#c2185b; text-decoration:none; }
        
        .right-sidebar {
            width: 200px;
            flex-shrink: 0;
            align-self: stretch;
            display: flex;
            flex-direction: column;
            padding-top: 20px; 
        }

        .stats-box { 
            padding-left:10px; 
            font-size:13px; 
            color:#333; 
            flex: 1; 
        }

        .right-sidebar .sidebar-section:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 1024px) { .right-sidebar { display:none; } }
        @media (max-width: 768px) {
            .container { flex-direction: column; padding: 10px; }
            .sidebar { width: 100%; display:flex; overflow-x:auto; gap:20px; padding:10px 0; margin-bottom:20px; }
            .history-item { flex-direction: row; }
            .video-thumbnail { width: 100%; height: 140px; align-self: center; }
            .history-actions { width:auto; flex-direction: column; justify-content: flex-start; }
        }
        @media (max-width: 480px) {
            .nav-bar { padding: 0 10px; }
            .search-input { width: 120px; }
            .video-thumbnail { height: 100px; }
        }

        .footer {
            background: #2c2c2c;
            color: #fff;
            padding: 25px 0 15px 0;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        @media (min-width: 1700px) {
            .footer-content {
                max-width: 1700px !important;
            }
        }

        @media (min-width: 2000px) {
            .footer-content {
                max-width: 1800px !important;
            }
        }

        .footer-logo {
            flex-shrink: 0;
            width: 200px;
        }

        .footer-logo img {
            height: 40px;
            width: auto;
        }

        .footer-logo p {
            margin-top: 8px;
            font-size: 11px;
            color: #ccc;
            line-height: 1.3;
        }

        .footer-sections {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-main {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-right {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .footer-mascot {
            flex-shrink: 0;
        }

        .footer-mascot img {
            height: 180px;
            width: auto;
        }

        .footer-section {
            flex: 1;
        }

        .footer-section h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #fff;
            font-weight: 600;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-section li {
            margin-bottom: 6px;
        }

        .footer-section a {
            color: #ccc;
            text-decoration: none;
            font-size: 11px;
            transition: color 0.2s;
        }

        .footer-section a:hover {
            color: #ff69b4;
        }

        .footer-bottom {
            border-top: 1px solid #444;
            margin-top: 20px;
            padding-top: 15px;
            text-align: center;
            color: #999;
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .footer-sections {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-section {
                text-align: center;
            }
        }
        
        body.dark-theme input.search-input {
  background: #4a3a34 !important;
  color: #fff !important;
  border-color: #555 !important;
}
    </style>
</head>
<link rel="icon" href="favicon/youvi/favicon.ico" type="image/x-icon">
<body class="monolith">
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="top-nav-content">
      <a href="youvi_main.html"class="active" data-i18n="nav.video">Видео</a>
      <a href="index.html" data-i18n="nav.management">Управление</a>
      <a href="youvi_ch_list.html" data-i18n="nav.channels">Каналы</a>
      <a href="youvi_playlists_list.html" data-i18n="nav.playlists">Плейлисты</a>
      <a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a> 
      <a href="wiki/index.html" data-i18n="nav.wiki">Wiki</a>
      <div class="lang-switcher">
        <select id="langSwitcher" class="lang-select">
          <option value="ru">🇷🇺 RU</option>
          <option value="en">🇬🇧 EN</option>
          <option value="uk">🇺🇦 UK</option>
        </select>
      </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content-wrapper">
            <div class="header-left">
                <button class="sidebar-toggle-btn" id="sidebarToggle" title="Свернуть/Развернуть боковую панель">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
                
                <div class="logo">
                    <a href="youvi_main.html">
                        <img src="images/logo_youvi_ind.png" alt="Youvi logo">
                    </a>
                </div>
            </div>
            
            <div class="header-center">
                <div class="search-area autocomplete-wrapper">
                    <input type="text" class="search-input" id="headerSearchInput" placeholder="Поиск видео..." data-i18n-placeholder="search.placeholder">
                    <button class="search-btn" id="headerSearchBtn" data-i18n="search.button">Поиск</button>
                </div>
            </div>
            
            <div class="header-right">
                <div class="user-actions">
                   
                    <div class="settings-container">
                        <a href="#" class="settings-btn">⚙</a>
                        <div class="theme-dropdown">
                            <button class="theme-dropdown-item" data-theme="light" data-i18n="themes.light">Белая</button>
                            <button class="theme-dropdown-item" data-theme="dark" data-i18n="themes.dark">Черная</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.navigation">Навигация</div>
                <a href="youvi_main.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span data-i18n="sidebar.home">Главная</span>
                </a>
                <a href="youvi_feed_all.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 11a9 9 0 0 1 9 9"/>
                        <path d="M4 4a16 16 0 0 1 16 16"/>
                        <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <span data-i18n="sidebar.feed">Feed</span>
                </a>
                <a href="youvi_tags.html" class="sidebar-item nav-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                     <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                 </svg>
                    <span data-i18n="sidebar.allTagsLink">Все теги</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.library">Библиотека</div>
                <a href="youvi_history.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.history">История</span>
                </a>
                <a href="youvi_fav.html" class="sidebar-item library-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span data-i18n="sidebar.favorites">Избранное</span>
                </a>
                <a href="youvi_playlists_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.playlists">Плейлисты</span>
                </a>
                <a href="youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span data-i18n="sidebar.channels">Каналы</span>
                </a>
                <a href="youvi_subscriptions.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span data-i18n="sidebar.subscriptions">Подписки</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.subscriptionsTitle">Подписки</div>
                <div id="subscribedChannelsContainer"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.sorting">Сортировка</div>
                <a href="#" class="sidebar-item library-item active" id="sortNew">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.sortNew">Новые</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortOld">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span data-i18n="sidebar.sortOld">Старые</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortAlphabetical">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 16L8 6l4 10"/>
                        <path d="M5 13h6"/>
                        <path d="M14 6h6"/>
                        <path d="M14 12h6"/>
                        <path d="M14 18h6"/>
                    </svg>
                    <span data-i18n="sidebar.sortAlphabetical">По алфавиту</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortRandom">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="3" ry="3"/>
                        <circle cx="8" cy="8" r="1"/>
                        <circle cx="16" cy="8" r="1"/>
                        <circle cx="8" cy="16" r="1"/>
                        <circle cx="16" cy="16" r="1"/>
                        <circle cx="12" cy="12" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.sortRandom">Случайные</span>
                </a>
            </div>
        </aside>

        <!-- Content Wrapper (centered) -->
        <div class="content-wrapper">
            <!-- Main Content -->
            <main class="main-content">
                <div class="main-content-header">
                    <h1 class="section-title" data-i18n="favorites.title">Избранное</h1>
                    <div class="fav-stats">
                        <span id="favCount" data-i18n="favorites.defaultCount">0 видео</span>
                    </div>
                </div>

                <div class="history-list" id="favList"></div>
                <div class="pagination"></div>
            </main>

            <aside class="right-sidebar">
                
                <div class="sidebar-section">
                    <div class="sidebar-title" data-i18n="stats.title">Статистика</div>
                    <div class="stats-box"></div>
                </div>
            </aside>
        </div><!-- /content-wrapper -->
    </div>   
     <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-logo">
                    <img src="images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
                    <p data-i18n="footer.description">Платформа для просмотра видео контента. Сохраняйте, категоризируйте и смотрите видео.</p>
                </div>
                <div class="footer-sections">
                    <div class="footer-section">
                        <h3 data-i18n="footer.sections">Разделы</h3>
             <ul>
              <li><a href="youvi_main.html" data-i18n="footer.video">Видео</a></li>
              <li><a href="youvi_tags.html" data-i18n="sidebar.tags">Теги</a></li>
              <li><a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a></li>
              <li><a href="index.html" data-i18n="nav.management">Управление</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3 data-i18n="sidebar.library">Библиотека</h3>
            <ul>
              <li><a href="youvi_ch_list.html" data-i18n="sidebar.channels">Каналы</a></li>
              <li><a href="youvi_playlists_list.html" data-i18n="sidebar.playlists">Плейлисты</a></li>
              <li><a href="youvi_subscriptions.html" data-i18n="sidebar.subscriptions">Подписки</a></li>
              <li><a href="youvi_fav.html" data-i18n="sidebar.favorites">Избранное</a></li>
              <li><a href="youvi_history.html" data-i18n="sidebar.history">История</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3 data-i18n="nav.wiki">Wiki</h3>
            <ul>
              <li><a href="wiki/index.html" data-i18n="sidebar.home">Главная</a></li>
              <li><a href="wiki/player.html" data-i18n="footer.wiki.player">Плеер</a></li>
              <li><a href="wiki/danmaku.html" data-i18n="footer.wiki.danmaku">Данмаку</a></li>
              <li><a href="wiki/tags/general.html" data-i18n="sidebar.tags">Теги</a></li>
              <li><a href="wiki/tags/rules.html" data-i18n="footer.wiki.taggingRules">Правила тегирования</a></li>
              <li><a href="wiki/search/general.html" data-i18n="footer.wiki.search">Поиск</a></li>
            </ul>
          </div>
                            <div class="footer-section">
                        <h3 data-i18n="footer.pgc">PGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Anime (ct)" data-i18n="footer.categories.anime">Anime</a></li>
                            <li><a href="youvi_main.html?tag=Animation (ct)" data-i18n="footer.categories.animation">Animation</a></li>
                            <li><a href="youvi_main.html?tag=Movies (ct)" data-i18n="footer.categories.movies">Movies</a></li>
                            <li><a href="youvi_main.html?tag=Series (ct)" data-i18n="footer.categories.series">Series</a></li>
                            <li><a href="youvi_main.html?tag=Music (ct)" data-i18n="footer.categories.music">Music</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.ugc">UGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Games (ct)" data-i18n="footer.categories.games">Games</a></li>
                            <li><a href="youvi_main.html?tag=Technology (ct)" data-i18n="footer.categories.tech">Technology</a></li>
                            <li><a href="youvi_main.html?tag=Entertainment (ct)" data-i18n="footer.categories.entertainment">Entertainment</a></li>
                            <li><a href="youvi_main.html?tag=IRL (ct)" data-i18n="footer.categories.irl">IRL</a></li>
                            <li><a href="youvi_main.html?tag=TV (ct)" data-i18n="footer.categories.tv">TV</a></li>
                            <li><a href="youvi_main.html?tag=Education (ct)" data-i18n="footer.categories.education">Education</a></li>
                            <li><a href="youvi_main.html?tag=Other (ct)" data-i18n="footer.categories.other">Other</a></li>
                        </ul>
                    </div>
          <div class="footer-section">
            <h3 data-i18n="footer.about">О сайте</h3>
            <ul>
              <li><a href="wiki/about.html" data-i18n="footer.aboutSite">Про сайт</a></li>
               <li><a href="wiki/docs.html" data-i18n="footer.docs">Документация</a></li>
              <li><a href="wiki/tech.html" data-i18n="footer.tech">Технологии</a></li>
            </ul>
                        </div>
                    </div>
                </div>
                <div class="footer-right">
                    <div class="footer-mascot">
                        <img src="images/mascot1.png" alt="Yuvi">
                    </div>
                </div>
            </div>
        </footer>

    <script>
      (function(){
        function updateHeaderOffset(){
          try{
            var header=document.querySelector('.header');
            var topNav=document.querySelector('.top-nav');
            if(!header||!topNav) return;
            if(window.scrollY===0){ header.style.top = topNav.offsetHeight+'px'; }
            else { header.style.top='0px'; }
          }catch(_){ }
        }
        window.addEventListener('scroll', updateHeaderOffset, {passive:true});
        window.addEventListener('resize', updateHeaderOffset);
        document.addEventListener('DOMContentLoaded', updateHeaderOffset);
        updateHeaderOffset();
      })();
    </script>
    <script>
      /**
       * DEBUG_MODE flag - Controls console logging
       * Set to false to disable console.log statements in production
       * Set to true to enable debugging output
       */
      const DEBUG_MODE = false;
      
      let videoDirectoryHandle = null;
      let perPage=20, currentPage=1, currentQuery='', currentSort='new';

      async function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open('8SiteDB',1);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles');};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
      async function getFromDB(db,key){const tx=db.transaction('handles','readonly');const s=tx.objectStore('handles');return new Promise((res)=>{const rq=s.get(key);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>res(null);});}
      async function initVideoHandle(){try{const db=await openDB();const h=await getFromDB(db,'videoDirectoryHandle');if(h){const p=await h.queryPermission();if(p==='granted'||(p==='prompt' && await h.requestPermission()==='granted')){videoDirectoryHandle=h;}}}catch(_){}}
      async function getCachedPreview(name){try{const db=await openDB();const c=await getFromDB(db,'preview_'+name);if(c && (Date.now()-c.timestamp<30*24*60*60*1000)) return c.preview;}catch(_){}return null;}
      async function getCachedDuration(name){
        try{
          const db=await openDB();
          const c=await getFromDB(db,'duration_'+name);
          if(c && typeof c.duration==='string' && (Date.now()-c.timestamp<30*24*60*60*1000)) return c.duration;
          const p=await getFromDB(db,'preview_'+name);
          if(p && typeof p.duration==='string' && (Date.now()-p.timestamp<30*24*60*60*1000)) return p.duration;
        }catch(_){}
        return null;
      }
      const fileResolutionCache = new Map();
      
      async function resolveFileForItem(it){
        try{
          if(!videoDirectoryHandle||!it||!it.name) return null;
          
          const cacheKey = `${it.name}_${it.playlist || 'root'}`;
          if (fileResolutionCache.has(cacheKey)) {
            const cached = fileResolutionCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < 300000) {
              return cached.file;
            }
            fileResolutionCache.delete(cacheKey);
          }
          
          let dir=videoDirectoryHandle;
          const pl=(it.playlist||'').trim();
          
          if(pl){
            try{
              dir=await videoDirectoryHandle.getDirectoryHandle(pl);
            }catch(_){}
          }
          
          try {
            const fh=await dir.getFileHandle(it.name);
            const file = await fh.getFile();
            
            fileResolutionCache.set(cacheKey, {
              file: file,
              timestamp: Date.now()
            });
            
            return file;
          } catch (fileError) {
            try {
              for await (const [name, handle] of dir.entries()) {
                if (handle.kind === 'directory') {
                  try {
                    const subDir = await dir.getDirectoryHandle(name);
                    const subFileHandle = await subDir.getFileHandle(it.name);
                    const file = await subFileHandle.getFile();
                    
                    fileResolutionCache.set(cacheKey, {
                      file: file,
                      timestamp: Date.now()
                    });
                    
                    return file;
                  } catch (subError) {
                    continue;
                  }
                }
              }
            } catch (searchError) {
            }
            
            fileResolutionCache.set(cacheKey, {
              file: null,
              timestamp: Date.now()
            });
            
            return null;
          }
        }catch(_){
          return null;
        }
      }
      async function getVideoMetadata(dirHandle, fileName) {
        try {
          const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
          const metaHandle = await metaDir.getFileHandle(fileName + '.meta.json');
          const file = await metaHandle.getFile();
          const metadata = JSON.parse(await file.text());
          return metadata;
        } catch (e) { 
          return { views: 0, likes: 0, dislikes: 0, tags: [], created: Date.now() }; 
        }
      }

      async function saveVideoMetadata(dirHandle, fileName, metadata) {
        try {
          const existingMeta = await getVideoMetadata(dirHandle, fileName);
          const safeMeta = {
            ...existingMeta,
            ...metadata,
            views: Math.max(existingMeta.views || 0, metadata.views || 0),
            quality: metadata.quality || existingMeta.quality,
            tags: metadata.tags || existingMeta.tags || []
          };
          
          const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
          const metaFileName = fileName + '.meta.json';
          const fh = await metaDir.getFileHandle(metaFileName, { create: true });
          const w = await fh.createWritable();
          await w.write(JSON.stringify(safeMeta, null, 2));
          await w.close();
        } catch (e) {
          console.error('Error saving video metadata:', e);
        }
      }

      async function getPreviewAndDuration(video) {
        if (video._cachedPreview && video._cachedDuration) {
          return { preview: video._cachedPreview, duration: video._cachedDuration };
        }

        const dirHandle = video.dirHandle || videoDirectoryHandle;
        const meta = await getVideoMetadata(dirHandle, video.name);

        const fileChanged = meta.size !== video.file.size || meta.modified !== video.file.lastModified;

        if (meta.preview && meta.duration && !fileChanged) {
          video._cachedPreview = meta.preview;
          video._cachedDuration = meta.duration;
          return { preview: meta.preview, duration: meta.duration };
        }

        try{
          const cachedDur = await getCachedDuration(video.name);
          if (cachedDur) {
            video._cachedDuration = cachedDur;
          }
        }catch(_){ }

        if (!video.file) {
          return { preview: '', duration: '0:00' };
        }

        return new Promise((resolve, reject) => {
          const el = document.createElement('video');
          el.muted = true;
          el.playsInline = true;
          el.preload = 'metadata';
          
          const url = URL.createObjectURL(video.file);
          
          const cleanup = () => {
            URL.revokeObjectURL(url);
            el.remove();
          };
          
          const timeout = setTimeout(() => {
            cleanup();
            resolve({ preview: null, duration: video._cachedDuration || '0:00' });
          }, 10000);
          
          el.addEventListener('error', (e) => {
            clearTimeout(timeout);
            cleanup();
            resolve({ preview: null, duration: '0:00' });
          }, { once: true });
          
          el.addEventListener('loadedmetadata', async () => {
            try {
              if (!isFinite(el.duration) || el.duration <= 0) {
                clearTimeout(timeout);
                cleanup();
                resolve({ preview: null, duration: '0:00' });
                return;
              }
              
              const duration = formatDuration(el.duration);
              el.currentTime = Math.max(0, el.duration / 2);
              
              el.addEventListener('seeked', async () => {
                try {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  
                  canvas.width = 320;
                  canvas.height = 180;
                  
                  if (el.videoWidth === 0 || el.videoHeight === 0) {
                    throw new Error('Invalid video dimensions');
                  }
                  
                  ctx.drawImage(el, 0, 0, canvas.width, canvas.height);
                  
                  let preview;
                  try {
                    preview = canvas.toDataURL('image/webp', 0.8);
                  } catch (e) {
                    preview = canvas.toDataURL('image/jpeg', 0.7);
                  }
                  
                  clearTimeout(timeout);
                  cleanup();
                  
                  const updatedMeta = {
                    ...meta,
                    preview: preview,
                    duration: duration,
                    size: video.file.size,
                    modified: video.file.lastModified,
                    compressed: preview.includes('image/webp')
                  };
                  saveVideoMetadata(dirHandle, video.name, updatedMeta).catch(console.error);

                  video._cachedPreview = preview;
                  video._cachedDuration = duration;
                  
                  resolve({ preview, duration });
                } catch (e) {
                  clearTimeout(timeout);
                  cleanup();
                  resolve({ preview: null, duration: duration });
                }
              }, { once: true });
              
              el.addEventListener('error', (e) => {
                clearTimeout(timeout);
                cleanup();
                resolve({ preview: null, duration: duration });
              }, { once: true });
              
            } catch (e) {
              clearTimeout(timeout);
              cleanup();
              resolve({ preview: null, duration: '0:00' });
            }
          }, { once: true });
          
          el.src = url;
        });
      }

      function formatDuration(seconds) {
        if (!isFinite(seconds) || isNaN(seconds) || seconds <= 0) return '0:00';
        const s = Math.round(seconds);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const ss = String(s % 60).padStart(2, '0');
        return h > 0 ? `${h}:${String(m).padStart(2, '0')}:${ss}` : `${m}:${ss}`;
      }

      const previewQueue = [];
      let isProcessingQueue = false;

      const previewObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const item = img.dataset.item ? JSON.parse(img.dataset.item) : null;
            if (item) {
              const priority = entry.intersectionRatio > 0.5 ? 1 : 2;
              previewQueue.push({ img, item, priority });
              previewQueue.sort((a, b) => a.priority - b.priority);
              
              previewObserver.unobserve(img);
              
              if (!isProcessingQueue) {
                processPreviewQueue();
              }
            }
          }
        });
      }, {
        rootMargin: '100px 0px',
        threshold: [0.1, 0.5, 1.0]
      });

      async function processPreviewQueue() {
        if (isProcessingQueue || previewQueue.length === 0) return;
        
        isProcessingQueue = true;
        
        while (previewQueue.length > 0) {
          const { img, item } = previewQueue.shift();
          await loadPreviewForItem(img, item);
          
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        isProcessingQueue = false;
      }

      async function loadPreviewForItem(img, it) {
        if (!img || !it) return;
        const name = it.name || '';
        if (!name) return;
        
        img.setAttribute('decoding', 'async');
        img.setAttribute('loading', 'lazy');
        
        try {
          const c = await getCachedPreview(name);
          if (c && c.length > 100) {
            img.src = c;
            
            const badge = img.closest('.video-thumbnail')?.querySelector('.video-duration');
            if (badge) {
              const d = await getCachedDuration(name);
              if (d) {
                badge.textContent = d;
              }
            }
            return;
          }
        } catch (_) { }
        
        try {
          const file = await resolveFileForItem(it);
          if (file) {
            const video = {
              name: it.name,
              file: file,
              dirHandle: videoDirectoryHandle
            };
            
            const { preview, duration } = await getPreviewAndDuration(video);
            if (preview) {
              img.src = preview;
            }
            if (duration) {
              const badge = img.closest('.video-thumbnail')?.querySelector('.video-duration');
              if (badge) {
                badge.textContent = duration;
              }
            }
          } else {
            const badge = img.closest('.video-thumbnail')?.querySelector('.video-duration');
            if (badge) {
              badge.textContent = '0:00';
            }
          }
        } catch (_) {
          const badge = img.closest('.video-thumbnail')?.querySelector('.video-duration');
          if (badge) {
            badge.textContent = '0:00';
          }
        }
      }

      async function fillThumbnail(img, it) {
        if (!img || !it) return;
        const name = it.name || '';
        if (!name) return;
        
        img.dataset.item = JSON.stringify(it);
        
        try {
          const c = await getCachedPreview(name);
          if (c && c.length > 100) {
            img.src = c;
            const badge = img.closest('.video-thumbnail')?.querySelector('.video-duration');
            if (badge) {
              const d = await getCachedDuration(name);
              if (d) {
                badge.textContent = d;
              }
            }
            return;
          }
        } catch (_) { }
        
        previewObserver.observe(img);
      }
      async function ensureHistoryDir(){try{if(!videoDirectoryHandle) return null;return await videoDirectoryHandle.getDirectoryHandle('.history',{create:true});}catch(_){return null;}}
      async function readFileFromHistory(name,fallback){try{const dir=await ensureHistoryDir();if(!dir) return fallback;const fh=await dir.getFileHandle(name,{create:false});const f=await fh.getFile();return JSON.parse(await f.text());}catch(_){return fallback;}}
      async function writeFileToHistory(name,data){try{const dir=await ensureHistoryDir();if(!dir) return false;const fh=await dir.getFileHandle(name,{create:true});const w=await fh.createWritable();await w.write(JSON.stringify(data));await w.close();return true;}catch(_){return false;}}
      async function loadFavorites(){return await readFileFromHistory('favorites.json',[]);} 
      async function saveFavorites(a){return await writeFileToHistory('favorites.json',a||[]);} 

      function updatePageParam(){ try{ const url=new URL(window.location.href); if(currentPage && currentPage>1) url.searchParams.set('page', String(currentPage)); else url.searchParams.delete('page'); window.history.replaceState({},'',url.toString()); }catch(_){}}
      function readInitialPage(){ try{ const p=parseInt(new URL(window.location.href).searchParams.get('page')||'1',10); if(isFinite(p)&&p>0) currentPage=p; }catch(_){ currentPage=1; }}

      function buildVideoUrl(it){
        const n=encodeURIComponent(it.name||'');
        const p=encodeURIComponent(it.playlist||'');
        return window.VideoID 
            ? window.VideoID.buildVideoUrl(it.name, it.playlist)
            : `youvi_video.html?name=${n}&playlist=${p}`;
      }
      function naturalSort(a, b){
        const normalize = (s)=> String(s).replace(/е/g,'e');
        const chunkify = (s)=>{ const m = String(s).match(/\D+|\d+/g); return m ? m.map(c=> isNaN(c) ? c.toLowerCase() : parseInt(c,10)) : []; };
        const A = chunkify(normalize(a||'')), B = chunkify(normalize(b||''));
        for(let i=0;i<Math.min(A.length,B.length);i++){
          const x=A[i], y=B[i];
          if(typeof x==='number' && typeof y==='number'){ if(x<y) return -1; if(x>y) return 1; }
          else if(typeof x==='string' && typeof y==='string'){ const cmp = x.localeCompare(y,'ru',{numeric:false,caseFirst:'lower'}); if(cmp!==0) return cmp; }
          else if(typeof x==='number') return -1; else return 1;
        }
        return A.length - B.length;
      }
      function getFileNameWithoutExtension(name){try{return String(name||'').replace(/\.[^/.]+$/,'');}catch(_){return name||'';}}
      function getDisplayTitle(it){
        try{
          const raw = (it && (it.title || it.name)) ? String(it.title || it.name) : 'Видео';
          return raw.replace(/\.(mp4|mkv|avi|mov|webm|m4v)$/i,'');
        }catch(_){ return 'Видео'; }
      }
      async function readJSON(dirHandle,fileName,def){try{const fh=await dirHandle.getFileHandle(fileName,{create:false});const f=await fh.getFile();return JSON.parse(await f.text());}catch(_){return def;}}
      async function loadMetaDescriptionForItem(it){try{if(!videoDirectoryHandle||!it||!it.name) return '';
          let dir=videoDirectoryHandle;const pl=(it.playlist||'').trim();
          if(pl){ try{ dir=await videoDirectoryHandle.getDirectoryHandle(pl); }catch(_){}}
          const metaDir=await dir.getDirectoryHandle('.metadata',{create:true});
          const meta=await readJSON(metaDir, it.name + '.meta.json', {});
          const d=typeof meta.description==='string'?meta.description.trim():'';
          return d;
      }catch(_){return '';} }

      async function renderFav(){
        const root=document.getElementById('favList');
        const pag=document.querySelector('.pagination');
        const info=pag?.querySelector('.pagination-info');
        root.innerHTML='';
        let list = await loadFavorites();
        if(currentQuery){const q=currentQuery.toLowerCase();list=list.filter(it=>((it.title||it.name||'').toLowerCase().includes(q)));}
        if(currentSort==='new'){ list.sort((a,b)=>(b.addedAt||0)-(a.addedAt||0)); }
        else if(currentSort==='old'){ list.sort((a,b)=>(a.addedAt||0)-(b.addedAt||0)); }
        else if(currentSort==='alphabetical'){ list.sort((a,b)=> naturalSort(getDisplayTitle(a), getDisplayTitle(b))); }
        else if(currentSort==='random'){ list = list.slice().sort(()=> Math.random()-0.5); }
        const total = list.length;
        document.getElementById('favCount').textContent = total + ' ' + i18n.t('favorites.videoCount');
        if(total===0){ root.innerHTML='<div class="empty-state">' + i18n.t('favorites.noFavorites') + '</div>'; if(info) info.textContent='0-0 ' + i18n.t('pagination.of') + ' 0'; buildPagination(1,1); return; }
        const totalPages=Math.max(1,Math.ceil(total/perPage));
        if(currentPage>totalPages){ currentPage=totalPages; updatePageParam(); }
        const start=(currentPage-1)*perPage; const end=Math.min(total,start+perPage);
        const pageItems=list.slice(start,end);
        if(info) info.textContent=`${start+1}-${end} ${i18n.t('pagination.of')} ${total} (${i18n.t('pagination.page')} ${currentPage} ${i18n.t('pagination.of')} ${totalPages})`;

        for(const it of pageItems){
          const row=document.createElement('div'); row.className='video-card';
          const link=document.createElement('a'); link.href=buildVideoUrl(it); link.className='video-thumbnail';
          const img=document.createElement('img'); link.appendChild(img);
          const dur=document.createElement('div'); dur.className='video-duration'; dur.textContent='...'; link.appendChild(dur);

          const infoWrap=document.createElement('div'); infoWrap.className='video-info';
          
          const addedDate = it.addedAt ? new Date(it.addedAt).toLocaleDateString() : '';
          const datesLine = addedDate ? `<div class="video-dates-line">${addedDate}</div>` : '';
          
          const tags = Array.isArray(it.tags) ? it.tags.filter(t=>!t.includes('(ка)')) : [];
          const descLine = tags.length ? `<div class="video-desc">${escapeHtml(tags.join(', '))}</div>` : '';
          
          const channelTags = Array.isArray(it.tags) ? it.tags.filter(t=>t.includes('(ка)')) : [];
          let channelName = channelTags.length ? channelTags[0].replace(' (ка)','') : '';
          let channelRow = '';
          if(channelName){
            channelRow = `<div class="video-channel-row"><span class="channel-avatar-mini" data-channel="${escapeHtml(channelName)}">${escapeHtml(channelName.charAt(0).toUpperCase())}</span><a href="youvi_ch_view.html?channel=${encodeURIComponent(channelName)}" class="playlist-channel-link">${escapeHtml(channelName)}</a></div>`;
          }
          
          infoWrap.innerHTML = `<div class="video-card-title"><a href="${buildVideoUrl(it)}" style="color:inherit;text-decoration:none;" title="${escapeHtml(getDisplayTitle(it))}">${escapeHtml(getDisplayTitle(it))}</a></div>${datesLine}${descLine}${channelRow}`;

          const actions=document.createElement('div'); actions.className='history-actions';
          const del=document.createElement('button'); del.className='remove-btn'; del.setAttribute('aria-label','Удалить из избранного'); del.textContent='✕';
          del.addEventListener('click', async (e)=>{ e.stopPropagation(); e.preventDefault(); const arr=await loadFavorites(); const idx=arr.findIndex(x=>x.key===it.key); if(idx>=0){ arr.splice(idx,1); await saveFavorites(arr); await renderFav(); updateStats(); }});
          actions.appendChild(del);

          row.appendChild(link); row.appendChild(infoWrap); row.appendChild(actions);
          root.appendChild(row);

          try{ fillThumbnail(img,it); }catch(_){ }
        }

        buildPagination(currentPage,totalPages);
      }

      function buildPagination(page,totalPages){
        const pag=document.querySelector('.pagination'); if(!pag) return; pag.innerHTML='';
        const info=document.createElement('div'); info.className='pagination-info'; info.textContent=''; pag.appendChild(info);
        const prev=document.createElement('button'); prev.className='pagination-btn'; prev.textContent=i18n.t('pagination.previous'); prev.disabled=page<=1; prev.addEventListener('click',()=>{ if(currentPage>1){ currentPage--; updatePageParam(); renderFav(); } }); pag.appendChild(prev);
        const maxButtons=5; let start=Math.max(1,page-2); let end=Math.min(totalPages,start+maxButtons-1); if(end-start+1<maxButtons){ start=Math.max(1,end-maxButtons+1); }
        if(start>1){ const first=document.createElement('button'); first.className='pagination-btn'; first.textContent='1'; first.addEventListener('click',()=>{ currentPage=1; updatePageParam(); renderFav(); }); pag.appendChild(first); if(start>2){ const dots=document.createElement('span'); dots.textContent=' ... '; pag.appendChild(dots); } }
        for(let i=start;i<=end;i++){ const b=document.createElement('button'); b.className='pagination-btn'+(i===page?' active':''); b.textContent=String(i); b.addEventListener('click',()=>{ currentPage=i; updatePageParam(); renderFav(); }); pag.appendChild(b); }
        if(end<totalPages){ if(end<totalPages-1){ const dots=document.createElement('span'); dots.textContent=' ... '; pag.appendChild(dots); } const last=document.createElement('button'); last.className='pagination-btn'; last.textContent=String(totalPages); last.addEventListener('click',()=>{ currentPage=totalPages; updatePageParam(); renderFav(); }); pag.appendChild(last); }
        const next=document.createElement('button'); next.className='pagination-btn'; next.textContent=i18n.t('pagination.next'); next.disabled=page>=totalPages; next.addEventListener('click',()=>{ if(currentPage<totalPages){ currentPage++; updatePageParam(); renderFav(); } }); pag.appendChild(next);
      }

      document.getElementById('headerSearchBtn').addEventListener('click',(e)=>{
        e.preventDefault();
        const q=(document.getElementById('headerSearchInput').value||'').trim();
        const params=new URLSearchParams();
        if(q) params.set('q', q);
        window.location.href = `youvi_search.html${params.toString()?('?'+params.toString()):''}`;
      });
      document.getElementById('headerSearchInput').addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){
          e.preventDefault();
          const q=(e.target.value||'').trim();
          const params=new URLSearchParams();
          if(q) params.set('q', q);
          window.location.href = `youvi_search.html${params.toString()?('?'+params.toString()):''}`;
        }
      });
      function setActiveSort(id){['sortNew','sortOld','sortAlphabetical','sortRandom'].forEach(i=>{ const el=document.getElementById(i); if(el) el.classList.remove('active'); }); const el=document.getElementById(id); if(el) el.classList.add('active');}
      const sortNew=document.getElementById('sortNew'); if(sortNew) sortNew.addEventListener('click',(e)=>{ e.preventDefault(); currentSort='new'; currentPage=1; setActiveSort('sortNew'); renderFav(); });
      const sortOld=document.getElementById('sortOld'); if(sortOld) sortOld.addEventListener('click',(e)=>{ e.preventDefault(); currentSort='old'; currentPage=1; setActiveSort('sortOld'); renderFav(); });
      const sortAlpha=document.getElementById('sortAlphabetical'); if(sortAlpha) sortAlpha.addEventListener('click',(e)=>{ e.preventDefault(); currentSort='alphabetical'; currentPage=1; setActiveSort('sortAlphabetical'); renderFav(); });
      const sortRandom=document.getElementById('sortRandom'); if(sortRandom) sortRandom.addEventListener('click',(e)=>{ e.preventDefault(); currentSort='random'; currentPage=1; setActiveSort('sortRandom'); renderFav(); });

      let statsCache = {
        data: null,
        timestamp: 0,
        listLength: 0
      };
      
      async function updateStats(){
        try{
          const list = await loadFavorites();
          const total = list.length;
          const box = document.querySelector('.right-sidebar .stats-box');
          if(box){
            box.innerHTML = `<div style="margin-bottom: 5px;"><strong>${i18n.t('stats.totalInFavorites')}:</strong> ${total} ${i18n.t('favorites.videoCount')}</div>`;
          }
        }catch(_){ }
      }

      function escapeHtml(str){
        return String(str)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#039;');
      }
      function timecodeToSeconds(code){
        const parts = code.split(':').map(n=>parseInt(n,10));
        if(parts.length===3){ const [h,m,s]=parts; if(h>=0&&m>=0&&m<60&&s>=0&&s<60) return h*3600+m*60+s; }
        if(parts.length===2){ const [m,s]=parts; if(m>=0&&s>=0&&s<60) return m*60+s; }
        return null;
      }
      function linkifyTimecodes(htmlText, baseUrl){
        const re=/(\b(?:[0-9]{1,2}:)?[0-5]?\d:[0-5]\d\b)/g;
        return htmlText.replace(re,(m)=>{
          const sec=timecodeToSeconds(m);
          if(sec==null) return m;
          const url = baseUrl + (baseUrl.includes('?')?'&':'?') + 't=' + sec;
          return `<a class="timecode" href="${url}">${m}</a>`;
        });
      }

      async function loadAllVideosAndPlaylistsForAutocomplete() {
        if (typeof AutocompleteDataLoader === 'undefined') {
          console.error('[Autocomplete] AutocompleteDataLoader module not loaded');
          return { videos: [], playlists: [] };
        }
        
        const result = await AutocompleteDataLoader.loadData();
        return { videos: result.videos || [], playlists: result.playlists || [] };
      }

      (async function init(){
        await initVideoHandle();
        readInitialPage(); currentQuery='';
        setActiveSort('sortNew');
        renderFav();
        updateStats();
        renderSubscribedChannelsList();
        
        if (window.i18n && typeof window.i18n.subscribe === 'function') {
          window.i18n.subscribe(() => {
              renderFav();
              updateStats();
          });
        }
        
        try {
          const searchInput = document.getElementById('headerSearchInput');
          if (searchInput && typeof AutocompleteIntegration !== 'undefined' && typeof YouviAutocomplete !== 'undefined') {
            const { videos, playlists } = await loadAllVideosAndPlaylistsForAutocomplete();
            
            const cacheValid = await window.autocompleteCache.isCacheValid(
              videos.length,
              playlists.length
            );
            
            const autocompleteIntegration = new AutocompleteIntegration();
            await autocompleteIntegration.init(searchInput, {
              videoDirectoryHandle: videoDirectoryHandle,
              allVideos: cacheValid ? [] : videos,
              allPlaylists: cacheValid ? [] : playlists
            });
            if (DEBUG_MODE) console.log('[Autocomplete] ✅ Initialized on youvi_fav.html');
          }
        } catch (error) {
          console.error('[Autocomplete] Failed to initialize:', error);
        }
      })();

      function searchByTag(tag) {
          if (DEBUG_MODE) console.log('Search by tag:', tag);
      }

      async function loadSubscriptionsFromFile() {
        try {
          const localSubscriptions = localStorage.getItem('8site_subscriptions');
          if (localSubscriptions) {
            return JSON.parse(localSubscriptions);
          }

          if (!videoDirectoryHandle) return null;

          const subscriptionsFile = await videoDirectoryHandle.getFileHandle('.subscriptions.json');
          const file = await subscriptionsFile.getFile();
          const text = await file.text();
          const fileSubscriptions = JSON.parse(text);

          localStorage.setItem('8site_subscriptions', JSON.stringify(fileSubscriptions));
          return fileSubscriptions;
        } catch (e) {
          if (DEBUG_MODE) console.log('No subscriptions found, using default');
          return null;
        }
      }

      async function renderSubscribedChannelsList() {
        const sidebarContainer = document.getElementById('subscribedChannelsContainer');
        if (!sidebarContainer) return;

        try {
          const savedSubscriptions = await loadSubscriptionsFromFile();
          const subscribedChannels = Array.isArray(savedSubscriptions) ? savedSubscriptions : [];

          sidebarContainer.innerHTML = '';

          if (subscribedChannels.length === 0) {
            const noSubs = document.createElement('div');
            noSubs.className = 'sidebar-item';
            noSubs.textContent = i18n.t('sidebar.noSubscriptions') || 'Нет подписок';
            noSubs.style.fontStyle = 'italic';
            noSubs.style.color = '#999';
            sidebarContainer.appendChild(noSubs);
            return;
          }

          subscribedChannels.forEach((channelName, index) => {
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'sidebar-item';
            link.dataset.channel = channelName;
            link.id = `sidebar_channel_${index}`;
            link.style.display = 'flex';
            link.style.alignItems = 'center';
            link.style.gap = '8px';

            const avatar = document.createElement('div');
            avatar.style.cssText = `
              width: 20px;
              height: 20px;
              background: #ff69b4;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: bold;
              font-size: 10px;
              flex-shrink: 0;
              background-size: cover;
              background-position: center;
              background-repeat: no-repeat;
              cursor: pointer;
            `;
            avatar.textContent = channelName.charAt(0).toUpperCase();
            avatar.title = 'Перейти к каналу';

            const textSpan = document.createElement('span');
            textSpan.textContent = channelName;
            textSpan.style.overflow = 'hidden';
            textSpan.style.textOverflow = 'ellipsis';
            textSpan.style.whiteSpace = 'nowrap';
            textSpan.style.flex = '1';

            link.appendChild(avatar);
            link.appendChild(textSpan);

            avatar.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
            });

            textSpan.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              window.location.href = 'youvi_subscriptions.html';
            });

            loadChannelAvatar(channelName).then(avatarUrl => {
              if (avatarUrl) {
                avatar.style.backgroundImage = `url(${avatarUrl})`;
                avatar.textContent = '';
              }
            }).catch(() => {
            });

            sidebarContainer.appendChild(link);
          });
        } catch (e) {
          console.error('Error loading subscriptions:', e);
          sidebarContainer.innerHTML = '<div class="sidebar-item" style="font-style: italic; color: #999;">' + (i18n.t('sidebar.loadingError') || 'Ошибка загрузки') + '</div>';
        }
      }

      const avatarCache = new Map();

      async function loadChannelAvatar(channelName) {
        const cacheKey = `avatar_${channelName}`;
        if (avatarCache.has(cacheKey)) {
          const cached = avatarCache.get(cacheKey);
          if (Date.now() - cached.timestamp < 300000) {
            return cached.url;
          }
          if (cached.url && cached.url.startsWith('blob:')) {
            URL.revokeObjectURL(cached.url);
          }
          avatarCache.delete(cacheKey);
        }

        try {
          const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
          const channelDir = await channelsDir.getDirectoryHandle(channelName, { create: true });

          const channelData = await readJSONFile(channelDir, 'channel.json', {});
          let avatarUrl = null;

          if (channelData.avatar) {
            avatarUrl = await loadImageFile(channelDir, channelData.avatar);
          }

          avatarCache.set(cacheKey, {
            url: avatarUrl,
            timestamp: Date.now()
          });

          return avatarUrl;
        } catch (e) {
          avatarCache.set(cacheKey, {
            url: null,
            timestamp: Date.now()
          });
          return null;
        }
      }

      async function readJSONFile(dirHandle, name, defaultValue = null) {
        try {
          const fileHandle = await dirHandle.getFileHandle(name);
          const file = await fileHandle.getFile();
          const text = await file.text();
          return JSON.parse(text);
        } catch (e) {
          return defaultValue;
        }
      }

      async function loadImageFile(dirHandle, name) {
        try {
          const fileHandle = await dirHandle.getFileHandle(name);
          const file = await fileHandle.getFile();
          return URL.createObjectURL(file);
        } catch (e) {
          return null;
        }
      }
    </script>
    
    <!-- Autocomplete -->
    <link rel="stylesheet" href="youvi/autocomplete/autocomplete.css">
    <script src="youvi/autocomplete-data-loader.js"></script>
    <script src="youvi/autocomplete/autocomplete.js"></script>
    <script src="youvi/autocomplete/autocomplete-cache.js"></script>
    <script src="youvi/autocomplete/autocomplete-integration.js"></script>
    
    <script src="youvi/themes/theme-toggle.js"></script>
    
    <!-- i18n Support -->
    <script src="youvi/i18n/ru.js"></script>
    <script src="youvi/i18n/en.js"></script>
    <script src="youvi/i18n/uk.js"></script>
    <script src="youvi/i18n/i18n.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const langSwitcher = document.getElementById('langSwitcher');
            
            if (langSwitcher) {
                langSwitcher.value = i18n.getCurrentLanguage();
                
                langSwitcher.addEventListener('change', async function(e) {
                    const newLang = e.target.value;
                    await i18n.setLanguage(newLang);
                    if (window.statsCache) window.statsCache = {};
                    updateStats();
                    renderFav();
                });
            }
        });
    </script>
</body>
</html>