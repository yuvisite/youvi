<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="subscriptions.pageTitle">–ü–æ–¥–ø–∏—Å–∫–∏ | Youvi</title>
    <script>
        (function() {
            var theme = localStorage.getItem('youvi-theme');
            var sidebar = localStorage.getItem('sidebarCollapsed');
            
            var htmlClasses = [];
            if (theme === 'dark') htmlClasses.push('dark-theme');
            else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
            if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
            if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
        })();
    </script>
    <link rel="stylesheet" href="youvi/header/youvi-header.css">
    <script src="youvi/sidebar-toggle.js"></script>
    <script src="youvi/sidebar-scroll.js"></script>
    <script src="youvi/header/youvi-header.js"></script>
    
    <!-- Video ID System -->
    <script src="youvi/video-id.js"></script>
    
    <link rel="stylesheet" href="youvi/sidebar.css">
    <link rel="stylesheet" href="youvi/sidebar-scroll.css">
    <link rel="stylesheet" href="youvi/pagination.css">
    
    <!-- Theme System -->
    <link rel="stylesheet" href="youvi/themes/dark-theme.css">
    <link rel="stylesheet" href="youvi/themes/theme-dropdown.css">
    
    <!-- YouVi Hover Preview System -->
    <script src="youvi/hover/hover-preview-queue.js"></script>
    <script src="youvi/hover/hover-preview.js"></script>
    <script src="youvi/hover/hover-init.js"></script>
    <script src="youvi/hover/hover-bundle.js"></script>
    
    <!-- Avatar Cache Module -->
    <script src="youvi/avatar-cache.js"></script>

    <!-- Danmaku Counter -->
    <script src="youvi/danmaku-counter.js"></script>
    <link rel="stylesheet" href="youvi/danmaku-counter.css">

    <link rel="stylesheet" href="youvi/sticky-video.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #111;
        }

        .top-nav {
            background: #d94b88;
            border-bottom: 1px solid #c2185b;
            padding: 4px 0;
        }

        .top-nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 0;
            transition: color 0.2s;
        }

        .top-nav a:hover {
            color: #ffd6ea;
        }

        .top-nav a.active {
            color: #ffd6ea;
            font-weight: 600;
        }

        .lang-switcher {
            margin-left: auto;
        }
        
        .lang-select {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            outline: none;
        }
        
        .lang-select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-select option {
            background: #d94b88;
            color: #fff;
        }

        .header {
            background: #FFE7F4;
            padding: 0;
            border-bottom: 1px solid #f2cfe1;
            min-height: 40px;
            width: 100%;
        }

        .header-content-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            box-sizing: border-box;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
            min-height: 40px;
        }

        .sidebar-toggle-btn {
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #111;
            transition: background-color 0.2s;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .sidebar-toggle-btn:hover {
            background: transparent;
        }

        .sidebar-toggle-btn svg {
            width: 16px;
            height: 16px;
            fill: #111;
        }

        .sidebar-collapsed .sidebar,
        html.sidebar-collapsed .sidebar {
            width: 60px !important;
            padding: 10px 8px !important;
            display: block !important;
            position: sticky !important;
            top: 40px !important;
            max-height: calc(var(--sidebar-max-height, 100vh) - 75px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .sidebar-collapsed .container,
        html.sidebar-collapsed .container {
            padding-left: 20px;
        }

        .sidebar-collapsed .main-content,
        html.sidebar-collapsed .main-content {
            margin-left: 0;
        }

        .sidebar-collapsed .content-wrapper,
        html.sidebar-collapsed .content-wrapper {
            max-width: 1500px;
        }

        .sidebar-collapsed .sidebar-title,
        html.sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-item,
        html.sidebar-collapsed .sidebar-item {
            padding: 8px !important;
            padding-left: 5px !important;
            padding-right: 8px !important;
            justify-content: center !important;
            border-left: 3px solid transparent !important;
            border-radius: 4px;
            font-size: 0 !important;
        }

        .sidebar-collapsed .sidebar-item:hover,
        html.sidebar-collapsed .sidebar-item:hover {
            background: rgba(255, 105, 180, 0.1);
        }

        .sidebar-collapsed .sidebar-item.active,
        html.sidebar-collapsed .sidebar-item.active {
            background: rgba(255, 105, 180, 0.15);
        }

        .sidebar-collapsed .sidebar-item svg,
        .sidebar-collapsed .sidebar-item img,
        html.sidebar-collapsed .sidebar-item svg,
        html.sidebar-collapsed .sidebar-item img {
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
            font-size: 16px !important;
        }

        .sidebar-collapsed #subscribedChannelsList .sidebar-item,
        html.sidebar-collapsed #subscribedChannelsList .sidebar-item {
            justify-content: center !important;
        }

        .sidebar-collapsed #subscribedChannelsList .sidebar-item span,
        html.sidebar-collapsed #subscribedChannelsList .sidebar-item span {
            display: none !important;
        }

        .sidebar-collapsed #subscribedChannelsList .sidebar-item div,
        html.sidebar-collapsed #subscribedChannelsList .sidebar-item div {
            margin: 0 !important;
        }

        .sidebar-collapsed .library-item,
        .sidebar-collapsed .nav-item,
        html.sidebar-collapsed .library-item,
        html.sidebar-collapsed .nav-item {
            justify-content: center !important;
            gap: 0 !important;
        }

        .sidebar-collapsed .library-item span,
        .sidebar-collapsed .nav-item span,
        html.sidebar-collapsed .library-item span,
        html.sidebar-collapsed .nav-item span {
            display: none !important;
        }

        .sidebar-collapsed .library-item svg,
        .sidebar-collapsed .nav-item svg,
        html.sidebar-collapsed .library-item svg,
        html.sidebar-collapsed .nav-item svg {
            margin: 0 !important;
        }

        .nav-bar {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            height: 100%;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-left: calc(200px + 20px + 20px);
        }

        .nav-right-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-links a {
            color: #111;
            text-decoration: none;
            font-size: 13px;
            padding: 5px 0;
        }



        .search-btn {
            padding: 8px 15px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .user-actions a {
            color: #111;
            text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }

        .user-actions a:hover {
            color: #ff69b4;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: stretch;
            min-height: calc(100vh - 200px);
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }
        
        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
        }
        
        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
        }
        
        .header-content-wrapper,
        .top-nav-content {
            max-width: none !important;
            margin: 0 !important;
        }




        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 40px;
        }

        .main-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            margin-top: 5px;
            padding: 0 20px;
        }

        .section-title {
            font-size: 24px;
            color: #111;
            margin: 0;
        }

        .videos-stats {
            font-size: 14px;
            color: #666;
        }

        .feed-mode-toggle-buttons {
            display: flex;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 2px;
            gap: 2px;
            margin: 0 auto;
        }


        .feed-mode-btn {
            padding: 4px 16px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            transition: all 0.2s ease;
            font-size: 13px;
            min-width: 80px;
            text-align: center;
            height: 28px;
            line-height: 20px;
        }

        .feed-mode-btn.active {
            background: #ff69b4;
            color: white;
        }

        .channel-avatars-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            margin-left: 0;
            padding: 0 20px;
            align-items: center;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .channel-avatars-bar::-webkit-scrollbar {
            display: none;
        }

        .channel-avatar-btn {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            border: none !important;
            outline: none !important;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .channel-avatar-btn:hover {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .channel-avatar-btn.active {
            border: 2px solid #ff69b4 !important;
            outline: none !important;
            box-shadow: 0 0 0 1px #ff69b4 !important;
        }

        .channel-avatar-btn.all-videos {
            background: #f5f5f5;
            border: none !important;
            outline: none !important;
        }

        .channel-avatar-btn.all-videos svg {
            width: 28px;
            height: 28px;
            display: block;
        }



        .channel-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 0;
            background: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }

        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 20px;
        }

        #subscriptionContent .video-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)) !important;
        }

        #subscriptionContent {
            width: 100%;
        }
        
        #subscriptionContent .video-grid {
            width: 100%;
            max-width: none;
        }

        .chronological-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .chronological-list .video-card {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .chronological-list .video-card {
            align-items: stretch;
        }

        .chronological-list .video-thumbnail {
            flex: 0 0 280px;
            height: 158px;
            aspect-ratio: auto;
            border-radius: 6px;
            background: #eee;
            position: relative;
            overflow: hidden;
        }

        .chronological-list .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chronological-list .video-info {
            padding: 0 0 0 4px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: hidden;
            min-width: 0;
        }

        .chronological-list .video-card-title {
            font-size: 18px;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #111;
            line-height: 1.3;
        }

        .chronological-list .video-meta-line,
        .chronological-list .video-views-line,
        .chronological-list .video-likes-line,
        .chronological-list .video-dates-line {
            font-size: 13px;
            color: #666;
        }

        .chronological-list .video-views {
            font-size: 12px;
            color: #666;
        }

        .chronological-list .video-desc {
            font-size: 13px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            color: #444;
        }

        .chronological-list .video-category {
            font-size: 13px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            color: #444;
        }

        .chronological-list .video-category-link {
            color: #666;
            text-decoration: none;
        }

        .chronological-list .video-category-link:hover {
            color: #ff69b4;
            text-decoration: underline;
        }

        .chronological-list .video-channel-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
        }

        .chronological-list .video-channel-row .channel-avatar-mini {
            width: 20px;
            height: 20px;
            font-size: 12px;
            background: #ff69b4;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: 4px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            flex-shrink: 0;
        }

        .chronological-list .video-channel-row .playlist-channel-link {
            font-size: 14px;
        }

        .chronological-list .playlist-channel {
            font-size: 13px;
        }
        
        .video-card-meta-row-sub {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 4px;
        }
        
        .video-card-avatar-link {
            text-decoration: none;
            display: block;
            flex-shrink: 0;
        }
        
        .channel-avatar-mini.custom-avatar {
            background-color: transparent;
        }
        
        .video-card-text-sub {
            flex: 1;
            min-width: 0;
        }
        
        .video-channel-row-inline {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .chronological-list .video-channel-row .playlist-channel-link {
            font-size: 14px;
            color: #ff69b4;
            text-decoration: none;
            font-weight: 500;
        }

        .chronological-list .video-channel-row .playlist-channel-link:hover {
            text-decoration: underline;
        }

        .chronological-list .video-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
            color: #fff;
            z-index: 2;
        }

        .list-item {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }

        .list-item:hover {
            background: #f8f8f8;
        }

        .list-thumbnail {
            width: 280px;
            height: 158px;
            background: #ddd;
            border-radius: 6px;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        .list-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .list-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-width: 0;
        }

        .list-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 6px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #111;
        }

        .list-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: #666;
            font-size: 13px;
        }

        .list-channel {
            color: #ff69b4;
            font-weight: 400;
            text-decoration: none;
        }

        .list-channel:hover {
            text-decoration: underline;
        }

        .list-date {
            color: #888;
        }

        .list-views {
            color: #666;
        }

        .date-group {
            margin: 20px 0 15px 0;
        }

        .date-group-title {
            font-weight: 600;
            color: #111;
            margin-bottom: 12px;
            font-size: 18px;
            padding: 0;
        }

        
        .video-quality {
            position: absolute;
            top: 5px;
            left: 5px;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 10px;
            color: #fff;
            z-index: 3;
            font-weight: bold;
        }
        .video-quality[data-quality="4K"] { background: rgba(156,39,176,0.8); }
        .video-quality[data-quality="1080p"] { background: rgba(255,105,180,0.8); }
        .video-quality[data-quality="720p"] { background: rgba(76,175,80,0.8); }
        .video-quality[data-quality="480p"] { background: rgba(255,152,0,0.8); }
        .video-quality[data-quality="SD"] { background: rgba(102,102,102,0.8); }
        
        body.dark-theme .video-quality[data-quality="4K"] { background: rgba(156,39,176,0.9); }
        body.dark-theme .video-quality[data-quality="1080p"] { background: rgba(255,105,180,0.9); }
        body.dark-theme .video-quality[data-quality="720p"] { background: rgba(76,175,80,0.9); }
        body.dark-theme .video-quality[data-quality="480p"] { background: rgba(255,152,0,0.9); }
        body.dark-theme .video-quality[data-quality="SD"] { background: rgba(102,102,102,0.9); }

        .badges-hidden .video-quality,
        .badges-hidden .video-new {
            display: none !important;
        }

        .badges-hidden [style*="position:absolute"][style*="top:8px"][style*="left:8px"][style*="background: rgba(255,134,195,0.8)"],
        .badges-hidden [style*="position:absolute"][style*="top:8px"][style*="right:8px"][style*="background:#ff4444"] {
            display: none !important;
        }

        .badges-hidden [style*="background: rgba(255,134,195,0.8)"],
        .badges-hidden [style*="background:#ff4444"] {
            display: none !important;
        }

        .badges-hidden [class*="video-quality"],
        .badges-hidden [class*="video-new"] {
            display: none !important;
        }

        .badges-hidden .video-card [class*="video-quality"],
        .badges-hidden .video-card [class*="video-new"] {
            display: none !important;
        }


        .video-tag-link, .video-category-link {
            color: #666;
            text-decoration: none;
            margin-right: 5px;
            cursor: pointer;
        }

        .playlist-channel-link {
            color: #ff69b4;
            text-decoration: none;
            font-weight: 500;
        }

        .playlist-channel-link:hover {
            text-decoration: underline;
        }

        .channel-section {
            margin-bottom: 30px;
        }

        .channel-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 0 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .channel-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .sidebar-item.active .channel-avatar-small {
            background-color: #e0e0e0;
        }

        .channel-section-info {
            flex: 1;
        }

        .channel-section-name {
            font-size: 16px;
            font-weight: 600;
            color: #111;
            margin-bottom: 2px;
        }

        .channel-section-name a {
            color: #111;
            text-decoration: none;
        }

        .channel-section-name a:hover {
            color: #ff69b4;
        }

        .channel-section-stats {
            font-size: 12px;
            color: #666;
        }

        .view-all-btn {
            background: none;
            border: 1px solid #ff69b4;
            color: #ff69b4;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-all-btn:hover {
            background: #ff69b4;
            color: white;
        }


        .empty-state {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            font-size: 16px;
        }

        .footer {
            background: #2c2c2c;
            color: #fff;
            padding: 25px 0 15px 0;
            margin-top: 0;
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .footer-logo {
            flex-shrink: 0;
            width: 200px;
        }

        .footer-logo img {
            height: 40px;
            width: auto;
        }

        .footer-logo p {
            margin-top: 8px;
            font-size: 11px;
            color: #ccc;
            line-height: 1.3;
        }

        .footer-sections {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-main {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-right {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .footer-mascot {
            flex-shrink: 0;
        }

        .footer-mascot img {
            height: 180px;
            width: auto;
        }

        .footer-section {
            flex: 1;
        }

        .footer-section h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #fff;
            font-weight: 600;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-section li {
            margin-bottom: 6px;
        }

        .footer-section a {
            color: #ccc;
            text-decoration: none;
            font-size: 11px;
            transition: color 0.2s;
        }

        .footer-section a:hover {
            color: #ff69b4;
        }

        .footer-bottom {
            border-top: 1px solid #444;
            margin-top: 20px;
            padding-top: 15px;
            text-align: center;
            color: #999;
            font-size: 10px;
        }

        .channel-avatar-btn,
        .channel-avatar-btn:hover {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .channel-avatar-btn.active {
            outline: none !important;
            background-color: #e0e0e0 !important;
        }

        .no-subscriptions {
            text-align: center;
            padding: 80px 20px;
        }

        .no-subscriptions h3 {
            font-size: 20px;
            color: #111;
            margin-bottom: 12px;
        }

        .no-subscriptions p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .browse-channels-btn {
            background: #ff69b4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.2s;
        }

        .browse-channels-btn:hover {
            background: #d94b88;
        }

        body.dark-theme input.search-input {
  background: #4a3a34 !important;
  color: #fff !important;
  border-color: #555 !important;
}


        .skeleton-card {
            position: relative;
            cursor: default;
            width: 100%;
            min-width: 0;
            overflow: hidden;
            contain: layout;
            opacity: 0.7;
        }
        
        .skeleton-thumb {
            width: 100%;
            height: auto;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 6px;
            margin-bottom: 4px;
            aspect-ratio: 16/9;
        }
        
        .skeleton-info {
            padding: 0 5px;
            width: 100%;
            min-width: 0;
        }
        
        .skeleton-title {
            height: 13px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 2px;
            margin-bottom: 3px;
        }
        
        .skeleton-channel {
            height: 11px;
            width: 70%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 2px;
            margin-bottom: 2px;
        }
        
        .skeleton-views {
            height: 11px;
            width: 50%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 2px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: #ff69b4;
            transition: width 0.3s ease;
            z-index: 1001;
        }

        @media (max-width: 1024px) {
            .videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }
            
            #subscriptionContent .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                gap: 20px;
                padding: 10px 0;
                margin-bottom: 20px;
            }
            
            .sidebar-section {
                flex-shrink: 0;
                margin-bottom: 0;
            }
            
            .nav-links {
                display: none;
            }
            
            .search-input {
                width: 150px;
            }
            
            .videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
                padding: 0 10px;
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
                padding: 0 10px;
            }
            
            #subscriptionContent .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
                padding: 0 10px !important;
            }

            .main-content-header {
                padding: 0 10px;
            }

            .subscription-tabs {
                padding: 0 10px;
            }

            .channel-section-header {
                padding: 0 10px;
            }
        }

        @media (max-width: 768px) {
            .main-content-header {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .feed-mode-toggle-buttons {
                order: 2;
            }

            .feed-mode-btn {
                padding: 4px 14px;
                font-size: 12px;
                min-width: 70px;
                height: 26px;
                line-height: 18px;
            }


            .chronological-list {
                padding: 0 10px;
            }

            .chronological-list .video-thumbnail {
                flex: 0 0 120px;
                height: 68px;
            }

            .chronological-list .video-card-title {
                font-size: 14px;
            }

            .chronological-list .video-meta-line,
            .chronological-list .video-dates-line,
            .chronological-list .video-desc {
                font-size: 12px;
            }

            .date-group-title {
                font-size: 16px;
                padding: 0 10px;
            }
        }

        @media (max-width: 480px) {
            .feed-mode-toggle-buttons {
                padding: 1px;
            }

            .feed-mode-btn {
                padding: 3px 12px;
                font-size: 11px;
                min-width: 65px;
                height: 24px;
                line-height: 18px;
            }

            .chronological-list .video-thumbnail {
                flex: 0 0 100px;
                height: 56px;
            }

            .chronological-list .video-card-title {
                font-size: 13px;
            }

            .chronological-list .video-meta-line,
            .chronological-list .video-dates-line,
            .chronological-list .video-desc {
                font-size: 11px;
            }

            .chronological-list .video-channel-row {
                gap: 6px;
            }

            .chronological-list .video-channel-row .channel-avatar-mini {
                width: 16px;
                height: 16px;
                font-size: 10px;
            }

            .chronological-list .video-channel-row .playlist-channel-link {
                font-size: 12px;
            }


            .main-content-header {
                padding: 0 10px;
            }

            .videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }
            
            #subscriptionContent .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
            }

            .section-title {
                font-size: 18px;
            }

            .channel-avatars-bar {
                gap: 8px;
                padding: 0 10px;
                margin-left: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; 
            }

            .channel-avatar-btn {
                width: 42px;
                height: 42px;
                font-size: 12px;
                border-radius: 0;
                min-width: 42px; 
                flex-shrink: 0;
            }

            .chronological-list {
                gap: 6px;
                padding: 0 10px;
            }

            .date-group-title {
                font-size: 14px;
                margin-bottom: 8px;
            }
        }

        @media (min-width: 1400px) {
            .videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            #subscriptionContent .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
            }
        }

        @media (min-width: 1700px) {
            .footer-content {
                max-width: 1700px !important;
            }
        }

        @media (min-width: 2000px) {
            .footer-content {
                max-width: 1800px !important;
            }
        }
    </style>
</head>
<link rel="icon" href="favicon/youvi/favicon.ico" type="image/x-icon">
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="top-nav-content">
      <a href="youvi_main.html" class="active" data-i18n="nav.video">–í–∏–¥–µ–æ</a>
      <a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
      <a href="youvi_ch_list.html" data-i18n="nav.channels">–ö–∞–Ω–∞–ª—ã</a>
      <a href="youvi_playlists_list.html" data-i18n="nav.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a>
      <a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a> 
      <a href="wiki/index.html" data-i18n="nav.wiki">Wiki</a>
      <div class="lang-switcher">
        <select id="langSwitcher" class="lang-select">
          <option value="ru">üá∑üá∫ RU</option>
          <option value="en">üá¨üáß EN</option>
          <option value="uk">üá∫üá¶ UK</option>
        </select>
      </div>
        </div>
    </div>

    <!-- Header -->
    <!-- Header -->
    <header class="header">
        <div class="header-content-wrapper">
            <div class="header-left">
                <button class="sidebar-toggle-btn" id="sidebarToggle">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
                
                <div class="logo">
                    <a href="youvi_main.html">
                        <img src="images/logo_youvi_ind.png" alt="Youvi logo">
                    </a>
                </div>
            </div>
            
            <div class="header-center">
                <div class="search-area autocomplete-wrapper">
                    <input type="text" class="search-input" id="headerSearchInput" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." data-i18n-placeholder="search.placeholder">
                    <button class="search-btn" id="headerSearchBtn" data-i18n="search.button">–ü–æ–∏—Å–∫</button>
                </div>
            </div>
            
            <div class="header-right">
                <div class="user-actions">
                    <a href="#" id="badgesToggle" onclick="toggleVideoBadges(); return false;" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –∫–∞—á–µ—Å—Ç–≤–∞" data-i18n="header.badges" data-i18n-title="subscriptions.badgesTitle">–ú–µ—Ç–∫–∏</a>
                    <div class="settings-container">
                        <a href="#" class="settings-btn">‚öô</a>
                        <div class="theme-dropdown">
                            <button class="theme-dropdown-item" data-theme="light" data-i18n="themes.light">–ë–µ–ª–∞—è</button>
                            <button class="theme-dropdown-item" data-theme="dark" data-i18n="themes.dark">–ß–µ—Ä–Ω–∞—è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.navigation">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                <a href="youvi_main.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
                <a href="youvi_feed_all.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 11a9 9 0 0 1 9 9"/>
                        <path d="M4 4a16 16 0 0 1 16 16"/>
                        <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <span data-i18n="sidebar.feed">Feed</span>
                </a>
                <a href="youvi_tags.html" class="sidebar-item nav-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                     <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                 </svg>
                    <span data-i18n="sidebar.allTagsLink">–í—Å–µ —Ç–µ–≥–∏</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
                <a href="youvi_history.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</span>
                </a>
                <a href="youvi_fav.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                </a>
                <a href="youvi_playlists_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</span>
                </a>
                <a href="youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</span>
                </a>
                <a href="youvi_subscriptions.html" class="sidebar-item library-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.subscriptionsTitle">–ü–æ–¥–ø–∏—Å–∫–∏</div>
                <div id="subscribedChannelsList">
                    <!-- Subscribed channels will be populated here -->
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.sorting">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
                <div id="sortOptionsContainer">
                    <a href="#" class="sidebar-item library-item active" id="sortDate">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span data-i18n="subscriptions.sortByDate">–ü–æ –¥–∞—Ç–µ</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortPopular">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        <span data-i18n="subscriptions.sortByPopular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortViews">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span data-i18n="subscriptions.sortByViews">–ü–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortAlphabetical">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <path d="M4 16L8 6l4 10"/>
                            <path d="M5 13h6"/>
                            <path d="M14 6h6"/>
                            <path d="M14 12h6"/>
                            <path d="M14 18h6"/>
                        </svg>
                        <span data-i18n="subscriptions.sortByAlphabetical">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Content Wrapper (centered) -->
        <div class="content-wrapper">
        <!-- Main Content -->
        <main class="main-content">
            <div class="main-content-header">
                <h1 class="section-title" data-i18n="subscriptions.title">–ü–æ–¥–ø–∏—Å–∫–∏</h1>
                <div class="feed-mode-toggle-buttons">
                    <button class="feed-mode-btn active" id="gridModeBtn" data-i18n="subscriptions.grid">–°–µ—Ç–∫–∞</button>
                    <button class="feed-mode-btn" id="listModeBtn" data-i18n="subscriptions.list">–°–ø–∏—Å–æ–∫</button>
                </div>
                <div class="videos-stats">
                    <a href="#" id="openChannelLink" style="display:none;margin-right:10px;color:#ff69b4;text-decoration:none;font-size:13px;" data-i18n="subscriptions.openChannel">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª</a>
                    <span id="videosCount" data-i18n="subscriptions.defaultCount">0 –≤–∏–¥–µ–æ</span>
                </div>
            </div>

            <!-- Channel Avatars Bar -->
            <div class="channel-avatars-bar" id="channelAvatarsBar">
                <!-- Channel avatars will be populated here -->
            </div>

            <div id="subscriptionContent">
                <!-- Content will be rendered here -->
            </div>

            <div id="paginationContainer">
                <!-- Pagination will be rendered here -->
            </div>
        </main>
        </div><!-- /content-wrapper -->
    </div>
    
   <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-logo">
                    <img src="images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
                    <p data-i18n="footer.description">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ.</p>
                </div>
                <div class="footer-sections">
                    <div class="footer-section">
                        <h3 data-i18n="footer.sections">–†–∞–∑–¥–µ–ª—ã</h3>
                        <ul>
                            <li><a href="youvi_main.html" data-i18n="footer.video">–í–∏–¥–µ–æ</a></li>
                            <li><a href="youvi_tags.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
                            <li><a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a></li>
                            <li><a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
                        <ul>
                            <li><a href="youvi_ch_list.html" data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</a></li>
                            <li><a href="youvi_playlists_list.html" data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a></li>
                            <li><a href="youvi_subscriptions.html" data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</a></li>
                            <li><a href="youvi_fav.html" data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a></li>
                            <li><a href="youvi_history.html" data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="nav.wiki">Wiki</h3>
                        <ul>
                            <li><a href="wiki/index.html" data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li><a href="wiki/player.html" data-i18n="footer.wiki.player">–ü–ª–µ–µ—Ä</a></li>
                            <li><a href="wiki/danmaku.html" data-i18n="footer.wiki.danmaku">–î–∞–Ω–º–∞–∫—É</a></li>
                            <li><a href="wiki/tags/general.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
                            <li><a href="wiki/tags/rules.html" data-i18n="footer.wiki.taggingRules">–ü—Ä–∞–≤–∏–ª–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</a></li>
                            <li><a href="wiki/search/general.html" data-i18n="footer.wiki.search">–ü–æ–∏—Å–∫</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.pgc">PGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Anime (ct)" data-i18n="footer.categories.anime">Anime</a></li>
                            <li><a href="youvi_main.html?tag=Animation (ct)" data-i18n="footer.categories.animation">Animation</a></li>
                            <li><a href="youvi_main.html?tag=Movies (ct)" data-i18n="footer.categories.movies">Movies</a></li>
                            <li><a href="youvi_main.html?tag=Series (ct)" data-i18n="footer.categories.series">Series</a></li>
                            <li><a href="youvi_main.html?tag=Music (ct)" data-i18n="footer.categories.music">Music</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.ugc">UGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Games (ct)" data-i18n="footer.categories.games">Games</a></li>
                            <li><a href="youvi_main.html?tag=Technology (ct)" data-i18n="footer.categories.tech">Technology</a></li>
                            <li><a href="youvi_main.html?tag=Entertainment (ct)" data-i18n="footer.categories.entertainment">Entertainment</a></li>
                            <li><a href="youvi_main.html?tag=IRL (ct)" data-i18n="footer.categories.irl">IRL</a></li>
                            <li><a href="youvi_main.html?tag=TV (ct)" data-i18n="footer.categories.tv">TV</a></li>
                            <li><a href="youvi_main.html?tag=Education (ct)" data-i18n="footer.categories.education">Education</a></li>
                            <li><a href="youvi_main.html?tag=Other (ct)" data-i18n="footer.categories.other">Other</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.about">–û —Å–∞–π—Ç–µ</h3>
                        <ul>
                            <li><a href="wiki/about.html" data-i18n="footer.aboutSite">–ü—Ä–æ —Å–∞–π—Ç</a></li>
                            <li><a href="wiki/docs.html" data-i18n="footer.docs">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></li>
                            <li><a href="wiki/tech.html" data-i18n="footer.tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-right">
                <div class="footer-mascot">
                    <img src="images/mascot1.png" alt="Yuvi" loading="lazy">
                </div>
            </div>
        </div>
    </footer>

    <script>
        /**
         * DEBUG_MODE flag - Controls console logging
         * Set to false to disable console.log statements in production
         * Set to true to enable debugging output
         * NOTE: console.error statements for critical errors will still show
         */
        const DEBUG_MODE = false;
        
        let allVideos = [];
        let filteredVideos = [];
        let subscribedChannels = [];
        let currentPage = 1;
        let videosPerPage = 60;
        let currentSort = 'date';
        let currentTimeFilter = 'all';
        let currentSearchQuery = '';
        let videoDirectoryHandle = null;
        window.videoDirectoryHandle = null;
        let groupByChannel = false;
        let currentFeedMode = 'grid';
        let currentChannelName = null;
        const currentGridColumns = 5;
        const supportsFS = 'showDirectoryPicker' in window;
        
        let skeletonVisible = false;
        let initialLoadComplete = false;
        const SCAN_INTERVAL = 5 * 60 * 1000;
        const BATCH_SIZE = 100;
        
        function showLoadingProgress() {
            let progressBar = document.getElementById('loadingProgress');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.id = 'loadingProgress';
                progressBar.className = 'loading-progress';
                document.body.appendChild(progressBar);
            }
            progressBar.style.width = '0%';
        }
        
        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingProgress');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }
        
        function hideLoadingProgress() {
            const progressBar = document.getElementById('loadingProgress');
            if (progressBar) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.opacity = '0';
                    setTimeout(() => progressBar.remove(), 300);
                }, 200);
            }
        }
        
        function showSkeletonLoading() {
            const container = document.getElementById('subscriptionContent');
            if (!container || skeletonVisible) return;
            
            skeletonVisible = true;
            const skeletonCount = 30;
            
            let html = '<div class="video-grid" id="videosGrid">';
            for (let i = 0; i < skeletonCount; i++) {
                html += `
                    <div class="skeleton-card">
                        <div class="skeleton-thumb"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-channel"></div>
                            <div class="skeleton-views"></div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        function hideSkeletonLoading() {
            skeletonVisible = false;
        }

        
        class TaskQueue {
            constructor(concurrency = 3) {
                this.concurrency = concurrency;
                this.running = 0;
                this.queue = [];
                this.priorityQueue = [];
            }

            add(task, priority = 0) {
                const taskWrapper = { task, priority, id: Date.now() + Math.random() };

                if (priority > 0) {
                    this.priorityQueue.push(taskWrapper);
                    this.priorityQueue.sort((a, b) => b.priority - a.priority);
                } else {
                    this.queue.push(taskWrapper);
                }

                this.process();
            }

            async process() {
                if (this.running >= this.concurrency || (this.priorityQueue.length === 0 && this.queue.length === 0)) {
                    return;
                }

                this.running++;

                let taskWrapper;
                if (this.priorityQueue.length > 0) {
                    taskWrapper = this.priorityQueue.shift();
                } else {
                    taskWrapper = this.queue.shift();
                }

                if (taskWrapper) {
                    try {
                        await taskWrapper.task();
                    } catch (error) {
                        console.error('Task execution error:', error);
                    } finally {
                        this.running--;
                        this.process();
                    }
                } else {
                    this.running--;
                }
            }

            getStats() {
                return {
                    running: this.running,
                    queued: this.queue.length,
                    priorityQueued: this.priorityQueue.length
                };
            }
        }

        const taskQueue = new TaskQueue(3);

        class VideoLazyLoader {
            constructor() {
                this.observer = null;
                this.pendingVideos = new Map();
                this.initObserver();
            }

            initObserver() {
                if ('IntersectionObserver' in window) {
                    this.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const videoName = entry.target.dataset.videoName;
                                const videoData = this.pendingVideos.get(videoName);
                                if (videoData) {
                                    this.loadVideoPreview(videoData.video, videoData.thumbnailElement, videoData.priority);
                                    this.pendingVideos.delete(videoName);
                                    this.observer.unobserve(entry.target);
                                }
                            }
                        });
                    }, {
                        rootMargin: '50px',
                        threshold: 0.1
                    });
                } else {
                    console.warn('IntersectionObserver not supported. Previews will load without lazy loading.');
                }
            }

            addVideo(video, thumbnailElement, priority = 0) {
                if (!this.observer) {
                    this.loadVideoPreview(video, thumbnailElement, priority);
                    return;
                }

                thumbnailElement.dataset.videoName = video.name;

                this.pendingVideos.set(video.name, { video, thumbnailElement, priority });

                this.observer.observe(thumbnailElement);
            }

            forceLoadAll() {
                this.pendingVideos.forEach((videoData, videoName) => {
                    this.loadVideoPreview(videoData.video, videoData.thumbnailElement, videoData.priority);
                    if (this.observer) {
                        this.observer.unobserve(videoData.thumbnailElement);
                    }
                });
                this.pendingVideos.clear();
            }

            getStats() {
                return {
                    pending: this.pendingVideos.size,
                    observerActive: !!this.observer
                };
            }

            cleanup() {
                if (this.observer) {
                    this.observer.disconnect();
                    this.observer = null;
                }

                this.pendingVideos.clear();
            }

            async loadVideoPreview(video, thumbnailElement, priority = 0) {
                const task = async () => {
                    try {
                        if (DEBUG_MODE) console.log(`Loading preview for video: ${video.name}`, {
                            hasFile: !!video.file,
                            hasHandle: !!video.handle,
                            hasDirHandle: !!video.dirHandle
                        });

                        if (!video.file || !video.handle) {
                            const foundVideo = allVideos.find(av => av.name === video.name);
                            if (foundVideo && foundVideo.file && foundVideo.handle) {
                                if (DEBUG_MODE) console.log(`Using found video data for lazy loading: ${video.name}`);
                                video.file = foundVideo.file;
                                video.handle = foundVideo.handle;
                                video.dirHandle = foundVideo.dirHandle;
                            } else {
                            console.warn(`Video ${video.name} missing file/handle, skipping preview generation`);
                            return;
                            }
                        }

                        const { preview, duration } = await getPreviewAndDuration(video);

                        let existingImg = thumbnailElement.querySelector('img');
                        let existingDuration = thumbnailElement.querySelector('.video-duration');

                        if (preview) {
                            if (existingImg) {
                                existingImg.src = preview;
                                existingImg.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1;';
                            } else {
                                const img = document.createElement('img');
                                img.src = preview;
                                img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1;';
                                thumbnailElement.appendChild(img);
                            }
                            if (DEBUG_MODE) console.log(`Successfully loaded preview for: ${video.name}`);
                        } else {
                            if (!existingImg) {
                                const fallbackDiv = document.createElement('div');
                                fallbackDiv.style.cssText = 'width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#111;font-size:12px;text-align:center;padding:5px;position:absolute;top:0;left:0;z-index:1;';
                                fallbackDiv.textContent = escapeHtml(getnameWithoutExtension(video.name));
                                thumbnailElement.appendChild(fallbackDiv);
                            }
                        }

                        if (existingDuration) {
                            existingDuration.textContent = duration || '0:00';
                        } else {
                            const durationElement = document.createElement('div');
                            durationElement.className = 'video-duration';
                            durationElement.textContent = duration || '0:00';
                            thumbnailElement.appendChild(durationElement);
                        }


                    } catch (e) {
                        console.error('Error loading preview for', video.name, e);
                        let existingDuration = thumbnailElement.querySelector('.video-duration');
                        if (!existingDuration) {
                            const durationElement = document.createElement('div');
                            durationElement.className = 'video-duration';
                            durationElement.style.cssText = 'position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.8);padding:2px 6px;border-radius:3px;font-size:11px;color:#fff;z-index:2;';
                            durationElement.textContent = '0:00';
                            thumbnailElement.appendChild(durationElement);
                        }
                        
                        if (!thumbnailElement.querySelector('img') && !thumbnailElement.querySelector('div[style*="background:#333"]')) {
                            const fallbackDiv = document.createElement('div');
                            fallbackDiv.style.cssText = 'width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;text-align:center;padding:5px;position:absolute;top:0;left:0;z-index:1;';
                            fallbackDiv.textContent = escapeHtml(getnameWithoutExtension(video.name));
                            thumbnailElement.appendChild(fallbackDiv);
                        }
                    }
                };

                taskQueue.add(task, priority);
            }
        }
        let videoLazyLoader = null;

        if (typeof VideoLazyLoader !== 'undefined') {
            videoLazyLoader = new VideoLazyLoader();
            if (DEBUG_MODE) console.log('VideoLazyLoader initialized successfully');
        } else {
            console.error('VideoLazyLoader class not found');
        }


        async function loadAllVideosAndPlaylistsForAutocomplete() {
          if (typeof AutocompleteDataLoader === 'undefined') {
            console.error('[Autocomplete] AutocompleteDataLoader module not loaded');
            return { videos: [], playlists: [] };
          }
          
          const result = await AutocompleteDataLoader.loadData();
          return { videos: result.videos || [], playlists: result.playlists || [] };
        }

        document.addEventListener('DOMContentLoaded', async function() {
            if (!supportsFS) {
                document.getElementById('subscriptionContent').innerHTML = 
                    '<div class="empty-state" style="color:red"><strong>File System API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge.</strong></div>';
                return;
            }

            showSkeletonLoading();
            showLoadingProgress();

            try {
                const db = await openDB();
                const savedHandle = await getFromDB(db, 'videoDirectoryHandle');
                
                if (savedHandle) {
                    const permission = await savedHandle.queryPermission();
                    if (permission === 'granted' || (permission === 'prompt' && await savedHandle.requestPermission() === 'granted')) {
                        videoDirectoryHandle = savedHandle;
                        window.videoDirectoryHandle = savedHandle;
                        
                        // Load danmaku counts BEFORE loading subscription data
                        if (window.DanmakuCounter) {
                          await window.DanmakuCounter.load(videoDirectoryHandle, null);
                        }
                        
                        await loadSubscriptionData();
                        await syncSubscriptions();
                        
                        try {
                          const searchInput = document.getElementById('headerSearchInput');
                          if (searchInput && typeof AutocompleteIntegration !== 'undefined' && typeof YouviAutocomplete !== 'undefined') {
                            const { videos, playlists } = await loadAllVideosAndPlaylistsForAutocomplete();
                            
                            const cacheValid = await window.autocompleteCache.isCacheValid(
                              videos.length,
                              playlists.length
                            );
                            
                            const autocompleteIntegration = new AutocompleteIntegration();
                            await autocompleteIntegration.init(searchInput, {
                              videoDirectoryHandle: videoDirectoryHandle,
                              allVideos: cacheValid ? [] : videos,
                              allPlaylists: cacheValid ? [] : playlists
                            });
                            if (DEBUG_MODE) console.log('[Autocomplete] ‚úÖ Initialized on youvi_subscriptions.html');
                          }
                        } catch (error) {
                          console.error('[Autocomplete] Failed to initialize:', error);
                        }
                    } else {
                        showNoDirectoryAccess();
                    }
                } else {
                    showSelectDirectoryFirst();
                }
            } catch (e) {
                console.error('Error accessing directory:', e);
                showError();
            }
            
            setupEventListeners();
            
            window.addEventListener('storage', function(e) {
                if (e.key === '8site_subscriptions') {
                    loadSubscriptionData();
                }
            });
            
            window.addEventListener('subscriptionChanged', function() {
                loadSubscriptionData();
            });

            window.addEventListener('beforeunload', function() {
                for (const [key, value] of avatarCache.entries()) {
                    if (value.url && value.url.startsWith('blob:')) {
                        URL.revokeObjectURL(value.url);
                    }
                }
                avatarCache.clear();
            });
            
            initializeBadgesState();
            setupBadgeToggle();

            setInterval(cleanupAvatarCache, 2 * 60 * 1000);

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    cleanupAvatarCache();
                }
            });
        });

        function showNoDirectoryAccess() {
            document.getElementById('subscriptionContent').innerHTML = 
                '<div class="empty-state"><strong>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ —Å –≤–∏–¥–µ–æ</strong></div>';
        }

        function showSelectDirectoryFirst() {
            document.getElementById('subscriptionContent').innerHTML = 
                '<div class="empty-state"><strong>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –≤–∏–¥–µ–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</strong></div>';
        }

        function showError() {
            document.getElementById('subscriptionContent').innerHTML = 
                '<div class="empty-state" style="color:red"><strong>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ</strong></div>';
        }

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('8SiteDB', 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('handles')) {
                        db.createObjectStore('handles');
                    }
                    if (!db.objectStoreNames.contains('subscriptions')) {
                        db.createObjectStore('subscriptions');
                    }
                    if (!db.objectStoreNames.contains('videos')) {
                        db.createObjectStore('videos', { keyPath: 'name' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getFromDBGeneric(storeName, key) {
            if (!db || !storeName || !key || typeof key !== 'string' || key.length === 0) {
                console.warn('Invalid parameters for getFromDBGeneric:', { hasDB: !!db, storeName, key, keyType: typeof key });
                return null;
            }
            
            try {
                if (!db.objectStoreNames.contains(storeName)) {
                    console.warn('Store does not exist:', storeName);
                    return null;
                }
                
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return new Promise((resolve) => {
                    const r = store.get(key);
                    r.onsuccess = () => resolve(r.result);
                    r.onerror = (e) => {
                        console.warn('IndexedDB getFromDBGeneric error:', e);
                        resolve(null);
                    };
                });
            } catch (e) {
                console.warn('Failed to create transaction for store/key:', storeName, key, e);
                return null;
            }
        }

        async function getFromDB(db, key) {
            const storeName = key === 'subscriptions' ? 'subscriptions' : (key === 'videoDirectoryHandle' ? 'handles' : 'videos');
            
            if (!db.objectStoreNames.contains(storeName)) {
                return null;
            }
            
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            return new Promise((resolve) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        async function saveToDB(db, storeName, key, value) {
            if (!db.objectStoreNames.contains(storeName)) {
                if (DEBUG_MODE) console.warn(`Store '${storeName}' does not exist`);
                return;
            }
            
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            await store.put(value, key);
            
            if (storeName === 'subscriptions' && key === 'subscriptions') {
                await saveSubscriptionsToFile(value);
            }
        }

        async function ensureSubscriptionsDir() {
            try {
                if (!videoDirectoryHandle) return null;
                return videoDirectoryHandle;
            } catch (e) { return null; }
        }

        async function saveSubscriptionsToFile(subscriptions) {
            try {
                if (!videoDirectoryHandle) return;
                const dir = await ensureSubscriptionsDir();
                if (!dir) throw new Error('Cannot access video directory');
                const fileHandle = await dir.getFileHandle('.subscriptions.json', { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(subscriptions, null, 2));
                await writable.close();
                if (DEBUG_MODE) console.log('Subscriptions saved to .subscriptions.json');
                
                localStorage.setItem('8site_subscriptions', JSON.stringify(subscriptions));
                
                window.dispatchEvent(new CustomEvent('subscriptionChanged'));
            } catch (e) {
                console.error('Error saving subscriptions to .subscriptions:', e);
            }
        }

        async function loadSubscriptionsFromFile() {
            try {
                const localSubscriptions = localStorage.getItem('8site_subscriptions');
                if (localSubscriptions) {
                    return JSON.parse(localSubscriptions);
                }
                
                if (!videoDirectoryHandle) return null;
                const dir = await ensureSubscriptionsDir();
                if (!dir) return null;
                const fileHandle = await dir.getFileHandle('.subscriptions.json');
                const file = await fileHandle.getFile();
                const text = await file.text();
                const fileSubscriptions = JSON.parse(text);
                
                localStorage.setItem('8site_subscriptions', JSON.stringify(fileSubscriptions));
                return fileSubscriptions;
            } catch (e) {
                if (DEBUG_MODE) console.log('No subscriptions found in .subscriptions.json, using default');
                return null;
            }
        }

        async function syncSubscriptions() {
            try {
                const db = await openDB();
                const fileSubscriptions = await loadSubscriptionsFromFile();
                const dbSubscriptions = await getFromDB(db, 'subscriptions');
                
                if (fileSubscriptions && !dbSubscriptions) {
                    await saveToDB(db, 'subscriptions', 'subscriptions', fileSubscriptions);
                    if (DEBUG_MODE) console.log('Synced subscriptions from file to DB');
                }
                else if (dbSubscriptions && !fileSubscriptions) {
                    await saveSubscriptionsToFile(dbSubscriptions);
                    if (DEBUG_MODE) console.log('Synced subscriptions from DB to file');
                }
                else if (fileSubscriptions && dbSubscriptions && 
                         JSON.stringify(fileSubscriptions) !== JSON.stringify(dbSubscriptions)) {
                    await saveToDB(db, 'subscriptions', 'subscriptions', fileSubscriptions);
                    if (DEBUG_MODE) console.log('Synced subscriptions - file data used as source of truth');
                }
            } catch (e) {
                console.error('Error syncing subscriptions:', e);
            }
        }

        async function loadSubscriptionData() {
            if (!videoDirectoryHandle) return;
            
            const startTime = performance.now();
            if (DEBUG_MODE) console.log('‚úÖ Starting progressive loadSubscriptionData...');
            
            allVideos = [];
            subscribedChannels = [];
            
            try {
                const db = await openDB();
                let savedSubscriptions = await loadSubscriptionsFromFile();
                if (!savedSubscriptions) {
                    savedSubscriptions = await getFromDB(db, 'subscriptions');
                }
                subscribedChannels = Array.isArray(savedSubscriptions) ? savedSubscriptions : [];
                
                if (subscribedChannels.length === 0) {
                    showNoSubscriptions();
                    return;
                }
                
                updateLoadingProgress(10);
                
                let cachedVideos = await getAllVideosFromDB();
                if (DEBUG_MODE) console.log(`‚úÖ Loaded ${cachedVideos.length} videos from cache in ${Math.round(performance.now() - startTime)}ms`);
                
                if (!Array.isArray(cachedVideos)) {
                    console.warn('cachedVideos is not an array, converting to empty array');
                    cachedVideos = [];
                }
                
                const videoMap = new Map(cachedVideos.map(v => [v.name, v]));
                const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.m4v'];
                
                updateLoadingProgress(20);
                
                if (cachedVideos.length > 0) {
                    allVideos = cachedVideos.filter(video => {
                        return subscribedChannels.some(channelName => {
                            return (video.tags || []).some(tag => tag === `${channelName} (–∫–∞)`) || video.channelName === channelName;
                        });
                    }).map(video => ({
                        ...video,
                        handle: null,
                        file: null,
                        dirHandle: null
                    }));
                    
                    allVideos.sort((a, b) => (b.created || 0) - (a.created || 0));
                    
                    if (DEBUG_MODE) console.log(`‚úÖ ${allVideos.length} subscription videos ready for display from cache`);
                    updateLoadingProgress(50);
                    
                    renderSubscribedChannelsList();
                    setFeedMode('grid');
                    filterVideos();
                    hideSkeletonLoading();
                    initialLoadComplete = true;
                    
                    updateLoadingProgress(70);
                    
                    if (DEBUG_MODE) console.log('üîÑ Starting background scan to attach file handles for previews...');
                    
                    setTimeout(async () => {
                        const scanStart = performance.now();
                        const tempVideos = [];
                        
                        async function attachHandles(dir, path = '') {
                            const entries = [];
                            try {
                                for await (const [name, handle] of dir.entries()) {
                                    entries.push({ name, handle });
                                }
                            } catch (e) {
                                return;
                            }
                            
                            for (let i = 0; i < entries.length; i += BATCH_SIZE) {
                                const batch = entries.slice(i, i + BATCH_SIZE);
                                if (i > 0) await new Promise(r => setTimeout(r, 5));
                                
                                await Promise.all(batch.map(async ({ name, handle }) => {
                                    if (handle.kind === 'file') {
                                        const isVideo = videoExtensions.some(ext => name.toLowerCase().endsWith(ext));
                                        if (isVideo) {
                                            try {
                                                const file = await handle.getFile();
                                                const cachedVideo = videoMap.get(name);
                                                
                                                if (cachedVideo) {
                                                    tempVideos.push({
                                                        ...cachedVideo,
                                                        handle: handle,
                                                        file: file,
                                                        dirHandle: dir
                                                    });
                                                } else {
                                                    const metadata = await getVideoMetadata(dir, name);
                                                    const videoData = {
                                                        name,
                                                        size: file.size,
                                                        modified: file.lastModified,
                                                        created: metadata.created || file.lastModified,
                                                        views: metadata.views || 0,
                                                        likes: metadata.likes || 0,
                                                        dislikes: metadata.dislikes || 0,
                                                        tags: metadata.tags || [],
                                                        duration: metadata.duration || '0:00',
                                                        quality: metadata.quality || getVideoQuality({ file, size: file.size }),
                                                        handle: handle,
                                                        file: file,
                                                        dirHandle: dir,
                                                        channelName: null
                                                    };
                                                    
                                                    const channelTags = (metadata.tags || []).filter(t => t.includes('(–∫–∞)'));
                                                    if (channelTags.length > 0) {
                                                        videoData.channelName = channelTags[0].replace(' (–∫–∞)', '');
                                                    }
                                                    
                                                    tempVideos.push(videoData);
                                                    await saveVideoToDB(videoData);
                                                }
                                            } catch (e) { }
                                        }
                                    } else if (handle.kind === 'directory' && !name.startsWith('.')) {
                                        await attachHandles(handle, path + '/' + name);
                                    }
                                }));
                            }
                        }
                        
                        await attachHandles(videoDirectoryHandle);
                        
                        const freshVideos = tempVideos.filter(video => {
                            return subscribedChannels.some(channelName => {
                                return (video.tags || []).some(tag => tag === `${channelName} (–∫–∞)`) || video.channelName === channelName;
                            });
                        });
                        
                        allVideos = freshVideos.sort((a, b) => (b.created || 0) - (a.created || 0));
                        
                        if (DEBUG_MODE) console.log(`‚úÖ Background scan completed in ${Math.round(performance.now() - scanStart)}ms`);
                        if (DEBUG_MODE) console.log(`üìä ${allVideos.length} videos now have file handles for previews`);
                        
                        filterVideos();
                        localStorage.setItem('lastSubscriptionScan', Date.now().toString());
                    }, 100);
                    
                    updateLoadingProgress(100);
                    hideLoadingProgress();
                    
                } else {
                    if (DEBUG_MODE) console.log('üìÇ No cache found, starting full scan...');
                    if (DEBUG_MODE) console.log('üìÇ Subscribed channels:', subscribedChannels);
                    
                    await collectAllVideoMetadataOptimizedBatched(videoDirectoryHandle, subscribedChannels, videoMap, videoExtensions);
                    
                    if (DEBUG_MODE) console.log(`üìÇ Scan complete, videoMap has ${videoMap.size} videos`);
                    
                    const allMapVideos = Array.from(videoMap.values());
                    if (DEBUG_MODE) console.log(`üìÇ All videos from map: ${allMapVideos.length}`);
                    
                    allVideos = allMapVideos.filter(video => {
                        const isSubscribed = subscribedChannels.some(channelName => {
                            return (video.tags || []).some(tag => tag === `${channelName} (–∫–∞)`) || video.channelName === channelName;
                        });
                        return isSubscribed;
                    }).map(video => ({
                        ...video,
                        file: video.file,
                        handle: video.handle,
                        dirHandle: video.dirHandle
                    }));
                    
                    allVideos.sort((a, b) => (b.created || 0) - (a.created || 0));
                    localStorage.setItem('lastSubscriptionScan', Date.now().toString());
                    
                    if (DEBUG_MODE) console.log(`‚úÖ Initial scan completed: ${allVideos.length} subscription videos from ${allMapVideos.length} total`);
                    
                    renderSubscribedChannelsList();
                    setFeedMode('grid');
                    filterVideos();
                    hideSkeletonLoading();
                    hideLoadingProgress();
                }

                document.querySelectorAll('#channelAvatarsBar .channel-avatar-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                const videosGrid = document.getElementById('videosGrid');
                if (videosGrid) {
                    videosGrid.classList.add('grid-5');
                }
                
                if (DEBUG_MODE) console.log(`‚úÖ loadSubscriptionData completed in ${Math.round(performance.now() - startTime)}ms`);
                
            } catch (e) {
                console.error('Error loading subscription data:', e);
                hideLoadingProgress();
                showNoSubscriptions();
            }
        }

        function showNoSubscriptions() {
            const content = document.getElementById('subscriptionContent');
            if (content) {
                content.innerHTML = `
                    <div class="no-subscriptions">
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</h3>
                        <p>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ –≤–∏–¥–µ–æ</p>
                        <a href="youvi_ch_list.html" class="browse-channels-btn">–û–±–∑–æ—Ä –∫–∞–Ω–∞–ª–æ–≤</a>
                    </div>
                `;
            }
        }

        async function readJSONFile(dirHandle, name, defaultValue = null) {
            try {
                const fileHandle = await dirHandle.getFileHandle(name);
                const file = await fileHandle.getFile();
                const text = await file.text();
                return JSON.parse(text);
            } catch (e) {
                return defaultValue;
            }
        }

        async function loadImageFile(dirHandle, name) {
            try {
                const fileHandle = await dirHandle.getFileHandle(name);
                const file = await fileHandle.getFile();
                return URL.createObjectURL(file);
            } catch (e) {
                return null;
            }
        }


        async function getVideoMetadata(dirHandle, name) {
            try {
                const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
                const metaname = name + '.meta.json';
                const fileHandle = await metaDir.getFileHandle(metaname);
                const file = await fileHandle.getFile();
                const text = await file.text();
                const metadata = JSON.parse(text);
                metadata.name = name;
                return metadata;
            } catch (e) {
                return {
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    tags: [],
                    created: Date.now(),
                    name: name
                };
            }
        }

        async function saveVideoMetadata(dirHandle, fileName, metadata) {
          try {
            const existingMeta = await getVideoMetadata(dirHandle, fileName);
            const safeMeta = {
              ...existingMeta,
              ...metadata,
              views: Math.max(existingMeta.views || 0, metadata.views || 0),
              quality: metadata.quality || existingMeta.quality,
              tags: metadata.tags || existingMeta.tags || []
            };
            
            const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
            const metaFileName = fileName + '.meta.json';
            await writeJSONFile(metaDir, metaFileName, safeMeta);
          } catch (e) {
            console.error('Error saving video metadata:', e);
          }
        }

        async function writeJSONFile(dirHandle, fileName, data) {
          const fh = await dirHandle.getFileHandle(fileName, { create: true });
          const w = await fh.createWritable();
          await w.write(JSON.stringify(data, null, 2));
          await w.close();
        }

        async function collectAllVideoMetadataOptimizedBatched(dirHandle, subscribedChannels, videoMap, videoExtensions) {
            const videosToSave = [];
            let processedCount = 0;
            if (DEBUG_MODE) console.log('üîç Starting batched scan of directory...');
            
            async function scanDirectory(dir, path = '') {
                const entries = [];
                try {
                    for await (const [name, handle] of dir.entries()) {
                        entries.push({ name, handle });
                    }
                } catch (e) {
                    console.error('Error reading directory:', path, e);
                    return;
                }
                
                entries.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
                
                for (let i = 0; i < entries.length; i += BATCH_SIZE) {
                    const batch = entries.slice(i, i + BATCH_SIZE);
                    
                    if (i > 0) {
                        await new Promise(resolve => setTimeout(resolve, 5));
                    }
                    
                    await Promise.all(batch.map(async ({ name, handle }) => {
                        if (handle.kind === 'file') {
                            const isVideo = videoExtensions.some(ext => name.toLowerCase().endsWith(ext));
                            if (isVideo) {
                                try {
                                    let cachedVideo = videoMap.get(name);
                                    const file = await handle.getFile();
                                    
                                    if (cachedVideo && cachedVideo.modified === file.lastModified) {
                                        cachedVideo.file = file;
                                        cachedVideo.handle = handle;
                                        cachedVideo.dirHandle = dir;
                                        videoMap.set(name, cachedVideo);
                                        processedCount++;
                                        return;
                                    }
                                    
                                    const metadata = await getVideoMetadata(dir, name);
                                    const videoData = {
                                        name: name,
                                        size: file.size,
                                        modified: file.lastModified,
                                        created: metadata.created || file.lastModified,
                                        views: metadata.views || 0,
                                        likes: metadata.likes || 0,
                                        dislikes: metadata.dislikes || 0,
                                        tags: metadata.tags || [],
                                        preview: metadata.preview || null,
                                        duration: metadata.duration || '0:00',
                                        quality: metadata.quality || getVideoQuality({ file: file, size: file.size }),
                                        handle: handle,
                                        file: file,
                                        dirHandle: dir,
                                        channelName: null
                                    };
                                    
                                    const channelTags = (metadata.tags || []).filter(t => t.includes('(–∫–∞)'));
                                    if (channelTags.length > 0) {
                                        videoData.channelName = channelTags[0].replace(' (–∫–∞)', '');
                                    }
                                    
                                    videosToSave.push(videoData);
                                    videoMap.set(name, videoData);
                                    processedCount++;
                                    
                                    if (videosToSave.length >= BATCH_SIZE) {
                                        await Promise.all(videosToSave.map(v => saveVideoToDB(v)));
                                        videosToSave.length = 0;
                                    }
                                } catch (e) {
                                    console.warn('Cannot access file:', name, e);
                                }
                            }
                        } else if (handle.kind === 'directory' && !name.startsWith('.')) {
                            await scanDirectory(handle, path + '/' + name);
                        }
                    }));
                }
            }
            
            await scanDirectory(dirHandle);
            
            if (videosToSave.length > 0) {
                if (DEBUG_MODE) console.log(`üíæ Saving final batch of ${videosToSave.length} videos...`);
                await Promise.all(videosToSave.map(v => saveVideoToDB(v)));
            }
            
            if (DEBUG_MODE) console.log(`‚úÖ Batched scan completed: ${processedCount} videos processed, videoMap size: ${videoMap.size}`);
        }
        
        async function collectAllVideoMetadataOptimized(dirHandle, subscribedChannels, videoMap, videoExtensions) {
            return collectAllVideoMetadataOptimizedBatched(dirHandle, subscribedChannels, videoMap, videoExtensions);
        }

        async function getAllVideosFromDB() {
            try {
                const db = await openDB();
                if (!db.objectStoreNames.contains('videos')) {
                    if (DEBUG_MODE) console.log('Videos store does not exist yet, returning empty array');
                    return [];
                }
                
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('videos', 'readonly');
                    const store = tx.objectStore('videos');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const result = request.result;
                        if (DEBUG_MODE) console.log('Retrieved videos from IndexedDB:', result?.length || 0, 'videos');
                        resolve(Array.isArray(result) ? result : []);
                    };
                    
                    request.onerror = () => {
                        console.error('Error in getAll request:', request.error);
                        resolve([]);
                    };
                });
            } catch (e) {
                console.error("Error fetching videos from IndexedDB:", e);
                return [];
            }
        }

        function renderSubscribedChannelsList() {
            const sidebarContainer = document.getElementById('subscribedChannelsList');
            if (sidebarContainer) {
                sidebarContainer.innerHTML = '';

                subscribedChannels.forEach((channelName, index) => {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'sidebar-item';
                    link.dataset.channel = channelName;
                    link.id = `sidebar_channel_${index}`;
                    link.style.display = 'flex';
                    link.style.alignItems = 'center';
                    link.style.gap = '8px';

                    const avatar = document.createElement('div');
                    avatar.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border-radius: 0;
                        background: #ff69b4;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 10px;
                        flex-shrink: 0;
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                    `;
                    avatar.textContent = channelName.charAt(0).toUpperCase();

                    const textSpan = document.createElement('span');
                    textSpan.textContent = channelName;
                    textSpan.style.overflow = 'hidden';
                    textSpan.style.textOverflow = 'ellipsis';
                    textSpan.style.whiteSpace = 'nowrap';

                    link.appendChild(avatar);
                    link.appendChild(textSpan);

                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
                    });

                    if (videoDirectoryHandle) {
                        loadChannelAvatar(channelName, videoDirectoryHandle).then(avatarUrl => {
                            if (avatarUrl) {
                                avatar.style.backgroundImage = `url(${avatarUrl})`;
                                avatar.textContent = '';
                            }
                        }).catch(() => {
                            if (DEBUG_MODE) console.log(`Using initial for sidebar channel: ${channelName}`);
                        });
                    }

                    sidebarContainer.appendChild(link);
                });
            }

            const avatarsContainer = document.getElementById('channelAvatarsBar');
            if (avatarsContainer) {
                avatarsContainer.style.display = 'flex';

                const existingAvatars = avatarsContainer.querySelectorAll('.channel-avatar');
                existingAvatars.forEach(avatar => avatar.remove());

                subscribedChannels.forEach((channelName, index) => {
                    const avatarBtn = document.createElement('div');
                    avatarBtn.className = 'channel-avatar-btn channel-avatar';
                    avatarBtn.textContent = channelName.charAt(0).toUpperCase();
                    avatarBtn.dataset.channel = channelName;
                    avatarBtn.id = `avatar_channel_${index}`;
                    avatarBtn.title = channelName;

                    avatarBtn.addEventListener('click', (e) => {
                        filterByChannel(channelName, avatarBtn.id);
                    });

                    if (videoDirectoryHandle) {
                        loadChannelAvatar(channelName, videoDirectoryHandle).then(avatarUrl => {
                            if (avatarUrl) {
                                avatarBtn.style.backgroundImage = `url(${avatarUrl})`;
                                avatarBtn.textContent = '';
                            }
                        }).catch(() => {
                            if (DEBUG_MODE) console.log(`Using initial for channel: ${channelName}`);
                        });
                    }

                    avatarsContainer.appendChild(avatarBtn);
                });
            }
        }

        function filterByChannel(channelName, elementId) {
            currentSearchQuery = '';
            currentPage = 1;

            const searchInput = document.getElementById('headerSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            const clickedElement = document.getElementById(elementId);
            const isAlreadyActive = clickedElement && clickedElement.classList.contains('active');

            if (isAlreadyActive) {
                currentChannelName = null;

                document.querySelectorAll('#subscribedChannelsList .sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelectorAll('#channelAvatarsBar .channel-avatar-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                filteredVideos = allVideos.map(video => {
                    const videoCopy = { ...video };
                    if (!videoCopy.channelName && videoCopy.tags) {
                        const channelTags = videoCopy.tags.filter(t => t.includes('(–∫–∞)'));
                        if (channelTags.length > 0) {
                            videoCopy.channelName = channelTags[0].replace(' (–∫–∞)', '');
                        }
                    }
                    videoCopy.file = video.file;
                    videoCopy.handle = video.handle;
                    videoCopy.dirHandle = video.dirHandle;
                    videoCopy.views = video.views || 0;
                    videoCopy.created = video.created || video.modified || 0;
                    videoCopy.quality = video.quality || getVideoQuality(video);
                    return videoCopy;
                });

                updateSectionTitle(null);
            } else {
                currentChannelName = channelName;

                document.querySelectorAll('#subscribedChannelsList .sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });

                document.querySelectorAll('#channelAvatarsBar .channel-avatar-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                if (clickedElement) {
                    clickedElement.classList.add('active');
                }

                filteredVideos = allVideos.filter(video => {
                    const hasChannelName = video.channelName === channelName;
                    const hasChannelTag = (video.tags || []).some(tag => tag === `${channelName} (–∫–∞)`);
                    return hasChannelName || hasChannelTag;
                }).map(video => {
                    const videoCopy = { ...video };
                    if (!videoCopy.channelName && videoCopy.tags) {
                        const channelTags = videoCopy.tags.filter(t => t.includes('(–∫–∞)'));
                        if (channelTags.length > 0) {
                            videoCopy.channelName = channelTags[0].replace(' (–∫–∞)', '');
                        }
                    }
                    const completeVideo = allVideos.find(av => av.name === video.name);
                    if (completeVideo) {
                        Object.assign(videoCopy, {
                            file: completeVideo.file,
                            handle: completeVideo.handle,
                            dirHandle: completeVideo.dirHandle,
                            views: completeVideo.views || videoCopy.views || 0,
                            created: completeVideo.created || videoCopy.created || completeVideo.modified || 0,
                            quality: completeVideo.quality || videoCopy.quality || getVideoQuality(videoCopy)
                        });
                    }
                    return videoCopy;
                });

                updateSectionTitle(channelName);
            }

            renderVideos();
        }



        function setupEventListeners() {
            const searchBtn = document.getElementById('headerSearchBtn');
            const searchInput = document.getElementById('headerSearchInput');

            if (searchBtn) {
                searchBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const q = (searchInput?.value||'').trim();
                    const params = new URLSearchParams();
                    if (q) params.set('q', q);
                    params.set('type', 'channels');
                    window.location.href = `youvi_search.html?${params.toString()}`;
                });
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const q = (e.target.value||'').trim();
                        const params = new URLSearchParams();
                        if (q) params.set('q', q);
                        params.set('type', 'channels');
                        window.location.href = `youvi_search.html?${params.toString()}`;
                    }
                });
            }



            const gridModeBtn = document.getElementById('gridModeBtn');
            const listModeBtn = document.getElementById('listModeBtn');

            if (gridModeBtn) {
                gridModeBtn.addEventListener('click', () => setFeedMode('grid'));
            }

            if (listModeBtn) {
                listModeBtn.addEventListener('click', () => setFeedMode('list'));
            }

            document.getElementById('sortDate').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveSort('date');
            });

            document.getElementById('sortPopular').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveSort('popular');
            });

            document.getElementById('sortViews').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveSort('views');
            });

            document.getElementById('sortAlphabetical').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveSort('alphabetical');
            });

            const openChannelLink = document.getElementById('openChannelLink');
            if (openChannelLink) {
                openChannelLink.addEventListener('click', (e) => {
                    if (currentChannelName) {
                        window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(currentChannelName)}`;
                    }
                });
            }
        }

        function setTimeFilter(filter) {
            currentTimeFilter = filter;
            currentPage = 1;
            
            document.querySelectorAll('.subscription-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
            
            document.querySelectorAll('#subscribedChannelsList .sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            filterVideos();
        }

        function setActiveSort(sortType) {
            currentSort = sortType;
            currentPage = 1;
            
            document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sort${sortType.charAt(0).toUpperCase() + sortType.slice(1)}`).classList.add('active');

            renderVideos();
        }

        function searchVideos() {
            const searchInput = document.getElementById('headerSearchInput');
            const searchQuery = searchInput.value.trim();
            
            if (searchQuery) {
                currentSearchQuery = searchQuery;
                currentPage = 1;
                filterVideos();
            }
        }

        function filterVideos() {
            const term = currentSearchQuery.toLowerCase();
            const now = Date.now();
            const oneDayMs = 24 * 60 * 60 * 1000;
            const oneWeekMs = 7 * oneDayMs;
            const oneMonthMs = 30 * oneDayMs;

            filteredVideos = allVideos.filter(video => {
                if (currentTimeFilter !== 'all') {
                    const videoAge = now - (video.created || 0);
                    switch (currentTimeFilter) {
                        case 'today':
                            if (videoAge > oneDayMs) return false;
                            break;
                        case 'week':
                            if (videoAge > oneWeekMs) return false;
                            break;
                        case 'month':
                            if (videoAge > oneMonthMs) return false;
                            break;
                        case 'unwatched':
                            if (video.watched) return false;
                            break;
                    }
                }

                if (term) {
                    const titleMatch = (video.title || video.name || '').toLowerCase().includes(term);
                    const channelMatch = (video.channelName || '').toLowerCase().includes(term);
                    const tagMatch = video.tags && video.tags.some(tag =>
                        tag.toLowerCase().includes(term)
                    );
                    if (!titleMatch && !channelMatch && !tagMatch) return false;
                }

                return true;
            });

            currentPage = 1;
            renderVideos();

            updateSectionTitle(currentChannelName);
        }

        function setFeedMode(mode) {
            currentFeedMode = mode;

            document.querySelectorAll('.feed-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(mode === 'grid' ? 'gridModeBtn' : 'listModeBtn').classList.add('active');

            const avatarsContainer = document.getElementById('channelAvatarsBar');
            if (avatarsContainer) {
                avatarsContainer.style.display = 'flex';
            }

            const previousMode = document.getElementById('gridModeBtn').classList.contains('active') ? 'grid' : 'list';
            if (previousMode !== mode) {
                if (videoLazyLoader && typeof videoLazyLoader.cleanup === 'function') {
                    videoLazyLoader.cleanup();
                }
                videoLazyLoader = new VideoLazyLoader();
                if (DEBUG_MODE) console.log('Recreated VideoLazyLoader for mode switch:', previousMode, '->', mode);
            }

            renderVideos();
            updateSectionTitle(currentChannelName);
        }

        function groupVideosByDate(videos) {
            const groups = {};
            videos.forEach(video => {
                const date = new Date(video.created || video.modified || 0);
                const key = [date.getFullYear(), date.getMonth() + 1, date.getDate()].join('-');

                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(video);
            });

            return Object.entries(groups)
                .sort(([a], [b]) => {
                    const [yearA, monthA, dayA] = a.split('-').map(n => parseInt(n, 10));
                    const [yearB, monthB, dayB] = b.split('-').map(n => parseInt(n, 10));

                    if (yearA !== yearB) return yearB - yearA;
                    if (monthA !== monthB) return monthB - monthA;
                    return dayB - dayA;
                })
                .map(([key, videos]) => ({ key, videos }));
        }

        function formatGroupDate(key) {
            const [year, month, day] = key.split('-').map(n => parseInt(n, 10));
            const date = new Date(year, month - 1, day);
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return '–°–µ–≥–æ–¥–Ω—è';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return '–í—á–µ—Ä–∞';
            } else {
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            }
        }

        function renderVideosList(sortedVideos) {
            const container = document.getElementById('subscriptionContent');

            if (sortedVideos.length === 0) {
                container.innerHTML = '<div class="empty-state">–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                renderPagination(0, 0);
                return;
            }

            const totalPages = Math.ceil(sortedVideos.length / videosPerPage);
            const startIndex = (currentPage - 1) * videosPerPage;
            const endIndex = startIndex + videosPerPage;
            const pageVideos = sortedVideos.slice(startIndex, endIndex);

            container.innerHTML = '<div class="chronological-list" id="chronologicalList"></div>';
            const list = document.getElementById('chronologicalList');

            for (const v of pageVideos) {
                const card = document.createElement('div');
                card.className = 'video-card';
                const link = document.createElement('a');
                link.className = 'video-thumbnail';
                const url = window.VideoID 
                    ? window.VideoID.buildVideoUrl(v.name)
                    : `youvi_video.html?name=${encodeURIComponent(v.name)}`;
                link.href = url;

                const badges = [];
                const q = getVideoQuality(v);
                if (q) { badges.push(`<div class="video-quality" data-quality="${q}">${q}</div>`); }
                if (v.created && (Date.now() - v.created) < 24 * 60 * 60 * 1000) { badges.push(`<div class="video-new">–ù–æ–≤–∏–Ω–∫–∞</div>`); }
                link.innerHTML = `<div class="video-duration">...</div>${badges.join('')}<div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#111;font-size:10px;text-align:center;padding:5px;">${escapeHtml(getFileNameWithoutExtension(v.name))}</div>`;

                const info = document.createElement('div');
                info.className = 'video-info';

                const channelTags = (v.tags || []).filter(t => t && t.includes('(–∫–∞)'));
                let primaryChannel = '';
                if (channelTags.length > 0) { primaryChannel = channelTags[0].replace(' (–∫–∞)', ''); }

                let channelRow = '';
                if (primaryChannel) {
                    channelRow = `<div class="video-channel-row"><span class="channel-avatar-mini" data-channel="${escapeHtml(primaryChannel)}">${escapeHtml(primaryChannel.charAt(0).toUpperCase())}</span><a href="youvi_ch_view.html?channel=${encodeURIComponent(primaryChannel)}" class="playlist-channel-link" style="color:#ff69b4;text-decoration:none;font-weight:500;">${escapeHtml(primaryChannel)}</a></div>`;
                    
                    if (videoDirectoryHandle) {
                        loadChannelAvatar(primaryChannel, videoDirectoryHandle).then(avatarUrl => {
                            if (avatarUrl) {
                                const el = info.querySelector('.channel-avatar-mini[data-channel="' + CSS.escape(primaryChannel) + '"]');
                                if (el) { el.style.backgroundImage = `url(${avatarUrl})`; el.textContent = ''; }
                            }
                        }).catch(() => {});
                    }
                }

                const createdDateObj = v.created ? new Date(v.created) : null;
                const dateStr = createdDateObj ? `${String(createdDateObj.getDate()).padStart(2,'0')}/${String(createdDateObj.getMonth()+1).padStart(2,'0')}/${createdDateObj.getFullYear()}` : '';
                const viewsCount = typeof v.views === 'number' ? v.views : 0;
                const danmakuCount = v.danmakuCount || (window.DanmakuCounter ? window.DanmakuCounter.get(v.name) : 0);
                const viewsSvg = `<svg width="12" height="12" viewBox="0 0 24 24" style="display:inline;vertical-align:-2px;"><path fill="#888" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
                const danmakuSvg = `<svg width="12" height="12" viewBox="0 0 24 24" style="display:inline;vertical-align:-2px;"><path fill="#888" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>`;
                const statsLine = `<div class="video-meta-line" style="color:#888;font-size:12px;">${dateStr ? dateStr + ' ‚Ä¢ ' : ''}${viewsSvg} ${viewsCount.toLocaleString()} ‚Ä¢ ${danmakuSvg} ${danmakuCount}</div>`;

                const descText = Array.isArray(v.tags) ? v.tags.filter(t => !t.includes('(–∫–∞)')).join(', ') : '';
                const descLine = descText ? `<div class="video-desc">${escapeHtml(descText)}</div>` : '';

                info.innerHTML = `<div class="video-card-title"><a href="${url}" class="video-title-link" style="color:inherit;text-decoration:none;" title="${escapeHtml(getFileNameWithoutExtension(v.name))}">${escapeHtml(getFileNameWithoutExtension(v.name))}</a></div>${statsLine}${descLine}${channelRow}`;
                card.appendChild(link);
                card.appendChild(info);
                list.appendChild(card);

                if (v.file && v.handle && typeof addHoverPreview === 'function') {
                    const videoData = { ...v, file: v.file, handle: v.handle, dirHandle: v.dirHandle };
                    addHoverPreview(link, videoData);
                }

                if (v.file && v.handle) {
                    loadVideoPreviewImmediately(v, link);
                }
            }

            renderPagination(totalPages, sortedVideos.length);
        }



        function renderVideos() {
            const container = document.getElementById('subscriptionContent');
            if (!container) return;

            if (allVideos.length === 0) {
                container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>';
                return;
            }

            if (videoLazyLoader && typeof videoLazyLoader.cleanup === 'function') {
                videoLazyLoader.cleanup();
            }

            if (!videoLazyLoader || !videoLazyLoader.observer) {
                videoLazyLoader = new VideoLazyLoader();
            }

            const sortedVideos = [...filteredVideos];
            sortedVideos.sort((a, b) => {
                switch (currentSort) {
                    case 'date':
                        return (b.created || 0) - (a.created || 0);
                    case 'popular':
                        return (b.views || 0) - (a.views || 0);
                    case 'views':
                        return (b.views || 0) - (a.views || 0);
                    case 'alphabetical':
                        return (a.title || a.name || '').localeCompare(b.title || b.name || '');
                    default:
                        return 0;
                }
            });

            if (currentFeedMode === 'list') {
                renderVideosList(sortedVideos);
            } else {
                if (groupByChannel) {
                    renderVideosByChannel(sortedVideos);
                } else {
                    renderVideosGrid(sortedVideos);
                }
            }

            updateSectionTitle(currentChannelName);
        }

        function renderVideosGrid(sortedVideos) {
            const container = document.getElementById('subscriptionContent');
            
            if (sortedVideos.length === 0) {
                container.innerHTML = '<div class="empty-state">–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            const totalPages = Math.ceil(sortedVideos.length / videosPerPage);
            const startIndex = (currentPage - 1) * videosPerPage;
            const endIndex = startIndex + videosPerPage;
            const pageVideos = sortedVideos.slice(startIndex, endIndex);

            container.innerHTML = '<div class="video-grid" id="videosGrid"></div>';
            const grid = document.getElementById('videosGrid');

            if (typeof renderVideoGrid === 'function') {
                const preparedVideos = pageVideos.map(video => ({
                    ...video,
                    channel: video.channelName || (video.tags && video.tags.find(t => t.includes('(–∫–∞)'))?.replace(' (–∫–∞)', '')) || video.channel,
                    quality: video.quality || getVideoQuality(video)
                }));
                
                renderVideoGrid(grid, preparedVideos, YouViCardsPresets.subscription);
                
                setTimeout(() => {
                    if (typeof addHoverPreview === 'function') {
                        if (DEBUG_MODE) console.log('addHoverPreview function is available in main grid');
                        preparedVideos.forEach((video, index) => {
                            const card = grid.children[index];
                            if (card) {
                                const thumbnail = card.querySelector('.video-thumbnail');
                                const thumbnailLink = card.querySelector('a.video-thumbnail');
                                const videoLink = card.querySelector('a[href*="youvi_video.html"]');
                                const targetElement = thumbnailLink || videoLink || thumbnail;
                                
                                if (targetElement) {
                                    const videoData = {
                                        ...video,
                                        file: video.file,
                                        handle: video.handle,
                                        dirHandle: video.dirHandle
                                    };
                                    
                                    if (DEBUG_MODE) console.log(`Adding hover preview for video: ${video.name}`, {
                                        hasFile: !!videoData.file,
                                        hasHandle: !!videoData.handle,
                                        hasDirHandle: !!videoData.dirHandle,
                                        targetElement: targetElement.tagName + (targetElement.className ? '.' + targetElement.className : ''),
                                        targetHref: targetElement.href
                                    });
                                    
                                    addHoverPreview(targetElement, videoData);
                                } else {
                                    console.warn(`No thumbnail element found for card ${index}`, card.innerHTML);
                                }
                            }
                        });
                    } else {
                        console.warn('addHoverPreview function not available in main grid, previews disabled');
                    }
                }, 100);
                
                preparedVideos.forEach((video, index) => {
                    const card = grid.children[index];
                    if (card) {
                        const thumbnail = card.querySelector('.video-thumbnail');
                        if (thumbnail && videoLazyLoader) {
                            if (video.file && video.handle) {
                                videoLazyLoader.addVideo(video, thumbnail, 1);
                            } else {
                                const foundVideo = allVideos.find(av => av.name === video.name);
                                if (foundVideo && foundVideo.file && foundVideo.handle) {
                                    videoLazyLoader.addVideo(foundVideo, thumbnail, 1);
                                }
                            }
                        }
                    }
                });
            } else {
                console.error('renderVideoGrid function not found - cards module not loaded');
                grid.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã –∫–∞—Ä—Ç–æ—á–µ–∫</div>';
            }

            renderPagination(totalPages, sortedVideos.length);
        }

        function renderVideosByChannel(sortedVideos) {
            const container = document.getElementById('subscriptionContent');
            container.innerHTML = '';
            
            const videosByChannel = {};
            sortedVideos.forEach(video => {
                if (!videosByChannel[video.channelName]) {
                    videosByChannel[video.channelName] = [];
                }
                videosByChannel[video.channelName].push(video);
            });

            Object.entries(videosByChannel).forEach(([channelName, videos]) => {
                const channelSection = createChannelSection(channelName, videos);
                container.appendChild(channelSection);
            });
        }

        function createChannelSection(channelName, videos) {
            const section = document.createElement('div');
            section.className = 'channel-section';
            
            const header = document.createElement('div');
            header.className = 'channel-section-header';
            
            const avatar = document.createElement('div');
            avatar.className = 'channel-avatar-small';
            avatar.textContent = channelName.charAt(0).toUpperCase();

            if (videoDirectoryHandle) {
                loadChannelAvatar(channelName, videoDirectoryHandle).then(avatarUrl => {
                    if (avatarUrl) {
                        avatar.style.backgroundImage = `url(${avatarUrl})`;
                        avatar.textContent = '';
                    }
                }).catch(() => {
                });
            }
            
            const info = document.createElement('div');
            info.className = 'channel-section-info';
            
            const name = document.createElement('div');
            name.className = 'channel-section-name';
            name.innerHTML = `<a href="youvi_ch_view.html?channel=${encodeURIComponent(channelName)}">${escapeHtml(channelName)}</a>`;
            
            const stats = document.createElement('div');
            stats.className = 'channel-section-stats';
            stats.textContent = `${videos.length} –Ω–æ–≤—ã—Ö –≤–∏–¥–µ–æ`;
            
            const viewAllBtn = document.createElement('button');
            viewAllBtn.className = 'view-all-btn';
            viewAllBtn.textContent = '–í—Å–µ –≤–∏–¥–µ–æ';
            viewAllBtn.addEventListener('click', () => {
                window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
            });
            
            info.appendChild(name);
            info.appendChild(stats);
            
            header.appendChild(avatar);
            header.appendChild(info);
            header.appendChild(viewAllBtn);
            
            const grid = document.createElement('div');
            grid.className = 'video-grid';
            
            const channelVideos = videos.slice(0, 4);
            if (typeof renderVideoGrid === 'function') {
                const preparedVideos = channelVideos.map(video => ({
                    ...video,
                    channel: video.channelName || (video.tags && video.tags.find(t => t.includes('(–∫–∞)'))?.replace(' (–∫–∞)', '')) || video.channel,
                    quality: video.quality || getVideoQuality(video)
                }));
                
                renderVideoGrid(grid, preparedVideos, YouViCardsPresets.subscription);
                
                setTimeout(() => {
                    if (typeof addHoverPreview === 'function') {
                        if (DEBUG_MODE) console.log('addHoverPreview function is available');
                        preparedVideos.forEach((video, index) => {
                            const card = grid.children[index];
                            if (card) {
                                const thumbnail = card.querySelector('.video-thumbnail');
                                const thumbnailLink = card.querySelector('a.video-thumbnail');
                                const videoLink = card.querySelector('a[href*="youvi_video.html"]');
                                const targetElement = thumbnailLink || videoLink || thumbnail;
                                
                                if (targetElement) {
                                    const videoData = {
                                        ...video,
                                        file: video.file,
                                        handle: video.handle,
                                        dirHandle: video.dirHandle
                                    };
                                    
                                    if (DEBUG_MODE) console.log(`Adding hover preview for video: ${video.name}`, {
                                        hasFile: !!videoData.file,
                                        hasHandle: !!videoData.handle,
                                        hasDirHandle: !!videoData.dirHandle,
                                        targetElement: targetElement.tagName + (targetElement.className ? '.' + targetElement.className : ''),
                                        targetHref: targetElement.href
                                    });
                                    
                                    addHoverPreview(targetElement, videoData);
                                } else {
                                    console.warn(`No thumbnail element found for card ${index}`, card.innerHTML);
                                }
                            }
                        });
                    } else {
                        console.warn('addHoverPreview function not available, previews disabled');
                    }
                }, 100);
            } else {
                console.error('renderVideoGrid function not found');
            }
            
            section.appendChild(header);
            section.appendChild(grid);
            
            return section;
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));
            
            if (diffDays === 0) return i18n.t('dates.today') || 'Today';
            if (diffDays === 1) return i18n.t('dates.yesterday') || 'Yesterday';
            if (diffDays < 7) {
                const daysAgo = i18n.t('dates.daysAgo') || '{n} days ago';
                return daysAgo.replace('{n}', diffDays);
            }
            if (diffDays < 30) {
                const weeksAgo = i18n.t('dates.weeksAgo') || '{n} weeks ago';
                return weeksAgo.replace('{n}', Math.floor(diffDays / 7));
            }
            if (diffDays < 365) {
                const monthsAgo = i18n.t('dates.monthsAgo') || '{n} months ago';
                return monthsAgo.replace('{n}', Math.floor(diffDays / 30));
            }
            const yearsAgo = i18n.t('dates.yearsAgo') || '{n} years ago';
            return yearsAgo.replace('{n}', Math.floor(diffDays / 365));
        }

        function getViewsText(count) {
            const viewsWord = i18n.t('main.views') || 'views';
            return `${count.toLocaleString()} ${viewsWord}`;
        }

        function getVideoQuality(video) {
            if (video.quality) {
                return video.quality;
            }

            const name = video.name.toLowerCase();
            if (name.includes('4k') || name.includes('2160p') || name.includes('uhd')) {
                return '4K';
            } else if (name.includes('1080p') || name.includes('fhd')) {
                return '1080p';
            } else if (name.includes('720p') || name.includes('hd')) {
                return '720p';
            } else if (name.includes('480p') || name.includes('sd')) {
                return '480p';
            }

            const sizeInMB = video.size / (1024 * 1024);
            if (sizeInMB > 1000) return '4K';
            if (sizeInMB > 500) return '1080p';
            if (sizeInMB > 200) return '720p';
            if (sizeInMB > 50) return '480p';

            return 'SD';
        }

        function toggleVideoBadges() {
            const body = document.body;
            const isHidden = body.classList.contains('badges-hidden');
            
            if (isHidden) {
                body.classList.remove('badges-hidden');
                localStorage.setItem('youvi-badges-hidden', 'false');
            } else {
                body.classList.add('badges-hidden');
                localStorage.setItem('youvi-badges-hidden', 'true');
            }
        }

        function initBadgeVisibility() {
            const shouldHide = localStorage.getItem('youvi-badges-hidden') === 'true';
            if (shouldHide) {
                document.body.classList.add('badges-hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initBadgeVisibility();
        });

        function openVideo(video) {
            if (video && video.name) {
                const url = window.VideoID 
                    ? window.VideoID.buildVideoUrl(video.name)
                    : `youvi_video.html?name=${encodeURIComponent(video.name)}`;
                window.location.href = url;
            }
        }

        function renderPagination(totalPages, totalItems) {
            const container = document.getElementById('paginationContainer');
            if (!container) return;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const pagination = document.createElement('div');
            pagination.className = 'pagination';

            const info = document.createElement('div');
            info.className = 'pagination-info';
            const showingText = i18n.t('subscriptions.showing') || 'Showing';
            const ofText = i18n.t('pagination.of') || 'of';
            info.textContent = `${showingText} ${Math.min((currentPage - 1) * videosPerPage + 1, totalItems)}-${Math.min(currentPage * videosPerPage, totalItems)} ${ofText} ${totalItems}`;
            pagination.appendChild(info);

            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.textContent = i18n.t('pagination.previous') || '‚Äπ –ù–∞–∑–∞–¥';
                prevBtn.addEventListener('click', () => {
                    currentPage--;
                    renderVideos();
                });
                pagination.appendChild(prevBtn);
            }

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderVideos();
                });
                pagination.appendChild(pageBtn);
            }

            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.textContent = i18n.t('pagination.next') || '–í–ø–µ—Ä–µ–¥ ‚Ä∫';
                nextBtn.addEventListener('click', () => {
                    currentPage++;
                    renderVideos();
                });
                pagination.appendChild(nextBtn);
            }

            container.innerHTML = '';
            container.appendChild(pagination);
        }

        function updateSectionTitle(channelName = null) {
            const titleElement = document.querySelector('.section-title');
            const countElement = document.getElementById('videosCount');
            const openChannelLink = document.getElementById('openChannelLink');

            const baseTitle = i18n.t('subscriptions.title') || '–ü–æ–¥–ø–∏—Å–∫–∏';
            
            if (channelName) {
                titleElement.textContent = `${baseTitle}: ${channelName}`;
                if (openChannelLink) {
                    openChannelLink.style.display = 'inline';
                    openChannelLink.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
                    openChannelLink.textContent = i18n.t('subscriptions.openChannel') || '–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª';
                }
            } else {
                titleElement.textContent = baseTitle;
                if (openChannelLink) {
                    openChannelLink.style.display = 'none';
                }
            }

            if (countElement) {
                const totalVideos = allVideos.length;
                const filteredCount = filteredVideos.length;
                const videoWord = i18n.t('main.videos') || '–≤–∏–¥–µ–æ';
                const ofWord = i18n.t('pagination.of') || '–∏–∑';
                if (filteredCount === totalVideos) {
                    countElement.textContent = `${totalVideos} ${videoWord}`;
                } else {
                    countElement.textContent = `${filteredCount} ${ofWord} ${totalVideos} ${videoWord}`;
                }
            }
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text ?? '';
            return d.innerHTML;
        }

        function searchByTag(tag) {
            currentSearchQuery = tag;
            currentPage = 1;
            
            const searchInput = document.getElementById('headerSearchInput');
            if (searchInput) {
                searchInput.value = tag;
            }
            
            filterVideos();
        }

        async function getPreviewAndDuration(video){
            if (video._cachedPreview && video._cachedDuration) {
                if (DEBUG_MODE) console.log(`Using memory cache for: ${video.name}`);
                return { preview: video._cachedPreview, duration: video._cachedDuration };
            }

            if (DEBUG_MODE) console.log(`getPreviewAndDuration called for: ${video.name}`, {
                hasFile: !!video.file,
                hasHandle: !!video.handle,
                hasDirHandle: !!video.dirHandle
            });


            const dirHandle = video.dirHandle || videoDirectoryHandle;
            const meta = await getVideoMetadata(dirHandle, video.name);

            const fileChanged = meta.size !== video.file.size || meta.modified !== video.file.lastModified;

            if (meta.preview && meta.duration && !fileChanged) {
                if (DEBUG_MODE) console.log(`Using cached preview for: ${video.name}`);
                video._cachedPreview = meta.preview;
                video._cachedDuration = meta.duration;
                return { preview: meta.preview, duration: meta.duration };
            }

            try {
                if (!db) {
                    db = await openDB();
                }
                
                if (db.objectStoreNames.contains('videos')) {
                    const cachedVideo = await getFromDBGeneric('videos', video.name);
                    if (cachedVideo && cachedVideo.preview && !fileChanged) {
                        if (DEBUG_MODE) console.log(`Using IndexedDB (videos) cached preview for: ${video.name}`);
                    video._cachedPreview = cachedVideo.preview;
                    video._cachedDuration = cachedVideo.duration;
                    return { preview: cachedVideo.preview, duration: cachedVideo.duration };
                    }
                }
                
                if (video.name && typeof video.name === 'string' && video.name.length > 0) {
                    const oldCacheKey = 'preview_' + video.name;
                    const cachedPreview = await getFromDB(db, oldCacheKey);
                    if (cachedPreview && cachedPreview.preview && !fileChanged) {
                        if (DEBUG_MODE) console.log(`Using IndexedDB (handles) cached preview for: ${video.name}`);
                        video._cachedPreview = cachedPreview.preview;
                        video._cachedDuration = cachedPreview.duration || '0:00';
                        return { preview: cachedPreview.preview, duration: cachedPreview.duration || '0:00' };
                    }
                }
            } catch (e) {
                console.warn('Failed to get from IndexedDB cache:', e);
            }

            if (!video.file) {
                console.warn('No file available for video:', video.name);
                return { preview: '', duration: '0:00' };
            }

            return new Promise((resolve, reject) => {
                const el = document.createElement('video');
                el.muted = true;
                el.playsInline = true;
                el.preload = 'metadata';
                el.crossOrigin = 'anonymous';
                
                const url = URL.createObjectURL(video.file);
                
                const cleanup = () => {
                    URL.revokeObjectURL(url);
                    el.remove();
                };
                
                const timeout = setTimeout(() => {
                    cleanup();
                    console.warn(`Timeout generating preview for ${video.name}`);
                    resolve({ preview: null, duration: '0:00' });
                }, 10000);
                
                el.addEventListener('error', (e) => {
                    clearTimeout(timeout);
                    cleanup();
                    console.warn(`Video loading error for ${video.name}:`, e);
                    resolve({ preview: null, duration: '0:00' });
                }, { once: true });
                
                el.addEventListener('loadedmetadata', async () => {
                    try {
                        if (!isFinite(el.duration) || el.duration <= 0) {
                            clearTimeout(timeout);
                            cleanup();
                            console.warn(`Invalid duration for ${video.name}:`, el.duration);
                            resolve({ preview: null, duration: '0:00' });
                            return;
                        }
                        
                        const duration = formatDuration(el.duration);
                        el.currentTime = Math.max(0, el.duration / 2);
                        
                        el.addEventListener('seeked', async () => {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = 240; canvas.height = 140;
                                const ctx = canvas.getContext('2d');
                                
                                if (el.videoWidth === 0 || el.videoHeight === 0) {
                                    throw new Error('Invalid video dimensions');
                                }
                                
                                ctx.drawImage(el, 0, 0, canvas.width, canvas.height);
                                
                                let preview;
                                try {
                                    preview = canvas.toDataURL('image/webp', 0.8);
                                    if (!preview || preview === 'data:,' || preview.length < 50) {
                                        throw new Error('Empty preview data');
                                    }
                                } catch (e) {
                                    try {
                                        preview = canvas.toDataURL('image/jpeg', 0.7);
                                        if (!preview || preview === 'data:,' || preview.length < 50) {
                                            throw new Error('Empty JPEG preview data');
                                        }
                                    } catch (jpegError) {
                                        console.error('Failed to generate both WebP and JPEG previews:', jpegError);
                                        preview = null;
                                    }
                                }
                                
                                clearTimeout(timeout);
                                cleanup();
                                
                                if (preview && preview !== null) {
                                const updatedMeta = {
                                    ...meta,
                                    preview: preview,
                                    duration: duration,
                                    size: video.file.size,
                                    modified: video.file.lastModified,
                                    compressed: preview.includes('image/webp')
                                };
                                saveVideoMetadata(dirHandle, video.name, updatedMeta).catch(console.error);
                                    await saveVideoToDB({ ...video, preview, duration, compressed: preview.includes('image/webp') });

                                video._cachedPreview = preview;
                                video._cachedDuration = duration;
                                
                                if (DEBUG_MODE) console.log(`Successfully generated preview for: ${video.name}`);
                                resolve({ preview, duration });
                                } else {
                                    console.warn(`Failed to generate valid preview for: ${video.name}`);
                                    resolve({ preview: null, duration });
                                }
                            } catch (e) {
                                clearTimeout(timeout);
                                cleanup();
                                console.error(`Error generating preview for ${video.name}:`, e);
                                resolve({ preview: null, duration: '0:00' });
                            }
                        }, { once: true });
                        
                        el.addEventListener('error', (e) => {
                            clearTimeout(seekTimeout);
                            clearTimeout(timeout);
                            cleanup();
                            console.warn(`Seek error for ${video.name}:`, e);
                            resolve({ preview: null, duration });
                        }, { once: true });
                        
                    } catch (e) {
                        clearTimeout(metadataTimeout);
                        clearTimeout(timeout);
                        cleanup();
                        console.error(`Error in loadedmetadata for ${video.name}:`, e);
                        resolve({ preview: null, duration: '0:00' });
                    }
                }, { once: true });
                
                try {
                    if (DEBUG_MODE) console.log(`Starting to load video: ${video.name}`);
                    el.src = url;
                } catch (e) {
                    clearTimeout(timeout);
                    cleanup();
                    console.error(`Error setting video source for ${video.name}:`, e);
                    resolve({ preview: null, duration: '0:00' });
                }
            });
        }



        async function loadVideoPreviewImmediately(video, thumbnailElement) {
            const existingImg = thumbnailElement.querySelector('img');
            if (existingImg && existingImg.src && existingImg.src.startsWith('data:')) {
                if (DEBUG_MODE) console.log(`Preview already loaded for: ${video.name}`);
                return;
            }

            try {
                if (DEBUG_MODE) console.log(`Immediately loading preview for: ${video.name}`, {
                    hasFile: !!video.file,
                    hasHandle: !!video.handle,
                    hasDirHandle: !!video.dirHandle
                });
                
                if (!video.file || !video.handle) {
                    const foundVideo = allVideos.find(av => av.name === video.name);
                    if (foundVideo && foundVideo.file && foundVideo.handle) {
                        if (DEBUG_MODE) console.log(`Using found video data for: ${video.name}`);
                        video.file = foundVideo.file;
                        video.handle = foundVideo.handle;
                        video.dirHandle = foundVideo.dirHandle;
                    } else {
                        console.warn(`No file/handle data available for: ${video.name}`);
                        return;
                    }
                }
                
                if (!video.views && !video.created && !video.tags) {
                    const foundVideo = allVideos.find(av => av.name === video.name);
                    if (foundVideo) {
                        Object.assign(video, {
                            views: foundVideo.views || 0,
                            created: foundVideo.created || foundVideo.modified || 0,
                            tags: foundVideo.tags || [],
                            quality: foundVideo.quality || getVideoQuality(video)
                        });
                    }
                }
                
                const { preview, duration } = await getPreviewAndDuration(video);
                
                const existingQuality = thumbnailElement.querySelector('.video-quality');
                const existingNew = thumbnailElement.querySelector('.video-new');
                
                thumbnailElement.innerHTML = '';
                
                const durationElement = document.createElement('div');
                durationElement.className = 'video-duration';
                durationElement.textContent = duration || '0:00';
                thumbnailElement.appendChild(durationElement);
                
                if (existingQuality) thumbnailElement.appendChild(existingQuality);
                if (existingNew) thumbnailElement.appendChild(existingNew);
                
                if (preview) {
                    const img = document.createElement('img');
                    img.src = preview;
                    img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1;';
                    thumbnailElement.appendChild(img);
                    
                    durationElement.style.cssText = 'position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.8);padding:2px 6px;border-radius:3px;font-size:11px;color:#fff;z-index:2;';
                    
                    if (DEBUG_MODE) console.log(`Successfully loaded preview for: ${video.name}`);
                } else {
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.style.cssText = 'width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#111;font-size:12px;text-align:center;padding:5px;position:absolute;top:0;left:0;z-index:1;';
                    fallbackDiv.textContent = escapeHtml(getnameWithoutExtension(video.name));
                    thumbnailElement.appendChild(fallbackDiv);
                }
                
            } catch (e) {
                console.error('Error loading preview for', video.name, e);
                thumbnailElement.innerHTML = `
                    <div class="video-duration" style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.8);padding:2px 6px;border-radius:3px;font-size:11px;color:#fff;z-index:2;">0:00</div>
                    <div style="width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;text-align:center;padding:5px;position:absolute;top:0;left:0;z-index:1;">
                        ${escapeHtml(getnameWithoutExtension(video.name))}
                    </div>`;
            }
        }

        function getVideoQuality(video) {
            if (video.quality) return video.quality;
            if (video.file && video.size) {
                const sizeMB = video.size / (1024 * 1024);
                if (sizeMB > 1000) return '4K';
                if (sizeMB > 500) return '1080p';
                if (sizeMB > 200) return '720p';
                if (sizeMB > 50) return '480p';
                return 'SD';
            }
            return null;
        }

        function getnameWithoutExtension(name) {
            return name.replace(/\.[^/.]+$/, '');
        }

        function toggleVideoBadges() {
            const body = document.body;
            const isHidden = body.classList.contains('badges-hidden');

            if (isHidden) {
                body.classList.remove('badges-hidden');
                localStorage.setItem('videoBadgesHidden', 'false');
            } else {
                body.classList.add('badges-hidden');
                localStorage.setItem('videoBadgesHidden', 'true');
            }
        }

        function cleanupAvatarCache() {
            const now = Date.now();
            const maxAge = 5 * 60 * 1000;

            for (const [key, value] of avatarCache.entries()) {
                if (now - value.timestamp > maxAge) {
                    if (value.url && value.url.startsWith('blob:')) {
                        URL.revokeObjectURL(value.url);
                    }
                    avatarCache.delete(key);
                }
            }
        }

        function initializeBadgesState() {
            const badgesHidden = localStorage.getItem('videoBadgesHidden');
            if (badgesHidden === 'true') {
                document.body.classList.add('badges-hidden');
            }
        }

        function setupBadgeToggle() {
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleVideoBadges();
                });
            }
        }

        async function saveVideoToDB(videoData) {
            if (!videoData || !videoData.name || typeof videoData.name !== 'string' || videoData.name.trim() === '') {
                console.error('Cannot save video with invalid name:', videoData);
                return;
            }

            try {
                const db = await openDB();
                
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('videos', 'readwrite');
                    const store = tx.objectStore('videos');

                    const { file, handle, dirHandle, ...dataToStore } = videoData;
                    const request = store.put(dataToStore);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('Error in put request:', request.error);
                        resolve();
                    };
                });
            } catch (e) {
                console.error('Error saving video to IndexedDB:', e, 'videoData:', videoData);
            }
        }

    </script>
    
    <!-- Autocomplete Module -->
    <link rel="stylesheet" href="youvi/autocomplete/autocomplete.css">
    <script src="youvi/autocomplete-data-loader.js"></script>
    <script src="youvi/autocomplete/autocomplete-cache.js"></script>
    <script src="youvi/autocomplete/autocomplete.js"></script>
    <script src="youvi/autocomplete/autocomplete-integration.js"></script>
    
    <script src="youvi/cards/cards-bundle.js"></script>
    
    <!-- Theme Toggle Script -->
    <script src="youvi/themes/theme-toggle.js"></script>
    
    <!-- i18n Support -->
    <script src="youvi/i18n/ru.js"></script>
    <script src="youvi/i18n/en.js"></script>
    <script src="youvi/i18n/uk.js"></script>
    <script src="youvi/i18n/i18n.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const langSwitcher = document.getElementById('langSwitcher');
            
            if (langSwitcher) {
                langSwitcher.value = i18n.getCurrentLanguage();
                
                langSwitcher.addEventListener('change', async function(e) {
                    const newLang = e.target.value;
                    await i18n.setLanguage(newLang);
                    if (typeof renderVideos === 'function') {
                        renderVideos();
                    }
                    if (typeof updateSectionTitle === 'function') {
                        updateSectionTitle(selectedChannel);
                    }
                });
            }
        });
    </script>
</body>
</html>