<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="playlists.pageTitle">–ü–ª–µ–π–ª–∏—Å—Ç | Youvi</title>
    <script>

        (function() {
            var theme = localStorage.getItem('youvi-theme');
            var sidebar = localStorage.getItem('sidebarCollapsed');
            
            var htmlClasses = [];
            if (theme === 'dark') htmlClasses.push('dark-theme');
            else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
            if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
            if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
        })();
    </script>
    <link rel="stylesheet" href="youvi/header/youvi-header.css">
    <script src="youvi/sidebar-toggle.js"></script>
    <script src="youvi/sidebar-scroll.js"></script>
    <script src="youvi/header/youvi-header.js"></script>
    
    <!-- i18n System -->
    <script src="youvi/i18n/ru.js"></script>
    <script src="youvi/i18n/en.js"></script>
    <script src="youvi/i18n/uk.js"></script>
    <script src="youvi/i18n/i18n.js"></script>
    
    <link rel="stylesheet" href="youvi/sidebar.css">
    <link rel="stylesheet" href="youvi/sidebar-scroll.css">
    <link rel="stylesheet" href="youvi/pagination.css">
    
    <!-- Theme System -->
    <link rel="stylesheet" href="youvi/themes/dark-theme.css">
    <link rel="stylesheet" href="youvi/themes/theme-dropdown.css">
    <script src="youvi/themes/theme-toggle.js"></script>
    
    <!-- Youvi Hover Preview System -->
    <script src="youvi/hover/hover-preview-queue.js"></script>
    <script src="youvi/hover/hover-preview.js"></script>
    <script src="youvi/hover/hover-init.js"></script>
    <script src="youvi/hover/hover-bundle.js"></script>
    
    <!-- Avatar Cache Module -->
    <script src="youvi/avatar-cache.js"></script>

    <!-- Danmaku Counter -->
    <script src="youvi/danmaku-counter.js"></script>
    <link rel="stylesheet" href="youvi/danmaku-counter.css">

    <link rel="stylesheet" href="youvi/sticky-video.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #111;
            --header-height: 88px; --footer-height: 220px; }

        .top-nav {
            background: #d94b88;
            border-bottom: 1px solid #c2185b;
            padding: 4px 0;
        }

        .top-nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 0;
            transition: color 0.2s;
        }

        .top-nav a:hover {
            color: #ffd6ea;
        }

        .top-nav a.active {
            color: #ffd6ea;
            font-weight: 600;
        }

        .header {
            background: #FFE7F4; padding: 0;
            border-bottom: 1px solid #f2cfe1;
            min-height: 40px;
            width: 100%; }

        .header-content-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            box-sizing: border-box;
            max-width: 1600px; margin: 0 auto; padding: 0 20px; width: 100%; min-height: 40px; }

        .nav-bar {
            display: flex;
            align-items: center;
            width: 100%; justify-content: space-between;
            height: 100%;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-left: calc(200px + 20px + 20px); }

        .nav-right-actions {
            display: flex;
            align-items: center;
            gap: 15px; }

        .nav-links a {
            color: #111; text-decoration: none;
            font-size: 13px;
            padding: 5px 0;
        }



        .search-btn {
            padding: 8px 15px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .user-actions a {
            color: #111; text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }
        
        .user-actions a:hover {
            color: #ff69b4;
        }
        
        .lang-switcher {
            margin-left: auto;
        }
        
        .lang-select {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            outline: none;
        }
        
        .lang-select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-select option {
            background: #d94b88;
            color: #fff;
        }


        .container {
            width: 100%;
            margin: 0;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: stretch;
            min-height: calc(100vh - 200px);
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }
        
        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
        }
        
        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
        }
        
        .header-content-wrapper,
        .top-nav-content {
            max-width: none !important;
            margin: 0 !important;
        }
		
		html, body {
            height: 100%;
        }
        
        .sidebar-collapsed .sidebar,
        html.sidebar-collapsed .sidebar {
            width: 60px !important;
            padding: 10px 8px !important;
            display: block !important;
            position: sticky !important;
            top: 40px !important;
            max-height: calc(var(--sidebar-max-height, 100vh) - 75px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .sidebar-collapsed .sidebar-title,
        html.sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-item,
        html.sidebar-collapsed .sidebar-item {
            padding: 8px !important;
            padding-left: 5px !important;
            padding-right: 8px !important;
            justify-content: center !important;
            border-left: 3px solid transparent !important;
            border-radius: 4px;
            font-size: 0 !important;
        }

        .sidebar-collapsed .sidebar-item svg,
        html.sidebar-collapsed .sidebar-item svg {
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
        }

        .sidebar-collapsed .container,
        html.sidebar-collapsed .container {
            padding-left: 20px;
        }

        .sidebar-collapsed .content-wrapper,
        html.sidebar-collapsed .content-wrapper {
            max-width: 1500px;
        }


        .main-content {
            flex: 1;
            display: flex; flex-direction: column; min-height: 0; padding-top: 5px; padding-bottom: 40px;
        }

        .video-player {
            width: 100%;
            height: 400px;
            background: #eee;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 20px;
        }

        .video-title {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .video-meta {
            color: #ccc;
            font-size: 14px;
        }

        .play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(255, 105, 180, 0.9);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #ff69b4;
            width: 35%;
        }

        .time-display {
            position: absolute;
            bottom: 10px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .video-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px; margin-bottom: 15px;
            color: #111;
            padding-left: 20px; }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            justify-content: start;
        }

        .video-views {
            font-size: 12px;
            color: #888;
        }

        .playlist-view-card .video-views {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .video-tag-link, .video-category-link { color: #666; text-decoration: none; margin-right: 5px; cursor: pointer; }

        .playlists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .playlist-section-carousel {
            margin-bottom: 30px; }

        .playlist-item {
            background: #fff; border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
            position: relative;
            border: 1px solid #eee;
        }

        .playlist-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .playlist-thumbnail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            aspect-ratio: 16/9;
            background: #eee;
            position: relative;
        }

        .playlist-thumb {
            background: #f2f2f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 10px;
            border: 1px solid #e6e6e6;
            position: relative;
            overflow: hidden;
        }

        .playlist-info {
            padding: 12px;
            background: #fafafa; border-top: 1px solid #eee;
        }

        .playlist-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            color: #111;
        }

        .playlist-meta {
            font-size: 12px;
            color: #777;
            margin-bottom: 4px;
        }

        .playlist-channel {
            font-size: 11px;
            color: #ff69b4; }

        .playlist-channel-link {
            color: #ff69b4;
            text-decoration: none;
            font-weight: 500;
        }

        .playlist-channel-link:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            font-size: 16px;
        }
        
        .no-data-message {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .skeleton-item {
            pointer-events: none;
        }
        
        .skeleton-thumb {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            aspect-ratio: 16/9;
            border-radius: 6px;
        }
        
        .skeleton-line {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .dark-theme .skeleton-thumb,
        .dark-theme .skeleton-line {
            background: linear-gradient(90deg, #3a3a3a 25%, #4a4a4a 50%, #3a3a3a 75%);
            background-size: 200% 100%;
        }

        .latest-section {
            margin-top: 10px;
        }
        .latest-title {
            font-size: 20px;
            margin: 10px 0 8px 20px;
            color: #111;
        }
        .latest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            padding: 0 20px 20px 20px;
        }
        .latest-card {
            position: relative;
            cursor: pointer;
            max-width: 200px;
        }
        .latest-thumb {
            width: 100%;
            height: 100px; background: #eee;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            margin-bottom: 8px;
            display: block;
        }
        .latest-info {
            padding: 0 5px;
        }
        .latest-title-text {
            font-size: 13px;
            margin-bottom: 3px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            color: #111;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .latest-sub {
            font-size: 11px;
            color: #666;
        }
        .latest-channel {
            font-size: 11px;
            color: #ff69b4;
            margin-bottom: 2px;
        }
        
        .latest-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
            color: #fff;
            z-index: 2;
        }

        @media (max-width: 1024px) {
            .sidebar-right {
                display: none;
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            
            
            .nav-links {
                display: none;
            }
            

            
            .video-player {
                height: 250px;
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }

            .playlists-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .latest-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .nav-bar {
                padding: 0 10px;
            }
            

            
            .video-player {
                height: 200px;
            }
            
            .video-title {
                font-size: 18px;
            }
            
            .play-btn {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
            
            .latest-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
                padding: 0 10px 20px 10px;
            }
            
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .latest-thumb {
                height: 100px;
            }
        }

        .playlist-section-title {
            font-size: 20px;
            margin-bottom: 5px; color: #111;
            }

        .playlist-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    margin-bottom: 5px; min-height: 32px;
    gap: 20px;
}

.playlist-section-all-link {
    color: #333;
    text-decoration: none;
    font-size: 12px;
    cursor: pointer;
    flex-shrink: 0;
    white-space: nowrap;
    margin-left: auto;
}

        .video-carousel-wrapper {
            position: relative;
            padding: 0 20px; }

        .video-carousel {
    display: flex;
    overflow: hidden;
    gap: 15px;
    width: 100%;
    justify-content: flex-start;
}



        .video-carousel .video-card {
            flex: 0 0 auto;
            width: 180px;
            min-width: 160px;
            max-width: 220px;
            overflow: hidden;
            transition: transform .2s, box-shadow .2s;
        }
        .video-carousel .video-thumbnail {
            background: #eee;
            position: relative;
            overflow: hidden;
            width: 100%; height: 100px; margin-bottom: 6px;
            display: block; }

        .video-carousel .video-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
            color: #fff;
            z-index: 2; }

        .video-carousel .video-info {
            padding: 0 5px; }
        
        .video-carousel .video-playlist { font-size: 11px;
            color: #ff69b4;
            margin-bottom: 2px;
        }

        .video-carousel .video-card-title {
            font-size: 16px;
            margin-bottom: 3px; color: #111;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .video-carousel .video-category {
            font-size: 13px; color: #666; }
        
        .video-carousel .video-views {
            font-size: 12px; color: #888;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .carousel-nav-btn {
            position: absolute;
            top: 50%; transform: translateY(-50%); background: rgba(128, 128, 128, 0.8); color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%; font-size: 20px;
            line-height: 1;
            height: 50px;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: opacity 0.2s;
            margin-top: -25px; }

        .carousel-nav-btn.prev-btn {
            left: 20px; }

        .carousel-nav-btn.next-btn {
            right: 20px; }

        @media (max-width: 1024px) {
            .video-carousel-wrapper {
                padding: 0 30px;
            }
            .carousel-nav-btn {
                padding: 8px 12px;
                font-size: 18px;
                height: 40px;
                width: 40px;
            }
        }

        @media (max-width: 768px) {
            .video-carousel-wrapper {
                padding: 0 20px;
            }
            .carousel-nav-btn {
                padding: 6px 10px;
                font-size: 16px;
                height: 35px;
                width: 35px;
            }
            .playlist-section-title {
                font-size: 16px;
                padding-left: 0;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .video-carousel-wrapper {
                padding: 0 10px;
            }
            .carousel-nav-btn {
                display: none; }
            .playlist-section-title {
                font-size: 16px;
                padding-left: 0;
                text-align: center;
            }
        }

        @media (max-width: 768px) {

    }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 5; }

        .playlist-view-header {
            padding: 0; margin-bottom: 20px;
            margin-top: 5px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 20px;
        }

        .playlist-header-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .playlist-view-header h1 {
            color: #111;
            margin: 0;
            font-size: 32px; font-weight: 200; font-family: Arial, sans-serif; line-height: 1.1; max-height: 2.2em; overflow: hidden;
            text-overflow: ellipsis; display: -webkit-box; line-clamp: 2;
            -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        .playlist-view-meta {
            color: rgba(0,0,0,0.8);
            font-size: 16px;
            margin-top: 5px;
        }

        .playlist-view-categories {
            color: rgba(0,0,0,0.8);
            font-size: 14px;
            margin-top: 5px;
        }

        .back-to-main-link {
            color: #ff69b4;
            text-decoration: none;
            font-size: 14px; font-weight: normal; white-space: nowrap;
            flex-shrink: 0;
        }

        .back-to-main-link:hover {
            text-decoration: underline;
        }

        .playlist-view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 0;
            margin-bottom: 20px;
        }
        
        #playlistViewContent { padding: 0 20px; }
        #paginationContainer { padding: 0 20px; }

        @media (max-width: 992px) {
            .playlist-view-grid {
                grid-template-columns: repeat(3, 1fr); }
            .playlist-view-header h1 {
                font-size: 38px;
            }
        } 

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px; }
            .nav-links {
                margin-left: 0; }
            .main-content {
                padding: 0; }
            .playlist-view-grid {
                grid-template-columns: repeat(5, 1fr); padding: 0 20px; gap: 15px;
            }
            .playlist-view-header {
                flex-direction: column; align-items: flex-start;
                gap: 10px;
                padding: 0 20px; }
            .back-to-main-link {
                order: -1; }
            .playlist-view-header h1 {
                font-size: 32px;
            }
        }

        @media (max-width: 480px) {
            .playlist-view-header h1 {
                font-size: 24px;
            }
            .playlist-view-meta, .playlist-view-categories {
                font-size: 12px;
            }
            .back-to-main-link {
                font-size: 14px;
            }
            .playlist-view-card .video-thumbnail {
                height: 100px; }
        }

        .footer {
            background: #2c2c2c;
            color: #fff;
            padding: 25px 0 15px 0;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .footer-logo {
            flex-shrink: 0;
            width: 200px;
        }

        .footer-logo img {
            height: 40px;
            width: auto;
        }

        .footer-logo p {
            margin-top: 8px;
            font-size: 11px;
            color: #ccc;
            line-height: 1.3;
        }

        .footer-sections {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-main {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-right {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .footer-mascot {
            flex-shrink: 0;
        }

        .footer-mascot img {
            height: 180px;
            width: auto;
        }

        .footer-section {
            flex: 1;
        }

        .footer-section h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #fff;
            font-weight: 600;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-section li {
            margin-bottom: 6px;
        }

        .footer-section a {
            color: #ccc;
            text-decoration: none;
            font-size: 11px;
            transition: color 0.2s;
        }

        .footer-section a:hover {
            color: #ff69b4;
        }

        .footer-bottom {
            border-top: 1px solid #444;
            margin-top: 20px;
            padding-top: 15px;
            text-align: center;
            color: #999;
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .footer-sections {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-section {
                text-align: center;
            }
        }
        
        @media (min-width: 1400px) {
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .playlist-view-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        @media (min-width: 1700px) {
            .footer-content {
                max-width: 1700px !important;
            }
        }

        @media (min-width: 2000px) {
            .footer-content {
                max-width: 1800px !important;
            }
        }

                body.dark-theme input.search-input {
  background: #4a3a34 !important;
  color: #fff !important;
  border-color: #555 !important;
}

.video-quality {
    position: absolute;
    top: 5px;
    left: 5px;
    padding: 2px 4px;
    border-radius: 2px;
    font-size: 10px;
    color: #fff;
    z-index: 3;
    font-weight: bold;
}
.video-quality[data-quality="4K"] { background: rgba(156,39,176,0.8); }
.video-quality[data-quality="1080p"] { background: rgba(255,105,180,0.8); }
.video-quality[data-quality="720p"] { background: rgba(76,175,80,0.8); }
.video-quality[data-quality="480p"] { background: rgba(255,152,0,0.8); }
.video-quality[data-quality="SD"] { background: rgba(102,102,102,0.8); }

body.dark-theme .video-quality[data-quality="4K"] { background: rgba(156,39,176,0.9); }
body.dark-theme .video-quality[data-quality="1080p"] { background: rgba(255,105,180,0.9); }
body.dark-theme .video-quality[data-quality="720p"] { background: rgba(76,175,80,0.9); }
body.dark-theme .video-quality[data-quality="480p"] { background: rgba(255,152,0,0.9); }
body.dark-theme .video-quality[data-quality="SD"] { background: rgba(102,102,102,0.9); }

@media (max-width: 768px) {
    .video-quality {
        font-size: 9px;
        padding: 1px 3px;
    }
}

@media (max-width: 480px) {
    .video-quality {
        font-size: 8px;
        padding: 1px 2px;
    }
}
    </style>
</head>
<link rel="icon" href="favicon/youvi/favicon.ico" type="image/x-icon">
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="top-nav-content">
      <a href="youvi_main.html" data-i18n="nav.video">–ù–∞–∑–∞–¥</a>
      <a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
      <a href="youvi_ch_list.html" data-i18n="nav.channels">–ö–∞–Ω–∞–ª—ã</a>
      <a href="youvi_playlists_list.html" class="active" data-i18n="nav.playlists">–∏–∑–∏–∑–ù–∞–∑–∞–¥</a>
      <a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a> 
      <a href="wiki/index.html" data-i18n="nav.wiki">Wiki</a>
      <div class="lang-switcher">
        <select id="langSwitcher" class="lang-select">
          <option value="ru">üá∑üá∫ RU</option>
          <option value="en">üá¨üáß EN</option>
          <option value="uk">üá∫üá¶ UK</option>
        </select>
      </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content-wrapper">
            <div class="header-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
                
                <div class="logo">
                    <a href="youvi_main.html">
                        <img src="images/logo_youvi_ind.png" alt="Youvi logo">
                    </a>
                </div>
            </div>
            
            <div class="header-center">
                <div class="search-area autocomplete-wrapper">
                    <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." class="search-input" data-i18n-placeholder="search.placeholder">
                    <button id="doSearch" class="search-btn" data-i18n="search.button">–ù–∞–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="header-right">
                <div class="user-actions">
                    <a href="#" id="badgesToggle" data-i18n="header.badges">–ú–µ—Ç–∫–∞</a>
                    <div class="settings-container">
                        <a href="#" class="settings-btn">‚öô</a>
                        <div class="theme-dropdown">
                            <button class="theme-dropdown-item" data-theme="light" data-i18n="themes.light">–ë–µ–ª–∞—è</button>
                            <button class="theme-dropdown-item" data-theme="dark" data-i18n="themes.dark">–ß–µ—Ä–Ω–∞—è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.navigation">–∏–∑–∏–∑–ù–∞–∑–∞–¥</div>
                <a href="youvi_main.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span data-i18n="sidebar.home">–∏–∑–ù–∞–∑–∞–¥</span>
                </a>
                <a href="youvi_feed_all.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 11a9 9 0 0 1 9 9"/>
                        <path d="M4 4a16 16 0 0 1 16 16"/>
                        <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <span data-i18n="sidebar.feed">Feed</span>
                </a>
                <a href="youvi_tags.html" class="sidebar-item nav-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                     <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                 </svg>
                    <span data-i18n="sidebar.allTags">–í—Å–µ —Ç–µ–≥–∏</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
                <a href="youvi_history.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</span>
                </a>
                <a href="youvi_fav.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                </a>
                <a href="youvi_playlists_list.html" class="sidebar-item library-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.playlists">–∏–∑–∏–∑–ù–∞–∑–∞–¥</span>
                </a>
                <a href="youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</span>
                </a>
                <a href="youvi_subscriptions.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.subscriptionsTitle">–ü–æ–¥–ø–∏—Å–∫–∏</div>
                <div id="subscribedChannelsContainer"></div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.sorting">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
                <div id="sortOptionsContainer">
                    <a href="#" class="sidebar-item library-item active" id="sortDefault">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="8" y1="8" x2="16" y2="8"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                            <line x1="8" y1="16" x2="16" y2="16"/>
                        </svg>
                        <span data-i18n="playlists.default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortNew">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        <span data-i18n="sidebar.sortNew">–ù–∞–∑–∞–¥</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortPopular">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        <span data-i18n="sidebar.sortPopular">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortOld">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span data-i18n="sidebar.sortOld">–°—Ç–∞—Ä—ã–µ</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortAlphabetical">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <path d="M4 16L8 6l4 10"/>
                            <path d="M5 13h6"/>
                            <path d="M14 6h6"/>
                            <path d="M14 12h6"/>
                            <path d="M14 18h6"/>
                        </svg>
                        <span data-i18n="sidebar.sortAlphabetical">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortRandom">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="3" ry="3"/>
                            <circle cx="8" cy="8" r="1"/>
                            <circle cx="16" cy="8" r="1"/>
                            <circle cx="8" cy="16" r="1"/>
                            <circle cx="16" cy="16" r="1"/>
                            <circle cx="12" cy="12" r="1"/>
                        </svg>
                        <span data-i18n="sidebar.sortRandom">–°–ª—É—á–∞–π–Ω—ã–µ</span>
                    </a>
                    <a href="#" class="sidebar-item library-item" id="sortDanmaku">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span data-i18n="sidebar.sortDanmaku">–ü–æ –¥–∞–Ω–º–∞–∫—É</span>
                    </a>
                </div>
            </div>

        </aside>

        <!-- Content Wrapper (centered) -->
        <div class="content-wrapper">
        <!-- Main Content -->
        <main class="main-content">
            <div id="playlistViewContent">
                <div class="loading" data-i18n="playlists.loadingPlaylist">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞...</div>
            </div>
            <div id="paginationContainer"></div>
        </main>
        </div><!-- /content-wrapper -->
    </div>   

   <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-logo">
                    <img src="images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
                    <p data-i18n="footer.description">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ.</p>
                </div>
                <div class="footer-sections">
                    <div class="footer-section">
                        <h3 data-i18n="footer.sections">–†–∞–∑–¥–µ–ª—ã</h3>
                        <ul>
                            <li><a href="youvi_main.html" data-i18n="footer.video">–í–∏–¥–µ–æ</a></li>
                            <li><a href="youvi_tags.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
                            <li><a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a></li>
                            <li><a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
                        <ul>
                            <li><a href="youvi_ch_list.html" data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</a></li>
                            <li><a href="youvi_playlists_list.html" data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a></li>
                            <li><a href="youvi_subscriptions.html" data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</a></li>
                            <li><a href="youvi_fav.html" data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a></li>
                            <li><a href="youvi_history.html" data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="nav.wiki">Wiki</h3>
                        <ul>
                            <li><a href="wiki/index.html" data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li><a href="wiki/player.html" data-i18n="footer.wiki.player">–ü–ª–µ–µ—Ä</a></li>
                            <li><a href="wiki/danmaku.html" data-i18n="footer.wiki.danmaku">–î–∞–Ω–º–∞–∫—É</a></li>
                            <li><a href="wiki/tags/general.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
                            <li><a href="wiki/tags/rules.html" data-i18n="footer.wiki.taggingRules">–ü—Ä–∞–≤–∏–ª–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</a></li>
                            <li><a href="wiki/search/general.html" data-i18n="footer.wiki.search">–ü–æ–∏—Å–∫</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.pgc">PGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Anime (ct)" data-i18n="footer.categories.anime">Anime</a></li>
                            <li><a href="youvi_main.html?tag=Animation (ct)" data-i18n="footer.categories.animation">Animation</a></li>
                            <li><a href="youvi_main.html?tag=Movies (ct)" data-i18n="footer.categories.movies">Movies</a></li>
                            <li><a href="youvi_main.html?tag=Series (ct)" data-i18n="footer.categories.series">Series</a></li>
                            <li><a href="youvi_main.html?tag=Music (ct)" data-i18n="footer.categories.music">Music</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.ugc">UGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Games (ct)" data-i18n="footer.categories.games">Games</a></li>
                            <li><a href="youvi_main.html?tag=Technology (ct)" data-i18n="footer.categories.tech">Technology</a></li>
                            <li><a href="youvi_main.html?tag=Entertainment (ct)" data-i18n="footer.categories.entertainment">Entertainment</a></li>
                            <li><a href="youvi_main.html?tag=IRL (ct)" data-i18n="footer.categories.irl">IRL</a></li>
                            <li><a href="youvi_main.html?tag=TV (ct)" data-i18n="footer.categories.tv">TV</a></li>
                            <li><a href="youvi_main.html?tag=Education (ct)" data-i18n="footer.categories.education">Education</a></li>
                            <li><a href="youvi_main.html?tag=Other (ct)" data-i18n="footer.categories.other">Other</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h3 data-i18n="footer.about">–û —Å–∞–π—Ç–µ</h3>
                        <ul>
                            <li><a href="wiki/about.html" data-i18n="footer.aboutSite">–ü—Ä–æ —Å–∞–π—Ç</a></li>
                            <li><a href="wiki/docs.html" data-i18n="footer.docs">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></li>
                            <li><a href="wiki/tech.html" data-i18n="footer.tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-right">
                <div class="footer-mascot">
                    <img src="images/mascot1.png" alt="Yuvi" loading="lazy">
                </div>
            </div>
        </div>
    </footer>
    
    <script>

      const supportsFS = 'showDirectoryPicker' in window;


      const DEBUG_MODE = false;
      const log = (...args) => { if (DEBUG_MODE) console.log(...args); };
      
      let videoDirectoryHandle = null;
      window.videoDirectoryHandle = null;
      let allVideos = [];
      let currentPlaylist = null;
      let currentSort = 'default';
      let currentPage = 1;
      const itemsPerPage = 24;
      let currentSearchTerm = '';

      let db = null;

      async function openDB(){
        return new Promise((resolve,reject)=>{
          const req = indexedDB.open('8SiteDB', 1);
          req.onupgradeneeded = ()=> {
            const db = req.result;
            if (!db.objectStoreNames.contains('handles')) db.createObjectStore('handles');
            if (!db.objectStoreNames.contains('videos')) db.createObjectStore('videos', { keyPath: 'name' });
            if (!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', { keyPath: 'id' });
          };
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
      }
      async function getFromDB(key){
        const tx = db.transaction('handles','readonly');
        const store = tx.objectStore('handles');
        return new Promise((resolve)=> {
          const r = store.get(key);
          r.onsuccess = ()=> resolve(r.result);
          r.onerror = ()=> resolve(null);
        });
      }
      async function saveToDB(key, value) {
        const tx = db.transaction('handles', 'readwrite');
        const store = tx.objectStore('handles');
        await store.put(value, key);
      }

      async function saveVideoToDB(video) {
        const tx = db.transaction('videos', 'readwrite');
        const store = tx.objectStore('videos');
        await store.put(video);
      }

      async function getVideosFromDB() {
        const tx = db.transaction('videos', 'readonly');
        const store = tx.objectStore('videos');
        return new Promise((resolve) => {
          const r = store.getAll();
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve([]);
        });
      }

      async function deleteVideoFromDB(videoName) {
        const tx = db.transaction('videos', 'readwrite');
        const store = tx.objectStore('videos');
        await store.delete(videoName);
      }

      async function savePlaylistToDB(playlist) {
        const tx = db.transaction('playlists', 'readwrite');
        const store = tx.objectStore('playlists');
        await store.put(playlist);
      }

      async function getPlaylistsFromDB() {
        const tx = db.transaction('playlists', 'readonly');
        const store = tx.objectStore('playlists');
        return new Promise((resolve) => {
          const r = store.getAll();
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve([]);
        });
      }

      async function deletePlaylistFromDB(playlistId) {
        const tx = db.transaction('playlists', 'readwrite');
        const store = tx.objectStore('playlists');
        await store.delete(playlistId);
      }

      async function getFromDBGeneric(storeName, key) {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        return new Promise((resolve) => {
          const r = store.get(key);
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve(null);
        });
      }

      async function readJSONFile(dirHandle, fileName, def=null){
        try{
          const fh = await dirHandle.getFileHandle(fileName);
          const f = await fh.getFile();
          return JSON.parse(await f.text());
        }catch(e){ return def; }
      }
      async function writeJSONFile(dirHandle, fileName, data){
        const fh = await dirHandle.getFileHandle(fileName, { create:true });
        const w = await fh.createWritable();
        await w.write(JSON.stringify(data, null, 2));
        await w.close();
      }

      async function getVideoMetadata(dirHandle, fileName){
        try{
          const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create:true });
          const metaHandle = await metaDir.getFileHandle(fileName + '.meta.json');
          const file = await metaHandle.getFile();
          const metadata = JSON.parse(await file.text());
          return metadata;
        }catch(e){ return { views:0, likes:0, dislikes:0, tags:[], created:Date.now() }; }
      }

      async function saveVideoMetadata(dirHandle, fileName, metadata) {
        try {
          const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
          const metaFileName = fileName + '.meta.json';
          await writeJSONFile(metaDir, metaFileName, metadata);
        } catch (e) {
          console.error('Error saving video metadata:', e);
        }
      }

      async function getPreviewAndDuration(video){
        if (!video.file) {

          if (video.handle) {
            try {
              video.file = await video.handle.getFile();
            } catch (e) {
              console.warn('Could not get file for video:', video.name, e);
            }
          }

          if (!video.file) {
            const dirHandle = video.dirHandle || videoDirectoryHandle;
            const meta = await getVideoMetadata(dirHandle, video.name);

            if (meta.preview && meta.duration) {
              return { preview: meta.preview, duration: meta.duration };
            }

            console.warn('No file available for video:', video.name);
            return { 
              preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
              duration: '0:00' 
            };
          }
        }
        
        const dirHandle = video.dirHandle || videoDirectoryHandle;
        const meta = await getVideoMetadata(dirHandle, video.name);

        const fileChanged = meta.size !== video.file.size || meta.modified !== video.file.lastModified;

        if (meta.preview && meta.duration && !fileChanged) {
          return { preview: meta.preview, duration: meta.duration };
        }

        return new Promise((resolve, reject) => {
          const el = document.createElement('video');
          el.muted = true;
          el.playsInline = true;
          el.preload = 'metadata';
          el.crossOrigin = 'anonymous';
          
          const url = URL.createObjectURL(video.file);
          
          const cleanup = () => {
            URL.revokeObjectURL(url);
            el.remove();
          };

          const timeout = setTimeout(() => {
            cleanup();
            console.warn(`Preview generation timeout for ${video.name}`);

            resolve({ 
              preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
              duration: '0:00' 
            });
          }, 20000);
          
          el.addEventListener('error', (e) => {
            clearTimeout(timeout);
            cleanup();
            console.warn(`Video loading error for ${video.name}:`, e);

            resolve({ 
              preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
              duration: '0:00' 
            });
          }, { once: true });
          
          el.addEventListener('loadedmetadata', async () => {
            try {
              if (!isFinite(el.duration) || el.duration <= 0) {
                clearTimeout(timeout);
                cleanup();
                resolve({ 
                  preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
                  duration: '0:00' 
                });
                return;
              }
              
              const duration = formatDuration(el.duration);

              const seekPositions = [
                Math.max(0, el.duration * 0.1),
                Math.max(0, el.duration * 0.25),
                Math.max(0, el.duration * 0.5)
              ];
              
              let seekAttempt = 0;
              
              const trySeek = () => {
                if (seekAttempt >= seekPositions.length) {
                  clearTimeout(timeout);
                  cleanup();
                  console.warn(`Failed to generate preview after ${seekAttempt} attempts for ${video.name}`);
                  resolve({ 
                    preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
                    duration: duration 
                  });
                  return;
                }
                
                el.currentTime = seekPositions[seekAttempt];
                seekAttempt++;
              };
              
              const seekedHandler = async () => {
                try {

                  await new Promise(resolve => setTimeout(resolve, 100));
                  
                  const canvas = document.createElement('canvas');
                  canvas.width = 240; 
                  canvas.height = 140;
                  const ctx = canvas.getContext('2d');
                  
                  if (el.videoWidth === 0 || el.videoHeight === 0) {
                    throw new Error('Invalid video dimensions');
                  }

                  ctx.drawImage(el, 0, 0, canvas.width, canvas.height);

                  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                  const hasContent = imageData.data.some((value, index) => 
                    index % 4 !== 3 && value > 10
                  );
                  
                  if (!hasContent && seekAttempt < seekPositions.length) {

                    trySeek();
                    return;
                  }
                  
                  const preview = canvas.toDataURL('image/jpeg', 0.7);
                  
                  clearTimeout(timeout);
                  cleanup();

                  const updatedMeta = {
                    ...meta,
                    preview: preview,
                    duration: duration,
                    size: video.file.size,
                    modified: video.file.lastModified
                  };
                  saveVideoMetadata(dirHandle, video.name, updatedMeta).catch(console.error);
                  await saveVideoToDB({ ...video, preview, duration });

                  resolve({ preview, duration });
                } catch (e) {
                  console.warn(`Preview generation error for ${video.name} at attempt ${seekAttempt}:`, e);
                  if (seekAttempt < seekPositions.length) {

                    trySeek();
                  } else {
                    clearTimeout(timeout);
                    cleanup();
                    resolve({ 
                      preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
                      duration: duration 
                    });
                  }
                }
              };
              
              el.addEventListener('seeked', seekedHandler, { once: true });
              
              el.addEventListener('error', (e) => {
                console.warn(`Seek error for ${video.name}:`, e);
                if (seekAttempt < seekPositions.length) {

                  trySeek();
                } else {
                  clearTimeout(timeout);
                  cleanup();
                  resolve({ 
                    preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
                    duration: duration 
                  });
                }
              }, { once: true });

              trySeek();
              
            } catch (e) {
              clearTimeout(timeout);
              cleanup();
              console.warn(`Metadata processing error for ${video.name}:`, e);
              resolve({ 
                preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', 
                duration: '0:00' 
              });
            }
          }, { once: true });
          
          el.src = url;
        });
      }

      async function parallelLimit(tasks, limit = 2) {
        const results = [];
        const executing = new Set();
        
        for (const task of tasks) {
          const p = Promise.resolve().then(() => task());
          results.push(p);
          executing.add(p);
          p.finally(() => executing.delete(p));
          
          if (executing.size >= limit) {
            await Promise.race(executing);

            await new Promise(resolve => setTimeout(resolve, 50));
          }
        }
        return Promise.all(results);
      }

      async function findVideoFile(rootDir, videoName) {
        const exts = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.m4v'];
        
        async function searchDir(dir) {
          try {
            for await (const [name, handle] of dir.entries()) {
              if (handle.kind === 'file' && name === videoName) {
                return { handle, dirHandle: dir };
              } else if (handle.kind === 'directory' && !name.startsWith('.')) {
                const result = await searchDir(handle);
                if (result) return result;
              }
            }
          } catch (e) {
            console.warn('Error searching directory:', e);
          }
          return null;
        }
        
        return await searchDir(rootDir);
      }

      async function loadAllPlaylistsForSingleView(playlistId){
          let foundPlaylist = null;
          try{
            const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create:true });
            for await (const [name, handle] of channelsDir.entries()){
              if (handle.kind === 'directory'){
                const channelData = await readJSONFile(handle, 'channel.json', { playlists: [] });
                const pl = (channelData.playlists || []).find(p => String(p.id) === playlistId);
                if (pl) {
                  foundPlaylist = { ...pl, channelName:name, channelHandle:handle, isChannelPlaylist:true };
                  break;
                }
              }
            }
            if (!foundPlaylist) {
                const globalPlaylists = await readJSONFile(videoDirectoryHandle, '.global_playlists.json', []);
                const pl = (globalPlaylists || []).find(p => String(p.id) === playlistId);
                if (pl) {
                    foundPlaylist = { ...pl, channelName:null, isChannelPlaylist:false };
                }
            }

            if (foundPlaylist && foundPlaylist.videos) {
                log(`? Enriching ${foundPlaylist.videos.length} playlist videos...`);
                foundPlaylist = await loadPlaylistVideosOnly(foundPlaylist);
            }
          }catch(e){
            console.error('loadAllPlaylistsForSingleView error', e);
          }
          return foundPlaylist;
        }

      async function loadPlaylistVideosOnly(playlist){
        log('? Loading videos for playlist only...');
        const startTime = performance.now();
        
        if (!videoDirectoryHandle || !playlist || !playlist.videos) {
          return playlist;
        }

        const videoNames = new Set(playlist.videos.map(v => v.name));

        const cachedVideos = await getVideosFromDB();
        const cachedMap = new Map(cachedVideos.map(v => [v.name, v]));

        const enrichedVideos = await Promise.all(playlist.videos.map(async (video) => {
          const cached = cachedMap.get(video.name);
          
          if (cached) {

            return {
              ...video,
              ...cached,
              handle: null,
              file: null,
              dirHandle: null
            };
          }

          return video;
        }));
        
        log(`? Enriched ${enrichedVideos.length} playlist videos in ${Math.round(performance.now() - startTime)}ms`);
        
        return {
          ...playlist,
          videos: enrichedVideos
        };
      }

      async function backgroundVideoScan() {
        log('?? Starting background video scan...');
        const scanStart = performance.now();
        const exts = ['.mp4','.avi','.mov','.mkv','.webm','.m4v'];
        const videoMap = new Map(allVideos.map(v => [v.name, v]));
        const currentVideoNames = new Set();
        const scannedVideos = [];
        
        async function scan(dir, path = ''){
          for await (const [name, handle] of dir.entries()){
            if (handle.kind === 'file'){
              const lower = name.toLowerCase();
              if (exts.some(ext => lower.endsWith(ext))){
                currentVideoNames.add(name);
                const file = await handle.getFile();
                const cachedVideo = videoMap.get(name);

                if (!cachedVideo || cachedVideo.modified !== file.lastModified) {
                  const meta = await getVideoMetadata(dir, name);
                  const videoData = {
                    name, 
                    size: file.size,
                    modified: file.lastModified,
                    ...meta
                  };
                  scannedVideos.push({
                    ...videoData,
                    handle: handle,
                    file: file,
                    dirHandle: dir
                  });
                  await saveVideoToDB(videoData);
                } else {
                  scannedVideos.push({
                    ...cachedVideo,
                    handle: handle,
                    file: file,
                    dirHandle: dir
                  });
                }
              }
            } else if (handle.kind === 'directory' && !name.startsWith('.')){
              await scan(handle, path + '/' + name);
            }
          }
        }
        
        await scan(videoDirectoryHandle);

        const cachedVideos = await getVideosFromDB();
        for (const cachedVideo of cachedVideos) {
          if (!currentVideoNames.has(cachedVideo.name)) {
            await deleteVideoFromDB(cachedVideo.name);
          }
        }

        if (scannedVideos.length !== allVideos.length) {
          allVideos = scannedVideos;
          log(`?? Background scan complete: ${allVideos.length} videos (${Math.round(performance.now() - scanStart)}ms)`);
        } else {
          log(`? Background scan complete: no changes (${Math.round(performance.now() - scanStart)}ms)`);
        }
      }

      const videoHandleCache = new Map();
      
      async function ensureVideoHandle(video) {
        if (video.file && video.handle) {
          return video;
        }

        if (videoHandleCache.has(video.name)) {
          const cached = videoHandleCache.get(video.name);
          video.handle = cached.handle;
          video.dirHandle = cached.dirHandle;
          video.file = cached.file;
          return video;
        }

        if (!video.handle && videoDirectoryHandle) {
          try {
            const result = await findVideoFile(videoDirectoryHandle, video.name);
            if (result) {
              video.handle = result.handle;
              video.dirHandle = result.dirHandle;
              video.file = await result.handle.getFile();

              videoHandleCache.set(video.name, {
                handle: video.handle,
                dirHandle: video.dirHandle,
                file: video.file
              });
            }
          } catch (e) {
            console.warn('Could not find handle for video:', video.name, e);
          }
        }
        
        return video;
      }
      
      async function batchLoadVideoHandles(videos, limit = 5) {
        const tasks = videos.map(video => async () => {
          await ensureVideoHandle(video);
        });
        
        await parallelLimit(tasks, limit);
        return videos;
      }

      function createVideoCardPreviewTask(video, thumbnailElement, videoIndex = null) {
        return async () => {
          try {
            await ensureVideoHandle(video);
            
            const { preview, duration } = await getPreviewAndDuration(video);

            let existingImg = thumbnailElement.querySelector('img');
            let existingDuration = thumbnailElement.querySelector('.video-duration');
            let existingNumber = thumbnailElement.querySelector('.video-number');

            const numberText = existingNumber ? existingNumber.textContent : (videoIndex !== null ? videoIndex + 1 : '');
            
            if (preview) {

              if (existingImg) {
                existingImg.src = preview;
                existingImg.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1;';
              } else {
                const img = document.createElement('img');
                img.src = preview;
                img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1;';
                thumbnailElement.appendChild(img);
              }
            } else {

              if (!existingImg) {
                const fallbackDiv = document.createElement('div');
                fallbackDiv.style.cssText = 'width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#111;font-size:10px;text-align:center;padding:5px;position:absolute;top:0;left:0;z-index:1;';
                fallbackDiv.textContent = escapeHtml(getFileNameWithoutExtension(video.name));
                thumbnailElement.appendChild(fallbackDiv);
              }
            }

            if (existingDuration) {
              existingDuration.textContent = duration || '0:00';
            } else {
              const durationElement = document.createElement('div');
              durationElement.className = 'video-duration';
              durationElement.textContent = duration || '0:00';
              thumbnailElement.appendChild(durationElement);
            }

            if (existingNumber) {
              existingNumber.textContent = numberText;
            } else {
              const numberElement = document.createElement('div');
              numberElement.className = 'video-number';
              numberElement.textContent = numberText;
              thumbnailElement.appendChild(numberElement);
            }
            
          } catch (e) {
            console.error('Error loading preview for', video.name, e);

            let existingNumber = thumbnailElement.querySelector('.video-number');
            let existingDuration = thumbnailElement.querySelector('.video-duration');
            
            const numberText = existingNumber ? existingNumber.textContent : (videoIndex !== null ? videoIndex + 1 : '');

            if (!existingNumber) {
              const numberElement = document.createElement('div');
              numberElement.className = 'video-number';
              numberElement.textContent = numberText;
              thumbnailElement.appendChild(numberElement);
            }
            
            if (!existingDuration) {
              const durationElement = document.createElement('div');
              durationElement.className = 'video-duration';
              durationElement.textContent = '0:00';
              thumbnailElement.appendChild(durationElement);
            }

            if (!thumbnailElement.querySelector('img') && !thumbnailElement.querySelector('div[style*="background:#eee"]')) {
              const fallbackDiv = document.createElement('div');
              fallbackDiv.style.cssText = 'width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#111;font-size:10px;text-align:center;padding:5px;position:absolute;top:0;left:0;z-index:1;';
              fallbackDiv.textContent = escapeHtml(getFileNameWithoutExtension(video.name));
              thumbnailElement.appendChild(fallbackDiv);
            }
          }
        };
      }

      function naturalSort(a, b) {
          const normalize = (s) => s.replace(/–π/g, 'y');
          
          const chunkify = (s) => {
              const match = s.match(/\D+|\d+/g);
              return match ? match.map(c => isNaN(c) ? c.toLowerCase() : parseInt(c, 10)) : [];
          };

          const aChunks = chunkify(normalize(String(a)));
          const bChunks = chunkify(normalize(String(b)));

          for (let i = 0; i < Math.min(aChunks.length, bChunks.length); i++) {
              const aChunk = aChunks[i];
              const bChunk = bChunks[i];

              if (typeof aChunk === 'number' && typeof bChunk === 'number') {
                  if (aChunk < bChunk) return -1;
                  if (aChunk > bChunk) return 1;
              } else if (typeof aChunk === 'string' && typeof bChunk === 'string') {
                  const cmp = aChunk.localeCompare(bChunk, 'ru', { numeric: false, caseFirst: 'lower' });
                  if (cmp !== 0) return cmp;
              } else if (typeof aChunk === 'number') {
                  return -1;
              } else {
                  return 1;
              }
          }

          return aChunks.length - bChunks.length;
      }

      function sortVideos(videos) {
          switch (currentSort) {
              case 'default':
                  return videos.slice();
              case 'new':
                  return videos.slice().sort((a, b) => {
                      const dt = (b.created ?? b.modified ?? 0) - (a.created ?? a.modified ?? 0);
                      if (dt !== 0) return dt;
                      const an = getFileNameWithoutExtension(a.name) || '';
                      const bn = getFileNameWithoutExtension(b.name) || '';
                      return an.localeCompare(bn, undefined, { numeric: true, sensitivity: 'base' });
                  });
              case 'popular':
                  return videos.slice().sort((a, b) => (b.views || 0) - (a.views || 0));
              case 'old':
                  return videos.slice().sort((a, b) => {
                      const dt = (a.created ?? a.modified ?? 0) - (b.created ?? b.modified ?? 0);
                      if (dt !== 0) return dt;
                      const an = getFileNameWithoutExtension(a.name) || '';
                      const bn = getFileNameWithoutExtension(b.name) || '';
                      return an.localeCompare(bn, undefined, { numeric: true, sensitivity: 'base' });
                  });
              case 'alphabetical':
                  return videos.slice().sort((a, b) => naturalSort(getFileNameWithoutExtension(a.name) || '', getFileNameWithoutExtension(b.name) || ''));
              case 'random':
                  return videos.slice().sort(() => Math.random() - 0.5);
              case 'danmaku':
                  return videos.slice().sort((a, b) => {
                      const aDanmaku = a.danmakuCount || (window.DanmakuCounter ? window.DanmakuCounter.get(a.name) : 0);
                      const bDanmaku = b.danmakuCount || (window.DanmakuCounter ? window.DanmakuCounter.get(b.name) : 0);
                      return bDanmaku - aDanmaku;
                  });
              default:
                  return videos.slice();
          }
      }

      async function renderSinglePlaylistVideos(playlist) {
        const container = document.getElementById('playlistViewContent');
        if (!container) {
          console.error('playlistViewContent not found');
          return;
        }

        container.innerHTML = '';

        if (!playlist || !playlist.videos || playlist.videos.length === 0) {
            container.innerHTML = `
                <div class="playlist-view-header">
                    <div class="playlist-header-info">
                        <h1 data-i18n="playlists.playlistNotFound">–ü–ª–µ–π–ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç</h1>
                        <div class="playlist-view-meta" data-i18n="playlists.noVideos">–í —ç—Ç–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ –Ω–µ—Ç –≤–∏–¥–µ–æ.</div>
                    </div>
                    <a href="#" class="back-to-main-link" onclick="if(document.referrer && document.referrer !== window.location.href) { window.location.href = document.referrer; } else { window.location.href = 'youvi_playlists_list.html'; } return false;"><span data-i18n="playlists.back">< –ù–∞–∑–∞–¥</span></a>
                </div>
                <div class="empty-state" data-i18n="playlists.noVideos">–í —ç—Ç–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ –Ω–µ—Ç –≤–∏–¥–µ–æ.</div>
            `;
            return;
        }

        document.title = `${playlist.title} | Youvi`;

        const filteredVideos = playlist.videos.filter(video => 
          getFileNameWithoutExtension(video.name).toLowerCase().includes(currentSearchTerm.toLowerCase())
        );

        const sortedVideos = sortVideos(filteredVideos);
        const totalVideos = sortedVideos.length;
        const totalPages = Math.ceil(totalVideos / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalVideos);
        const videosToRender = sortedVideos.slice(start, end);

        container.innerHTML = `
            <div class="playlist-view-header">
                <div class="playlist-header-info">
                    <h1>${escapeHtml(playlist.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h1>
                    <div class="playlist-view-meta">
                        ${totalVideos} ${i18n.t('playlists.videoCount')} ‚Ä¢ ${playlist.channelName ? `${i18n.t('playlists.channel')}: <a href="youvi_ch_view.html?channel=${encodeURIComponent(playlist.channelName)}" class="playlist-channel-link">${escapeHtml(playlist.channelName)}</a>` : i18n.t('playlists.collection')}
                    </div>
                    ${playlist.categories && playlist.categories.length > 0 ? 
                        `<div class="playlist-view-categories">${i18n.t('playlists.categories')}: ${playlist.categories.map(c => `<span class="category-tag">${escapeHtml(c)}</span>`).join(', ')}</div>` 
                        : ''}
                </div>
                <a href="#" class="back-to-main-link" onclick="if(document.referrer && document.referrer !== window.location.href) { window.location.href = document.referrer; } else { window.location.href = 'youvi_playlists_list.html'; } return false;"><span data-i18n="playlists.back">${i18n.t('playlists.back')}</span></a>
            </div>
            <div class="playlist-view-grid">
                <!-- Video cards will go here -->
            </div>
        `;

        const videoGrid = container.querySelector('.playlist-view-grid');
        const previewTasks = [];

        if (videosToRender.length > 0) {
            log(`? Loading handles for ${videosToRender.length} visible videos...`);
            await batchLoadVideoHandles(videosToRender, 5);
            
            const videosWithNumbers = videosToRender.map((video, idx) => {
                return {
                    ...video,
                    playlistNumber: start + idx + 1,
                    playlistUrl: window.VideoID 
                        ? window.VideoID.buildVideoUrl(video.name, playlist.id)
                        : `youvi_video.html?name=${encodeURIComponent(video.name)}&playlist=${encodeURIComponent(playlist.id || '')}`,
                    playlistCategories: playlist.categories,
                    quality: video.quality || getVideoQuality(video)
                };
            });

            if (typeof renderVideoGrid === 'function') {
                renderVideoGrid(videoGrid, videosWithNumbers, YouViCardsPresets.playlist);

                setTimeout(() => {
                    if (typeof addHoverPreview === 'function') {
                        log('addHoverPreview function is available');
                        videosWithNumbers.forEach((video, index) => {
                            const card = videoGrid.children[index];
                            if (card) {

                                const thumbnail = card.querySelector('.video-thumbnail');
                                const thumbnailLink = card.querySelector('a.video-thumbnail');
                                const videoLink = card.querySelector('a[href*="youvi_video.html"]');
                                const targetElement = thumbnailLink || videoLink || thumbnail;
                                
                                if (targetElement) {

                                    const videoData = {
                                        ...video,
                                        file: video.file,
                                        handle: video.handle,
                                        dirHandle: video.dirHandle
                                    };
                                    
                                    log(`Adding hover preview for video: ${video.name}`, {
                                        hasFile: !!videoData.file,
                                        hasHandle: !!videoData.handle,
                                        hasDirHandle: !!videoData.dirHandle,
                                        targetElement: targetElement.tagName + (targetElement.className ? '.' + targetElement.className : ''),
                                        targetHref: targetElement.href
                                    });
                                    
                                    addHoverPreview(targetElement, videoData);
                                } else {
                                    console.warn(`No thumbnail element found for card ${index}`, card.innerHTML);
                                }
                            }
                        });
                    } else {
                        console.warn('addHoverPreview function not available, previews disabled');
                    }
                }, 100);

                const previewTasks = [];
                videosWithNumbers.forEach((video, idx) => {
                    const cardThumbnail = videoGrid.children[idx]?.querySelector('.video-thumbnail');
                    if (cardThumbnail) {
                        previewTasks.push(createVideoCardPreviewTask(video, cardThumbnail, start + idx));
                    }
                });
                
                if (previewTasks.length > 0) {
                    await parallelLimit(previewTasks, 3);
                }
            } else {
                console.error('renderVideoGrid function not found - cards module not loaded');
                videoGrid.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤–∏–¥–µ–æ</div>';
            }
        } else {
            videoGrid.innerHTML = `<div class="empty-state" style="padding: 20px; font-size: 14px;">${i18n.t('playlists.noVideos')}</div>`;
        }
        renderPagination(totalPages);
      }

      function getVideoQuality(video) {

          if (video.quality) {
              return video.quality;
          }

          const name = video.name.toLowerCase();
          if (name.includes('4k') || name.includes('2160p') || name.includes('uhd')) {
              return '4K';
          } else if (name.includes('1080p') || name.includes('fhd')) {
              return '1080p';
          } else if (name.includes('720p') || name.includes('hd')) {
              return '720p';
          } else if (name.includes('480p') || name.includes('sd')) {
              return '480p';
          }

          if (video.size) {
              const sizeInMB = video.size / (1024 * 1024);
              if (sizeInMB > 1000) return '4K';
              if (sizeInMB > 500) return '1080p';
              if (sizeInMB > 200) return '720p';
              if (sizeInMB > 50) return '480p';
          }

          return 'SD';
      }

      function toggleVideoBadges() {
          const body = document.body;
          const isHidden = body.classList.contains('badges-hidden');
          
          if (isHidden) {
              body.classList.remove('badges-hidden');
              localStorage.setItem('youvi-badges-hidden', 'false');
          } else {
              body.classList.add('badges-hidden');
              localStorage.setItem('youvi-badges-hidden', 'true');
          }
      }

      function initBadgeVisibility() {
          const shouldHide = localStorage.getItem('youvi-badges-hidden') === 'true';
          if (shouldHide) {
              document.body.classList.add('badges-hidden');
          }
      }

      document.addEventListener('DOMContentLoaded', function() {
          initBadgeVisibility();
      });

      function createPaginationButton(text, page){
        const btn = document.createElement('button');
        btn.className = 'btn pagination-btn';
        btn.textContent = text;
        btn.addEventListener('click', ()=>{
          currentPage = page;
          renderSinglePlaylistVideos(currentPlaylist);
          const url = new URL(window.location.href);
          url.searchParams.set('page', page);
          window.history.pushState({ page: page }, '', url.toString());

          document.getElementById('playlistViewContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        return btn;
      }

      function renderPagination(totalPages){
        const container = document.getElementById('paginationContainer');
        if (totalPages <= 1){ container.innerHTML = ''; return; }

        const pag = document.createElement('div');
        pag.className = 'pagination';

        const info = document.createElement('div');
        info.className = 'pagination-info';
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, currentPlaylist.videos.length);
        const ofTxt = typeof i18n !== 'undefined' ? i18n.t('main.of', '–∏–∑') : '–∏–∑';
        const pageTxt = typeof i18n !== 'undefined' ? i18n.t('main.page', '—Å—Ç—Ä.') : '—Å—Ç—Ä.';
        info.textContent = `${startItem}-${endItem} ${ofTxt} ${currentPlaylist.videos.length} (${pageTxt} ${currentPage} ${ofTxt} ${totalPages})`;
        pag.appendChild(info);

        if (currentPage > 1) pag.appendChild(createPaginationButton(`‚Üê ${i18n.t('pagination.prev')}`, currentPage - 1));

        const maxVisible = 5;
        let s = Math.max(1, currentPage - Math.floor(maxVisible/2));
        let e = Math.min(totalPages, s + maxVisible - 1);
        if (e - s + 1 < maxVisible) s = Math.max(1, e - maxVisible + 1);

        if (s > 1){
          pag.appendChild(createPaginationButton('1', 1));
          if (s > 2) pag.appendChild(document.createTextNode(' ... '));
        }
        for (let i=s;i<=e;i++){
          const b = createPaginationButton(String(i), i);
          if (i === currentPage) b.classList.add('active');
          pag.appendChild(b);
        }
        if (e < totalPages){
          if (e < totalPages - 1) pag.appendChild(document.createTextNode(' ... '));
          pag.appendChild(createPaginationButton(String(totalPages), totalPages));
        }

        if (currentPage < totalPages) pag.appendChild(createPaginationButton(`${i18n.t('pagination.next')} ‚Üí`, currentPage + 1));

        container.innerHTML = '';
        container.appendChild(pag);
      }

      function getFileNameWithoutExtension(name){ return name.replace(/\.[^/.]+$/,''); }
      function formatFileSize(b){ if (b<1024) return b+' B'; if (b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
      function formatDuration(sec){
        if (!isFinite(sec)||isNaN(sec)||sec<=0) return '0:00';
        const s = Math.round(sec);
        const h = Math.floor(s/3600);
        const m = Math.floor((s%3600)/60);
        const ss = String(s%60).padStart(2,'0');
        return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${ss}` : `${m}:${ss}`;
      }
      
      function escapeHtml(text){ const d=document.createElement('div'); d.textContent = text ?? ''; return d.innerHTML; }
      function getViewsText(count){
        const n = Math.abs(Number(count)||0) % 100; const n1 = n % 10;

        const lang = (typeof i18n !== 'undefined' && i18n.currentLang) ? i18n.currentLang : 'ru';

        if (lang === 'en') {
          return 'views';
        }

        if (lang === 'uk') {
          if (n>10 && n<20) return '–ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤';
          if (n1===1) return '–∏–∑–∏–∑–∏–∑–∏–∑';
          if (n1>=2 && n1<=4) return '–≤–∏–¥–µ–æ';
          return '–≤–∏–¥–µ–æ';
        }

        if (n>10 && n<20) return '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤';
        if (n1===1) return '–∏–∑–∏–∑–∏–∑–∏–∑';
        if (n1>=2 && n1<=4) return '–ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
        return '–∏–∑–∏–∑–∏–∑–∏–∑–∏–∑';
      }

      function getVideoChannelFromTags(video) {
        if (!video.tags || !Array.isArray(video.tags)) return null;

        const channelTag = video.tags.find(tag => 
          typeof tag === 'string' && tag.toLowerCase().includes('(–∫–∞)')
        );
        
        if (channelTag) {

          return channelTag.replace(/\s*\(–∫–∞\)\s*$/i, '').trim();
        }
        
        return null;
      }

      function showSkeletonLoading() {
        const container = document.getElementById('playlistViewContent');
        if (!container) return;
        
        let skeletonHTML = `
          <div class="playlist-view-header" style="padding:0 20px">
            <div class="playlist-header-info">
              <div class="skeleton-line" style="width:200px;height:32px;margin-bottom:8px"></div>
              <div class="skeleton-line" style="width:100px;height:16px"></div>
            </div>
          </div>
          <div class="video-grid" style="padding:0 20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">
        `;
        for (let i = 0; i < 20; i++) {
          skeletonHTML += `
            <div class="video-card skeleton-item">
              <div class="skeleton-thumb" style="width:100%;aspect-ratio:16/9;border-radius:6px"></div>
              <div class="video-info" style="padding:8px 5px">
                <div class="skeleton-line" style="width:90%;height:14px;margin-bottom:6px"></div>
                <div class="skeleton-line" style="width:60%;height:12px"></div>
              </div>
            </div>
          `;
        }
        skeletonHTML += '</div>';
        container.innerHTML = skeletonHTML;
      }
      
      function hideSkeletonLoading() {
        const skeletons = document.querySelectorAll('.skeleton-item');
        skeletons.forEach(s => s.remove());
      }

      async function loadPlaylistFromCache(playlistId) {
        try {
          const cachedPlaylists = await getPlaylistsFromDB();
          const cached = cachedPlaylists.find(p => String(p.id) === playlistId);
          if (cached) {
            log(`? Found playlist "${cached.title}" in cache`);

            const cachedVideos = await getVideosFromDB();
            const videoMap = new Map(cachedVideos.map(v => [v.name, v]));
            
            const enrichedVideos = (cached.videos || []).map(v => {
              const cachedVideo = videoMap.get(v.name);
              if (cachedVideo) {
                return {
                  ...v,
                  ...cachedVideo,
                  handle: null,
                  file: null,
                  dirHandle: null
                };
              }
              return { ...v, handle: null, file: null, dirHandle: null };
            });
            
            return {
              ...cached,
              videos: enrichedVideos
            };
          }
        } catch (e) {
          console.error('Error loading playlist from cache:', e);
        }
        return null;
      }

      async function attachHandlesToPlaylistVideos(playlist) {
        if (!playlist || !playlist.videos || playlist.videos.length === 0) return playlist;
        
        log('?? Attaching file handles to playlist videos...');
        const startTime = performance.now();
        const exts = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.m4v'];
        const videoNames = new Set(playlist.videos.map(v => v.name));
        const foundHandles = new Map();
        
        async function scan(dir, path = '') {
          try {
            for await (const [name, handle] of dir.entries()) {
              if (handle.kind === 'file' && videoNames.has(name)) {
                try {
                  const file = await handle.getFile();
                  foundHandles.set(name, { handle, file, dirHandle: dir });
                } catch (e) { }
              } else if (handle.kind === 'directory' && !name.startsWith('.')) {
                await scan(handle, path + '/' + name);
              }
            }
          } catch (e) { }
        }
        
        await scan(videoDirectoryHandle);

        playlist.videos.forEach(video => {
          const found = foundHandles.get(video.name);
          if (found) {
            video.handle = found.handle;
            video.file = found.file;
            video.dirHandle = found.dirHandle;
          }
        });
        
        log(`? Attached handles to ${foundHandles.size}/${playlist.videos.length} videos in ${Math.round(performance.now() - startTime)}ms`);
        return playlist;
      }

      function loadVisibleVideoPreviews() {
        log('??? Loading previews for visible videos...');
        const container = document.getElementById('playlistViewContent');
        if (!container) return;
        
        const videoCards = container.querySelectorAll('.video-card');
        log(`Found ${videoCards.length} video cards`);
        
        videoCards.forEach(card => {
          const videoName = card.dataset.videoName;
          if (!videoName) return;
          
          const thumbEl = card.querySelector('.video-thumbnail');
          if (!thumbEl || thumbEl.querySelector('img')) return;

          const video = currentPlaylist?.videos?.find(v => v.name === videoName);
          if (video && video.file) {
            getPreviewAndDuration(video).then(({preview, duration}) => {

              const img = document.createElement('img');
              img.src = preview;
              img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0';
              thumbEl.insertBefore(img, thumbEl.firstChild);

              const durationEl = card.querySelector('.video-duration');
              if (durationEl && duration) {
                durationEl.textContent = duration;
              }
            }).catch(() => { });
          }
        });
      }

      document.addEventListener('DOMContentLoaded', async ()=>{

        const langSwitcher = document.getElementById('langSwitcher');
        if (langSwitcher && typeof i18n !== 'undefined') {

          langSwitcher.value = i18n.getCurrentLanguage();

          langSwitcher.addEventListener('change', async (e) => {
            await i18n.setLanguage(e.target.value);

            window.location.reload();
          });
        }
        
        if (!supportsFS){
          document.getElementById('playlistViewContent').innerHTML = '<div class="empty-state" style="color:red"><strong>File System API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge.</strong></div>';
          return;
        }
        try{
          const startTime = performance.now();

          showSkeletonLoading();
          
          db = await openDB();
          const savedHandle = await getFromDB('videoDirectoryHandle');
          if (savedHandle){
            const perm = await savedHandle.queryPermission();
            if (perm === 'granted' || (perm === 'prompt' && await savedHandle.requestPermission() === 'granted')){
              videoDirectoryHandle = savedHandle;
              window.videoDirectoryHandle = savedHandle;

              // Load danmaku counts BEFORE rendering
              if (window.DanmakuCounter) {
                await window.DanmakuCounter.load(videoDirectoryHandle, null);
              }

              renderSubscribedChannelsList();

              setTimeout(async () => {
                try {
                  const searchInput = document.getElementById('globalSearch');
                  if (searchInput && typeof AutocompleteIntegration !== 'undefined' && typeof YouviAutocomplete !== 'undefined') {
                    const { videos, playlists } = typeof AutocompleteDataLoader !== 'undefined' 
                        ? await AutocompleteDataLoader.loadData() 
                        : { videos: allVideos || [], playlists: [] };

                    const cacheValid = await window.autocompleteCache.isCacheValid(
                      videos.length,
                      playlists.length
                    );

                    const autocompleteIntegration = new AutocompleteIntegration();
                    await autocompleteIntegration.init(searchInput, {
                      videoDirectoryHandle: videoDirectoryHandle,
                      allVideos: cacheValid ? [] : videos,
                      allPlaylists: cacheValid ? [] : playlists
                    });
                    log('[Autocomplete] ? Initialized on youvi_playlists_view.html');
                  }
                } catch (error) {
                  console.error('[Autocomplete] Failed to initialize:', error);
                }
              }, 200);

              const urlParams = new URLSearchParams(window.location.search);
              const playlistId = urlParams.get('playlistId');
              const folderParam = urlParams.get('folder');
              const pageParam = urlParams.get('page');
              const searchTermParam = urlParams.get('search');

              if (pageParam && !isNaN(pageParam) && parseInt(pageParam) > 0) {
                currentPage = parseInt(pageParam);
              }

              if (searchTermParam) {
                currentSearchTerm = decodeURIComponent(searchTermParam);
                document.getElementById('globalSearch').value = currentSearchTerm;
              }

              if (playlistId) {

                let cachedPlaylist = await loadPlaylistFromCache(playlistId);
                
                if (cachedPlaylist && cachedPlaylist.videos && cachedPlaylist.videos.length > 0) {

                  currentPlaylist = cachedPlaylist;

                  await renderSinglePlaylistVideos(currentPlaylist);
                  log(`? Displayed cached playlist in ${Math.round(performance.now() - startTime)}ms`);

                  setTimeout(() => {
                    attachHandlesToPlaylistVideos(currentPlaylist).then(updatedPlaylist => {
                      currentPlaylist = updatedPlaylist;
                      log(`? File handles attached`);
                    });
                  }, 100);
                } else {

                  log('?? No cache found, loading from filesystem...');
                  currentPlaylist = await loadAllPlaylistsForSingleView(playlistId);
                  await renderSinglePlaylistVideos(currentPlaylist);
                  log(`? Loaded playlist from filesystem in ${Math.round(performance.now() - startTime)}ms`);
                }

                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                document.getElementById(`sort${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`).classList.add('active');
              } else if (folderParam) {

                const folderName = decodeURIComponent(folderParam);
                const folderVideos = allVideos.filter(v => v.dirHandle && v.dirHandle.name === folderName);
                currentPlaylist = {
                  id: null,
                  title: folderName,
                  channelName: null,
                  categories: [],
                  videos: folderVideos
                };
                renderSinglePlaylistVideos(currentPlaylist);

                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                document.getElementById(`sort${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`).classList.add('active');
              } else {
                document.getElementById('playlistViewContent').innerHTML = `
                  <div class="playlist-view-header">
                    <div class="playlist-header-info">
                      <h1 data-i18n="playlists.playlistNotSpecified">–ü–ª–µ–π–ª–∏—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω.</h1>
                    </div>
                    <a href="#" class="back-to-main-link" onclick="if(document.referrer && document.referrer !== window.location.href) { window.location.href = document.referrer; } else { window.location.href = 'youvi_playlists_list.html'; } return false;"><span data-i18n="playlists.back">< –ù–∞–∑–∞–¥</span></a>
                  </div>
                  <div class="empty-state"><strong data-i18n="playlists.playlistNotSpecified">–ü–ª–µ–π–ª–∏—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω.</strong></div>
                `;
              }

              document.getElementById('sortDefault').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'default';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });
              document.getElementById('sortNew').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'new';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });
              document.getElementById('sortPopular').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'popular';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });
              document.getElementById('sortOld').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'old';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });
              document.getElementById('sortAlphabetical').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'alphabetical';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });
              document.getElementById('sortRandom').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'random';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });
              document.getElementById('sortDanmaku').addEventListener('click', (e) => {
                e.preventDefault();
                currentSort = 'danmaku';
                currentPage = 1;
                renderSinglePlaylistVideos(currentPlaylist);
                document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
              });

              const badgesToggle = document.getElementById('badgesToggle');
              if (badgesToggle) {
                badgesToggle.addEventListener('click', (e) => {
                  e.preventDefault();
                  toggleVideoBadges();
                });
              }

              const headerSearchInput = document.getElementById('globalSearch');
              const headerSearchBtn = document.getElementById('doSearch');

              if (headerSearchBtn) {
                  headerSearchBtn.addEventListener('click', (e) => {
                      e.preventDefault();
                      const q = (headerSearchInput?.value||'').trim();
                      const params = new URLSearchParams();
                      if (q) params.set('q', q);
                      params.set('type', 'playlists');
                      window.location.href = `youvi_search.html?${params.toString()}`;
                  });
              }

              if (headerSearchInput) {
                  headerSearchInput.addEventListener('keypress', (e) => {
                      if (e.key === 'Enter') {
                          e.preventDefault();
                          const q = (e.target.value||'').trim();
                          const params = new URLSearchParams();
                          if (q) params.set('q', q);
                          params.set('type', 'playlists');
                          window.location.href = `youvi_search.html?${params.toString()}`;
                      }
                  });
              }

            }else{
              document.getElementById('playlistViewContent').innerHTML = `<div class="empty-state"><strong>${i18n.t('playlists.noFolderAccess')}</strong></div>`;
            }
          }else{
            document.getElementById('playlistViewContent').innerHTML = `<div class="empty-state"><strong>${i18n.t('playlists.selectFolderFirst')}</strong></div>`;
          }
        }catch(e){
          console.error('FS access error', e);
          document.getElementById('playlistViewContent').innerHTML = '<div class="empty-state" style="color:red"><strong>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–ª–µ–π–ª–∏—Å—Ç—É</strong></div>';
        }
      });

      function searchByTag(tag) {


          log('Search by tag:', tag);

      }

      
      async function loadImageFile(dirHandle, name) {
        try {
          const fileHandle = await dirHandle.getFileHandle(name);
          const file = await fileHandle.getFile();
          return URL.createObjectURL(file);
        } catch (e) {
          return null;
        }
      }

      async function loadSubscriptionsFromFile() {
          try {
              const localSubscriptions = localStorage.getItem('8site_subscriptions');
              if (localSubscriptions && localSubscriptions !== 'null' && localSubscriptions !== 'undefined') {
                  const parsed = JSON.parse(localSubscriptions);
                  if (Array.isArray(parsed)) {
                      return parsed;
                  }
              }

              if (videoDirectoryHandle) {
                  try {
                      const subscriptionsFile = await videoDirectoryHandle.getFileHandle('.subscriptions.json');
                      const file = await subscriptionsFile.getFile();
                      const text = await file.text();
                      const fileSubscriptions = JSON.parse(text);

                      if (Array.isArray(fileSubscriptions)) {
                          localStorage.setItem('8site_subscriptions', JSON.stringify(fileSubscriptions));
                          return fileSubscriptions;
                      }
                  } catch (fileError) {
                      log('Could not load from file:', fileError.message);
                  }
              }

              return [];
          } catch (e) {
              console.error('Error loading subscriptions:', e);
              return [];
          }
      }

      async function renderSubscribedChannelsList() {
        const sidebarContainer = document.getElementById('subscribedChannelsContainer');
        if (!sidebarContainer) return;

        try {
          const savedSubscriptions = await loadSubscriptionsFromFile();
          const subscribedChannels = Array.isArray(savedSubscriptions) ? savedSubscriptions : [];

          sidebarContainer.innerHTML = '';

          if (subscribedChannels.length === 0) {
            const noSubs = document.createElement('div');
            noSubs.className = 'sidebar-item';
            noSubs.style.fontStyle = 'italic';
            noSubs.style.color = '#999';
            noSubs.textContent = '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            sidebarContainer.appendChild(noSubs);
            return;
          }

          subscribedChannels.forEach((channelName, index) => {
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'sidebar-item';
            link.dataset.channel = channelName;
            link.id = `sidebar_channel_${index}`;
            link.style.display = 'flex';
            link.style.alignItems = 'center';
            link.style.gap = '8px';

            const avatar = document.createElement('div');
            avatar.style.cssText = `
              width: 20px;
              height: 20px;
              border-radius: 0;
              background: #ff69b4;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: bold;
              font-size: 10px;
              flex-shrink: 0;
              background-size: cover;
              background-position: center;
              background-repeat: no-repeat;
              cursor: pointer;
            `;
            avatar.textContent = channelName.charAt(0).toUpperCase();
            avatar.title = '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–Ω–∞–ª—É';

            const textSpan = document.createElement('span');
            textSpan.textContent = channelName;
            textSpan.style.overflow = 'hidden';
            textSpan.style.textOverflow = 'ellipsis';
            textSpan.style.whiteSpace = 'nowrap';
            textSpan.style.flex = '1';

            link.appendChild(avatar);
            link.appendChild(textSpan);

            avatar.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
            });

            textSpan.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
            });

            loadChannelAvatar(channelName, videoDirectoryHandle).then(avatarUrl => {
              if (avatarUrl) {
                avatar.style.backgroundImage = `url(${avatarUrl})`;
                avatar.textContent = '';
              }
            }).catch(() => {

            });

            sidebarContainer.appendChild(link);
          });
        } catch (e) {
          console.error('Error loading subscriptions:', e);
          sidebarContainer.innerHTML = '<div class="sidebar-item" style="font-style: italic; color: #999;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
      }
    </script>
    
    <!-- Autocomplete Module -->
    <link rel="stylesheet" href="youvi/autocomplete/autocomplete.css">
    <script src="youvi/autocomplete-data-loader.js"></script>
    <script src="youvi/autocomplete/autocomplete-cache.js"></script>
    <script src="youvi/autocomplete/autocomplete.js"></script>
    <script src="youvi/autocomplete/autocomplete-integration.js"></script>
    
    <!-- Video ID System -->
    <script src="youvi/video-id.js"></script>
    
    <script src="youvi/cards/cards-bundle.js"></script>
</body>
</html>