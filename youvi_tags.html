<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n-title="tags.pageTitle">Теги | Youvi</title>
  <script>
   
    (function() {
      var theme = localStorage.getItem('youvi-theme');
      var sidebar = localStorage.getItem('sidebarCollapsed');
      
      var htmlClasses = [];
      if (theme === 'dark') htmlClasses.push('dark-theme');
      else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
      if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
      if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
    })();
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #111;
    }

    .sidebar-collapsed .sidebar,
    html.sidebar-collapsed .sidebar {
      width: 60px !important;
      padding: 10px 8px !important;
      display: block !important; 
      position: sticky !important;
      top: 40px !important; 
      max-height: calc(var(--sidebar-max-height, 100vh) - 75px) !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
    }

    .sidebar-collapsed .sidebar-title,
    html.sidebar-collapsed .sidebar-title {
      display: none !important;
    }

    .sidebar-collapsed .sidebar-item,
    html.sidebar-collapsed .sidebar-item {
      padding: 8px !important;
      padding-left: 5px !important;
      padding-right: 8px !important;
      justify-content: center !important;
      border-left: 3px solid transparent !important;
      border-radius: 4px;
      font-size: 0 !important;
    }

    .sidebar-collapsed .sidebar-item:hover,
    html.sidebar-collapsed .sidebar-item:hover {
      background: rgba(255, 105, 180, 0.1);
    }

    .sidebar-collapsed .sidebar-item.active,
    html.sidebar-collapsed .sidebar-item.active {
      background: rgba(255, 105, 180, 0.15);
    }

    .sidebar-collapsed .sidebar-item svg,
    .sidebar-collapsed .sidebar-item img,
    html.sidebar-collapsed .sidebar-item svg,
    html.sidebar-collapsed .sidebar-item img {
      margin: 0 !important;
      width: 20px !important;
      height: 20px !important;
      font-size: 16px !important;
    }

    .sidebar-collapsed .library-item,
    .sidebar-collapsed .nav-item,
    html.sidebar-collapsed .library-item,
    html.sidebar-collapsed .nav-item {
      justify-content: center !important;
      gap: 0 !important;
    }

    .sidebar-collapsed .library-item span,
    .sidebar-collapsed .nav-item span,
    html.sidebar-collapsed .library-item span,
    html.sidebar-collapsed .nav-item span {
      display: none !important;
    }

    .sidebar-collapsed .library-item svg,
    .sidebar-collapsed .nav-item svg,
    html.sidebar-collapsed .library-item svg,
    html.sidebar-collapsed .nav-item svg {
      margin: 0 !important;
    }

    .sidebar-collapsed .container,
    html.sidebar-collapsed .container {
      padding-left: 20px;
    }

    .sidebar-collapsed .main-content,
    html.sidebar-collapsed .main-content {
      margin-left: 0;
    }
    
    .sidebar-collapsed .content-wrapper,
    html.sidebar-collapsed .content-wrapper {
      max-width: 1500px;
    }

    .sidebar-collapsed .nav-links {
      display: none;
    }

    .container {
      width: 100%;
      margin: 0;
      padding: 0 20px 0 20px;
      display: flex;
      gap: 20px;
      align-items: stretch;
      min-height: calc(100vh - 200px);
    }
    
    .content-wrapper {
      display: flex;
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      gap: 20px;
    }

    .footer-content {
      max-width: 1600px !important;
      margin: 0 auto !important;
      padding: 0 20px !important;
    }

    .top-nav {
      background: #d94b88;
      border-bottom: 1px solid #c2185b;
      padding: 4px 0;
    }

    .top-nav-content {
      max-width: none !important;
      margin: 0 !important;
      padding: 0 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .top-nav a {
      color: #fff;
      text-decoration: none;
      font-size: 12px;
      padding: 2px 0;
      transition: color 0.2s;
    }

    .top-nav a:hover {
      color: #ffd6ea;
    }

    .top-nav a.active {
      color: #ffd6ea;
      font-weight: 600;
    }

    .lang-switcher {
      margin-left: auto;
    }
    
    .lang-select {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      outline: none;
    }
    
    .lang-select:hover {
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .lang-select option {
      background: #d94b88;
      color: #fff;
    }

    .header-content-wrapper {
      max-width: none !important;
      margin: 0 !important;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

.btn{
  padding:4px 8px;
  border-radius:8px;
  background:linear-gradient(180deg,#fff,#ffd6ea);
  border:1px solid rgba(0,0,0,0.06);
  cursor:pointer;
  font-weight:700;
  text-decoration:none;
  color:inherit;
  display:inline-block;
  font-size:12px;
  font-family: Verdana, Geneva;
}
.btn.active{
  background:linear-gradient(180deg,var(--accent),var(--accent-dark));
  color:#fff;
}

    .banner-section {
      background: center/cover no-repeat;
      margin: 0 0 0 0;
      overflow: hidden;
      height: 200px;
    }

    .pink-divider {
      height: 3px;
      background: linear-gradient(90deg, #ff69b4, #d94b88, #ff69b4);
      margin: 0 0 5px 0;
    }

.tag-cloud-full{
  margin: 0;
  padding: 0;
  background: #f8f8f8;
  min-height:300px;
  flex: 1;
  border-radius: 0;
}

.tag-cloud-full h2{
  margin:0 0 16px 0;
  padding: 20px 10px 0 10px;
  font-size:20px;
  color:#111;
}

#tagsWrap {
  padding: 0 10px 20px 10px;
}

.tag-section {
  margin-bottom: 25px;
}

.tag-section-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 10px;
  padding: 8px 12px;
  background: #f0f0f0;
  border-radius: 6px;
  border-left: 4px solid #ff69b4;
}

.tag-section-content {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 5px 0;
}

.tag {
  display: inline-flex;
  align-items: center;
  border-radius: 6px;
  padding: 5px 10px;
  font-size: 12px;
  color: #fff !important;
  text-decoration: none !important;
  transition: all 0.2s;
  font-weight: 500;
  border: none;
  cursor: pointer;
  position: relative;
}

.tag:hover {
  opacity: 0.9;
}

.tag-text {
  flex: 1;
}

.tag-edit-icon {
  display: none;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.3);
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
  margin-left: 4px;
  position: relative;
  z-index: 100;
}

.tag:hover .tag-edit-icon {
  display: inline-flex;
}

.tag-edit-icon:hover {
  background: rgba(0, 0, 0, 0.5) !important;
  transform: scale(1.2);
}

.tag-edit-icon svg {
  color: #fff;
  pointer-events: none;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
}

body.dark-theme .tag-section-title {
  background: #2a2a2a;
  color: #fff;
  border-left-color: #ff69b4;
}

body.dark-theme .tag-cloud-full {
  background: #1a1a1a;
}

body.dark-theme .tag-cloud-full h2 {
  color: #fff;
}

body.dark-theme .empty-state {
  color: #ccc;
}

body.dark-theme #accessStatus {
  color: #ccc;
}

body.dark-theme #tagSearchBox {
  background: #2a2a2a;
  border-color: #444;
  color: #fff;
}

body.dark-theme #tagSearchBox::placeholder {
  color: #999;
}

body.dark-theme #clearTagSearch {
  background: #333 !important;
  border-color: #555 !important;
  color: #fff !important;
}

body.dark-theme #clearTagSearch:hover {
  background: #444 !important;
}

.empty-state{
  text-align:center;
  color:#666;
  margin-top:40px;
  font-size:14px;
  padding: 0 10px;
}

#accessStatus{
  margin-top:16px;
  padding: 0 10px;
  color:#666;
  color:#666;
  font-size:13px;
  text-align:center;
}

#videoCounter {
  text-align: center;
  margin: 10px 0 20px 0;
  padding: 10px;
}

#counterDigits {
  display: inline-flex;
  gap: 2px;
}

#counterDigits img {
  height: 40px;
  width: auto;
  display: block;
}

.footer {
  background: #2c2c2c;
  color: #fff;
  padding: 25px 0 15px 0;
  margin-top: 0;
}

.footer-content {
  max-width: 1600px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  gap: 30px;
  align-items: flex-start;
}

.footer-logo {
  flex-shrink: 0;
  width: 200px;
}

.footer-logo img {
  height: 40px;
  width: auto;
}

.footer-logo p {
  margin-top: 8px;
  font-size: 11px;
  color: #ccc;
  line-height: 1.3;
}

.footer-sections {
  display: flex;
  gap: 30px;
  flex: 1;
}

.footer-main {
  display: flex;
  gap: 30px;
  flex: 1;
}

.footer-right {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.footer-mascot {
  flex-shrink: 0;
}

.footer-mascot img {
  height: 180px;
  width: auto;
}

.footer-section {
  flex: 1;
}

.footer-section h3 {
  font-size: 13px;
  margin-bottom: 10px;
  color: #fff;
  font-weight: 600;
}

.footer-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.footer-section li {
  margin-bottom: 6px;
}

.footer-section a {
  color: #ccc;
  text-decoration: none;
  font-size: 11px;
  transition: color 0.2s;
}

.footer-section a:hover {
  color: #ff69b4;
}

.footer-bottom {
  border-top: 1px solid #444;
  margin-top: 20px;
  padding-top: 15px;
  text-align: center;
  color: #999;
  font-size: 10px;
}

        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
            
            .footer-content {
                max-width: 1700px !important;
            }
        }

        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
            
            .footer-content {
                max-width: 1800px !important;
            }
        }

        @media (max-width: 1200px) {
            .video-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            .playlists-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            .latest-grid {
                grid-template-columns: repeat(var(--latest-cols, 5), 1fr);
            }
            .video-carousel {
                grid-template-columns: repeat(var(--latest-cols, 5), 1fr);
            }
        }

        @media (max-width: 1000px) {
            .video-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            .playlists-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            .latest-grid {
                grid-template-columns: repeat(var(--latest-cols, 4), 1fr);
            }
            .video-carousel {
                grid-template-columns: repeat(var(--latest-cols, 4), 1fr);
            }
        }

@media (max-width: 768px) {
  .banner-section {
    height: 140px;
    margin: 0 5px 3px 5px;
  }
  
  .footer-content {
    flex-direction: column;
    gap: 30px;
  }
  
  .footer-sections {
    flex-direction: column;
    gap: 20px;
  }
  
  .footer-main {
    flex-direction: column;
    gap: 20px;
  }
  
  .footer-right {
    width: 100%;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-top: 15px;
  }
  
  .footer-mascot img {
    height: 120px;
  }
  
  .footer-section {
    text-align: center;
  }
}

@media (max-width: 480px) {
  .banner-section {
    height: 110px;
    margin: 0 3px 2px 3px;
  }
  
  .container {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100% !important;
  }
}

.sidebar {
  padding-top: 0 !important;
  padding-bottom: 20px !important;
  margin-top: 0 !important;
}

.sidebar-section:first-child {
  margin-top: 10px;
}

.sidebar-collapsed .sidebar-section:first-child,
html.sidebar-collapsed .sidebar-section:first-child {
  margin-top: 0;
}

body.dark-theme input.search-input {
  background: #4a3a34 !important;
  color: #fff !important;
  border-color: #555 !important;
}

body.dark-theme input.search-input::placeholder {
  color: #999 !important;
}
  </style>
  <link rel="stylesheet" href="youvi/header/youvi-header.css">
  <style>
    body.dark-theme #headerSearchInput.search-input {
      background: #4a3a34 !important;
      color: #fff !important;
      border-color: #555 !important;
    }
    
    body.dark-theme #headerSearchInput.search-input::placeholder {
      color: #999 !important;
    }
  </style>
  <link rel="stylesheet" href="youvi/tag-types/tag-types.css">
  <link rel="stylesheet" href="youvi/sidebar.css">
  <link rel="stylesheet" href="youvi/sidebar-scroll.css">
  <link rel="stylesheet" href="youvi/themes/dark-theme.css">
  <link rel="stylesheet" href="youvi/themes/theme-dropdown.css">
  <link rel="icon" href="favicon/youvi/favicon.ico" type="image/x-icon">
</head>
<body>
  <div class="top-nav">
    <div class="top-nav-content">
      <a href="youvi_main.html" class="active" data-i18n="nav.video">Видео</a>
      <a href="index.html" data-i18n="nav.management">Управление</a>
      <a href="youvi_ch_list.html" data-i18n="nav.channels">Каналы</a>
      <a href="youvi_playlists_list.html" data-i18n="nav.playlists">Плейлисты</a>
      <a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a> 
      <a href="wiki/index.html" data-i18n="nav.wiki">Wiki</a>
      <div class="lang-switcher">
        <select id="langSwitcher" class="lang-select">
          <option value="ru">🇷🇺 RU</option>
          <option value="en">🇬🇧 EN</option>
          <option value="uk">🇺🇦 UK</option>
        </select>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-content-wrapper">
      <div class="header-left">
        <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
        
        <div class="logo">
          <a href="youvi_main.html">
            <img src="images/logo_youvi_ind.png" alt="Youvi logo">
          </a>
        </div>
      </div>
      
      <div class="header-center">
        <div class="search-area autocomplete-wrapper">
          <input type="text" id="headerSearchInput" placeholder="Поиск видео..." class="search-input" data-i18n-placeholder="search.placeholder">
          <button id="doSearch" class="search-btn" data-i18n="search.button">Найти</button>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-actions">
        
          <div class="settings-container">
            <a href="#" class="settings-btn">⚙</a>
            <div class="theme-dropdown">
              <button class="theme-dropdown-item" data-theme="light" data-i18n="themes.light">Белая</button>
              <button class="theme-dropdown-item" data-theme="dark" data-i18n="themes.dark">Черная</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title" data-i18n="sidebar.navigation">Навигация</div>
        <a href="youvi_main.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9,22 9,12 15,12 15,22"/>
          </svg>
          <span data-i18n="sidebar.home">Главная</span>
        </a>
        <a href="youvi_feed_all.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M4 11a9 9 0 0 1 9 9"/>
            <path d="M4 4a16 16 0 0 1 16 16"/>
            <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </svg>
          <span data-i18n="sidebar.feed">Feed</span>
        </a>
                <a href="youvi_tags.html" class="sidebar-item nav-item active">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                     <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                 </svg>
                    <span data-i18n="sidebar.allTagsLink">Все теги</span>
                </a>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title" data-i18n="sidebar.library">Библиотека</div>
        <a href="youvi_history.html" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12,6 12,12 16,14"/>
          </svg>
          <span data-i18n="sidebar.history">История</span>
        </a>
         <a href="youvi_fav.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span data-i18n="sidebar.favorites">Избранное</span>
                </a>
                <a href="youvi_playlists_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.playlists">Плейлисты</span>
                </a>
                <a href="youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span data-i18n="sidebar.channels">Каналы</span>
                </a>
                <a href="youvi_subscriptions.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span data-i18n="sidebar.subscriptions">Подписки</span>
                </a>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">PGC</div>
        <a href="youvi_main.html?tag=Anime (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><path d="M12 2l2.5 7.5H22l-6 4.5 2.5 7.5L12 17l-6.5 4.5L8 14 2 9.5h7.5z"/></svg>
          <span data-i18n="footer.categories.anime">Anime</span>
        </a>
        <a href="youvi_main.html?tag=Animation (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          <span data-i18n="footer.categories.animation">Animation</span>
        </a>
        <a href="youvi_main.html?tag=Movies (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>
          <span data-i18n="footer.categories.movies">Movies</span>
        </a>
        <a href="youvi_main.html?tag=Series (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><rect x="2" y="4" width="20" height="4" rx="1"/><rect x="2" y="10" width="20" height="4" rx="1"/><rect x="2" y="16" width="20" height="4" rx="1"/></svg>
          <span data-i18n="footer.categories.series">Series</span>
        </a>
        <a href="youvi_main.html?tag=Music (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
          <span data-i18n="footer.categories.music">Music</span>
        </a>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">UGC</div>
        <a href="youvi_main.html?tag=Games (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><line x1="6" y1="2" x2="6" y2="6"/><line x1="18" y1="2" x2="18" y2="6"/><line x1="6" y1="18" x2="6" y2="22"/><line x1="18" y1="18" x2="18" y2="22"/><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="8" cy="12" r="2"/><circle cx="16" cy="10" r="1"/><circle cx="16" cy="14" r="1"/></svg>
          <span data-i18n="footer.categories.games">Games</span>
        </a>
        <a href="youvi_main.html?tag=Technology (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span data-i18n="footer.categories.tech">Technology</span>
        </a>
        <a href="youvi_main.html?tag=Entertainment (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
          <span data-i18n="footer.categories.entertainment">Entertainment</span>
        </a>
        <a href="youvi_main.html?tag=IRL (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span data-i18n="footer.categories.irl">IRL</span>
        </a>
        <a href="youvi_main.html?tag=TV (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17,2 12,7 7,2"/><text x="12" y="17" text-anchor="middle" font-size="8" fill="#666" font-weight="bold" stroke="none">TV</text></svg>
          <span data-i18n="footer.categories.tv">TV</span>
        </a>
        <a href="youvi_main.html?tag=Education (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          <span data-i18n="footer.categories.education">Education</span>
        </a>
        <a href="youvi_main.html?tag=Other (ct)" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
          <span data-i18n="footer.categories.random">Other</span>
        </a>
      </div>
    </aside>

    <div class="content-wrapper">
    <main class="main-content">
      <div class="tag-cloud-full">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 20px 20px 0 20px;">
          <h2 style="margin: 0; padding: 0;" data-i18n="tags.allTags">Все теги</h2>
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="text" id="tagSearchBox" placeholder="Поиск тегов..." style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-width: 200px;" data-i18n-placeholder="tags.searchPlaceholder">
            <button id="clearTagSearch" style="padding: 6px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;" data-i18n="tags.clearSearch">Очистить</button>
          </div>
        </div>

        <div id="videoCounter" style="padding: 0 20px;">
          <div id="counterDigits"></div>
        </div>

        <div id="tagsWrap" style="padding: 0 20px 20px 20px;"></div>
      </div>

      <div id="emptyState" class="empty-state" style="display:none" data-i18n="tags.noTagsFound">
        Теги не найдены.
      </div>

      <div id="accessStatus"></div>
    </main>
    </div>
  </div>   <!-- Footer -->
  
      <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-logo">
                    <img src="images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
                    <p data-i18n="footer.description">Платформа для просмотра видео контента. Сохраняйте, категоризируйте и смотрите видео.</p>
                </div>
                <div class="footer-sections">
                    <div class="footer-section">
                        <h3 data-i18n="footer.sections">Разделы</h3>
                        <ul>
                            <li><a href="youvi_main.html" data-i18n="footer.video">Видео</a></li>
                            <li><a href="youvi_tags.html" data-i18n="sidebar.tags">Теги</a></li>
                            <li><a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a></li>
                            <li><a href="index.html" data-i18n="nav.management">Управление</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="sidebar.library">Библиотека</h3>
                        <ul>
                            <li><a href="youvi_ch_list.html" data-i18n="sidebar.channels">Каналы</a></li>
                            <li><a href="youvi_playlists_list.html" data-i18n="sidebar.playlists">Плейлисты</a></li>
                            <li><a href="youvi_subscriptions.html" data-i18n="sidebar.subscriptions">Подписки</a></li>
                            <li><a href="youvi_fav.html" data-i18n="sidebar.favorites">Избранное</a></li>
                            <li><a href="youvi_history.html" data-i18n="sidebar.history">История</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="nav.wiki">Wiki</h3>
                        <ul>
                            <li><a href="wiki/index.html" data-i18n="sidebar.home">Главная</a></li>
                            <li><a href="wiki/player.html" data-i18n="footer.wiki.player">Плеер</a></li>
                            <li><a href="wiki/danmaku.html" data-i18n="footer.wiki.danmaku">Данмаку</a></li>
                            <li><a href="wiki/tags/general.html" data-i18n="sidebar.tags">Теги</a></li>
                            <li><a href="wiki/tags/rules.html" data-i18n="footer.wiki.taggingRules">Правила тегирования</a></li>
                            <li><a href="wiki/search/general.html" data-i18n="footer.wiki.search">Поиск</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.pgc">PGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Anime (ct)" data-i18n="footer.categories.anime">Anime</a></li>
                            <li><a href="youvi_main.html?tag=Animation (ct)" data-i18n="footer.categories.animation">Animation</a></li>
                            <li><a href="youvi_main.html?tag=Movies (ct)" data-i18n="footer.categories.movies">Movies</a></li>
                            <li><a href="youvi_main.html?tag=Series (ct)" data-i18n="footer.categories.series">Series</a></li>
                            <li><a href="youvi_main.html?tag=Music (ct)" data-i18n="footer.categories.music">Music</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.ugc">UGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Games (ct)" data-i18n="footer.categories.games">Games</a></li>
                            <li><a href="youvi_main.html?tag=Technology (ct)" data-i18n="footer.categories.tech">Technology</a></li>
                            <li><a href="youvi_main.html?tag=Entertainment (ct)" data-i18n="footer.categories.entertainment">Entertainment</a></li>
                            <li><a href="youvi_main.html?tag=IRL (ct)" data-i18n="footer.categories.irl">IRL</a></li>
                            <li><a href="youvi_main.html?tag=TV (ct)" data-i18n="footer.categories.tv">TV</a></li>
                            <li><a href="youvi_main.html?tag=Education (ct)" data-i18n="footer.categories.education">Education</a></li>
                            <li><a href="youvi_main.html?tag=Other (ct)" data-i18n="footer.categories.other">Other</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.about">О сайте</h3>
                        <ul>
                            <li><a href="wiki/about.html" data-i18n="footer.aboutSite">Про сайт</a></li>
                            <li><a href="wiki/docs.html" data-i18n="footer.docs">Документация</a></li>
                            <li><a href="wiki/tech.html" data-i18n="footer.tech">Технологии</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-right">
                <div class="footer-mascot">
                    <img src="images/mascot1.png" alt="Yuvi" loading="lazy">
                </div>
            </div>
        </div>
    </footer>


  <script src="youvi/header/youvi-header.js"></script>
  <script src="youvi/sidebar-toggle.js"></script>
  <script src="youvi/sidebar-scroll.js"></script>
  <script src="youvi/themes/theme-toggle.js"></script>
  <link rel="stylesheet" href="youvi/sticky-video.css">

  <script src="youvi/tags/tag-broadcast-sync.js"></script>
  <script>
const YOUVI_TAGS_DEBUG = false;

async function loadRandomBanner(bannerElement) {
  try {
    const banners = [
            'images/banners/youvi_banner_1.png',
            'images/banners/youvi_banner_2.png'
    ];
    
    const randomBanner = banners[Math.floor(Math.random() * banners.length)];
    
    bannerElement.style.backgroundImage = `url('${randomBanner}')`;
    
    if (YOUVI_TAGS_DEBUG) console.log('Loaded random banner:', randomBanner);
  } catch (e) {
    console.error('Error loading random banner:', e);
    bannerElement.style.backgroundImage = "url('images/banners/yusite_banner_2.png')";
  }
}

const supportsFS = 'showDirectoryPicker' in window;
let videoDirectoryHandle = null;
let allVideos = [];
let videosCache = null;
let tagCache = null;
let tagIndex = null; 
let lastScanTime = 0;
let db = null; 

const tagsWrap = document.getElementById('tagsWrap');
const emptyState = document.getElementById('emptyState');
const accessStatus = document.getElementById('accessStatus');
const tagSearchBox = document.getElementById('tagSearchBox');

if (!supportsFS) {
  accessStatus.innerHTML = '<strong style="color:red">File System API не поддерживается в этом браузере. Используйте Chrome/Edge.</strong>';
}

async function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('8SiteDB', 1);
    request.onupgradeneeded = () => {
      const db = request.result;
      if (!db.objectStoreNames.contains('handles')) {
        db.createObjectStore('handles');
      }
      if (!db.objectStoreNames.contains('videos')) {
        const videoStore = db.createObjectStore('videos', { keyPath: 'name' });
        videoStore.createIndex('created', 'created', { unique: false });
        videoStore.createIndex('tags', 'tags', { unique: false, multiEntry: true });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function getVideosFromDB() {
  if (!db) return [];
  try {
    const tx = db.transaction('videos', 'readonly');
    const store = tx.objectStore('videos');
    return new Promise((resolve) => {
      const r = store.getAll();
      r.onsuccess = () => resolve(r.result || []);
      r.onerror = () => resolve([]);
    });
  } catch (e) {
    console.warn('Failed to get videos from DB:', e);
    return [];
  }
}

async function getFromDB(db, key) {
  const tx = db.transaction('handles', 'readonly');
  const store = tx.objectStore('handles');
  return new Promise((resolve) => {
    const request = store.get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => resolve(null);
  });
}

async function readJSONFile(dirHandle, fileName, defaultValue = null) {
  try {
    const fileHandle = await dirHandle.getFileHandle(fileName);
    const file = await fileHandle.getFile();
    const text = await file.text();
    return JSON.parse(text);
  } catch (e) {
    return defaultValue;
  }
}

async function getVideoMetadata(dirHandle, fileName) {
  try {
    const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
    const metaFileName = fileName + '.meta.json';
    const fileHandle = await metaDir.getFileHandle(metaFileName);
    const file = await fileHandle.getFile();
    const text = await file.text();
    const metadata = JSON.parse(text);
    
    metadata._metadataModified = file.lastModified;
    
    return metadata;
  } catch (e) {
    return {
      views: 0,
      likes: 0,
      dislikes: 0,
      tags: [],
      created: Date.now(),
      _metadataModified: Date.now()
    };
  }
}

async function writeJSONFile(dirHandle, fileName, data) {
  const fh = await dirHandle.getFileHandle(fileName, { create: true });
  const w = await fh.createWritable();
  await w.write(JSON.stringify(data, null, 2));
  await w.close();
}

async function saveVideoMetadata(dirHandle, fileName, metadata) {
  const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
  const metaFileName = fileName + '.meta.json';
  await writeJSONFile(metaDir, metaFileName, metadata);
}

window.videoManager = {
  get videos() { return allVideos; },
  async saveVideos() {
    let count = 0;
    for (const v of allVideos) {
      if (!v || !v._tagsUpdated) continue;
      if (!v.dirHandle || !v.name) continue;
      try {
        const metadata = await getVideoMetadata(v.dirHandle, v.name);
        const oldTags = Array.isArray(metadata.tags) ? metadata.tags : [];
        const newTags = Array.isArray(v.tags) ? v.tags : oldTags;
        metadata.tags = newTags;
        await saveVideoMetadata(v.dirHandle, v.name, metadata);
        v._tagsUpdated = false;
        count++;
        if (window.tagBroadcastSync) {
          window.tagBroadcastSync.broadcast('metadata_changed', { videoName: v.name });
          window.tagBroadcastSync.broadcast('tags_changed', { videoName: v.name, oldTags, newTags });
        }
      } catch (e) {
        console.error('Failed to save metadata for', v && v.name, e);
      }
    }
    return count;
  }
};

function isSpecialTag(tag) {
  const normalizedTag = tag.toLowerCase();
  return normalizedTag.includes('особое') || normalizedTag.includes('(ос)');
}

function hasSpecialTags(item) {
  const tags = item.tags || [];
  return tags.some(tag => isSpecialTag(tag));
}

async function loadAllVideos() {
  if (!videoDirectoryHandle) return;
  
  const perfStart = performance.now();
  const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.m4v'];
  
  const cachedVideos = await getVideosFromDB();
  
  if (cachedVideos.length > 0) {
    if (YOUVI_TAGS_DEBUG) console.log(`Loaded ${cachedVideos.length} videos from cache in ${Math.round(performance.now() - perfStart)}ms`);
    allVideos = cachedVideos;
    videosCache = cachedVideos;
    lastScanTime = Date.now();
    tagIndex = null; 
    accessStatus.textContent = '';
    
    setTimeout(async () => {
      if (YOUVI_TAGS_DEBUG) console.log('Starting background scan to verify all videos...');
      const scanStart = performance.now();
      const beforeCount = allVideos.length;
      
      const tempVideos = [];
      await (async function scanAll(dirHandle, playlistName = null, batchSize = 50) {
        try {
          let batch = [];
          for await (const [name, handle] of dirHandle.entries()) {
            if (handle.kind === 'file') {
              const isVideo = videoExtensions.some(ext => name.toLowerCase().endsWith(ext));
              if (isVideo) {
                batch.push({ name, handle, playlistName, dirHandle });
                if (batch.length >= batchSize) {
                  const results = await Promise.all(batch.map(async ({ name, handle, playlistName, dirHandle }) => {
                    try {
                      const file = await handle.getFile();
                      const metadata = await getVideoMetadata(dirHandle, name);
                      return { name, handle, file, size: file.size, modified: file.lastModified, ...metadata, playlist: playlistName, dirHandle };
                    } catch (e) { return null; }
                  }));
                  tempVideos.push(...results.filter(r => r !== null));
                  batch = [];
                }
              }
            } else if (handle.kind === 'directory') {
              await scanAll(handle, name, batchSize);
            }
          }
          if (batch.length > 0) {
            const results = await Promise.all(batch.map(async ({ name, handle, playlistName, dirHandle }) => {
              try {
                const file = await handle.getFile();
                const metadata = await getVideoMetadata(dirHandle, name);
                return { name, handle, file, size: file.size, modified: file.lastModified, ...metadata, playlist: playlistName, dirHandle };
              } catch (e) { return null; }
            }));
            tempVideos.push(...results.filter(r => r !== null));
          }
        } catch (e) {
          console.error('Scan error:', e);
        }
      })(videoDirectoryHandle);
      
      allVideos = tempVideos;
      videosCache = tempVideos;
      tagIndex = null;
      
      if (YOUVI_TAGS_DEBUG) console.log(`Background scan completed in ${Math.round(performance.now() - scanStart)}ms`);
      if (YOUVI_TAGS_DEBUG) console.log(`Total videos: ${allVideos.length} (was ${beforeCount} in cache)`);
      
      if (Math.abs(allVideos.length - beforeCount) > 10) {
        if (YOUVI_TAGS_DEBUG) console.log('Video count changed significantly, rebuilding tag cloud...');
        await buildTagCloud();
      }
    }, 200);
    
    return;
  }
  
  if (YOUVI_TAGS_DEBUG) console.log('No cache found, performing full scan...');
  allVideos = [];
  
  async function scanDirectory(dirHandle, playlistName = null, batchSize = 50) {
    try {
      let batch = [];
      for await (const [name, handle] of dirHandle.entries()) {
        if (handle.kind === 'file') {
          const isVideo = videoExtensions.some(ext => name.toLowerCase().endsWith(ext));
          if (isVideo) {
            batch.push({ name, handle, playlistName, dirHandle });
            
            if (batch.length >= batchSize) {
              await processBatch(batch);
              batch = [];
              await new Promise(resolve => setTimeout(resolve, 0));
            }
          }
        } else if (handle.kind === 'directory') {
          await scanDirectory(handle, name, batchSize);
        }
      }
      
      if (batch.length > 0) {
        await processBatch(batch);
      }
    } catch (e) {
      console.error('Error scanning directory:', e);
    }
  }
  
  async function processBatch(batch) {
    const batchPromises = batch.map(async ({ name, handle, playlistName, dirHandle }) => {
      try {
        const file = await handle.getFile();
        const metadata = await getVideoMetadata(dirHandle, name);
        return {
          name,
          handle,
          file,
          size: file.size,
          modified: file.lastModified,
          ...metadata,
          playlist: playlistName,
          dirHandle: dirHandle
        };
      } catch (e) {
        console.error(`Error processing ${name}:`, e);
        return null;
      }
    });
    
    const batchResults = await Promise.all(batchPromises);
    allVideos.push(...batchResults.filter(result => result !== null));
  }
  
  try {
    await scanDirectory(videoDirectoryHandle);
    videosCache = [...allVideos];
    lastScanTime = Date.now();
    tagCache = null;
    tagIndex = null;
    accessStatus.textContent = '';
    
    const totalTime = performance.now() - perfStart;
    console.log(`Scanned ${allVideos.length} videos in ${Math.round(totalTime)}ms`);
  } catch (e) {
    console.error('Error loading videos:', e);
    accessStatus.textContent = 'Ошибка загрузки видео: ' + e.message;
  }
}

async function buildTagIndex(videos = allVideos) {
  if (tagIndex && videos === allVideos) return tagIndex;
  
  const perfStart = performance.now();
  const tagMap = new Map();
  const tagToVideos = new Map();
  
  for (const video of videos) {
    const tags = video.tags || [];
    for (const tag of tags) {
      if (tag.endsWith('(ка)')) continue;
      
      const lowerTag = tag.toLowerCase();
      
      tagMap.set(tag, (tagMap.get(tag) || 0) + 1);
      
      if (!tagToVideos.has(lowerTag)) {
        tagToVideos.set(lowerTag, []);
      }
      tagToVideos.get(lowerTag).push(video.name);
    }
  }
  
  const result = { tagMap, tagToVideos };
  if (videos === allVideos) {
    tagIndex = result;
  }
  console.log(`Tag index built in ${Math.round(performance.now() - perfStart)}ms: ${tagMap.size} unique tags`);
  return result;
}

async function buildTagCloud() {
  const perfStart = performance.now();
  const showSpecialVideos = localStorage.getItem('showSpecialVideos') === 'true';
  const searchQuery = tagSearchBox.value.toLowerCase().trim();
  
  const cacheKey = `${showSpecialVideos}_${searchQuery}`;
  
  if (tagCache && tagCache.key === cacheKey) {
    renderTagCloud(tagCache.data);
    return;
  }
  
  const visibleVideos = showSpecialVideos ? allVideos : allVideos.filter(item => !hasSpecialTags(item));
  const { tagMap, tagToVideos } = await buildTagIndex(visibleVideos);
  
  let filteredTags = Array.from(tagMap.keys());

  if (searchQuery) {
    filteredTags = filteredTags.filter(tag => {
      if (tag.toLowerCase().includes(searchQuery)) {
        return true;
      }

      if (window.tagAliasSearch) {
        const resolvedTags = window.tagAliasSearch.resolveAliases(searchQuery);
        for (const resolvedTag of resolvedTags) {
          if (tag.toLowerCase().includes(resolvedTag.toLowerCase()) || 
              resolvedTag.toLowerCase().includes(tag.toLowerCase())) {
            return true;
          }
        }
      }
      
      return false;
    });
  }
  
  if (!showSpecialVideos) {
    filteredTags = filteredTags.filter(tag => !isSpecialTag(tag));
  }
  
  const displayMap = {};
  const names = new Set();
  filteredTags.forEach(tag => {
    displayMap[tag] = tagMap.get(tag);
    const list = tagToVideos.get(tag.toLowerCase());
    if (list && list.length) {
      for (const n of list) names.add(n);
    }
  });
  
  const tagData = {
    tagMap: displayMap,
    filteredCount: names.size,
    keys: filteredTags
  };
  
  tagCache = {
    key: cacheKey,
    data: tagData
  };
  
  console.log(`Tag cloud built in ${Math.round(performance.now() - perfStart)}ms: ${filteredTags.length} tags`);
  renderTagCloud(tagData);
}

function renderTagCloud({ tagMap, keys, filteredCount }) {
  if (YOUVI_TAGS_DEBUG) console.log('[TagCloud] Rendering', keys.length, 'tags with edit icons');
  
  if (keys.length === 0) {
    emptyState.style.display = 'block';
    const searchQuery = tagSearchBox.value.toLowerCase().trim();
    emptyState.textContent = searchQuery ? 'Теги не найдены по запросу' : 'Теги не найдены';
    tagsWrap.innerHTML = '';
    return;
  }
  
  emptyState.style.display = 'none';
  
  const tagsByType = {
    channel: [],
    general: [],
    character: [],
    author: [],
    genre: [],
    type: [],
    year: [],
    studio: [],
    category: [],
    rating: [],
    anime: [],
    serial: [],
    movie: [],
    animation: []
  };
  
  keys.forEach(tag => {
    const match = tag.match(/\(([a-zа-я]{2,3})\)$/i);
    if (match) {
      const suffix = match[1].toLowerCase();
      switch(suffix) {
        case 'ка': tagsByType.channel.push(tag); break;
        case 'gt': tagsByType.general.push(tag); break;
        case 'ch': tagsByType.character.push(tag); break;
        case 'au': tagsByType.author.push(tag); break;
        case 'ge': tagsByType.genre.push(tag); break;
        case 'tp': tagsByType.type.push(tag); break;
        case 'yr': tagsByType.year.push(tag); break;
        case 'st': tagsByType.studio.push(tag); break;
        case 'ct': tagsByType.category.push(tag); break;
        case 'ra': tagsByType.rating.push(tag); break;
        case 'at': tagsByType.anime.push(tag); break;
        case 'ser': tagsByType.serial.push(tag); break;
        case 'mt': tagsByType.movie.push(tag); break;
        case 'nat': tagsByType.animation.push(tag); break;
        default: tagsByType.general.push(tag);
      }
    } else {
      tagsByType.general.push(tag);
    }
  });
  
  Object.keys(tagsByType).forEach(type => {
    tagsByType[type].sort((a, b) => tagMap[b] - tagMap[a]);
  });
  
  const perfStart = performance.now();
  const fragment = document.createDocumentFragment();
  
  const editIconSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  editIconSVG.setAttribute('viewBox', '0 0 24 24');
  editIconSVG.setAttribute('width', '13');
  editIconSVG.setAttribute('height', '13');
  editIconSVG.setAttribute('fill', 'none');
  editIconSVG.setAttribute('stroke', 'currentColor');
  editIconSVG.setAttribute('stroke-width', '2.5');
  const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path1.setAttribute('d', 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7');
  const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path2.setAttribute('d', 'M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z');
  editIconSVG.appendChild(path1);
  editIconSVG.appendChild(path2);

  const implicationIconSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  implicationIconSVG.setAttribute('viewBox', '0 0 24 24');
  implicationIconSVG.setAttribute('width', '13');
  implicationIconSVG.setAttribute('height', '13');
  implicationIconSVG.setAttribute('fill', 'none');
  implicationIconSVG.setAttribute('stroke', 'currentColor');
  implicationIconSVG.setAttribute('stroke-width', '2.5');
  implicationIconSVG.setAttribute('stroke-linecap', 'round');
  implicationIconSVG.setAttribute('stroke-linejoin', 'round');
  const implPath1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  implPath1.setAttribute('d', 'M5 12h14');
  const implPath2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  implPath2.setAttribute('d', 'M12 5l7 7-7 7');
  implicationIconSVG.appendChild(implPath1);
  implicationIconSVG.appendChild(implPath2);
  
  const typeColors = {
    channel: '#9ca3af',
    general: '#6b7280',
    character: '#6b9e4d',
    author: '#ef6c7d',
    genre: '#6b9bd1',
    type: '#f59e6c',
    year: '#eab676',
    studio: '#f28b8b',
    category: '#67c5d6',
    rating: '#f5a3c7',
    anime: '#a78bdb',
    serial: '#8db8d6',
    movie: '#d4a373',
    animation: '#9dd6a8'
  };
  
  const typeLabels = {
    channel: 'Channel',
    general: 'General',
    character: 'Character',
    author: 'Author/Artist',
    genre: 'Genre',
    type: 'Type',
    year: 'Year',
    studio: 'Studio',
    category: 'Category',
    rating: 'Rating',
    anime: 'Anime',
    serial: 'Serial',
    movie: 'Movie',
    animation: 'Animation'
  };
  
  const typePrefixes = {
    channel: 'channel:',
    general: 'general:',
    character: 'character:',
    author: 'author:',
    genre: 'genre:',
    type: 'type:',
    year: 'year:',
    studio: 'studio:',
    category: 'category:',
    rating: 'rating:',
    anime: 'anime:',
    serial: 'serial:',
    movie: 'movie:',
    animation: 'animation:'
  };
  
  const categoryOrder = [
    'general',
    'category',
    'genre',
    'type',
    'anime',
    'serial',
    'movie',
    'animation',
    'character',
    'author',
    'studio',
    'year',
    'rating',
    'channel'
  ];
  
  categoryOrder.forEach(type => {
    const tags = tagsByType[type];
    if (tags.length === 0) return;
    
    const section = document.createElement('div');
    section.className = 'tag-section';
    
    const title = document.createElement('div');
    title.className = 'tag-section-title';
    title.textContent = typeLabels[type] || type;
    title.style.borderLeftColor = typeColors[type] || '#ff69b4';
    section.appendChild(title);
    
    const content = document.createElement('div');
    content.className = 'tag-section-content';
    
    tags.forEach(tag => {
      const count = tagMap[tag];
      const el = document.createElement('a');
      el.className = 'tag';
      el.style.backgroundColor = typeColors[type] || '#6b7280';
      
      const tagWithoutSuffix = tag.replace(/\s*\([a-zа-я]{2,3}\)$/i, '');
      
      const prefix = typePrefixes[type] || '';
      const searchQuery = prefix + tagWithoutSuffix;
      
      const textSpan = document.createElement('span');
      textSpan.textContent = count > 1 ? `${tagWithoutSuffix} (${count})` : tagWithoutSuffix;
      textSpan.className = 'tag-text';
      
      const editIcon = document.createElement('span');
      editIcon.className = 'tag-edit-icon';
      editIcon.appendChild(editIconSVG.cloneNode(true));
      editIcon.title = 'Управление алиасами';
      editIcon.dataset.tagName = tag;
      
      editIcon.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        if (YOUVI_TAGS_DEBUG) console.log('[TagAlias] Edit icon clicked for:', tag);
        if (window.tagAliasManager) {
          window.tagAliasManager.openModal(tag);
        } else {
          console.error('[TagAlias] tagAliasManager not available!');
        }
        return false;
      }, true);
      
      editIcon.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, true);

      const implicationIcon = document.createElement('span');
      implicationIcon.className = 'tag-edit-icon tag-impl-icon';
      implicationIcon.appendChild(implicationIconSVG.cloneNode(true));
      implicationIcon.title = 'Управление импликациями';
      implicationIcon.dataset.tagName = tag;
      
      implicationIcon.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        if (YOUVI_TAGS_DEBUG) console.log('[TagImplication] Implication icon clicked for:', tag);
        if (window.tagImplicationManager) {
          window.tagImplicationManager.openModal(tag);
        } else {
          console.error('[TagImplication] tagImplicationManager not available!');
        }
        return false;
      }, true);
      
      implicationIcon.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, true);
      
      el.appendChild(textSpan);
      el.appendChild(editIcon);
      el.appendChild(implicationIcon);
      el.title = `Нажмите чтобы открыть видео с тегом "${tagWithoutSuffix}"`;
      el.href = `youvi_search.html?q=${encodeURIComponent(searchQuery)}`;
      el.dataset.tagName = tag;
      
      content.appendChild(el);
    });
    
    section.appendChild(content);
    fragment.appendChild(section);
  });
  
  tagsWrap.innerHTML = '';
  tagsWrap.appendChild(fragment);
  
  console.log(`Tag cloud rendered in ${Math.round(performance.now() - perfStart)}ms`);
  updateVideoCounter(filteredCount);
}

function updateVideoCounter(providedCount) {
  const showSpecialVideos = localStorage.getItem('showSpecialVideos') === 'true';
  
  let count = providedCount;
  if (typeof count !== 'number') {
    let filteredVideos = allVideos;
    if (!showSpecialVideos) {
      filteredVideos = allVideos.filter(item => !hasSpecialTags(item));
    }
    count = filteredVideos.length;
  }
  const countStr = count.toString().padStart(5, '0');
  
  const counterDigits = document.getElementById('counterDigits');
  counterDigits.innerHTML = '';
  
  for (let i = 0; i < 5; i++) {
    const digit = countStr[i];
    const img = document.createElement('img');
    img.src = `counter/${digit}.png`;
    img.style.cssText = 'height:40px;width:auto;display:block;';
    img.onerror = function() {
      this.style.display = 'none';
      const span = document.createElement('span');
      span.textContent = digit;
      span.style.cssText = 'font-size:40px;font-weight:bold;color:#ff69b4;font-family:Verdana,sans-serif;line-height:40px;';
      this.parentNode.insertBefore(span, this.nextSibling);
    };
    counterDigits.appendChild(img);
  }
}

let searchTimeout = null;
let tagSearchTimeout = null;

function debounceTagSearch(func, delay = 300) {
  return function(...args) {
    clearTimeout(tagSearchTimeout);
    tagSearchTimeout = setTimeout(() => func.apply(this, args), delay);
  };
}

async function loadAllVideosAndPlaylistsForAutocomplete() {
  if (typeof AutocompleteDataLoader === 'undefined') {
    console.error('[Autocomplete] AutocompleteDataLoader module not loaded');
    return { videos: [], playlists: [] };
  }
  
  return await AutocompleteDataLoader.loadData();
}

const debouncedBuildTagCloud = debounceTagSearch(buildTagCloud, 300);

tagSearchBox.addEventListener('input', () => {
  debouncedBuildTagCloud();
});

tagSearchBox.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') {
    buildTagCloud();
  }
});

document.getElementById('clearTagSearch').addEventListener('click', () => {
  tagSearchBox.value = '';
  tagCache = null;
  buildTagCloud();
});

(async () => {
  const mainContent = document.querySelector('.main-content');
  const tagCloudFull = document.querySelector('.tag-cloud-full');
  
  if (mainContent && tagCloudFull) {
    const bannerSection = document.createElement('section');
    bannerSection.className = 'banner-section';
    mainContent.insertBefore(bannerSection, tagCloudFull);
    
    const pinkDivider = document.createElement('div');
    pinkDivider.className = 'pink-divider';
    mainContent.insertBefore(pinkDivider, tagCloudFull);
    
    loadRandomBanner(bannerSection);
  }
  
  if (supportsFS) {
    try {
      db = await openDB();
      const savedHandle = await getFromDB(db, 'videoDirectoryHandle');
      
      if (savedHandle) {
        try {
          await savedHandle.queryPermission();
          videoDirectoryHandle = savedHandle;
          
          await loadAllVideos();
          
          try {
            if (typeof tagDatabaseIntegration !== 'undefined') {
              await tagDatabaseIntegration.initialize(videoDirectoryHandle, allVideos);

              if (YOUVI_TAGS_DEBUG) console.log('[Tags]  Tag database system initialized and synced');
              
              if (YOUVI_TAGS_DEBUG) console.log('[Tags]  Force rebuilding tag cloud with edit icons...');
              await buildTagCloud();
              if (YOUVI_TAGS_DEBUG) console.log('[Tags]  Tag cloud rebuilt with edit icons');
              
              if (YOUVI_TAGS_DEBUG) console.log('[Tags]  Verifying broadcast listener...');
              
              const waitForBroadcastSync = () => {
                return new Promise((resolve) => {
                  if (window.tagBroadcastSync) {
                    resolve();
                    return;
                  }
                  
                  const checkInterval = setInterval(() => {
                    if (window.tagBroadcastSync) {
                      clearInterval(checkInterval);
                      resolve();
                    }
                  }, 50);
                  
                  setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                  }, 5000);
                });
              };
              
              await waitForBroadcastSync();
              
              if (window.tagBroadcastSync) {
                if (YOUVI_TAGS_DEBUG) console.log('[Tags] tagBroadcastSync available, listeners:', window.tagBroadcastSync.listeners.size);
                
                window.tagBroadcastSync.addEventListener(async (event) => {
                  if (YOUVI_TAGS_DEBUG) console.log('[Tags]  BROADCAST EVENT RECEIVED:', event);
                  
                  const { type, data } = event;
                  
                  switch (type) {
                    case 'tags_changed':
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tags changed for video:', data.videoName);
                      tagCache = null;
                      tagIndex = null;
                      await buildTagCloud();
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tag cloud rebuilt after tags changed');
                      break;
                      
                    case 'video_added':
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Video added:', data.videoName);
                      tagCache = null;
                      tagIndex = null;
                      await buildTagCloud();
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tag cloud rebuilt after video added');
                      break;
                      
                    case 'video_removed':
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Video removed:', data.videoName);

                      tagCache = null;
                      tagIndex = null;
                      await buildTagCloud();
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tag cloud rebuilt after video removed');
                      break;
                      
                    case 'metadata_changed':
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Metadata changed for video:', data.videoName);
                      tagCache = null;
                      tagIndex = null;
                      await buildTagCloud();
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tag cloud rebuilt after metadata changed');
                      break;
                      
                    case 'database_updated':
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Database updated');
                      tagCache = null;
                      tagIndex = null;
                      await buildTagCloud();
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tag cloud rebuilt after database updated');
                      break;
                      
                    default:
                      if (YOUVI_TAGS_DEBUG) console.log('[Tags] Unknown broadcast event type:', type);
                  }
                });
                
                if (YOUVI_TAGS_DEBUG) console.log('[Tags] Broadcast listener added, total listeners:', window.tagBroadcastSync.listeners.size);
                
                document.addEventListener('visibilitychange', async () => {
                  if (!document.hidden && videoDirectoryHandle) {
                    if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tab became visible, checking for updates...');
                    tagCache = null;
                    tagIndex = null;
                    await buildTagCloud();
                    if (YOUVI_TAGS_DEBUG) console.log('[Tags] Tag cloud refreshed on tab visibility change');
                  }
                });
                
              } else {
                console.error('[Tags] tagBroadcastSync NOT AVAILABLE after timeout!');
              }
            }
          } catch (error) {
            console.error('[Tags] Failed to initialize tag database:', error);
          }
          
          try {
            const searchInput = document.getElementById('headerSearchInput');
            if (searchInput && typeof AutocompleteIntegration !== 'undefined' && typeof YouviAutocomplete !== 'undefined') {
            
              const { videos, playlists } = await loadAllVideosAndPlaylistsForAutocomplete();
              
              const cacheValid = await window.autocompleteCache.isCacheValid(
                videos.length,
                playlists.length
              );
              
              const autocompleteIntegration = new AutocompleteIntegration();
              await autocompleteIntegration.init(searchInput, {
                videoDirectoryHandle: videoDirectoryHandle,
                allVideos: cacheValid ? [] : videos,
                allPlaylists: cacheValid ? [] : playlists
              });
              if (YOUVI_TAGS_DEBUG) console.log('[Autocomplete] ✅ Initialized on youvi_tags.html');
            }
          } catch (error) {
            console.error('[Autocomplete] Failed to initialize:', error);
          }
          
        } catch (e) {
          accessStatus.textContent = 'Сохранённая папка недоступна. Выберите папку на главной странице.';
        }
      } else {
        accessStatus.textContent = 'Выберите папку с видео на главной странице.';
      }
    } catch (e) {
      console.error('Error loading saved directory:', e);
      accessStatus.textContent = 'Ошибка загрузки папки. Выберите папку заново.';
    }
  }
})();

  document.addEventListener('DOMContentLoaded', () => {
    const headerSearchInput = document.getElementById('headerSearchInput');
    const headerSearchBtn = document.getElementById('doSearch');
    
    if (headerSearchInput && headerSearchBtn) {
      const goToSearch = () => {
        const q = (headerSearchInput.value || '').trim();
        const params = new URLSearchParams();
        if (q) params.set('q', q);
        window.location.href = `youvi_search.html${params.toString() ? '?' + params.toString() : ''}`;
      };
      
      headerSearchBtn.addEventListener('click', goToSearch);
      
      headerSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          goToSearch();
        }
      });
    }
  });
  </script>
  
  <!-- i18n Support -->
  <script src="youvi/i18n/ru.js"></script>
  <script src="youvi/i18n/en.js"></script>
  <script src="youvi/i18n/uk.js"></script>
  <script src="youvi/i18n/i18n.js"></script>
  
  <!-- Tag Database System -->
  <link rel="stylesheet" href="youvi/tags/tag-database.css">
  <script src="youvi/tags/tag-database-schema.js"></script>
  <script src="youvi/tags/tag-database-manager.js"></script>
  <script src="youvi/tags/tag-scanner.js"></script>
  <script src="youvi/tags/tag-sync-manager.js"></script>
  <script src="youvi/tags/metadata-watcher.js"></script>
  <script src="youvi/tags/tag-database-integration.js"></script>
  <script src="youvi/tags/tag-database-api.js"></script>
  <script src="youvi/tags/debug-helper.js"></script>
  <script src="youvi/tags/tag-database-test.js"></script>
  <link rel="stylesheet" href="youvi/autocomplete/autocomplete.css">
  <link rel="stylesheet" href="youvi/autocomplete/tag-input-autocomplete.css">
  <script src="youvi/autocomplete-data-loader.js"></script>
  <script src="youvi/autocomplete/autocomplete-cache.js"></script>
  <script src="youvi/autocomplete/autocomplete.js"></script>
  <script src="youvi/autocomplete/tag-input-autocomplete.js"></script>
  <script src="youvi/autocomplete/autocomplete-integration.js"></script>
  <link rel="stylesheet" href="youvi/tags/tag-alias-manager.css">
  <script src="youvi/tags/tag-alias-manager.js"></script>
  <script src="youvi/tags/tag-alias-search.js"></script>
  <link rel="stylesheet" href="youvi/tags/tag-implication-manager.css">
  <script src="youvi/tags/tag-implication-resolver.js"></script>
  <script src="youvi/tags/tag-implication-manager.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const langSwitcher = document.getElementById('langSwitcher');
      
      if (langSwitcher) {
        langSwitcher.value = i18n.getCurrentLanguage();
        
        langSwitcher.addEventListener('change', async function(e) {
          const newLang = e.target.value;
          await i18n.setLanguage(newLang);
        });
      }
    });
  </script>
</body>
</html>