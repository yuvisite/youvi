<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="feed.pageTitle">–í—Å–µ –ø–æ—Å—Ç—ã | Youvi</title>
    
    <script>
        (function() {
            var theme = localStorage.getItem('youvi-theme');
            var sidebar = localStorage.getItem('sidebarCollapsed');
            
            var htmlClasses = [];
            if (theme === 'dark') htmlClasses.push('dark-theme');
            else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
            if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
            if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
        })();
    </script>
    
    <link rel="stylesheet" href="youvi/header/youvi-header.css">
    <script src="youvi/sidebar-toggle.js"></script>
    <script src="youvi/sidebar-scroll.js"></script>
    <script src="youvi/header/youvi-header.js"></script>
    <link rel="stylesheet" href="youvi/channel/youvi_ch_feed.css">
    <link rel="stylesheet" href="youvi/channel/youvi_ch_feed_social.css">
    <link rel="stylesheet" href="youvi/sidebar.css">
    <link rel="stylesheet" href="youvi/sidebar-scroll.css">
    
    <!-- Theme System -->
    <link rel="stylesheet" href="youvi/themes/dark-theme.css?v=2">
    <link rel="stylesheet" href="youvi/themes/theme-dropdown.css">
    <link rel="stylesheet" href="youvi/sticky-video.css">
    
    <style>
        .filter-panel {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 20px 20px 20px; 
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            position: relative;
            min-height: 36px;
        }

        .filter-title {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin: 0;
            white-space: nowrap;
            position: absolute;
            left: 12px;
            z-index: 1;
        }

        .filter-toggle {
            display: flex;
            background: #fff;
            border-radius: 4px;
            padding: 2px;
            border: 1px solid #ddd;
            gap: 2px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .filter-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 70px;
            text-align: center;
        }

        .filter-btn.active {
            background: #ff69b4;
            color: white;
        }


        .loading {
            text-align: center;
            padding: 30px;
            color: #7a3c55;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #7a3c55;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7a3c55;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .empty-state p {
            color: #666;
            font-size: 13px;
        }

        .feed-form {
            display: none;
        }

        .container {
            max-width: none !important;
            margin: 0 !important;
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }
        
        
        .footer-content {
            max-width: 1600px !important;
            margin: 0 auto !important;
            padding: 0 20px !important;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            background: #fff;
            border-radius: 0;
            border: none;
        }
        
        .sidebar-collapsed .sidebar,
        html.sidebar-collapsed .sidebar {
            width: 60px !important;
            padding: 10px 8px !important;
            display: block !important;
            position: sticky !important;
            top: 40px !important;
            max-height: calc(var(--sidebar-max-height, 100vh) - 75px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .sidebar-collapsed .sidebar-title,
        html.sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-item,
        html.sidebar-collapsed .sidebar-item {
            padding: 8px !important;
            padding-left: 5px !important;
            padding-right: 8px !important;
            justify-content: center !important;
            border-left: 3px solid transparent !important;
            border-radius: 4px;
            font-size: 0 !important;
        }

        .sidebar-collapsed .sidebar-item:hover,
        html.sidebar-collapsed .sidebar-item:hover {
            background: rgba(255, 105, 180, 0.1);
        }

        .sidebar-collapsed .sidebar-item.active,
        html.sidebar-collapsed .sidebar-item.active {
            background: rgba(255, 105, 180, 0.15);
        }

        .sidebar-collapsed .sidebar-item svg,
        .sidebar-collapsed .sidebar-item img,
        html.sidebar-collapsed .sidebar-item svg,
        html.sidebar-collapsed .sidebar-item img {
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
            font-size: 16px !important;
        }

        .sidebar-collapsed .library-item,
        .sidebar-collapsed .nav-item,
        html.sidebar-collapsed .library-item,
        html.sidebar-collapsed .nav-item {
            justify-content: center !important;
            gap: 0 !important;
        }

        .sidebar-collapsed .library-item span,
        .sidebar-collapsed .nav-item span,
        html.sidebar-collapsed .library-item span,
        html.sidebar-collapsed .nav-item span {
            display: none !important;
        }

        .sidebar-collapsed .library-item svg,
        .sidebar-collapsed .nav-item svg,
        html.sidebar-collapsed .library-item svg,
        html.sidebar-collapsed .nav-item svg {
            margin: 0 !important;
        }
        
        .sidebar-collapsed .container,
        html.sidebar-collapsed .container {
            padding-left: 20px;
        }
        
        .sidebar-collapsed .main-content,
        html.sidebar-collapsed .main-content {
            margin-left: 0;
        }
        
        .sidebar-collapsed .content-wrapper,
        html.sidebar-collapsed .content-wrapper {
            max-width: 1500px;
        }
        
        .sidebar-collapsed .sidebar-section:first-child,
        html.sidebar-collapsed .sidebar-section:first-child {
            margin-top: 0;
        }

        .sidebar {
            position: sticky;
            top: 75px; 
            max-height: calc(100vh - 75px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        .sidebar {
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        
        .sidebar {
            padding-top: 0 !important;
            padding-bottom: 20px !important;
            margin-top: 0 !important;
        }

        .sidebar-section:first-child {
            margin-top: 10px;
        }

        .feed-posts {
            display: flex;
            flex-direction: column;
            gap: 4px; 
            padding: 0 20px; 
            background: #fff; 
        }

        .main-content.social-mode .feed-posts {
            gap: 0;
            padding: 0 15px !important; 
            background: #fff;
            max-width: 740px !important;
            margin: 0 auto !important;
            width: 740px; 
            box-sizing: border-box;
        }

        .main-content.social-mode {
            display: flex;
            flex-direction: column;
            background: #fff;
            border: none;
            border-radius: 0;
        }

        
        .header-content-wrapper,
        .top-nav-content {
            max-width: none !important;
            margin: 0 !important;
        }

        .top-nav {
            background: #d94b88;
            border-bottom: 1px solid #c2185b;
        }

        .lang-switcher {
            margin-left: auto;
        }
        
        .lang-select {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            outline: none;
        }
        
        .lang-select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-select option {
            background: #d94b88;
            color: #fff;
        }

        .footer {
            background: #2c2c2c;
            color: #fff;
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            cursor: pointer;
            border-radius: 4px;
        }

        :root {
            --header-height: 40px;
            --footer-height: 200px;
        }

        .feed-post {
            margin-bottom: 2px;
            padding: 0 2px;
        }

        .feed-post:not(:last-child) {
            border-bottom: none;
            padding-bottom: 2px;
        }

        .post-header {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .post-avatar.custom-avatar {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-size: 0;
        }

        .post-bubble {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 0;
            position: relative;
            min-width: 0;
        }

        .post-bubble::before,
        .post-bubble::after {
            content: '';
            position: absolute;
            left: -6px;
            top: 12px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        .post-bubble::before {
            border-right: 6px solid white;
            z-index: 2;
        }

        .post-bubble::after {
            left: -7px;
            border-right: 6px solid #e0e0e0;
            z-index: 1;
        }

        .post-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .post-author {
            font-weight: 600;
            font-size: 12px;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: text-decoration-color 0.2s;
        }

        .post-author:hover {
            text-decoration-color: currentColor;
        }

        .post-author.channel-nick {
            color: #ff69b4;
        }

        .post-channel-badge {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 500;
            color: #1565c0;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .post-channel-badge:hover {
            background: #bbdefb;
            border-color: #64b5f6;
        }

        .post-channel {
            font-weight: 600;
            font-size: 12px;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: text-decoration-color 0.2s;
        }

        .post-channel:hover {
            text-decoration-color: currentColor;
        }

        .view-mode-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .view-mode-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
            border-radius: 4px;
        }

        .view-mode-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .view-mode-btn.active {
            background: #ff69b4;
            color: white;
        }

        .view-mode-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .main-content.social-mode .feed-post {
            background: #fff;
            border-bottom: 1px solid #e1e8ed;
            border-left: none;
            border-right: none;
            border-top: none;
            border-radius: 0;
            padding: 9px 12px; 
            margin: 0; 
            box-shadow: none;
            transition: background-color 0.15s ease-in-out;
            width: 100%; 
            box-sizing: border-box;
        }

        .main-content.social-mode .feed-post:hover {
            background-color: #f5f8fa;
        }

        .feed-posts:not(.social-mode) {
            background: #fff;
        }

        .feed-posts:not(.social-mode) .feed-post {
            background: #fff;
            border: none; 
            border-radius: 0;
            padding: 6px; 
            margin-bottom: 1px; 
        }

        .main-content.social-mode .post-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            width: 100%; 
            max-width: 100%; 
            min-width: 100%; 
        }

        .main-content.social-mode .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .main-content.social-mode .post-bubble {
            flex: 1;
            background: none;
            border: none;
            padding: 0;
            min-width: 0;
            max-width: 100%; 
            width: 100%; 
            overflow-wrap: break-word; 
            word-wrap: break-word; 
        }

        .main-content.social-mode .post-bubble::before,
        .main-content.social-mode .post-bubble::after {
            display: none;
        }

        .main-content.social-mode .post-info {
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
            width: 100%; 
            max-width: 100%; 
        }

        .main-content.social-mode .post-author {
            font-size: 14px;
            font-weight: 700;
            color: #14171a;
            text-decoration: none;
        }

        .main-content.social-mode .post-author:hover {
            text-decoration: underline;
        }

        .main-content.social-mode .post-author.channel-nick {
            color: #ff69b4;
        }

        .main-content.social-mode .post-channel-badge {
            background: #1da1f2;
            color: #fff;
            border: none;
            border-radius: 2px;
            padding: 1px 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-content.social-mode .post-date {
            color: #657786;
            font-size: 13px;
            font-weight: 400;
        }

        .main-content.social-mode .post-date::before {
            content: "¬∑";
            margin: 0 4px;
            color: #657786;
        }

        .main-content.social-mode .post-content {
            font-size: 14px;
            line-height: 1.3125;
            color: #14171a;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word; 
            word-break: break-word; 
            width: 100%; 
            max-width: 100%; 
            display: block; 
        }

        .main-content.social-mode .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 10px 0 0 0;
            display: block;
            border: 1px solid #e1e8ed;
        }

        .main-content.social-mode .post-actions {
            border-top: none;
            padding-top: 8px;
            margin-top: 8px;
            display: flex;
            justify-content: flex-start !important; 
            align-items: center;
            gap: 12px;
            width: 100%; 
            max-width: 100%; 
        }
        .main-content.social-mode .open-post-btn { margin-left: 0 !important; order: 0; }
        .main-content.social-mode .post-stats { display: flex; gap: 12px; }

        .main-content.social-mode .post-stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .main-content.social-mode .like-btn,
        .main-content.social-mode .dislike-btn {
            background: none;
            border: none;
            color: #657786;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            transition: color 0.15s ease-in-out;
        }

        .main-content.social-mode .like-btn:hover {
            color: #1da1f2;
        }

        .main-content.social-mode .dislike-btn:hover {
            color: #e1306c;
        }

        .main-content.social-mode .like-btn svg,
        .main-content.social-mode .dislike-btn svg {
            width: 16px;
            height: 16px;
        }

        .main-content.social-mode .open-post-btn {
            background: none;
            color: #ff69b4;
            border: none;
            cursor: pointer;
            font-size: 10px; 
            padding: 0;
            transition: all 0.2s;
            text-decoration: none;
            font-weight: 400;
            margin-left: 0;
            order: 0; 
        }

        .main-content:not(.social-mode) .open-post-btn {
            margin-left: auto;
        }

        .main-content.social-mode .open-post-btn:hover {
            color: #d94b88;
            text-decoration: underline;
        }

        .main-content.social-mode .delete-btn {
            display: none !important;
        }

        .post-date {
            color: #999;
            font-size: 10px;
            margin-left: 0;
        }

        .post-content {
            color: #333;
            font-size: 12px;
            line-height: 1.4;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin-bottom: 4px;
        }

        .post-content img {
            max-width: 140px; 
            max-height: 105px; 
            border-radius: 0;
            cursor: pointer;
            object-fit: cover;
            margin: 4px 0;
            flex-shrink: 0;
            border: 1px solid #ddd;
            transition: opacity 0.3s ease;
        }

        .post-actions {
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            gap: 12px;
            margin-top: 4px;
            opacity: 1;
        }
        
        [data-channel-name], .post-channel-badge { cursor: pointer; }

        .feed-posts:not(.social-mode) .post-actions {
            justify-content: space-between;
        }

        .post-stats {
            color: #999;
            font-size: 10px;
        }

        .open-post-btn {
            background: #ff69b4;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.2s;
            text-decoration: none;
            font-weight: 500;
        }

        .open-post-btn:hover {
            background: #d94b88;
            color: white;
        }

        .like-btn,
        .dislike-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 2px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 2px;
            color: #666;
            margin-right: 4px;
        }

        .like-btn:hover {
            color: #ff69b4;
        }

        .dislike-btn:hover {
            color: #ff69b4;
        }

        .like-btn svg,
        .dislike-btn svg {
            width: 14px;
            height: 14px;
        }

        .like-count,
        .dislike-count {
            font-size: 10px;
            font-weight: 500;
        }

        .post-stats {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .image-modal .loading {
            color: white;
            text-align: center;
        }

        .image-modal .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .floating-banner {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 315px;
            height: 420px;
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            cursor: pointer;
            overflow: visible;
        }

        .floating-banner.visible {
            opacity: 1;
            visibility: visible;
        }

        .floating-banner img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
            border: none;
            outline: none;
            box-shadow: none;
        }

        .floating-banner-close {
            display: none;
        }

        .feed-posts:not(.social-mode) ~ .floating-banner {
            display: none;
        }

        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
            
            .footer-content {
                max-width: 1700px !important;
            }
        }

        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
            
            .footer-content {
                max-width: 1800px !important;
            }
        }

                body.dark-theme input.search-input {
  background: #4a3a34 !important;
  color: #fff !important;
  border-color: #555 !important;
}
    </style>
</head>
<link rel="icon" href="favicon/youvi/favicon.ico" type="image/x-icon">
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="top-nav-content">
      <a href="youvi_main.html" data-i18n="nav.video">–í–∏–¥–µ–æ</a>
      <a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
      <a href="youvi_ch_list.html" data-i18n="nav.channels">–ö–∞–Ω–∞–ª—ã</a>
      <a href="youvi_playlists_list.html" data-i18n="nav.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a>
      <a href="youvi_feed_all.html" class="active" data-i18n="nav.feed">Feed</a> 
      <a href="wiki/index.html" data-i18n="nav.wiki">Wiki</a>
      <div class="lang-switcher">
        <select id="langSwitcher" class="lang-select">
          <option value="ru">üá∑üá∫ RU</option>
          <option value="en">üá¨üáß EN</option>
          <option value="uk">üá∫üá¶ UK</option>
        </select>
      </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content-wrapper">
            <div class="header-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
                
                <div class="logo">
                    <a href="youvi_main.html">
                        <img src="images/logo_youvi_ind.png" alt="Youvi logo">
                    </a>
                </div>
            </div>
            
            <div class="header-center">
                <div class="search-area autocomplete-wrapper">
                    <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." class="search-input" data-i18n-placeholder="search.placeholder">
                    <button id="doSearch" class="search-btn" data-i18n="search.button">–ù–∞–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="header-right">
                <div class="user-actions">
                    <div class="settings-container">
                        <a href="#" class="settings-btn">‚öô</a>
                        <div class="theme-dropdown">
                            <button class="theme-dropdown-item" data-theme="light" data-i18n="themes.light">–ë–µ–ª–∞—è</button>
                            <button class="theme-dropdown-item" data-theme="dark" data-i18n="themes.dark">–ß–µ—Ä–Ω–∞—è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.navigation">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                <a href="youvi_main.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
                <a href="youvi_feed_all.html" class="sidebar-item nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                        <path d="M4 11a9 9 0 0 1 9 9"/>
                        <path d="M4 4a16 16 0 0 1 16 16"/>
                        <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <span data-i18n="sidebar.feed">Feed</span>
                </a>
                
                <a href="youvi_tags.html" class="sidebar-item nav-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                     <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                 </svg>
                    <span data-i18n="sidebar.allTagsLink">–í—Å–µ —Ç–µ–≥–∏</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
                <a href="youvi_history.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</span>
                </a>
                <a href="youvi_fav.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                </a>
                <a href="youvi_playlists_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</span>
                </a>
                <a href="youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</span>
                </a>
                <a href="youvi_subscriptions.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.subscriptionsTitle">–ü–æ–¥–ø–∏—Å–∫–∏</div>
                <div id="subscribedChannelsContainer"></div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.sorting">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
                <a href="#" class="sidebar-item library-item" id="sortNew">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.sortNew">–ù–æ–≤—ã–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortBest">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <span data-i18n="feed.sortBest">–õ—É—á—à–∏–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortWorst">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <polygon points="12 22 15.09 15.74 22 14.73 17 9.86 18.18 2.98 12 6.23 5.82 2.98 7 9.86 2 14.73 8.91 15.74 12 22"/>
                    </svg>
                    <span data-i18n="feed.sortWorst">–•—É–¥—à–∏–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortRandom">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="3" ry="3"/>
                        <circle cx="8" cy="8" r="1"/>
                        <circle cx="16" cy="8" r="1"/>
                        <circle cx="8" cy="16" r="1"/>
                        <circle cx="16" cy="16" r="1"/>
                        <circle cx="12" cy="12" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.sortRandom">–°–ª—É—á–∞–π–Ω—ã–µ</span>
                </a>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="feed.viewMode">–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
                <a href="#" class="sidebar-item library-item active" id="compactMode" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        </svg>
                        <span data-i18n="feed.compact">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="socialMode" title="–°–æ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (Timeline)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <line x1="3" y1="3" x2="21" y2="3"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <line x1="3" y1="17" x2="21" y2="17"/>
                        </svg>
                        <span data-i18n="feed.timeline">Timeline</span>
                </a>
            </div>

        </aside>

        <!-- Content Wrapper (centered) -->
        <div class="content-wrapper">
        <!-- Main Content -->
        <main class="main-content">
            <!-- Filter Panel -->
            <div class="filter-panel">
                <div class="filter-title" data-i18n="feed.filterPosts">–§–∏–ª—å—Ç—Ä –ø–æ—Å—Ç–æ–≤</div>
                <div class="filter-toggle">
                    <button class="filter-btn active" data-filter="all" data-i18n="feed.allPosts">–í—Å–µ –ø–æ—Å—Ç—ã</button>
                    <button class="filter-btn" data-filter="subscriptions" data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</button>
                </div>
            </div>

            <!-- Feed Posts -->
            <div class="feed-posts" id="feedPosts">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div data-i18n="feed.loadingPosts">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
                </div>
            </div>
        </main>
        </div><!-- /content-wrapper -->
    </div>

     <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-logo">
                    <img src="images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
                    <p data-i18n="footer.description">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ.</p>
                </div>
                <div class="footer-sections">
                    <div class="footer-section">
                        <h3 data-i18n="footer.sections">–†–∞–∑–¥–µ–ª—ã</h3>
            <ul>
              <li><a href="youvi_main.html" data-i18n="footer.video">–í–∏–¥–µ–æ</a></li>
              <li><a href="youvi_tags.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
              <li><a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a></li>
              <li><a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3 data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
            <ul>
              <li><a href="youvi_ch_list.html" data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</a></li>
              <li><a href="youvi_playlists_list.html" data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a></li>
              <li><a href="youvi_subscriptions.html" data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</a></li>
              <li><a href="youvi_fav.html" data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a></li>
              <li><a href="youvi_history.html" data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3 data-i18n="nav.wiki">Wiki</h3>
            <ul>
              <li><a href="wiki/index.html" data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
              <li><a href="wiki/player.html" data-i18n="footer.wiki.player">–ü–ª–µ–µ—Ä</a></li>
              <li><a href="wiki/danmaku.html" data-i18n="footer.wiki.danmaku">–î–∞–Ω–º–∞–∫—É</a></li>
              <li><a href="wiki/tags/general.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
              <li><a href="wiki/tags/rules.html" data-i18n="footer.wiki.taggingRules">–ü—Ä–∞–≤–∏–ª–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</a></li>
              <li><a href="wiki/search/general.html" data-i18n="footer.wiki.search">–ü–æ–∏—Å–∫</a></li>
            </ul>
          </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.pgc">PGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Anime (ct)" data-i18n="footer.categories.anime">Anime</a></li>
                            <li><a href="youvi_main.html?tag=Animation (ct)" data-i18n="footer.categories.animation">Animation</a></li>
                            <li><a href="youvi_main.html?tag=Movies (ct)" data-i18n="footer.categories.movies">Movies</a></li>
                            <li><a href="youvi_main.html?tag=Series (ct)" data-i18n="footer.categories.series">Series</a></li>
                            <li><a href="youvi_main.html?tag=Music (ct)" data-i18n="footer.categories.music">Music</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.ugc">UGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Games (ct)" data-i18n="footer.categories.games">Games</a></li>
                            <li><a href="youvi_main.html?tag=Technology (ct)" data-i18n="footer.categories.tech">Technology</a></li>
                            <li><a href="youvi_main.html?tag=Entertainment (ct)" data-i18n="footer.categories.entertainment">Entertainment</a></li>
                            <li><a href="youvi_main.html?tag=IRL (ct)" data-i18n="footer.categories.irl">IRL</a></li>
                            <li><a href="youvi_main.html?tag=TV (ct)" data-i18n="footer.categories.tv">TV</a></li>
                            <li><a href="youvi_main.html?tag=Education (ct)" data-i18n="footer.categories.education">Education</a></li>
                            <li><a href="youvi_main.html?tag=Other (ct)" data-i18n="footer.categories.other">Other</a></li>
                        </ul>
                    </div>
          <div class="footer-section">
            <h3 data-i18n="footer.about">–û —Å–∞–π—Ç–µ</h3>
            <ul>
              <li><a href="wiki/about.html" data-i18n="footer.aboutSite">–ü—Ä–æ —Å–∞–π—Ç</a></li>
               <li><a href="wiki/docs.html" data-i18n="footer.docs">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></li>
              <li><a href="wiki/tech.html" data-i18n="footer.tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a></li>
            </ul>
                    </div>
                </div>
            </div>
            <div class="footer-right">
                <div class="footer-mascot">
                    <img src="images/mascot1.png" alt="Yuvi" loading="lazy">
                </div>
            </div>
        </div>
    </footer>

    <script>
        /**
         * DEBUG_MODE flag - Controls console logging
         * Set to false to disable console.log statements in production
         * Set to true to enable debugging output
         */
        const DEBUG_MODE = false;
        
        (function(){
            try{
                const input = document.getElementById('headerSearchInput');
                const btn = document.getElementById('headerSearchBtn');
                const go = () => {
                    const q = (input?.value||'').trim();
                    const params = new URLSearchParams();
                    if (q) params.set('q', q);
                    window.location.href = `youvi_search.html${params.toString()?('?'+params.toString()):''}`;
                };
                if (btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); go(); });
                if (input) input.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); go(); } });
            }catch(_){ }
        })();

        let videoDirectoryHandle = null;
        let allPosts = [];
        let filteredPosts = [];
        let renderIndex = 0;
        const BATCH_SIZE = 20;
        let isLoadingBatch = false;
        let sentinelObserver = null;
        let lazyImageObserver = null;
        let currentFilter = 'all';
        let currentSort = 'new';
        let subscriptions = [];
        const avatarCache = new Map();
        
        const postsCache = new Map();
        const channelDataCache = new Map();
        const imageCache = new Map();
        const channelTimestampCache = new Map();
        let lastCacheTime = 0;
        const CACHE_DURATION = 60000;
        
        let bannerVisible = false;
        let bannerEnabled = true;

        function getUrlParam(param) {
            const value = new URLSearchParams(window.location.search).get(param);
            if (DEBUG_MODE) console.log(`getUrlParam('${param}') =`, value);
            return value;
        }

        async function openDB() {
            return new Promise((resolve, reject) => {
                if (DEBUG_MODE) console.log('Opening IndexedDB: 8SiteDB, version 1');
                const request = indexedDB.open('8SiteDB', 1);
                
                request.onupgradeneeded = () => {
                    if (DEBUG_MODE) console.log('IndexedDB upgrade needed');
                    const db = request.result;
                    if (!db.objectStoreNames.contains('handles')) {
                        if (DEBUG_MODE) console.log('Creating handles store');
                        db.createObjectStore('handles');
                    }
                    if (!db.objectStoreNames.contains('subscriptions')) {
                        if (DEBUG_MODE) console.log('Creating subscriptions store');
                        db.createObjectStore('subscriptions');
                    }
                };
                
                request.onsuccess = () => {
                    if (DEBUG_MODE) console.log('IndexedDB opened successfully');
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    console.error('IndexedDB open error:', request.error);
                    reject(request.error);
                };
            });
        }

        async function getFromDB(db, key) {
            if (DEBUG_MODE) console.log(`Getting from DB: ${key}`);
            const storeName = key === 'subscriptions' ? 'subscriptions' : 'handles';
            if (DEBUG_MODE) console.log('Using store:', storeName);
            
            if (!db.objectStoreNames.contains(storeName)) {
                if (DEBUG_MODE) console.log('Store not found:', storeName);
                return null;
            }
            
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            if (DEBUG_MODE) console.log('Transaction and store created');
            
            return new Promise((resolve) => {
                const request = store.get(key);
                request.onsuccess = () => {
                    if (DEBUG_MODE) console.log(`DB get success for ${key}:`, request.result);
                    resolve(request.result);
                };
                request.onerror = () => {
                    if (DEBUG_MODE) console.log(`DB get error for ${key}:`, request.error);
                    resolve(null);
                };
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        document.addEventListener('click', (e) => {
            const el = e.target.closest('[data-channel-name]');
            if (el) {
                const ch = el.getAttribute('data-channel-name');
                if (ch) {
                    e.preventDefault();
                    window.location.href = `youvi_ch_feed.html?channel=${encodeURIComponent(ch)}`;
                }
            }
        });

        document.addEventListener('click', (e) => {
            const badge = e.target.closest('.post-channel-badge');
            if (badge) {
                const ch = badge.textContent.trim();
                if (ch) {
                    e.preventDefault();
                    window.location.href = `youvi_ch_feed.html?channel=${encodeURIComponent(ch)}`;
                }
            }
        });

        async function loadAvatarForChannelName(channelName) {
            try {
                if (!videoDirectoryHandle || !channelName) return null;
                const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                const chDir = await channelsDir.getDirectoryHandle(channelName, { create: true });
                const chData = await readJSONFile(chDir, 'channel.json', {});
                if (chData && chData.avatar) {
                    return await loadImageFile(chDir, chData.avatar);
                }
            } catch (e) {
                console.error('Error loading avatar for channel', channelName, e);
            }
            return null;
        }

        function countRepliesDeep(replies) {
            let total = 0;
            (function walk(arr) {
                if (!Array.isArray(arr)) return;
                for (const r of arr) {
                    total += 1;
                    if (Array.isArray(r?.nestedReplies) && r.nestedReplies.length > 0) {
                        walk(r.nestedReplies);
                    }
                }
            })(replies);
            return total;
        }

        function getNickColor(nick) {
            const colors = ['#4a90e2', '#7b68ee', '#20b2aa', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
            let hash = 0;
            for (let i = 0; i < nick.length; i++) {
                hash = nick.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function processContentWithImages(content) {
            if (!content || typeof content !== 'string') return '';
            
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const images = tempDiv.querySelectorAll('img');
                
                images.forEach(img => {
                    img.style.maxWidth = '140px'; 
                    img.style.maxHeight = '105px'; 
                    img.style.cursor = 'pointer';
                    img.style.border = '1px solid #ddd';
                    img.style.borderRadius = '0';
                    img.style.objectFit = 'cover';
                    img.style.display = 'block';
                    img.style.opacity = '1';
                    img.style.margin = '4px 0';
                    img.style.flexShrink = '0';
                    img.className = 'loaded';
                    
                    img.setAttribute('data-expanded', 'false');
                    
                });
                
                return tempDiv.innerHTML;
            } catch (e) {
                console.error('Error processing content with images:', e);
                return content;
            }
        }

        function processImagesInPostContent(postElement) {
            const images = postElement.querySelectorAll('.post-content img');
            images.forEach(img => {
                img.classList.remove('lazy');
                img.classList.add('loaded');
                
                img.onclick = (e) => {
                    e.stopPropagation();
                    toggleImageSize(img);
                };
                
            });
        }

        /*
        async function openImageModal(src, fileName = null, postId = null, channelName = null) {
        }
        */

        async function loadFullImage(fileName, postId, channelName = null) {
            try {
                if (!videoDirectoryHandle) {
                    if (DEBUG_MODE) console.log('No file system access, cannot load full image');
                    return null;
                }

                if (DEBUG_MODE) console.log('Loading full image:', { fileName, postId, channelName });

                const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                
                if (channelName) {
                    try {
                        const channelHandle = await channelsDir.getDirectoryHandle(channelName);
                        const postsDir = await channelHandle.getDirectoryHandle('posts');
                        const postDir = await postsDir.getDirectoryHandle(`post_${postId}`);
                        const imagesDir = await postDir.getDirectoryHandle('images');
                        const fileHandle = await imagesDir.getFileHandle(fileName);
                        const file = await fileHandle.getFile();
                        
                        if (DEBUG_MODE) console.log('Found image in specified channel:', channelName);
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                    } catch (e) {
                        if (DEBUG_MODE) console.log('Post not found in specified channel:', channelName, e);
                    }
                }
                
                for await (const [channelName, channelHandle] of channelsDir.entries()) {
                    if (channelHandle.kind === 'directory') {
                        try {
                            const postsDir = await channelHandle.getDirectoryHandle('posts');
                            const postDir = await postsDir.getDirectoryHandle(`post_${postId}`);
                            const imagesDir = await postDir.getDirectoryHandle('images');
                            const fileHandle = await imagesDir.getFileHandle(fileName);
                            const file = await fileHandle.getFile();
                            
                            if (DEBUG_MODE) console.log('Found image in channel:', channelName);
                            return new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(file);
                            });
                        } catch (e) {
                            continue;
                        }
                    }
                }
                
                if (DEBUG_MODE) console.log('Post not found in any channel');
                return null;
                
            } catch (e) {
                console.error('Error loading full image:', e);
                return null;
            }
        }

        window.toggleImageSize = toggleImageSize;
        window.togglePostImage = togglePostImage;

        function showBanner() {
            if (!bannerEnabled) return;
            
            const banner = document.getElementById('floatingBanner');
            const feedPosts = document.getElementById('feedPosts');
            
            if (banner && feedPosts && feedPosts.classList.contains('social-mode')) {
                banner.classList.add('visible');
                bannerVisible = true;
                if (DEBUG_MODE) console.log('Banner shown');
            }
        }

        function hideBanner() {
            const banner = document.getElementById('floatingBanner');
            if (banner) {
                banner.classList.remove('visible');
                bannerVisible = false;
                if (DEBUG_MODE) console.log('Banner hidden');
            }
        }

        function toggleBanner() {
            if (bannerVisible) {
                hideBanner();
            } else {
                showBanner();
            }
        }

        function disableBanner() {
            bannerEnabled = false;
            hideBanner();
            if (DEBUG_MODE) console.log('Banner disabled');
        }

        function enableBanner() {
            bannerEnabled = true;
            setTimeout(() => {
                handleScroll();
            }, 100);
            if (DEBUG_MODE) console.log('Banner enabled');
        }

        function handleScroll() {
            const feedPosts = document.getElementById('feedPosts');
            if (!feedPosts || !feedPosts.classList.contains('social-mode') || !bannerEnabled) {
                return;
            }

            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            const scrollThreshold = 300;
            const hasScrolledDown = scrollTop >= scrollThreshold;
            
            if (hasScrolledDown && !bannerVisible) {
                showBanner();
            } else if (!hasScrolledDown && bannerVisible) {
                hideBanner();
            }
            
            if (bannerVisible) {
                positionBannerAboveFooter();
            }
        }

        function positionBannerAboveFooter() {
            const banner = document.getElementById('floatingBanner');
            if (!banner) return;
            
            const footer = document.querySelector('.footer');
            if (!footer) return;
            
            const footerRect = footer.getBoundingClientRect();
            const bannerHeight = 420;
            const margin = 20;
            const triggerDistance = 100;
            
            const footerDistanceFromBottom = footerRect.top - window.innerHeight;
            const shouldMoveBanner = footerDistanceFromBottom < triggerDistance;
            
            if (shouldMoveBanner) {
                const moveDistance = Math.max(0, triggerDistance - footerDistanceFromBottom);
                const newBottom = 20 + moveDistance;
                banner.style.bottom = newBottom + 'px';
            } else {
                banner.style.bottom = '20px';
            }
        }

        function setupBannerEvents() {
            const banner = document.getElementById('floatingBanner');
            
            if (banner) {
                banner.addEventListener('click', () => {
                    if (DEBUG_MODE) console.log('Banner clicked');
                });
            }
            
            document.addEventListener('keydown', (e) => {
                if (e.keyCode === 66 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        if (bannerEnabled) {
                            disableBanner();
                        } else {
                            enableBanner();
                        }
                    }
                }
            });
            
            window.addEventListener('scroll', handleScroll);
        }

        function toggleImageSize(imgElement) {
            const isExpanded = imgElement.getAttribute('data-expanded') === 'true';
            const fullSrc = imgElement.getAttribute('data-fullsrc');
            
            if (DEBUG_MODE) console.log('toggleImageSize called:', { isExpanded, src: imgElement.src });
            
            if (!isExpanded) {
                imgElement.style.maxWidth = '100%';
                imgElement.style.maxHeight = '400px';
                imgElement.style.width = 'auto';
                imgElement.style.height = 'auto';
                imgElement.style.objectFit = 'contain';
                imgElement.style.opacity = '1';
                imgElement.style.filter = 'none';
                imgElement.setAttribute('data-expanded', 'true');
                if (DEBUG_MODE) console.log('Image expanded');
                
                if (fullSrc && imgElement.src !== fullSrc) {
                    imgElement.src = fullSrc;
                }
            } else {
                imgElement.style.maxWidth = '140px'; 
                imgElement.style.maxHeight = '105px'; 
                imgElement.style.width = 'auto';
                imgElement.style.height = 'auto';
                imgElement.style.objectFit = 'cover';
                imgElement.style.opacity = '1';
                imgElement.style.filter = 'none';
                imgElement.setAttribute('data-expanded', 'false');
                if (DEBUG_MODE) console.log('Image collapsed');
            }
        }

        function togglePostImage(postId) {
            if (DEBUG_MODE) console.log('togglePostImage called with postId:', postId);
            
            const postContainer = document.querySelector(`#postContent_${postId}`)?.closest('.feed-post');
            if (!postContainer) {
                if (DEBUG_MODE) console.log('Post container not found for postId:', postId);
                return;
            }
            
            const images = postContainer.querySelectorAll('.post-content img');
            if (images.length === 0) {
                if (DEBUG_MODE) console.log('No images found in post:', postId);
                return;
            }
            
            if (DEBUG_MODE) console.log('Found', images.length, 'images in post:', postId);
            
            images.forEach(img => {
                toggleImageSize(img);
            });
            
            let allExpanded = true;
            images.forEach(img => {
                if (img.getAttribute('data-expanded') !== 'true') {
                    allExpanded = false;
                }
            });
            
            const button = postContainer.querySelector(`button[data-post-id="${postId}"].delete-btn`);
            if (button) {
                button.textContent = i18n.t('feed.image') || '–ö–∞—Ä—Ç–∏–Ω–∫–∞';
                button.title = allExpanded ? (i18n.t('feed.closeImages') || '–ó–∞–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è') : (i18n.t('feed.openImages') || '–û—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                if (DEBUG_MODE) console.log('Updated button text to:', button.textContent);
            } else {
                if (DEBUG_MODE) console.log('Button not found for postId:', postId);
            }
        }

        async function toggleLike(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) return;
            
            if (!post.likes) post.likes = 0;
            
            post.likes++;
            
            const likeCountElement = document.querySelector(`button[onclick="toggleLike('${postId}')"] .like-count`);
            if (likeCountElement) {
                likeCountElement.textContent = post.likes;
            }
            
            await savePostToDirectory(post);
        }
        
        async function toggleDislike(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) return;
            
            if (!post.dislikes) post.dislikes = 0;
            
            post.dislikes++;
            
            const dislikeCountElement = document.querySelector(`button[onclick="toggleDislike('${postId}')"] .dislike-count`);
            if (dislikeCountElement) {
                dislikeCountElement.textContent = post.dislikes;
            }
            
            await savePostToDirectory(post);
        }

        async function readJSONFile(dirHandle, fileName, defaultValue = null) {
            try {
                const fileHandle = await dirHandle.getFileHandle(fileName);
                const file = await fileHandle.getFile();
                const text = await file.text();
                const parsed = JSON.parse(text);
                return parsed;
            } catch (e) {
                if (defaultValue === null) {
                    console.error(`Error reading ${fileName}:`, e);
                }
                return defaultValue;
            }
        }

        async function writeJSONFile(dirHandle, fileName, data) {
            try {
                if (DEBUG_MODE) console.log(`Writing file: ${fileName} to directory:`, dirHandle);
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                if (DEBUG_MODE) console.log(`Successfully wrote ${fileName}`);
            } catch (e) {
                console.error(`Error writing ${fileName}:`, e);
            }
        }

        async function savePostToDirectory(post) {
            try {
                if (!videoDirectoryHandle) {
                    if (DEBUG_MODE) console.log('No file system access, cannot save post');
                    return;
                }

                const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                const channelDir = await channelsDir.getDirectoryHandle(post.channelName, { create: true });
                const postsDir = await channelDir.getDirectoryHandle('posts', { create: true });
                const postDir = await postsDir.getDirectoryHandle(`post_${post.id}`, { create: true });

                const postData = {
                    id: post.id,
                    author: post.author,
                    content: post.content,
                    timestamp: post.timestamp,
                    likes: post.likes || 0,
                    dislikes: post.dislikes || 0,
                    isAuthorPost: post.isAuthorPost || false
                };

                await writeJSONFile(postDir, 'post.json', postData);
                if (DEBUG_MODE) console.log('Saved post data to post.json');

            } catch (e) {
                console.error('Error saving post to directory:', e);
            }
        }

        async function loadImageFile(dirHandle, fileName) {
            if (DEBUG_MODE) console.log('=== Loading image file:', fileName, 'from directory:', dirHandle.name, '===');
            const cacheKey = `${dirHandle.name}_${fileName}`;
            if (avatarCache.has(cacheKey)) {
                const cached = avatarCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    if (DEBUG_MODE) console.log('Image found in cache:', fileName);
                    return cached.url;
                }
            }
            
            try {
                if (DEBUG_MODE) console.log('Getting file handle for:', fileName);
                const fileHandle = await dirHandle.getFileHandle(fileName);
                if (DEBUG_MODE) console.log('File handle obtained for:', fileName);
                
                if (DEBUG_MODE) console.log('Getting file object for:', fileName);
                const file = await fileHandle.getFile();
                if (DEBUG_MODE) console.log('File object obtained, size:', file.size, 'bytes');
                
                if (DEBUG_MODE) console.log('Creating object URL for:', fileName);
                const url = URL.createObjectURL(file);
                if (DEBUG_MODE) console.log('Object URL created:', url);
                
                avatarCache.set(cacheKey, {
                    url,
                    timestamp: Date.now()
                });
                
                if (DEBUG_MODE) console.log('Image cached successfully:', fileName);
                return url;
            } catch (e) {
                console.error('Error loading image file:', fileName, e);
                return null;
            }
        }

        async function loadAllPosts() {
            if (!videoDirectoryHandle) return;
            
            if (DEBUG_MODE) console.log('Loading all posts (optimized)...');
            const startTime = performance.now();

            try {
                const now = Date.now();
                if (postsCache.size > 0 && (now - lastCacheTime) < CACHE_DURATION) {
                    if (DEBUG_MODE) console.log('Using cached posts data');
                    allPosts = Array.from(postsCache.values()).flat();
                    const loadTime = performance.now() - startTime;
                    if (DEBUG_MODE) console.log(`Posts loaded from cache in ${loadTime.toFixed(2)}ms`);
                    applyFilter();
                    return;
                }

                if (DEBUG_MODE) console.log('Cache miss or expired, loading from filesystem...');
                const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                
                const channelNames = [];
                
                for await (const [channelName, channelHandle] of channelsDir.entries()) {
                    if (channelHandle.kind === 'directory') {
                        channelNames.push([channelName, channelHandle]);
                    }
                }
                
                if (DEBUG_MODE) console.log(`Found ${channelNames.length} channels to process`);
                
                const feedPostsContainer = document.getElementById('feedPosts');
                function updateLoadingProgress(channelsProcessed, totalChannels, postsLoaded = 0) {
                    feedPostsContainer.innerHTML = `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>${i18n.t('feed.loadingPosts') || '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...'}</div>
                            <div style="font-size: 12px; margin-top: 8px;">
                                ${i18n.t('feed.channels') || '–ö–∞–Ω–∞–ª–æ–≤'}: ${channelsProcessed}/${totalChannels}<br>
                                ${i18n.t('feed.postsLoaded') || '–ü–æ—Å—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'}: ${postsLoaded}
                            </div>
                        </div>
                    `;
                }
                
                const newPosts = [];
                let channelsProcessed = 0;
                let totalPostsLoaded = 0;
                
                updateLoadingProgress(0, channelNames.length, 0);
                
                const allChannelPromises = channelNames.map(async ([channelName, channelHandle]) => {
                    try {
                        if (DEBUG_MODE) console.log(`Processing channel: ${channelName}`);
                        
                        let channelData = channelDataCache.get(channelName);
                        if (!channelData) {
                            channelData = await readJSONFile(channelHandle, 'channel.json', {});
                            channelDataCache.set(channelName, channelData);
                        }
                        
                        const posts = await loadPostsFromChannel(channelHandle, channelName, channelData);
                        postsCache.set(channelName, posts);
                        
                        if (posts.length > 0) {
                            newPosts.push(...posts);
                            
                            allPosts = [...newPosts].sort((a, b) => (b.timestamp || b.created) - (a.timestamp || a.created));
                            
                            setTimeout(() => {
                                applyFilter();
                            }, 0);
                        }
                        
                        channelsProcessed++;
                        totalPostsLoaded += posts.length;
                        updateLoadingProgress(channelsProcessed, channelNames.length, totalPostsLoaded);
                        
                        return posts;
                    } catch (e) {
                        console.error(`Error loading channel ${channelName}:`, e);
                        channelsProcessed++;
                        updateLoadingProgress(channelsProcessed, channelNames.length, totalPostsLoaded);
                        return [];
                    }
                });
                
                await Promise.all(allChannelPromises);
                
                allPosts.sort((a, b) => (b.timestamp || b.created) - (a.timestamp || a.created));
                lastCacheTime = now;
                
                const loadTime = performance.now() - startTime;
                if (DEBUG_MODE) console.log(`All posts loaded in ${loadTime.toFixed(2)}ms (${allPosts.length} posts)`);
                
                applyFilter();
            } catch (e) {
                console.error('Error loading all posts:', e);
            }
        }

        async function loadPostsFromChannel(channelHandle, channelName, channelData) {
            const posts = [];
            
            try {
                const postsDir = await channelHandle.getDirectoryHandle('posts');
                
                const postDirs = [];
                for await (const [name, handle] of postsDir.entries()) {
                    if (handle.kind === 'directory' && name.startsWith('post_')) {
                        postDirs.push([name, handle]);
                    }
                }
                
                if (DEBUG_MODE) console.log(`Found ${postDirs.length} post directories in channel ${channelName}`);
                
                const allPromises = postDirs.map(async ([postDirName, postDirHandle]) => {
                    try {
                        const postId = postDirName.replace('post_', '');
                        
                        let hasReplies = false;
                        try {
                            await postDirHandle.getFileHandle('replies.json');
                            hasReplies = true;
                        } catch (e) {
                            hasReplies = false;
                        }
                        
                        const promises = [readJSONFile(postDirHandle, 'post.json')];
                        if (hasReplies) {
                            promises.push(readJSONFile(postDirHandle, 'replies.json', []));
                        }
                        
                        const results = await Promise.all(promises);
                        const postData = results[0];
                        const replies = hasReplies ? results[1] : [];
                        
                        if (!postData || !postData.id || postData.deleted) {
                            return null;
                        }
                        
                        const processedPost = {
                            ...postData,
                            author: postData.author || '–ê–Ω–æ–Ω–∏–º',
                            content: postData.content || '',
                            timestamp: postData.timestamp || Date.now(),
                            likes: postData.likes || 0,
                            dislikes: postData.dislikes || 0,
                            channelName: channelName,
                            channelData: channelData,
                            replyCount: replies ? countRepliesDeep(replies) : 0
                        };
                        
                        processedPost._hasImages = (postData.content || '').includes('<img');
                        processedPost._postDirHandle = postDirHandle;
                        
                        return processedPost;
                    } catch (e) {
                        console.error('Error loading post:', postDirName, e);
                        return null;
                    }
                });
                
                const allResults = await Promise.all(allPromises);
                posts.push(...allResults.filter(post => post !== null));
                
            } catch (e) {
                if (DEBUG_MODE) console.log('No posts directory found in channel:', channelName);
            }
            
            return posts;
        }

        async function loadPostImagesForFeed(post, imagesDir) {
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = post.content;
                const images = tempDiv.querySelectorAll('img');

                for (const img of images) {
                    const fileName = img.getAttribute('data-filename');
                    if (fileName) {
                        img.removeAttribute('src');
                    }
                    img.setAttribute('data-post-id', post.id);
                    img.setAttribute('data-channel-name', post.channelName);
                }

                post.content = tempDiv.innerHTML;

            } catch (e) {
                console.error('Error preparing post images:', e);
            }
        }

        async function loadPostImageForElement(imgElement) {
            try {
                const fileName = imgElement.getAttribute('data-filename');
                const postId = imgElement.getAttribute('data-post-id');
                const channelName = imgElement.getAttribute('data-channel-name');
                if (!fileName || !postId) return;
                const dataUrl = await loadFullImage(fileName, postId, channelName || null);
                if (dataUrl) imgElement.src = dataUrl;
            } catch (e) {
                console.error('Lazy image load failed:', e);
            }
        }

        async function loadSubscriptions() {
            try {
                const localSubscriptions = localStorage.getItem('8site_subscriptions');
                if (localSubscriptions && localSubscriptions !== 'null' && localSubscriptions !== 'undefined') {
                    const parsed = JSON.parse(localSubscriptions);
                    if (Array.isArray(parsed)) {
                        subscriptions = parsed;
                        return;
                    }
                }

                if (videoDirectoryHandle) {
                    try {
                        const subscriptionsFile = await videoDirectoryHandle.getFileHandle('.subscriptions.json');
                        const file = await subscriptionsFile.getFile();
                        const text = await file.text();
                        const fileSubscriptions = JSON.parse(text);

                        if (Array.isArray(fileSubscriptions)) {
                            subscriptions = fileSubscriptions;
                            localStorage.setItem('8site_subscriptions', JSON.stringify(fileSubscriptions));
                            return;
                        }
                    } catch (fileError) {
                        if (DEBUG_MODE) console.log('Could not load from file:', fileError.message);
                    }
                }

                subscriptions = [];
            } catch (e) {
                console.error('Error loading subscriptions:', e);
                subscriptions = [];
            }
        }

        async function loadSubscriptionsFromFile() {
            try {
                const localSubscriptions = localStorage.getItem('8site_subscriptions');
                if (localSubscriptions) {
                    return JSON.parse(localSubscriptions);
                }

                if (!videoDirectoryHandle) return null;

                const subscriptionsFile = await videoDirectoryHandle.getFileHandle('.subscriptions.json');
                const file = await subscriptionsFile.getFile();
                const text = await file.text();
                const fileSubscriptions = JSON.parse(text);

                localStorage.setItem('8site_subscriptions', JSON.stringify(fileSubscriptions));
                return fileSubscriptions;
            } catch (e) {
                if (DEBUG_MODE) console.log('No subscriptions found, using default');
                return null;
            }
        }

        async function loadChannelAvatar(channelName) {
            const cacheKey = `avatar_${channelName}`;
            
            if (avatarCache.has(cacheKey)) {
                const cached = avatarCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 600000) {
                    return cached.url;
                }
            }

            try {
                if (!videoDirectoryHandle) return null;

                let channelData = channelDataCache.get(channelName);
                if (!channelData) {
                    const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                    const channelDir = await channelsDir.getDirectoryHandle(channelName, { create: true });
                    channelData = await readJSONFile(channelDir, 'channel.json', {});
                    channelDataCache.set(channelName, channelData);
                }

                if (channelData && channelData.avatar) {
                    const imageCacheKey = `${channelName}_${channelData.avatar}`;
                    if (imageCache.has(imageCacheKey)) {
                        const cachedImage = imageCache.get(imageCacheKey);
                        avatarCache.set(cacheKey, { url: cachedImage, timestamp: Date.now() });
                        return cachedImage;
                    }

                    const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                    const channelDir = await channelsDir.getDirectoryHandle(channelName, { create: true });
                    const avatarUrl = await loadImageFile(channelDir, channelData.avatar);
                    
                    if (avatarUrl) {
                        avatarCache.set(cacheKey, { url: avatarUrl, timestamp: Date.now() });
                        imageCache.set(imageCacheKey, avatarUrl);
                        return avatarUrl;
                    }
                }
            } catch (e) {
                console.error('Error loading avatar for', channelName, e);
            }

            avatarCache.set(cacheKey, { url: null, timestamp: Date.now() });
            return null;
        }

        async function renderSubscribedChannelsList() {
            const container = document.getElementById('subscribedChannelsContainer');
            if (!container) return;

            try {
                const savedSubscriptions = await loadSubscriptionsFromFile();
                const subscribedChannels = Array.isArray(savedSubscriptions) ? savedSubscriptions : [];

                container.innerHTML = '';

                if (subscribedChannels.length === 0) {
                    const noSubs = document.createElement('div');
                    noSubs.className = 'sidebar-item';
                    noSubs.textContent = i18n.t('sidebar.noSubscriptions') || '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫';
                    noSubs.style.fontStyle = 'italic';
                    noSubs.style.color = '#999';
                    container.appendChild(noSubs);
                    return;
                }

                for (const channelName of subscribedChannels.slice(0, 10)) {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'sidebar-item';
                    link.dataset.channel = channelName;
                    link.style.display = 'flex';
                    link.style.alignItems = 'center';
                    link.style.gap = '8px';

                    const avatar = document.createElement('div');
                    avatar.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border-radius: 0;
                        background: #ff69b4;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 10px;
                        flex-shrink: 0;
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        cursor: pointer;
                    `;
                    avatar.textContent = channelName.charAt(0).toUpperCase();
                    avatar.title = '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–Ω–∞–ª—É';

                    const textSpan = document.createElement('span');
                    textSpan.textContent = channelName;
                    textSpan.style.overflow = 'hidden';
                    textSpan.style.textOverflow = 'ellipsis';
                    textSpan.style.whiteSpace = 'nowrap';
                    textSpan.style.flex = '1';

                    link.appendChild(avatar);
                    link.appendChild(textSpan);

                    avatar.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
                    });

                    textSpan.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
                    });

                    loadChannelAvatar(channelName).then(avatarUrl => {
                        if (DEBUG_MODE) console.log('=== Avatar loading result for', channelName, ':', avatarUrl, '===');
                        if (avatarUrl) {
                            if (DEBUG_MODE) console.log('Setting avatar background for', channelName);
                            avatar.style.backgroundImage = `url(${avatarUrl})`;
                            avatar.textContent = '';
                            if (DEBUG_MODE) console.log('Avatar set successfully for', channelName);
                        } else {
                            if (DEBUG_MODE) console.log('No avatar URL for', channelName, '- keeping initial letter');
                        }
                    }).catch((error) => {
                        console.error('Avatar failed to load for', channelName, ':', error);
                    });

                    container.appendChild(link);
                }

                if (subscribedChannels.length > 10) {
                    const moreItem = document.createElement('div');
                    moreItem.className = 'sidebar-item';
                    moreItem.style.fontSize = '11px';
                    moreItem.style.color = '#666';
                    moreItem.style.textAlign = 'center';
                    moreItem.style.cursor = 'pointer';
                    moreItem.textContent = `+${subscribedChannels.length - 10} –µ—â–µ`;
                    moreItem.addEventListener('click', () => {
                        window.open('youvi_subscriptions.html', '_blank');
                    });
                    container.appendChild(moreItem);
                }
            } catch (e) {
                console.error('Error rendering subscriptions:', e);
                container.innerHTML = `<div class="sidebar-item" style="font-style: italic; color: #999;">${i18n.t('sidebar.loadingError') || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</div>`;
            }
        }

        function sortPosts(posts) {
            const sorted = [...posts];
            
            switch (currentSort) {
                case 'new':
                    sorted.sort((a, b) => (b.timestamp || b.created || 0) - (a.timestamp || a.created || 0));
                    break;
                case 'best':
                    sorted.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                    break;
                case 'worst':
                    sorted.sort((a, b) => (b.dislikes || 0) - (a.dislikes || 0));
                    break;
                case 'random':
                    for (let i = sorted.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [sorted[i], sorted[j]] = [sorted[j], sorted[i]];
                    }
                    break;
            }
            
            return sorted;
        }

        function applyFilter() {
            if (currentFilter === 'subscriptions') {
                filteredPosts = allPosts.filter(post => 
                    !post.deleted && subscriptions.includes(post.channelName)
                );
            } else {
                filteredPosts = allPosts.filter(post => !post.deleted);
            }
            
            filteredPosts = sortPosts(filteredPosts);
            
            renderIndex = 0;
            renderPosts(true);
        }

        function renderPosts(reset = false) {
            const feedPosts = document.getElementById('feedPosts');
            
            if (reset) {
                feedPosts.innerHTML = '';
            }

            if (filteredPosts.length === 0) {
                feedPosts.innerHTML = `
                    <div class="empty-state">
                        <h3>${i18n.t('feed.noPosts') || '–ù–µ—Ç –ø–æ—Å—Ç–æ–≤'}</h3>
                        <p>${currentFilter === 'subscriptions' ? (i18n.t('feed.noPostsInSubscriptions') || '–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∏ –Ω–∞ –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –∏–ª–∏ –≤ –ø–æ–¥–ø–∏—Å–∫–∞—Ö –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤') : (i18n.t('feed.postsNotFound') || '–ü–æ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')}</p>
                    </div>
                `;
                return;
            }

            if (reset || renderIndex === 0) {
                feedPosts.innerHTML = '';
            }

            appendNextBatch();
            setupInfiniteScroll();

            const currentMode = localStorage.getItem('youvi_view_mode') || 'compact';
            if (currentMode === 'social') {
                document.getElementById('feedPosts').classList.add('social-mode');
            }
        }

        function renderPostHTML(post) {
            const timestamp = post.timestamp || post.created || Date.now();
            const date = new Date(timestamp).toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const isAuthorPost = post.isAuthorPost || false;
            const author = post.author || post.nick || '–ê–Ω–æ–Ω–∏–º';
            const isChannelNick = /\(–∫–∞\)\s*$/i.test(author);
            const cleanAuthor = isChannelNick ? author.replace(/\(–∫–∞\)\s*$/i, '').trim() : author;
            const nickColor = isAuthorPost ? '#d94b88' : getNickColor(cleanAuthor);
            const displayName = isAuthorPost ? post.channelName : cleanAuthor;
            const avatarText = displayName.charAt(0).toUpperCase();

            const replyCount = post.replyCount || 0;
            const hasImages = (post.content || post.text || '').includes('<img');

            return `
                    <div class="feed-post">
                        <div class="post-header">
                            <div class="post-avatar" id="postAvatar_${post.id}">
                                ${avatarText}
                            </div>
                            <div class="post-bubble">
                                <div class="post-info">
                                    <div class="post-author${isChannelNick || isAuthorPost ? ' channel-nick' : ''}" ${isAuthorPost ? `data-channel-name="${escapeHtml(displayName)}"` : (isChannelNick ? `data-channel-name="${escapeHtml(cleanAuthor)}"` : '')}>${escapeHtml(displayName)}</div>
                                    ${isAuthorPost ? `<span class="author-badge">${i18n.t('feed.author') || '–ê–≤—Ç–æ—Ä'}</span>` : ''}
                                    <div class="post-channel-badge">${escapeHtml(post.channelName || (i18n.t('feed.unknownChannel') || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª'))}</div>
                                    <div class="post-date">${date}</div>
                                </div>
                                <div class="post-content" id="postContent_${post.id}">
                                    ${post.content || post.text}
                                </div>
                                <div class="post-actions">
                                    <div class="post-stats">
                                        <button onclick="toggleLike('${post.id}')" class="like-btn" title="${i18n.t('feed.like') || '–õ–∞–π–∫'}">
                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M12 4l-8 8h6v8h4v-8h6l-8-8z" fill="currentColor"/>
                                            </svg>
                                            <span class="like-count">${post.likes || 0}</span>
                                        </button>
                                        <button onclick="toggleDislike('${post.id}')" class="dislike-btn" title="${i18n.t('feed.dislike') || '–î–∏–∑–ª–∞–π–∫'}">
                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M12 20l8-8h-6V4h-4v8H4l8 8z" fill="currentColor"/>
                                            </svg>
                                            <span class="dislike-count">${post.dislikes || 0}</span>
                                        </button>
                                        <span style="color: #999; font-size: 10px; margin-left: 8px;">
                                            ${replyCount > 0 ? `${replyCount} ${i18n.t('feed.replies') || '–æ—Ç–≤–µ—Ç–æ–≤'}` : (i18n.t('feed.noReplies') || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤')}
                                        </span>
                                        ${hasImages ? `<button onclick=\"togglePostImage('${post.id}')\" class=\"delete-btn\" data-post-id=\"${post.id}\" title=\"${i18n.t('feed.toggleImages') || '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'}\" style=\"margin-left: 8px;\">${i18n.t('feed.image') || '–ö–∞—Ä—Ç–∏–Ω–∫–∞'}</button>` : ''}
                                    </div>
                                    <a href="youvi_ch_feed_rep.html?channel=${encodeURIComponent(post.channelName)}&post_id=${encodeURIComponent(post.id)}" class="open-post-btn">${i18n.t('feed.open') || '–û—Ç–∫—Ä—ã—Ç—å'}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        function appendNextBatch() {
            if (isLoadingBatch) return;
            const feedPosts = document.getElementById('feedPosts');
            if (!feedPosts) return;
            if (renderIndex >= filteredPosts.length) return;
            isLoadingBatch = true;

            const end = Math.min(renderIndex + BATCH_SIZE, filteredPosts.length);
            const slice = filteredPosts.slice(renderIndex, end);
            
            const fragment = document.createDocumentFragment();
            
            const renderChunk = (startIdx) => {
                const chunkSize = 5;
                const endIdx = Math.min(startIdx + chunkSize, slice.length);
                const chunk = slice.slice(startIdx, endIdx);
                
                const html = chunk.map(renderPostHTML).join('');
                const container = document.createElement('div');
                container.innerHTML = html;
                
                while (container.firstChild) {
                    fragment.appendChild(container.firstChild);
                }
                
                if (endIdx < slice.length) {
                    requestAnimationFrame(() => renderChunk(endIdx));
                } else {
                    feedPosts.appendChild(fragment);
                    
                    setTimeout(() => {
                        loadPostAvatarsFor(slice);
                        processImagesInPosts();
                        setupLazyImages();
                    }, 0);
                    
                    renderIndex = end;
                    isLoadingBatch = false;
                }
            };
            
            renderChunk(0);
        }

        async function loadPostAvatarsFor(posts) {
            const channelGroups = new Map();
            
            for (const post of posts) {
                if (post.isAuthorPost && post.channelData && post.channelData.avatar) {
                    if (!channelGroups.has(post.channelName)) {
                        channelGroups.set(post.channelName, []);
                    }
                    channelGroups.get(post.channelName).push(post);
                } else {
                    const author = post.author || post.nick || '';
                    if (/\(–∫–∞\)\s*$/i.test(author)) {
                        const channelFromNick = author.replace(/\(–∫–∞\)\s*$/i, '').trim();
                        setTimeout(async () => {
                            try {
                                const url = await loadAvatarForChannelName(channelFromNick);
                                if (url) {
                                    const postAvatarEl = document.getElementById(`postAvatar_${post.id}`);
                                    if (postAvatarEl) {
                                        postAvatarEl.style.backgroundImage = `url(${url})`;
                                        postAvatarEl.classList.add('custom-avatar');
                                        postAvatarEl.textContent = '';
                                    }
                                }
                            } catch (e) {
                                console.error('Error setting (–∫–∞) avatar:', e);
                            }
                        }, 0);
                    }
                }
            }
            
            const channelPromises = Array.from(channelGroups.entries()).map(async ([channelName, channelPosts]) => {
                try {
                    const avatarUrl = await loadChannelAvatar(channelName);
                    if (avatarUrl) {
                        channelPosts.forEach(post => {
                            const postAvatarEl = document.getElementById(`postAvatar_${post.id}`);
                            if (postAvatarEl) {
                                postAvatarEl.style.backgroundImage = `url(${avatarUrl})`;
                                postAvatarEl.classList.add('custom-avatar');
                                postAvatarEl.textContent = '';
                            }
                        });
                    }
                } catch (e) {
                    console.error('Error loading avatar for channel:', channelName, e);
                }
            });
            
            Promise.all(channelPromises).catch(e => {
                console.error('Error in batch avatar loading:', e);
            });
        }

        function setupInfiniteScroll() {
            const feedPosts = document.getElementById('feedPosts');
            if (!feedPosts) return;
            let sentinel = document.getElementById('feedSentinel');
            if (!sentinel) {
                sentinel = document.createElement('div');
                sentinel.id = 'feedSentinel';
                sentinel.style.height = '1px';
                sentinel.style.width = '100%';
                feedPosts.appendChild(sentinel);
            }
            if (sentinelObserver) return;
            sentinelObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) appendNextBatch();
                });
            }, { root: null, rootMargin: '800px 0px', threshold: 0 });
            sentinelObserver.observe(sentinel);
        }

        async function loadPostAvatars() {
            for (const post of filteredPosts) {
                if (post.isAuthorPost && post.channelData && post.channelData.avatar) {
                    try {
                        const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
                        const channelDir = await channelsDir.getDirectoryHandle(post.channelName, { create: true });
                        const avatarUrl = await loadImageFile(channelDir, post.channelData.avatar);
                        if (avatarUrl) {
                            const postAvatarEl = document.getElementById(`postAvatar_${post.id}`);
                            if (postAvatarEl) {
                                postAvatarEl.style.backgroundImage = `url(${avatarUrl})`;
                                postAvatarEl.classList.add('custom-avatar');
                                postAvatarEl.textContent = '';
                            }
                        }
                    } catch (e) {
                        console.error('Error loading avatar for post:', e);
                    }
                } else {
                    try {
                        const author = post.author || post.nick || '';
                        if (/\(–∫–∞\)\s*$/i.test(author)) {
                            const channelFromNick = author.replace(/\(–∫–∞\)\s*$/i, '').trim();
                            const url = await loadAvatarForChannelName(channelFromNick);
                            if (url) {
                                const postAvatarEl = document.getElementById(`postAvatar_${post.id}`);
                                if (postAvatarEl) {
                                    postAvatarEl.style.backgroundImage = `url(${url})`;
                                    postAvatarEl.classList.add('custom-avatar');
                                    postAvatarEl.textContent = '';
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error setting (–∫–∞) avatar in all-feed:', e);
                    }
                }
            }
        }

        function processImagesInPosts() {
            const feedPosts = document.getElementById('feedPosts');
            const postElements = feedPosts.querySelectorAll('.feed-post');
            const isSocialMode = feedPosts.classList.contains('social-mode');
            
            postElements.forEach(postElement => {
                const images = postElement.querySelectorAll('.post-content img');
                images.forEach(img => {
                    if (isSocialMode) {
                        img.onclick = null;
                        img.style.cursor = 'default';
                        if (img.getAttribute('data-expanded') !== 'true') {
                            toggleImageSize(img);
                        }
                    } else {
                        img.onclick = (e) => {
                            e.stopPropagation();
                            toggleImageSize(img);
                        };
                        img.style.cursor = 'pointer';
                        if (img.getAttribute('data-expanded') === 'true') {
                            toggleImageSize(img);
                        }
                    }
                });
            });
        }

        function setupLazyImages() {
            const feedPosts = document.getElementById('feedPosts');
            if (!feedPosts) return;
            if (!lazyImageObserver) {
                lazyImageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            observer.unobserve(img);
                            if (!img.getAttribute('src') && img.getAttribute('data-filename')) {
                                loadPostImageForElement(img);
                            }
                        }
                    });
                }, { root: null, rootMargin: '600px 0px', threshold: 0 });
            }
            const imgs = feedPosts.querySelectorAll('.post-content img[data-filename]');
            imgs.forEach(img => {
                if (!img.getAttribute('src')) {
                    lazyImageObserver.observe(img);
                }
            });
        }

        function setupFilterButtons() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    applyFilter();
                });
            });
        }

        function setupSortingButtons() {
            const sortBtns = document.querySelectorAll('#sortNew, #sortBest, #sortWorst, #sortRandom');
            sortBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    sortBtns.forEach(b => b.classList.remove('active'));
                    
                    btn.classList.add('active');
                    
                    if (btn.id === 'sortNew') currentSort = 'new';
                    else if (btn.id === 'sortBest') currentSort = 'best';
                    else if (btn.id === 'sortWorst') currentSort = 'worst';
                    else if (btn.id === 'sortRandom') currentSort = 'random';
                    
                    applyFilter();
                });
            });
            
            const initialSortBtn = document.getElementById(`sort${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`);
            if (initialSortBtn) {
                initialSortBtn.classList.add('active');
            }
        }


        function setupViewModeToggle() {
            const compactBtn = document.getElementById('compactMode');
            const socialBtn = document.getElementById('socialMode');
            const feedPosts = document.getElementById('feedPosts');
            
            if (!compactBtn || !socialBtn || !feedPosts) return;
            
            const savedMode = localStorage.getItem('youvi_view_mode') || 'compact';
            if (savedMode === 'social') {
                setViewMode('social');
            } else {
                setViewMode('compact');
            }
            
            compactBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setViewMode('compact');
            });
            socialBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setViewMode('social');
            });
        }
        
        function setViewMode(mode) {
            const compactBtn = document.getElementById('compactMode');
            const socialBtn = document.getElementById('socialMode');
            const feedPosts = document.getElementById('feedPosts');
            const mainContent = document.querySelector('.main-content');
            
            if (!compactBtn || !socialBtn || !feedPosts || !mainContent) return;
            
            compactBtn.classList.remove('active');
            socialBtn.classList.remove('active');
            
            if (mode === 'compact') {
                compactBtn.classList.add('active');
                hideBanner();
            } else {
                socialBtn.classList.add('active');
                setTimeout(() => {
                    handleScroll();
                }, 100);
            }
            
            feedPosts.classList.toggle('social-mode', mode === 'social');
            mainContent.classList.toggle('social-mode', mode === 'social');
            
            localStorage.setItem('youvi_view_mode', mode);
            
            setTimeout(() => {
                const images = feedPosts.querySelectorAll('.post-content img');
                images.forEach(img => {
                    if (mode === 'social') {
                        if (img.getAttribute('data-expanded') !== 'true') {
                            toggleImageSize(img);
                        }
                    } else {
                        if (img.getAttribute('data-expanded') === 'true') {
                            toggleImageSize(img);
                        }
                    }
                });
            }, 100);
            
            processImagesInPosts();
        }

        async function loadAllVideosAndPlaylistsForAutocomplete() {
          if (typeof AutocompleteDataLoader === 'undefined') {
            console.error('[Autocomplete] AutocompleteDataLoader module not loaded');
            return { videos: [], playlists: [] };
          }
          
          if (!videoDirectoryHandle) {
            console.warn('[Autocomplete] videoDirectoryHandle not available yet, waiting...');
            for (let i = 0; i < 20; i++) {
              await new Promise(resolve => setTimeout(resolve, 100));
              if (videoDirectoryHandle) {
                if (DEBUG_MODE) console.log(`[Autocomplete] videoDirectoryHandle became available after ${(i + 1) * 100}ms`);
                break;
              }
            }
          }
          
          const result = await AutocompleteDataLoader.loadData();
          
          if (result.videos.length === 0 && result.playlists.length === 0 && videoDirectoryHandle) {
            if (DEBUG_MODE) console.log('[Autocomplete] Got empty results but directory handle exists, forcing refresh...');
            return await AutocompleteDataLoader.refreshData();
          }
          
          return result;
        }

        async function initializePage() {
            if (DEBUG_MODE) console.log('Initializing feed all page (optimized)...');
            const startTime = performance.now();

            setupViewModeToggle();
            setupBannerEvents();
            setupFilterButtons();
            setupSortingButtons();

            document.getElementById('feedPosts').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
                </div>
            `;

            try {
                const db = await openDB();
                const savedHandle = await getFromDB(db, 'videoDirectoryHandle');

                if (savedHandle) {
                    const permission = await savedHandle.queryPermission();

                    if (permission === 'granted' || (permission === 'prompt' && await savedHandle.requestPermission() === 'granted')) {
                        videoDirectoryHandle = savedHandle;
                        
                        const initPromises = [
                            loadSubscriptions(),
                            renderSubscribedChannelsList()
                        ];
                        
                        await Promise.all(initPromises);
                        
                        try {
                          const searchInput = document.getElementById('headerSearchInput');
                          if (searchInput && typeof AutocompleteIntegration !== 'undefined' && typeof YouviAutocomplete !== 'undefined') {
                            const { videos, playlists } = await loadAllVideosAndPlaylistsForAutocomplete();
                            
                            const cacheValid = await window.autocompleteCache.isCacheValid(
                              videos.length,
                              playlists.length
                            );
                            
                            const autocompleteIntegration = new AutocompleteIntegration();
                            await autocompleteIntegration.init(searchInput, {
                              videoDirectoryHandle: videoDirectoryHandle,
                              allVideos: cacheValid ? [] : videos,
                              allPlaylists: cacheValid ? [] : playlists
                            });
                            if (DEBUG_MODE) console.log('[Autocomplete] ‚úÖ Optimized initialization completed on youvi_feed_all.html');
                          }
                        } catch (error) {
                          console.error('[Autocomplete] Failed to initialize:', error);
                        }
                        
                        await loadAllPosts();
                        
                        const loadTime = performance.now() - startTime;
                        if (DEBUG_MODE) console.log(`Page initialized in ${loadTime.toFixed(2)}ms`);
                        
                    } else {
                        document.getElementById('feedPosts').innerHTML = `
                            <div class="empty-state">
                                <h3>${i18n.t('feed.noFolderAccess') || '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ —Å –≤–∏–¥–µ–æ'}</h3>
                                <p>${i18n.t('feed.selectFolderFirst') || '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –≤–∏–¥–µ–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ'}</p>
                            </div>
                        `;
                        renderSubscribedChannelsList();
                    }
                } else {
                    document.getElementById('feedPosts').innerHTML = `
                        <div class="empty-state">
                            <h3>${i18n.t('feed.noFolderSelected') || '–ü–∞–ø–∫–∞ —Å –≤–∏–¥–µ–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞'}</h3>
                            <p>${i18n.t('feed.selectFolderFirst') || '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –≤–∏–¥–µ–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ'}</p>
                        </div>
                    `;
                    renderSubscribedChannelsList();
                }
            } catch (e) {
                console.error('Error initializing page:', e);
                document.getElementById('feedPosts').innerHTML = `
                    <div class="empty-state">
                        <h3>${i18n.t('feed.loadError') || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</h3>
                        <p>${i18n.t('feed.loadErrorDesc') || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö'}</p>
                    </div>
                `;
                renderSubscribedChannelsList();
            }
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
    
    <!-- Autocomplete Module -->
    <link rel="stylesheet" href="youvi/autocomplete/autocomplete.css">
    <script src="youvi/autocomplete-data-loader.js"></script>
    <script src="youvi/autocomplete/autocomplete-cache.js"></script>
    <script src="youvi/autocomplete/autocomplete.js"></script>
    <script src="youvi/autocomplete/autocomplete-integration.js"></script>
    
    <script src="youvi/themes/theme-toggle.js"></script>
    
    <!-- i18n System -->
    <script src="youvi/i18n/ru.js"></script>
    <script src="youvi/i18n/en.js"></script>
    <script src="youvi/i18n/uk.js"></script>
    <script src="youvi/i18n/i18n.js"></script>
    
    <!-- Language Switcher Handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const langSwitcher = document.getElementById('langSwitcher');
            if (langSwitcher) {
                const savedLang = localStorage.getItem('youvi-language') || 'ru';
                langSwitcher.value = savedLang;
                
                langSwitcher.addEventListener('change', function() {
                    const newLang = this.value;
                    localStorage.setItem('youvi-language', newLang);
                    if (typeof i18n !== 'undefined' && i18n.setLanguage) {
                        i18n.setLanguage(newLang);
                    }
                });
            }
        });
    </script>
</body>
</html>