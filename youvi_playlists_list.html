<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="playlists.pageTitle">–ü–ª–µ–π–ª–∏—Å—Ç—ã | Youvi</title>
    <script>

        (function() {
            var theme = localStorage.getItem('youvi-theme');
            var sidebar = localStorage.getItem('sidebarCollapsed');
            
            var htmlClasses = [];
            if (theme === 'dark') htmlClasses.push('dark-theme');
            else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
            if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
            if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
        })();
    </script>
    <!-- Header styles -->
    <link rel="stylesheet" href="youvi/header/youvi-header.css">
    
    <script src="youvi/sidebar-toggle.js"></script>
    <script src="youvi/sidebar-scroll.js"></script>
    
    <!-- Video ID System -->
    <script src="youvi/video-id.js"></script>
    
    <!-- i18n System -->
    <script src="youvi/i18n/ru.js"></script>
    <script src="youvi/i18n/en.js"></script>
    <script src="youvi/i18n/uk.js"></script>
    <script src="youvi/i18n/i18n.js"></script>
    
    <link rel="stylesheet" href="youvi/sidebar.css">
    <link rel="stylesheet" href="youvi/sidebar-scroll.css">
    <link rel="stylesheet" href="youvi/pagination.css">
    
    <!-- Theme System -->
    <link rel="stylesheet" href="youvi/themes/dark-theme.css">
    <link rel="stylesheet" href="youvi/themes/theme-dropdown.css">
    <script src="youvi/themes/theme-toggle.js"></script>
    <link rel="stylesheet" href="youvi/sticky-video.css">
    
    <style>
        :root {
            --bg: #ffeef6;
            --panel: #fff;
            --accent: #ff6fb5;
            --accent-dark: #d94b88;
            --muted: #f6dfea;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --radius: 14px;
        }

        .btn { padding: 6px 10px; border-radius: 4px; background: #ff69b4; border: none; cursor: pointer; font-weight: 600; color: #fff; font-size: 12px; }
        .btn.secondary { background: #eee; color: #333; }
        .btn.primary { background: #d94b88; color: #fff; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; padding: 20px; align-items: center; justify-content: center; }
        .modal-content { background: #fff; border-radius: 8px; max-width: 700px; width: 90%; margin: 0; padding: 20px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee}
        .modal-header h3{margin:0;font-size:16px}
        .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
        .playlist-input{width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:12px;margin-bottom:6px}
        .video-search{margin-bottom:8px}
        .video-search input{width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:12px}
        .video-list{max-height:350px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;background:#fff}
        .video-list-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #eee}
        .video-list-item:last-child{border-bottom:none}
        .drag-handle{cursor:move;color:#666;font-size:14px;padding:0 4px;margin-right:4px}
        .modal-actions{display:flex;gap:6px;margin:8px 0;justify-content:flex-end}

        .modal-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            border-top: 1px solid #eee;
            background: #f9f9f9;
        }

        .modal-pagination button {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 60px;
        }

        .modal-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-pagination span {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #111;
            --header-height: 88px; --footer-height: 220px; }

        .top-nav {
            background: #d94b88;
            border-bottom: 1px solid #c2185b;
            padding: 4px 0;
        }

        .top-nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 0;
            transition: color 0.2s;
        }

        .top-nav a:hover {
            color: #ffd6ea;
        }

        .top-nav a.active {
            color: #ffd6ea;
            font-weight: 600;
        }

        .header {
            background: #FFE7F4; padding: 0;
            border-bottom: 1px solid #f2cfe1;
            min-height: 40px;
            width: 100%; }

        .header-content-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            box-sizing: border-box;
            max-width: 1600px; margin: 0 auto; padding: 0 20px; width: 100%; min-height: 40px; }

        .nav-bar {
            display: flex;
            align-items: center;
            width: 100%; justify-content: space-between;
            height: 100%;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-left: calc(200px + 20px + 20px); }

        .nav-right-actions {
            display: flex;
            align-items: center;
            gap: 15px; }

        .nav-links a {
            color: #111; text-decoration: none;
            font-size: 13px;
            padding: 5px 0;
        }





        .search-btn {
            padding: 8px 15px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .user-actions a {
            color: #111; text-decoration: none;
            font-size: 13px;
        }
        
        .lang-switcher {
            margin-left: auto;
        }
        
        .lang-select {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            outline: none;
        }
        
        .lang-select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-select option {
            background: #d94b88;
            color: #fff;
        }


        .container {
            width: 100%;
            margin: 0;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: stretch;
            min-height: calc(100vh - 200px);
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }
        
        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
        }
        
        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
        }
        
        .header-content-wrapper,
        .top-nav-content {
            max-width: none !important;
            margin: 0 !important;
        }
		
		html, body {
            height: 100%;
        }

        .sidebar-collapsed .sidebar,
        html.sidebar-collapsed .sidebar {
            width: 60px !important;
            padding: 10px 8px !important;
            display: block !important;
            position: sticky !important;
            top: 40px !important;
            max-height: calc(100vh - 75px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .sidebar-collapsed .sidebar-title,
        html.sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-item,
        html.sidebar-collapsed .sidebar-item {
            padding: 8px !important;
            padding-left: 5px !important;
            padding-right: 8px !important;
            justify-content: center !important;
            border-left: 3px solid transparent !important;
            border-radius: 4px;
            font-size: 0 !important;
        }

        .sidebar-collapsed .sidebar-item svg,
        html.sidebar-collapsed .sidebar-item svg {
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
        }

        .sidebar-collapsed .container,
        html.sidebar-collapsed .container {
            padding-left: 20px;
        }

        .sidebar-collapsed .content-wrapper,
        html.sidebar-collapsed .content-wrapper {
            max-width: 1500px;
        }

        .main-content {
            flex: 1;
            display: flex; flex-direction: column; min-height: 0; min-width: 0; padding-top: 5px; }

        .video-player {
            width: 100%;
            height: 400px;
            background: #eee;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 20px;
        }

        .video-title {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .video-meta {
            color: #ccc;
            font-size: 14px;
        }

        .play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(255, 105, 180, 0.9);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #ff69b4;
            width: 35%;
        }

        .time-display {
            position: absolute;
            bottom: 10px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .video-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px; margin-bottom: 15px;
            color: #fff;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }

        .video-card {
            position: relative;
            cursor: pointer;
        }

        .video-thumbnail {
            width: 100%;
            height: auto; aspect-ratio: 16/9; background: #eee;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            margin-bottom: 8px;
            display: block; }

        .video-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
            color: #fff; }

        .video-info {
            padding: 0 5px;
        }

        .video-card-title {
            font-size: 16px; margin-bottom: 3px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            color: #111;
        }

        .video-playlist {
            font-size: 14px; color: #ff69b4;
            margin-bottom: 2px;
        }

        .video-category {
            font-size: 14px; color: #666;
        }

        .video-tag-link, .video-category-link { color: #666; text-decoration: none; margin-right: 5px; cursor: pointer; }

        .playlists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;
            margin-top: 10px;
        }

        .playlist-item {
            background: #fff; border: none; border-radius: 6px; overflow: hidden; cursor: pointer;
            transition: none;
            position: relative;
            max-width: 280px; }
        
        .playlist-item-link {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0;
            pointer-events: none;
            text-decoration: none;
            color: transparent;
        }
        
        .playlist-item:hover .playlist-item-link {
            pointer-events: auto;
        }

        .playlist-thumbnail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            aspect-ratio: 16/9;
            background: #eee; position: relative; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px;
            overflow: hidden; }

        .playlist-thumb {
            background: #eee; display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 10px;
            border: none; position: relative;
            overflow: hidden;
        }

        .playlist-info {
            padding: 8px 5px; background: transparent; border-top: none; }

        .playlist-title {
            font-weight: normal;
            margin-bottom: 3px;
            font-size: 16px;
            color: #111;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .playlist-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }

        .playlist-channel {
            font-size: 14px;
            color: #ff69b4; }

        .playlist-channel-link {
            color: #ff69b4; text-decoration: none;
            font-weight: normal;
        }

        .playlist-count-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 2px;
            z-index: 2;
        }

        .playlist-channel-link:hover {
            text-decoration: underline;
        }

        .playlist-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity .2s;
            z-index: 10;
        }

        .playlist-item:hover .playlist-actions {
            opacity: 1;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            background: rgba(0,0,0,0.7);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: var(--accent);
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .skeleton-item {
            pointer-events: none;
        }
        
        .skeleton-thumb {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            aspect-ratio: 16/9;
        }
        
        .skeleton-line {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .dark-theme .skeleton-thumb,
        .dark-theme .skeleton-line {
            background: linear-gradient(90deg, #3a3a3a 25%, #4a4a4a 50%, #3a3a3a 75%);
            background-size: 200% 100%;
        }

        #playlistsContainer { padding: 0 20px; }
        #paginationContainer { padding: 0 20px; }

        @media (max-width: 1024px) {
            .sidebar-right {
                display: none;
            }
            
            .playlists-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                gap: 20px;
                padding: 10px 0;
                margin-bottom: 20px;
            }
            
            .sidebar-section {
                flex-shrink: 0;
                margin-bottom: 0;
            }
            
            .nav-links {
                display: none;
            }
            
            .search-input {
                width: 150px;
            }
            
            .playlists-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px; }
        }

        @media (max-width: 480px) {
            .nav-bar {
                padding: 0 10px;
            }
            
            .search-area {
                margin-right: 10px;
            }
            
            .search-input {
                width: 120px;
            }
            
            .playlists-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 8px; }
        }

        .playlist-section-title {
            font-size: 20px;
            margin-bottom: 5px; color: #111;
            }

        .playlist-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    margin-bottom: 5px; min-height: 32px;
    gap: 20px;
}

.playlist-section-all-link {
    color: #333;
    text-decoration: none;
    font-size: 12px;
    cursor: pointer;
    flex-shrink: 0;
    white-space: nowrap;
    margin-left: auto;
}

        .video-carousel-wrapper {
            position: relative;
            padding: 0 20px; }

        .video-carousel {
    display: flex;
    overflow: hidden;
    gap: 15px;
    width: 100%;
    justify-content: flex-start;
}



        .video-carousel .video-card {
    flex: 1;
    max-width: calc((100% - 60px) / 5);
    min-width: 160px;
    overflow: hidden;
    transition: transform .2s, box-shadow .2s;
}
        .video-carousel .video-thumbnail {
            background: #eee;
            position: relative;
            overflow: hidden;
            width: 100%; height: 100px; margin-bottom: 6px; display: block; }

        .video-carousel .video-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
            color: #fff;
            z-index: 2; }

        .video-carousel .video-info {
            padding: 0 5px; }
        
        .video-carousel .video-playlist { font-size: 11px;
            color: #ff69b4;
            margin-bottom: 2px;
        }

        .video-carousel .video-card-title {
            font-size: 16px; margin-bottom: 3px; color: #111;
        }

        .video-carousel .video-category {
            font-size: 13px; color: #666; }

        .carousel-nav-btn {
            position: absolute;
            top: 50%; transform: translateY(-50%); background: rgba(128, 128, 128, 0.8); color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%; font-size: 20px;
            line-height: 1;
            height: 50px;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: opacity 0.2s;
            margin-top: -25px; }

        .carousel-nav-btn.prev-btn {
            left: 20px; }

        .carousel-nav-btn.next-btn {
            right: 20px; }

        @media (max-width: 1024px) {
            .video-carousel-wrapper {
                padding: 0 30px;
            }
            .carousel-nav-btn {
                padding: 8px 12px;
                font-size: 18px;
                height: 40px;
                width: 40px;
            }
        }

        @media (max-width: 768px) {
            .video-carousel-wrapper {
                padding: 0 20px;
            }
            .carousel-nav-btn {
                padding: 6px 10px;
                font-size: 16px;
                height: 35px;
                width: 35px;
            }
            .playlist-section-title {
                font-size: 16px;
                padding-left: 0;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .video-carousel-wrapper {
                padding: 0 10px;
            }
            .carousel-nav-btn {
                display: none; }
            .playlist-section-title {
                font-size: 16px;
                padding-left: 0;
                text-align: center;
            }
        }

        @media (max-width: 768px) {
    
    }

        .latest-title {
            font-size: 20px;
            margin: 10px 0 8px 20px;
            color: #111;
        }

        .main-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            margin-top: 5px;
            padding: 0 20px;
        }

        .section-title {
            font-size: 24px;
            color: #111;
            margin: 0;
        }
        
        .main-content-header .btn {
            flex-shrink: 0;
        }

        .footer {
            background: #2c2c2c;
            color: #fff;
            padding: 25px 0 15px 0;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .footer-logo {
            flex-shrink: 0;
            width: 200px;
        }

        .footer-logo img {
            height: 40px;
            width: auto;
        }

        .footer-logo p {
            margin-top: 8px;
            font-size: 11px;
            color: #ccc;
            line-height: 1.3;
        }

        .footer-sections {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-main {
            display: flex;
            gap: 30px;
            flex: 1;
        }

        .footer-right {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .footer-mascot {
            flex-shrink: 0;
        }

        .footer-mascot img {
            height: 180px;
            width: auto;
        }

        .footer-section {
            flex: 1;
        }

        .footer-section h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #fff;
            font-weight: 600;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-section li {
            margin-bottom: 6px;
        }

        .footer-section a {
            color: #ccc;
            text-decoration: none;
            font-size: 11px;
            transition: color 0.2s;
        }

        .footer-section a:hover {
            color: #ff69b4;
        }

        .footer-bottom {
            border-top: 1px solid #444;
            margin-top: 20px;
            padding-top: 15px;
            text-align: center;
            color: #999;
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .footer-sections {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-section {
                text-align: center;
            }
        }

        @media (min-width: 1400px) {
            .playlists-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        @media (min-width: 1700px) {
            .footer-content {
                max-width: 1700px !important;
            }
        }

        @media (min-width: 2000px) {
            .footer-content {
                max-width: 1800px !important;
            }
        }
        
        body.dark-theme input.search-input {
            background: #4a3a34 !important;
            color: #fff !important;
            border-color: #555 !important;
        }
        
        body.dark-theme input.search-input::placeholder {
            color: #999 !important;
        }
        
        .sidebar-collapsed .sidebar-section:has(#sidebarTagsContainer),
        html.sidebar-collapsed .sidebar-section:has(#sidebarTagsContainer) {
            display: none !important;
        }
        
    </style>
</head>
<link rel="icon" href="favicon/youvi/favicon.ico" type="image/x-icon">
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="top-nav-content">
      <a href="youvi_main.html" data-i18n="nav.video">–í–∏–¥–µ–æ</a>
      <a href="index.html" data-i18n="nav.management">–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</a>
      <a href="youvi_ch_list.html" data-i18n="nav.channels">–ö–∞–Ω–∞–ª—ã</a>
      <a href="youvi_playlists_list.html" class="active" data-i18n="nav.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a>
      <a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a> 
      <a href="wiki/index.html" data-i18n="nav.wiki">Wiki</a>
      <div class="lang-switcher">
        <select id="langSwitcher" class="lang-select">
          <option value="ru">üá∑üá∫ RU</option>
          <option value="en">üá¨üáß EN</option>
          <option value="uk">üá∫üá¶ UK</option>
        </select>
      </div>
        </div>
    </div>

    <!-- Header -->
  <!-- Header -->
  <header class="header">
    <div class="header-content-wrapper">
      <div class="header-left">
        <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
        
        <div class="logo">
          <a href="youvi_main.html">
            <img src="images/logo_youvi_ind.png" alt="Youvi logo">
          </a>
        </div>
      </div>
      
      <div class="header-center">
        <div class="search-area autocomplete-wrapper">
          <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." class="search-input" data-i18n-placeholder="search.placeholder">
          <button id="doSearch" class="search-btn" data-i18n="search.button">–ù–∞–π—Ç–∏</button>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-actions">
          <div class="settings-container">
            <a href="#" class="settings-btn">‚öô</a>
            <div class="theme-dropdown">
              <button class="theme-dropdown-item" data-theme="light" data-i18n="themes.light">–ë–µ–ª–∞—è</button>
              <button class="theme-dropdown-item" data-theme="dark" data-i18n="themes.dark">–ß–µ—Ä–Ω–∞—è</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.navigation">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                <a href="youvi_main.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
                <a href="youvi_feed_all.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 11a9 9 0 0 1 9 9"/>
                        <path d="M4 4a16 16 0 0 1 16 16"/>
                        <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <span data-i18n="sidebar.feed">Feed</span>
                </a>
                <a href="youvi_tags.html" class="sidebar-item nav-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="1.5">
                     <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                  <line x1="7" y1="7" x2="7.01" y2="7"/>
                 </svg>
                    <span data-i18n="sidebar.allTags">–í—Å–µ —Ç–µ–≥–∏</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.library">–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                <a href="youvi_history.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</span>
                </a>
                <a href="youvi_fav.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                </a>
                <a href="youvi_playlists_list.html" class="sidebar-item library-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</span>
                </a>
                <a href="youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</span>
                </a>
                <a href="youvi_subscriptions.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span data-i18n="sidebar.subscriptions">–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.subscriptionsTitle">–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                <div id="subscribedChannelsContainer"></div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="sidebar.sorting">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
                <div id="sortOptionsContainer">
                <a href="#" class="sidebar-item library-item" id="sortNew">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span data-i18n="sidebar.sortNew">–ù–æ–≤—ã–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortPopular">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <span data-i18n="sidebar.sortPopular">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortOld">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span data-i18n="sidebar.sortOld">–°—Ç–∞—Ä—ã–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortRandom">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="3" ry="3"/>
                        <circle cx="8" cy="8" r="1"/>
                        <circle cx="16" cy="8" r="1"/>
                        <circle cx="8" cy="16" r="1"/>
                        <circle cx="16" cy="16" r="1"/>
                        <circle cx="12" cy="12" r="1"/>
                    </svg>
                    <span data-i18n="sidebar.sortRandom">–°–ª—É—á–∞–π–Ω—ã–µ</span>
                </a>
                <a href="#" class="sidebar-item library-item" id="sortAlphabetical">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 16L8 6l4 10"/>
                        <path d="M5 13h6"/>
                        <path d="M14 6h6"/>
                        <path d="M14 12h6"/>
                        <path d="M14 18h6"/>
                    </svg>
                    <span data-i18n="sidebar.sortAlphabetical">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</span>
                </a>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title" data-i18n="playlists.categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <a href="#" class="sidebar-item active" id="allPlaylistsLink" data-i18n="playlists.allCategories">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
                <div id="sidebarTagsContainer"></div>
            </div>
        </aside>

        <!-- Content Wrapper (centered) -->
        <div class="content-wrapper">
        <!-- Main Content -->
        <main class="main-content">
            <div class="main-content-header">
                <h1 class="section-title" data-i18n="playlists.title">–ü–ª–µ–π–ª–∏—Å—Ç—ã</h1>
                <button id="createGlobalPlaylist" class="btn primary" data-i18n="playlists.createPlaylist">–°–æ–∑–¥–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
            </div>

            <section id="playlistsContainer">
                <div class="loading" data-i18n="playlists.loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤...</div>
            </section>
            <div id="paginationContainer"></div>
        </main>
        </div><!-- /content-wrapper -->
<!-- Create Playlist Modal -->
<div id="createPlaylistModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-i18n="playlists.createNewPlaylist">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</h3>
      <button class="close-btn" data-close="create">&times;</button>
    </div>
   <input type="text" id="newPlaylistTitle" class="playlist-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞" data-i18n-placeholder="playlists.playlistName">
<input type="text" id="newPlaylistCategories" class="playlist-input" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä: –ú—É–∑—ã–∫–∞, –ê–Ω–∏–º–µ)" data-i18n-placeholder="playlists.categoriesPlaceholder">
    <div class="video-search">
      <input type="text" id="videoSearch" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." data-i18n-placeholder="playlists.searchVideos">
    </div>
    <div style="display:flex;gap:6px;margin:4px 0 6px;align-items:center">
      <button id="selectAllVideos" class="btn secondary" type="button" data-i18n="playlists.selectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ</button>
      <button id="clearSelection" class="btn secondary" type="button" data-i18n="playlists.clearSelection">–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
      <div id="selectionCounter" style="margin-left:auto;font-size:12px;color:#7a3c55"><span data-i18n="playlists.selected">–í—ã–±—Ä–∞–Ω–æ</span>: 0</div>
    </div>
    <div class="video-list" id="videoList" style="user-select: none;"></div>
    <div class="modal-actions">
      <button id="cancelPlaylist" class="btn secondary" data-i18n="playlists.cancel">–û—Ç–º–µ–Ω–∞</button>
      <button id="savePlaylist" class="btn primary" data-i18n="playlists.create">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Edit Playlist Modal -->
<div id="editPlaylistModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-i18n="playlists.editPlaylist">–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è</h3>
      <button class="close-btn" data-close="edit">&times;</button>
    </div>
    <input type="text" id="editPlaylistTitle" class="playlist-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞" data-i18n-placeholder="playlists.playlistName">
    <input type="text" id="editPlaylistCategories" class="playlist-input" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" data-i18n-placeholder="playlists.categories">
    <div style="display:flex;gap:8px;margin:8px 0;align-items:center;">
      <h4 style="margin:0;font-size:14px;" data-i18n="playlists.videosInPlaylist">–í–∏–¥–µ–æ –≤ –ø–ª–µ–π–ª–∏—Å—Ç–µ:</h4>
      <button id="addVideosToPlaylist" class="btn secondary" data-i18n="playlists.addVideos">–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ</button>
      <div id="playlistTypeInfo" style="margin-left:auto;font-size:11px;color:#666;"></div>
    </div>
    <div class="video-search">
      <input type="text" id="editPlaylistVideoSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –≤ –ø–ª–µ–π–ª–∏—Å—Ç–µ..." data-i18n-placeholder="playlists.searchInPlaylist">
    </div>
    <div id="editPlaylistVideosList" style="max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;background:#fff;margin-bottom:8px;user-select:none;"></div>
    <div class="modal-actions">
      <button id="cancelEditPlaylist" class="btn secondary" data-i18n="playlists.cancel">–û—Ç–º–µ–Ω–∞</button>
      <button id="saveEditPlaylist" class="btn primary" data-i18n="playlists.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
  </div>

<!-- Add Videos Modal -->
<div id="addVideosModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-i18n="playlists.addToPlaylist">–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ –≤ –ø–ª–µ–π–ª–∏—Å—Ç</h3>
      <button class="close-btn" data-close="addVideos">&times;</button>
    </div>
    <div class="video-search">
      <input type="text" id="addVideoSearch" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." data-i18n-placeholder="playlists.searchVideos">
      <div class="search-info" style="font-size:11px;color:#666;margin-top:4px;text-align:center;"></div>
    </div>
    <div style="display:flex;gap:6px;margin:4px 0 6px;align-items:center">
      <button id="selectAllAddVideos" class="btn secondary" data-i18n="playlists.selectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ</button>
      <button id="clearAddSelection" class="btn secondary" data-i18n="playlists.clearSelection">–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
      <div id="addSelectionCounter" style="margin-left:auto;font-size:12px;color:#7a3c55"><span data-i18n="playlists.selected">–í—ã–±—Ä–∞–Ω–æ</span>: 0</div>
    </div>
    <div class="video-list" id="addVideoList"></div>
    <div class="modal-actions">
      <button id="cancelAddVideos" class="btn secondary" data-i18n="playlists.cancel">–û—Ç–º–µ–Ω–∞</button>
      <button id="confirmAddVideos" class="btn primary" data-i18n="playlists.addSelectedVideos">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
  </div>

    </div>  
   <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-logo">
                    <img src="images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
                    <p data-i18n="footer.description">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ.</p>
                </div>
                <div class="footer-sections">
                    <div class="footer-section">
                        <h3 data-i18n="footer.sections">–†–∞–∑–¥–µ–ª—ã</h3>
                        <ul>
                            <li><a href="youvi_main.html" data-i18n="footer.video">–í–∏–¥–µ–æ</a></li>
                            <li><a href="youvi_tags.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
                            <li><a href="youvi_feed_all.html" data-i18n="nav.feed">Feed</a></li>
                            <li><a href="index.html" data-i18n="nav.management">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="sidebar.library">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
                        <ul>
                            <li><a href="youvi_ch_list.html" data-i18n="sidebar.channels">–ö–∞–Ω–∞–ª—ã</a></li>
                            <li><a href="youvi_playlists_list.html" data-i18n="sidebar.playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</a></li>
                            <li><a href="youvi_subscriptions.html" data-i18n="sidebar.subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</a></li>
                            <li><a href="youvi_fav.html" data-i18n="sidebar.favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a></li>
                            <li><a href="youvi_history.html" data-i18n="sidebar.history">–ò—Å—Ç–æ—Ä–∏—è</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="nav.wiki">Wiki</h3>
                        <ul>
                            <li><a href="wiki/index.html" data-i18n="sidebar.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li><a href="wiki/player.html" data-i18n="footer.wiki.player">–ü–ª–µ–µ—Ä</a></li>
                            <li><a href="wiki/danmaku.html" data-i18n="footer.wiki.danmaku">–î–∞–Ω–º–∞–∫—É</a></li>
                            <li><a href="wiki/tags/general.html" data-i18n="sidebar.tags">–¢–µ–≥–∏</a></li>
                            <li><a href="wiki/tags/rules.html" data-i18n="footer.wiki.taggingRules">–ü—Ä–∞–≤–∏–ª–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</a></li>
                            <li><a href="wiki/search/general.html" data-i18n="footer.wiki.search">–ü–æ–∏—Å–∫</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.pgc">PGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Anime (ct)" data-i18n="footer.categories.anime">Anime</a></li>
                            <li><a href="youvi_main.html?tag=Animation (ct)" data-i18n="footer.categories.animation">Animation</a></li>
                            <li><a href="youvi_main.html?tag=Movies (ct)" data-i18n="footer.categories.movies">Movies</a></li>
                            <li><a href="youvi_main.html?tag=Series (ct)" data-i18n="footer.categories.series">Series</a></li>
                            <li><a href="youvi_main.html?tag=Music (ct)" data-i18n="footer.categories.music">Music</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3 data-i18n="footer.ugc">UGC</h3>
                        <ul>
                            <li><a href="youvi_main.html?tag=Games (ct)" data-i18n="footer.categories.games">Games</a></li>
                            <li><a href="youvi_main.html?tag=Technology (ct)" data-i18n="footer.categories.tech">Technology</a></li>
                            <li><a href="youvi_main.html?tag=Entertainment (ct)" data-i18n="footer.categories.entertainment">Entertainment</a></li>
                            <li><a href="youvi_main.html?tag=IRL (ct)" data-i18n="footer.categories.irl">IRL</a></li>
                            <li><a href="youvi_main.html?tag=TV (ct)" data-i18n="footer.categories.tv">TV</a></li>
                            <li><a href="youvi_main.html?tag=Education (ct)" data-i18n="footer.categories.education">Education</a></li>
                            <li><a href="youvi_main.html?tag=Other (ct)" data-i18n="footer.categories.other">Other</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h3 data-i18n="footer.about">–û —Å–∞–π—Ç–µ</h3>
                        <ul>
                            <li><a href="wiki/about.html" data-i18n="footer.aboutSite">–ü—Ä–æ —Å–∞–π—Ç</a></li>
                            <li><a href="wiki/docs.html" data-i18n="footer.docs">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></li>
                            <li><a href="wiki/tech.html" data-i18n="footer.tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-right">
                <div class="footer-mascot">
                    <img src="images/mascot1.png" alt="Yuvi" loading="lazy">
                </div>
            </div>
        </div>
    </footer>
    

    <script>

      const supportsFS = 'showDirectoryPicker' in window;


      const DEBUG_MODE = false;
      const log = (...args) => { if (DEBUG_MODE) console.log(...args); };
      
      let videoDirectoryHandle = null;
      let allPlaylists = [];
      let allVideos = [];
      let filteredPlaylists = [];
      let selectedVideoIds = new Set();
      let currentPage = 1;
      const itemsPerPage = 40;
      const videosPerPage = 5;
      let carouselVideoPages = new Map();
      let allPlaylistCategories = new Map();
      let currentSearchQuery = new URLSearchParams(window.location.search).get('search') || '';
      let currentSort = new URLSearchParams(window.location.search).get('sort') || localStorage.getItem('playlistSort') || 'new';
      let currentFilter = new URLSearchParams(window.location.search).get('tag') || 'all';
      let db = null;
      let currentEditingPlaylist = null;
      let editingSelectedVideos = new Set();

      let modalVideosPerPage = 50;
      let currentModalPage = 1;
      let modalVideoCache = new Map();
      let modalSearchTimeout = null;
      let modalFilteredVideos = [];
      let modalVideoPreviewCache = new Map();
      let modalPreviewTasks = new Set();
      const MAX_CACHE_SIZE = 100;

      async function openDB(){
        return new Promise((resolve,reject)=>{
          const req = indexedDB.open('8SiteDB', 1);
          req.onupgradeneeded = ()=> {
            const db = req.result;
            if (!db.objectStoreNames.contains('handles')) db.createObjectStore('handles');
            if (!db.objectStoreNames.contains('videos')) db.createObjectStore('videos', { keyPath: 'name' });
            if (!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', { keyPath: 'id' });
          };
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
      }
      async function getFromDB(key){
        const tx = db.transaction('handles','readonly');
        const store = tx.objectStore('handles');
        return new Promise((resolve)=> {
          const r = store.get(key);
          r.onsuccess = ()=> resolve(r.result);
          r.onerror = ()=> resolve(null);
        });
      }
      async function saveToDB(key, value) {
        const tx = db.transaction('handles', 'readwrite');
        const store = tx.objectStore('handles');
        await store.put(value, key);
      }

      async function saveVideoToDB(video) {
        const tx = db.transaction('videos', 'readwrite');
        const store = tx.objectStore('videos');
        await store.put(video);
      }

      async function getVideosFromDB() {
        const tx = db.transaction('videos', 'readonly');
        const store = tx.objectStore('videos');
        return new Promise((resolve) => {
          const r = store.getAll();
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve([]);
        });
      }

      async function deleteVideoFromDB(videoName) {
        const tx = db.transaction('videos', 'readwrite');
        const store = tx.objectStore('videos');
        await store.delete(videoName);
      }

      async function savePlaylistToDB(playlist) {
        const tx = db.transaction('playlists', 'readwrite');
        const store = tx.objectStore('playlists');
        await store.put(playlist);
      }

      async function getPlaylistsFromDB() {
        const tx = db.transaction('playlists', 'readonly');
        const store = tx.objectStore('playlists');
        return new Promise((resolve) => {
          const r = store.getAll();
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve([]);
        });
      }

      async function deletePlaylistFromDB(playlistId) {
        const tx = db.transaction('playlists', 'readwrite');
        const store = tx.objectStore('playlists');
        await store.delete(playlistId);
      }

      async function getFromDBGeneric(storeName, key) {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        return new Promise((resolve) => {
          const r = store.get(key);
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve(null);
        });
      }

      async function readJSONFile(dirHandle, fileName, def=null){
        try{
          const fh = await dirHandle.getFileHandle(fileName);
          const f = await fh.getFile();
          return JSON.parse(await f.text());
        }catch(e){ return def; }
      }
      async function writeJSONFile(dirHandle, fileName, data){
        const fh = await dirHandle.getFileHandle(fileName, { create:true });
        const w = await fh.createWritable();
        await w.write(JSON.stringify(data, null, 2));
        await w.close();
      }

      async function getVideoMetadata(dirHandle, fileName){
        try{
          const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create:true });
          const metaHandle = await metaDir.getFileHandle(fileName + '.meta.json');
          const file = await metaHandle.getFile();
          const metadata = JSON.parse(await file.text());
          return metadata;
        }catch(e){ return { views:0, likes:0, dislikes:0, tags:[], created:Date.now() }; }
      }

      async function saveVideoMetadata(dirHandle, fileName, metadata) {
        try {
          const metaDir = await dirHandle.getDirectoryHandle('.metadata', { create: true });
          const metaFileName = fileName + '.meta.json';
          await writeJSONFile(metaDir, metaFileName, metadata);
        } catch (e) {
          console.error('Error saving video metadata:', e);
        }
      }

      async function getPreviewAndDuration(video){
        const dirHandle = video.dirHandle || videoDirectoryHandle;
        const meta = await getVideoMetadata(dirHandle, video.name);

        const fileChanged = meta.size !== video.file.size || meta.modified !== video.file.lastModified;

        if (meta.preview && meta.duration && !fileChanged) {
          return { preview: meta.preview, duration: meta.duration };
        }

        if (!video.file) {
          console.warn('No file available for video:', video.name);
          return { preview: '', duration: '0:00' };
        }

        return new Promise((resolve, reject) => {
          const el = document.createElement('video');
          el.muted = true;
          el.playsInline = true;
          el.preload = 'metadata';
          el.crossOrigin = 'anonymous';
          
          const url = URL.createObjectURL(video.file);
          
          const cleanup = () => {
            URL.revokeObjectURL(url);
            el.remove();
          };
          
          const timeout = setTimeout(() => {
            cleanup();
            reject(new Error('Timeout generating preview'));
          }, 10000);
          
          el.addEventListener('error', (e) => {
            clearTimeout(timeout);
            cleanup();
            reject(new Error('Video loading error: ' + (e.message || 'Unknown error')));
          }, { once: true });
          
          el.addEventListener('loadedmetadata', async () => {
            try {
              if (!isFinite(el.duration) || el.duration <= 0) {
                clearTimeout(timeout);
                cleanup();
                resolve({ preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjEyMCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBwcmV2aWV3PC90ZXh0Pjwvc3ZnPg==', duration: '0:00' });
                return;
              }
              
              const duration = formatDuration(el.duration);
              el.currentTime = Math.max(0, el.duration / 2);
              
              el.addEventListener('seeked', async () => {
                try {
                  const canvas = document.createElement('canvas');
                  canvas.width = 240; canvas.height = 140;
                  const ctx = canvas.getContext('2d');
                  
                  if (el.videoWidth === 0 || el.videoHeight === 0) {
                    throw new Error('Invalid video dimensions');
                  }
                  
                  ctx.drawImage(el, 0, 0, canvas.width, canvas.height);
                  const preview = canvas.toDataURL('image/jpeg', 0.7);
                  
                  clearTimeout(timeout);
                  cleanup();

                  const updatedMeta = {
                    ...meta,
                    preview: preview,
                    duration: duration,
                    size: video.file.size,
                    modified: video.file.lastModified
                  };
                  saveVideoMetadata(dirHandle, video.name, updatedMeta).catch(console.error);
                  await saveVideoToDB({ ...video, preview, duration });

                  resolve({ preview, duration });
                } catch (e) {
                  clearTimeout(timeout);
                  cleanup();
                  reject(e);
                }
              }, { once: true });
              
              el.addEventListener('error', (e) => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Seek error: ' + (e.message || 'Unknown error')));
              }, { once: true });
              
            } catch (e) {
              clearTimeout(timeout);
              cleanup();
              reject(e);
            }
          }, { once: true });
          
          el.src = url;
        });
      }

      async function parallelLimit(tasks, limit = 2) {
        const results = [];
        const executing = new Set();
        
        for (const task of tasks) {
          const p = Promise.resolve().then(() => task());
          results.push(p);
          executing.add(p);
          p.finally(() => executing.delete(p));
          
          if (executing.size >= limit) {
            await Promise.race(executing);

            await new Promise(resolve => setTimeout(resolve, 50));
          }
        }
        return Promise.all(results);
      }

      async function loadAllPlaylists(){
          log('Loading all playlists...');
          allPlaylists.length = 0;
          const cachedPlaylists = await getPlaylistsFromDB();
          const playlistMap = new Map(cachedPlaylists.map(pl => [pl.id, pl]));
          const currentPlaylistIds = new Set();

          try{
            const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create:true });
            for await (const [name, handle] of channelsDir.entries()){
              if (handle.kind === 'directory'){
                const channelData = await readJSONFile(handle, 'channel.json', { playlists: [] });
                for (const pl of (channelData.playlists || [])) {
                  const playlistId = pl.id;
                  currentPlaylistIds.add(playlistId);
                  const cachedPlaylist = playlistMap.get(playlistId);
                  
                  let playlistToPush = null;


                  if (!cachedPlaylist || 
                      cachedPlaylist.title !== pl.title ||
                      (cachedPlaylist.videos ? cachedPlaylist.videos.length : 0) !== (pl.videos ? pl.videos.length : 0)) {

                    const videosWithHandles = (pl.videos || []).map(video => {
                      const foundVideo = allVideos.find(av => av.name === video.name);
                      if (foundVideo) {
                        return { ...video, handle: foundVideo.handle, file: foundVideo.file, dirHandle: foundVideo.dirHandle };
                      }
                      return video;
                    });
                    playlistToPush = { ...pl, videos: videosWithHandles, channelName:name, channelHandle:handle, isChannelPlaylist:true };
                    await savePlaylistToDB({ ...playlistToPush, handle: null, dirHandle: null, videos: videosWithHandles.map(v => ({ name: v.name, tags: v.tags })) });
                  } else {

                    const videosWithHandles = (cachedPlaylist.videos || []).map(video => {
                      const foundVideo = allVideos.find(av => av.name === video.name);
                      if (foundVideo) {
                        return { ...video, handle: foundVideo.handle, file: foundVideo.file, dirHandle: foundVideo.dirHandle };
                      }
                      return video;
                    });
                    playlistToPush = { ...cachedPlaylist, videos: videosWithHandles, channelName:name, channelHandle:handle, isChannelPlaylist:true };
                  }
                  if (playlistToPush) allPlaylists.push(playlistToPush);
                }
              }
            }
            const globalPlaylists = await readJSONFile(videoDirectoryHandle, '.global_playlists.json', []);
            for (const pl of (globalPlaylists || [])) {
              const playlistId = pl.id;
              currentPlaylistIds.add(playlistId);
              const cachedPlaylist = playlistMap.get(playlistId);
              
              let playlistToPush = null;

              if (!cachedPlaylist || 
                  cachedPlaylist.title !== pl.title ||
                  (cachedPlaylist.videos ? cachedPlaylist.videos.length : 0) !== (pl.videos ? pl.videos.length : 0)) {

                const videosWithHandles = (pl.videos || []).map(video => {
                  const foundVideo = allVideos.find(av => av.name === video.name);
                  if (foundVideo) {
                    return { ...video, handle: foundVideo.handle, file: foundVideo.file, dirHandle: foundVideo.dirHandle };
                  }
                  return video;
                });
                playlistToPush = { ...pl, videos: videosWithHandles, channelName:null, isChannelPlaylist:false };
                await savePlaylistToDB({ ...playlistToPush, handle: null, dirHandle: null, videos: videosWithHandles.map(v => ({ name: v.name, tags: v.tags })) });
              } else {

                const videosWithHandles = (cachedPlaylist.videos || []).map(video => {
                  const foundVideo = allVideos.find(av => av.name === video.name);
                  if (foundVideo) {
                    return { ...video, handle: foundVideo.handle, file: foundVideo.file, dirHandle: foundVideo.dirHandle };
                  }
                  return video;
                });
                playlistToPush = { ...cachedPlaylist, videos: videosWithHandles, channelName:null, isChannelPlaylist:false };
              }
              if (playlistToPush) allPlaylists.push(playlistToPush);
            }

            for (const cachedPlaylist of cachedPlaylists) {
              if (!currentPlaylistIds.has(cachedPlaylist.id)) {
                await deletePlaylistFromDB(cachedPlaylist.id);
              }
            }

            allPlaylists.sort((a,b)=>(b.created||0)-(a.created||0));

            allPlaylistCategories.clear();
            allPlaylists.forEach(playlist => {
              (playlist.categories || []).forEach(category => {
                const trimmedCategory = category.trim();
                if (trimmedCategory) {
                  allPlaylistCategories.set(trimmedCategory, (allPlaylistCategories.get(trimmedCategory) || 0) + 1);
                }
              });
            });
          }catch(e){
            console.error('loadAllPlaylists error', e);
          }
        }

      async function loadAllVideos(){
        log('Starting loadAllVideos...');
        allVideos = [];
        const exts = ['.mp4','.avi','.mov','.mkv','.webm','.m4v'];
        
        if (!videoDirectoryHandle) {
          console.error('No videoDirectoryHandle available');
          return;
        }

        const cachedVideos = await getVideosFromDB();
        const videoMap = new Map(cachedVideos.map(v => [v.name, v]));
        const currentVideoNames = new Set();
        
        async function scan(dir, path = ''){
          for await (const [name, handle] of dir.entries()){
            if (handle.kind === 'file'){
              const lower = name.toLowerCase();
              if (exts.some(ext => lower.endsWith(ext))){
                currentVideoNames.add(name);
                const file = await handle.getFile();
                const cachedVideo = videoMap.get(name);

                if (!cachedVideo || cachedVideo.modified !== file.lastModified) {

                  const meta = await getVideoMetadata(dir, name);
                  const videoData = {
                    name, 
                    size: file.size,
                    modified: file.lastModified,


                    ...meta
                  };
                  allVideos.push({
                    ...videoData,
                    handle: handle,
                    file: file,
                    dirHandle: dir
                  });
                  await saveVideoToDB(videoData);
                } else {

                  allVideos.push({
                    ...cachedVideo,
                    handle: handle,
                    file: file,
                    dirHandle: dir
                  });
                }
              }
            } else if (handle.kind === 'directory' && !name.startsWith('.')){
              await scan(handle, path + '/' + name);
            }
          }
        }
        await scan(videoDirectoryHandle);

        for (const cachedVideo of cachedVideos) {
          if (!currentVideoNames.has(cachedVideo.name)) {
            await deleteVideoFromDB(cachedVideo.name);
          }
        }

        log('Total videos loaded:', allVideos.length);
      }

      async function renderPlaylists(){
        log('RENDER PLAYLISTS CALLED');
        log('filteredPlaylists.length:', filteredPlaylists ? filteredPlaylists.length : 'undefined');
        
        const container = document.getElementById('playlistsContainer');
        
        if (!container) {
          console.error('playlistsContainer not found');
          return;
        }
        
        container.innerHTML = '';

        if (!filteredPlaylists || filteredPlaylists.length === 0){
          container.innerHTML = `<div class="empty-state">${i18n.t('playlists.noPlaylists', '–ü–ª–µ–π–ª–∏—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')}</div>`;
          document.getElementById('paginationContainer').innerHTML = '';
          return;
        }

        const totalPages = Math.ceil(filteredPlaylists.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, filteredPlaylists.length);
        const pageItems = filteredPlaylists.slice(start, end);

        container.innerHTML = '<div class="playlists-grid" id="playlistsGrid"></div>';
        const grid = document.getElementById('playlistsGrid');

        for (const playlist of pageItems){
          const item = document.createElement('div');
          item.className = 'playlist-item';

          const playlistUrl = `youvi_playlists_view.html?playlistId=${encodeURIComponent(playlist.id)}`;

          const hiddenLink = document.createElement('a');
          hiddenLink.href = playlistUrl;
          hiddenLink.target = '_blank';
          hiddenLink.className = 'playlist-item-link';
          item.appendChild(hiddenLink);

          const thumbGrid = document.createElement('div');
          thumbGrid.className = 'playlist-thumbnail';

          for (let i=0;i<4;i++){
            const cell = document.createElement('div');
            cell.className = 'playlist-thumb';
            if (playlist.videos && playlist.videos[i]){
              const v = playlist.videos[i];
              cell.textContent = getFileNameWithoutExtension(v.name).slice(0,10) + '...';
              cell.setAttribute('data-video-name', v.name);

              if (v.file && v.handle) {
                getPreviewAndDuration(v).then(({preview})=>{
                  cell.innerHTML = `<img src="${preview}" style="width:100%;height:100%;object-fit:cover">`;
                }).catch(()=>{ });
              }
            }
            thumbGrid.appendChild(cell);
          }

          const countBadge = document.createElement('div');
          countBadge.className = 'playlist-count-badge';
          countBadge.textContent = `${(playlist.videos||[]).length} ${i18n.t('playlists.videoCount')}`;
          thumbGrid.appendChild(countBadge);

          const info = document.createElement('div');
          info.className = 'playlist-info';
          const channelLine = `<div class="playlist-channel">${playlist.channelName ? `<a href="youvi_ch_view.html?channel=${encodeURIComponent(playlist.channelName)}" class="playlist-channel-link">${escapeHtml(playlist.channelName)}</a>` : `<span data-i18n="playlists.collection">${i18n.t('playlists.collection')}</span>`}</div>`;

          info.innerHTML = `
            ${channelLine}
            <div class="playlist-title">${escapeHtml(playlist.title||i18n.t('main.untitled'))}</div>
            <div class="playlist-open" style="font-size:11px;color:#666;" data-i18n="playlists.openPlaylist">${i18n.t('playlists.openPlaylist')}</div>
          `;

          const actions = document.createElement('div');
          actions.className = 'playlist-actions';
          const viewBtn = document.createElement('button');
          viewBtn.className = 'action-btn';
          viewBtn.title = i18n.t('playlists.view', 'View');
          viewBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>';
          viewBtn.onclick = (e)=>{ e.stopPropagation(); window.location.href = `youvi_playlists_view.html?playlistId=${encodeURIComponent(playlist.id)}`; };

          const editBtn = document.createElement('button');
          editBtn.className = 'action-btn';
          editBtn.title = i18n.t('playlists.edit', '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å');
          editBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>';
          editBtn.onclick = (e)=>{ e.stopPropagation(); editPlaylist(playlist); };

          const delBtn = document.createElement('button');
          delBtn.className = 'action-btn';
          delBtn.title = i18n.t('playlists.delete', '–£–¥–∞–ª–∏—Ç—å');
          delBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>';
          delBtn.onclick = (e)=>{ e.stopPropagation(); deletePlaylist(playlist); };

          actions.appendChild(viewBtn);
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          item.appendChild(thumbGrid);
          item.appendChild(info);
          item.appendChild(actions);

          item.addEventListener('click', (e)=> {

            if (e.target.closest('.playlist-actions')) {
              return;
            }
            window.location.href = `youvi_playlists_view.html?playlistId=${encodeURIComponent(playlist.id)}`;
          });

          grid.appendChild(item);
        }

        renderPagination(totalPages);
      }

      function getFileNameWithoutExtension(name){ return name.replace(/\.[^/.]+$/,""); }

      function naturalSortByName(arr) {
        return [...arr].sort((a, b) => {
          const an = getFileNameWithoutExtension(a.name) || '';
          const bn = getFileNameWithoutExtension(b.name) || '';
          return an.localeCompare(bn, undefined, { numeric: true, sensitivity: 'base' });
        });
      }

      function showCreatePlaylistModal(){
        const modal = document.getElementById('createPlaylistModal');
        const videoList = document.getElementById('videoList');
        const searchInput = document.getElementById('videoSearch');
        document.getElementById('newPlaylistTitle').value = '';
        document.getElementById('newPlaylistCategories').value = '';
        searchInput.value = '';
        selectedVideoIds.clear();
        currentModalPage = 1;
        modalFilteredVideos = [];
        modal.style.display = 'flex';
        modal.removeAttribute('aria-hidden');
        videoList.innerHTML = `<div class="loading" data-i18n="playlists.loadingVideos">${i18n.t('playlists.loadingVideos')}</div>`;
        (async ()=>{ 
          if (allVideos.length === 0) await loadAllVideos(); 
          renderOptimizedVideoList(allVideos, 'create'); 
        })();
      }

      function needsVirtualization(videoCount) {
        return videoCount > 200;
      }

      function renderOptimizedVideoList(videos, modalType = 'create') {
        const list = document.getElementById(modalType === 'create' ? 'videoList' : 'addVideoList');
        const counter = document.getElementById(modalType === 'create' ? 'selectionCounter' : 'addSelectionCounter');
        
        if (!videos || videos.length === 0) {
          list.innerHTML = `<div class="empty-state">${i18n.t('playlists.noVideosFound')}</div>`;
          if (counter) counter.innerHTML = `<span data-i18n="playlists.selected">${i18n.t('playlists.selected')}</span>: 0`;
          return;
        }

        modalFilteredVideos = [...videos];
        const sorted = naturalSortByName(modalFilteredVideos);

        const effectivePageSize = needsVirtualization(sorted.length) ? 25 : modalVideosPerPage;

        const totalPages = Math.ceil(sorted.length / effectivePageSize);
        const start = (currentModalPage - 1) * effectivePageSize;
        const end = Math.min(start + effectivePageSize, sorted.length);
        const pageVideos = sorted.slice(start, end);

        list.innerHTML = '';

        if (needsVirtualization(sorted.length)) {
          const warning = document.createElement('div');
          warning.className = 'performance-warning';
          warning.style.cssText = 'background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:8px;margin-bottom:8px;border-radius:4px;font-size:11px;';
          warning.textContent = `${i18n.t('playlists.largeList')} (${sorted.length}). ${i18n.t('playlists.shownForPerformance')} ${pageVideos.length} ${i18n.t('playlists.of')} ${sorted.length}.`;
          list.appendChild(warning);
        }
        
        pageVideos.forEach((video, i) => {
          const globalIndex = start + i;
          const item = document.createElement('div');
          item.className = 'video-list-item';
          
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = `${modalType}Video_${globalIndex}`;
          cb.dataset.index = String(globalIndex);
          cb.dataset.videoName = video.name;
          
          if (modalType === 'create') {
            cb.checked = selectedVideoIds.has(video.name);
            cb.addEventListener('change', (e) => {
              const name = video.name;
              if (e.target.checked) {
                selectedVideoIds.add(name);
              } else {
                selectedVideoIds.delete(name);
              }
              updateSelectionCounter();
            });
          } else {
            cb.checked = editingSelectedVideos.has(video.name);
            cb.addEventListener('change', (e) => {
              if (e.target.checked) {
                editingSelectedVideos.add(video.name);
              } else {
                editingSelectedVideos.delete(video.name);
              }
              updateAddSelectionCounter();
            });
          }
          
          const label = document.createElement('label');
          label.htmlFor = cb.id;
          label.textContent = getFileNameWithoutExtension(video.name);
          
          const meta = document.createElement('div');
          meta.style.cssText = 'font-size:11px;color:#666;margin-left:auto;';
          meta.textContent = `${formatFileSize(video.size)} ‚Ä¢ ${new Date(video.modified).toLocaleDateString()}`;
          
          item.appendChild(cb);
          item.appendChild(label);
          item.appendChild(meta);
          list.appendChild(item);
        });

        if (totalPages > 1) {
          const paginationContainer = document.createElement('div');
          paginationContainer.className = 'modal-pagination';
          paginationContainer.style.cssText = 'display:flex;justify-content:center;align-items:center;gap:8px;margin-top:10px;padding:8px;border-top:1px solid #eee;';

          const prevBtn = document.createElement('button');
          prevBtn.textContent = `‚Üê ${i18n.t('playlists.prev')}`;
          prevBtn.className = 'btn secondary';
          prevBtn.disabled = currentModalPage === 1;
          prevBtn.addEventListener('click', () => {
            if (currentModalPage > 1) {
              currentModalPage--;
              log('Prev page clicked, currentModalPage:', currentModalPage, 'modalFilteredVideos.length:', modalFilteredVideos.length);
              renderOptimizedVideoList(modalFilteredVideos, modalType);

              if (modalType === 'create') {
                updateSelectionCounter();
              } else {
                updateAddSelectionCounter();
              }
            }
          });

          const pageInfo = document.createElement('span');
          pageInfo.textContent = `${i18n.t('playlists.page')} ${currentModalPage} ${i18n.t('playlists.of')} ${totalPages} (${sorted.length} ${i18n.t('playlists.videoCount')})`;
          pageInfo.style.cssText = 'font-size:12px;color:#666;';

          const nextBtn = document.createElement('button');
          nextBtn.textContent = `${i18n.t('playlists.next')} ‚Üí`;
          nextBtn.className = 'btn secondary';
          nextBtn.disabled = currentModalPage === totalPages;
          nextBtn.addEventListener('click', () => {
            if (currentModalPage < totalPages) {
              currentModalPage++;
              log('Next page clicked, currentModalPage:', currentModalPage, 'modalFilteredVideos.length:', modalFilteredVideos.length);
              renderOptimizedVideoList(modalFilteredVideos, modalType);

              if (modalType === 'create') {
                updateSelectionCounter();
              } else {
                updateAddSelectionCounter();
              }
            }
          });
          
          paginationContainer.appendChild(prevBtn);
          paginationContainer.appendChild(pageInfo);
          paginationContainer.appendChild(nextBtn);
          list.appendChild(paginationContainer);
        }

        if (modalType === 'create') {
        updateSelectionCounter();
        } else {
          updateAddSelectionCounter();
        }
      }

      function renderVideoList(videos){
        renderOptimizedVideoList(videos, 'create');
      }

      function updateSelectionCounter(){
        const counter = document.getElementById('selectionCounter');
        const count = selectedVideoIds.size;
        if (counter) counter.innerHTML = `<span data-i18n="playlists.selected">${i18n.t('playlists.selected')}</span>: ${count}`;
      }

      function searchVideos(){
        const term = document.getElementById('videoSearch').value.toLowerCase();

        if (modalSearchTimeout) {
          clearTimeout(modalSearchTimeout);
        }

        modalSearchTimeout = setTimeout(() => {
          const filtered = term ? 
            allVideos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(term)) : 
            allVideos;
          
          currentModalPage = 1;
          renderOptimizedVideoList(naturalSortByName(filtered), 'create');
          updateSelectionCounter();
        }, 300);
      }

      async function createGlobalPlaylist(){
        const title = document.getElementById('newPlaylistTitle').value.trim();
        const categoriesInput = document.getElementById('newPlaylistCategories').value.trim();
        if (!title){ alert(i18n.t('playlists.enterTitle')); return; }
        const categories = categoriesInput ? categoriesInput.split(',').map(c=>c.trim()).filter(Boolean) : [];
        const selected = [];

        const allSelectedVideos = [];
        selectedVideoIds.forEach(videoName => {
          const video = allVideos.find(v => v.name === videoName);
          if (video) {
            allSelectedVideos.push(video);
          }
        });

        const ordered = naturalSortByName(allSelectedVideos);
        ordered.forEach(video => {
          selected.push({
            name: video.name,
            size: video.size,
            modified: video.modified,
            created: video.created || Date.now(),
            views: video.views || 0,
            likes: video.likes || 0,
            dislikes: video.dislikes || 0,
            tags: video.tags || [],
            handle: video.handle,
            file: video.file,
            dirHandle: video.dirHandle
          });
        });
        if (selected.length===0){ alert(i18n.t('playlists.selectAtLeastOne')); return; }
        const playlist = { id: Date.now().toString(), title, categories, videos:selected, created: Date.now(), isChannelPlaylist: false };
        try{
          const global = await readJSONFile(videoDirectoryHandle, '.global_playlists.json', []);
          global.push(playlist);
          await writeJSONFile(videoDirectoryHandle, '.global_playlists.json', global);

          try { await savePlaylistToDB({ ...playlist, handle: null, dirHandle: null, videos: playlist.videos.map(v=>({ name:v.name, tags:v.tags })) }); } catch(e) { console.warn('cache save failed', e); }
          document.getElementById('createPlaylistModal').style.display = 'none';

          allPlaylists.unshift(playlist);
          applyFiltersAndRender();
          renderSidebarCategories();

          setTimeout(() => backgroundScanForHandles(), 50);
        }catch(e){ console.error('createGlobalPlaylist error', e); alert(i18n.t('playlists.errorCreating')); }
      }

      async function deletePlaylist(playlist){
        if (!confirm(`${i18n.t('playlists.confirmDelete')} "${playlist.title}"?`)) return;
        try{
          if (playlist.isChannelPlaylist){
            const chData = await readJSONFile(playlist.channelHandle, 'channel.json', { playlists:[] });
            chData.playlists = (chData.playlists||[]).filter(p => p.id !== playlist.id);
            await writeJSONFile(playlist.channelHandle, 'channel.json', chData);
          } else {
            const global = await readJSONFile(videoDirectoryHandle, '.global_playlists.json', []);
            const upd = (global||[]).filter(p => p.id !== playlist.id);
            await writeJSONFile(videoDirectoryHandle, '.global_playlists.json', upd);
          }

          try { await deletePlaylistFromDB(playlist.id); } catch(e) { console.warn('cache delete failed', e); }
          window.location.reload();
        }catch(e){ console.error('deletePlaylist error', e); alert(i18n.t('playlists.errorDeleting')); }
      }

      async function editPlaylist(playlist){
        currentEditingPlaylist = playlist;
        editingSelectedVideos.clear();
        const modal = document.getElementById('editPlaylistModal');
        const title = playlist.isChannelPlaylist ? `${i18n.t('playlists.editPlaylist')} (${playlist.channelName})` : i18n.t('playlists.editPlaylist');
        document.querySelector('#editPlaylistModal .modal-header h3').textContent = title;
        document.getElementById('editPlaylistTitle').value = playlist.title || '';
        document.getElementById('editPlaylistCategories').value = (playlist.categories || []).join(', ');
        const typeInfo = document.getElementById('playlistTypeInfo'); if (typeInfo) typeInfo.textContent = playlist.isChannelPlaylist ? `${i18n.t('playlists.channel')}: ${playlist.channelName}` : i18n.t('playlists.generalPlaylist');
        if (allVideos.length === 0) await loadAllVideos();
        const playlistVideos = [...(playlist.videos || [])];
        for (let v of playlistVideos){ const found = allVideos.find(av=>av.name===v.name); if (found) Object.assign(v, found); }
        renderEditPlaylistVideos(playlistVideos);
        modal.style.display = 'flex';
      }

      function renderEditPlaylistVideos(videos){
        const list = document.getElementById('editPlaylistVideosList');
        const search = document.getElementById('editPlaylistVideoSearch');
        function render(arr){
          if (!arr || arr.length===0){ list.innerHTML = `<div class="empty-state">${i18n.t('playlists.noVideos')}</div>`; return; }
          list.innerHTML = '';
          arr.forEach((video, idx)=>{
            const row = document.createElement('div');
            row.className = 'video-list-item';
            row.draggable = true; row.dataset.videoName = video.name;
            row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid #e5e5e5;font-size:12px;position:relative;cursor:move;';
            const dragHandle = document.createElement('div'); dragHandle.className = 'drag-handle'; dragHandle.textContent = '‚ò∞'; dragHandle.style.cssText='cursor:move;color:#666;font-size:12px;margin-right:4px;';
            const content = document.createElement('div'); content.style.cssText='display:flex;align-items:center;gap:8px;flex:1;';
            content.innerHTML = `<div style="font-size:11px;color:#606060;min-width:15px;">${idx+1}</div><div style="flex:1;min-width:0;"><div style="font-weight:500;">${escapeHtml(getFileNameWithoutExtension(video.name))}</div><div style=\"font-size:10px;color:#666;\">${formatFileSize(video.size)} ‚Ä¢ ${video.views||0} ${i18n.t('playlists.views')}</div></div>`;
            const removeBtn = document.createElement('button'); removeBtn.textContent=i18n.t('playlists.removeFromPlaylist'); removeBtn.style.cssText='background:var(--accent);color:white;border:none;border-radius:3px;padding:2px 6px;font-size:10px;cursor:pointer;'; removeBtn.onclick=()=>{ currentEditingPlaylist.videos = currentEditingPlaylist.videos.filter(v=>v.name!==video.name); renderEditPlaylistVideos(currentEditingPlaylist.videos); };
            row.addEventListener('dragstart',(e)=>{ row.classList.add('dragging'); e.dataTransfer.setData('text/plain', video.name); e.dataTransfer.effectAllowed='move'; });
            row.addEventListener('dragend',()=>{ row.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over')); });
            row.addEventListener('dragover',(e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; row.classList.add('drag-over'); });
            row.addEventListener('dragleave',()=>{ row.classList.remove('drag-over'); });
            row.addEventListener('drop',(e)=>{ e.preventDefault(); row.classList.remove('drag-over'); const draggedName = e.dataTransfer.getData('text/plain'); reorderVideosInEditModal(draggedName, video.name); });
            row.appendChild(dragHandle); row.appendChild(content); row.appendChild(removeBtn); list.appendChild(row);
          });
        }
        render(videos);
        search.oninput = ()=>{ const q = search.value.toLowerCase(); const filtered = q ? videos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(q)) : videos; render(filtered); };
        search.value='';
      }

      function reorderVideosInEditModal(draggedVideoName, targetVideoName){
        if (draggedVideoName===targetVideoName) return;
        const arr = currentEditingPlaylist.videos;
        const di = arr.findIndex(v=>v.name===draggedVideoName); const ti = arr.findIndex(v=>v.name===targetVideoName);
        if (di===-1 || ti===-1) return;
        const [dragged] = arr.splice(di,1); arr.splice(ti,0,dragged);
        renderEditPlaylistVideos(arr);
      }

      function getVideosForCurrentPlaylist(){
        if (!currentEditingPlaylist) return allVideos;
        if (currentEditingPlaylist.isChannelPlaylist){
          const channelIdentifier = currentEditingPlaylist.channelName ? currentEditingPlaylist.channelName.toLowerCase() : '';
          if (!channelIdentifier) return [];
          return allVideos.filter(video => (video.tags||[]).some(tag => tag.toLowerCase().includes(channelIdentifier) && tag.toLowerCase().includes('(–∫–∞)')));
        }
        return allVideos;
      }

      function showAddVideosModal(){
        editingSelectedVideos.clear();
        currentModalPage = 1;
        modalFilteredVideos = [];
        const modal = document.getElementById('addVideosModal');
        const list = document.getElementById('addVideoList');
        const search = document.getElementById('addVideoSearch');
        search.value = '';
        list.innerHTML = `<div class="loading">${i18n.t('playlists.loadingVideos')}</div>`;
        modal.style.display = 'flex';
        const modalTitle = document.querySelector('#addVideosModal .modal-header h3');
        if (modalTitle && currentEditingPlaylist){ modalTitle.textContent = currentEditingPlaylist.isChannelPlaylist ? `${i18n.t('playlists.addToPlaylist')} (${currentEditingPlaylist.channelName})` : i18n.t('playlists.addToPlaylist'); }
        const existingNames = new Set((currentEditingPlaylist.videos||[]).map(v=>v.name));
        const available = getVideosForCurrentPlaylist().filter(v=>!existingNames.has(v.name));
        const info = document.querySelector('#addVideosModal .search-info'); if (info){ const msg = currentEditingPlaylist && currentEditingPlaylist.isChannelPlaylist ? `${i18n.t('playlists.available')}: ${available.length} ${i18n.t('playlists.channelVideos')}` : `${i18n.t('playlists.available')}: ${available.length} ${i18n.t('playlists.videoCount')}`; info.textContent = msg; }
        if (available.length===0){ list.innerHTML = `<div class="empty-state">${i18n.t('playlists.noAvailableVideos')}</div>`; return; }
        renderOptimizedVideoList(available, 'add');
      }

      function renderAddVideoList(videos){
        const list = document.getElementById('addVideoList');
        const counter = document.getElementById('addSelectionCounter');
        if (!videos || videos.length===0){ list.innerHTML = `<div class="empty-state">${i18n.t('playlists.allVideosAdded')}</div>`; if (counter) counter.innerHTML=`<span data-i18n="playlists.selected">${i18n.t('playlists.selected')}</span>: 0`; return; }
        list.innerHTML='';
        const sorted = naturalSortByName(videos);
        sorted.forEach((video,i)=>{
          const item = document.createElement('div'); item.className='video-list-item';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.id = `addVideo_${i}`; cb.checked = editingSelectedVideos.has(video.name);
          cb.addEventListener('change', (e)=>{ if (e.target.checked) editingSelectedVideos.add(video.name); else editingSelectedVideos.delete(video.name); updateAddSelectionCounter(); });
          const label = document.createElement('label'); label.htmlFor = cb.id; label.textContent = getFileNameWithoutExtension(video.name);
          const meta = document.createElement('div'); meta.style.cssText='font-size:11px;color:#666;margin-left:auto;'; meta.textContent = `${formatFileSize(video.size)} ‚Ä¢ ${new Date(video.modified).toLocaleDateString()}`;
          item.appendChild(cb); item.appendChild(label); item.appendChild(meta); list.appendChild(item);
        });
        updateAddSelectionCounter();
      }

      function updateAddSelectionCounter(){
        const counter = document.getElementById('addSelectionCounter');
        const count = editingSelectedVideos.size;
        if (counter) counter.innerHTML = `<span data-i18n="playlists.selected">${i18n.t('playlists.selected')}</span>: ${count}`;
      }

      function searchAddVideos(){
        const term = document.getElementById('addVideoSearch').value.toLowerCase();

        if (modalSearchTimeout) {
          clearTimeout(modalSearchTimeout);
        }

        modalSearchTimeout = setTimeout(() => {
        const existingNames = new Set((currentEditingPlaylist.videos||[]).map(v=>v.name));
        const available = getVideosForCurrentPlaylist().filter(v=>!existingNames.has(v.name));
          const filtered = term ? 
            available.filter(v=> getFileNameWithoutExtension(v.name).toLowerCase().includes(term)) : 
            available;
          
          currentModalPage = 1;
          renderOptimizedVideoList(naturalSortByName(filtered), 'add');
          updateAddSelectionCounter();

          const info = document.querySelector('#addVideosModal .search-info');
          if (info) {
            const msg = currentEditingPlaylist && currentEditingPlaylist.isChannelPlaylist ? 
              `${i18n.t('playlists.available')}: ${available.length} ${i18n.t('playlists.channelVideos')}` : 
              `${i18n.t('playlists.available')}: ${available.length} ${i18n.t('playlists.videoCount')}`;
            info.textContent = msg;
          }
        }, 300);
      }

      function addSelectedVideosToPlaylist(){
        if (editingSelectedVideos.size===0){ alert(i18n.t('playlists.selectAtLeastOne')); return; }
        const updated = [...currentEditingPlaylist.videos];
        editingSelectedVideos.forEach(name=>{ const video = allVideos.find(v=>v.name===name); if (video){ updated.push({ name: video.name, size: video.size, modified: video.modified, created: video.created||Date.now(), views: video.views||0, likes: video.likes||0, dislikes: video.dislikes||0, tags: video.tags||[] }); }});
        currentEditingPlaylist.videos = updated;
        renderEditPlaylistVideos(currentEditingPlaylist.videos);
        document.getElementById('addVideosModal').style.display='none';
        editingSelectedVideos.clear();
      }

      async function saveEditedPlaylist(){
        const title = document.getElementById('editPlaylistTitle').value.trim();
        const categoriesInput = document.getElementById('editPlaylistCategories').value.trim();
        if (!title){ alert(i18n.t('playlists.enterTitle')); return; }
        const categories = categoriesInput ? categoriesInput.split(',').map(c=>c.trim()).filter(Boolean) : [];
        currentEditingPlaylist.title = title; currentEditingPlaylist.categories = categories;
        try{
          if (currentEditingPlaylist.isChannelPlaylist){
            if (!currentEditingPlaylist.channelHandle) throw new Error('Missing channel handle for channel playlist');
            const chData = await readJSONFile(currentEditingPlaylist.channelHandle, 'channel.json', { playlists: [] });
            const idx = (chData.playlists||[]).findIndex(p=>p.id===currentEditingPlaylist.id);
            if (idx!==-1) chData.playlists[idx] = currentEditingPlaylist; else chData.playlists.push(currentEditingPlaylist);
            await writeJSONFile(currentEditingPlaylist.channelHandle, 'channel.json', chData);
            const gIdx = allPlaylists.findIndex(p=>p.id===currentEditingPlaylist.id); if (gIdx!==-1) allPlaylists[gIdx] = { ...currentEditingPlaylist };

            try { await savePlaylistToDB({ ...currentEditingPlaylist, handle:null, dirHandle:null, videos:(currentEditingPlaylist.videos||[]).map(v=>({ name:v.name, tags:v.tags })) }); } catch(e) { console.warn('cache save failed', e); }
          } else {
            const global = await readJSONFile(videoDirectoryHandle, '.global_playlists.json', []);
            const idx = global.findIndex(p=>p.id===currentEditingPlaylist.id);
            if (idx!==-1) { 
              global[idx] = currentEditingPlaylist; 
              await writeJSONFile(videoDirectoryHandle, '.global_playlists.json', global); 
              const gIdx = allPlaylists.findIndex(p=>p.id===currentEditingPlaylist.id); if (gIdx!==-1) allPlaylists[gIdx] = { ...currentEditingPlaylist };
              try { await savePlaylistToDB({ ...currentEditingPlaylist, handle:null, dirHandle:null, videos:(currentEditingPlaylist.videos||[]).map(v=>({ name:v.name, tags:v.tags })) }); } catch(e) { console.warn('cache save failed', e); }
            }
          }
          document.getElementById('editPlaylistModal').style.display='none';
          filteredPlaylists = [...allPlaylists];
          renderPlaylists();

          setTimeout(() => backgroundScanForHandles(), 50);
        }catch(e){ console.error('saveEditedPlaylist error', e); alert(i18n.t('playlists.errorSaving')); }
      }

      function attachCarouselEventListeners() {
        document.querySelectorAll('.video-carousel-wrapper').forEach(wrapper => {
          const carousel = wrapper.querySelector('.video-carousel');
          const prevBtn = wrapper.querySelector('.prev-btn');
          const nextBtn = wrapper.querySelector('.next-btn');
          const playlistId = prevBtn ? prevBtn.dataset.playlistId : (nextBtn ? nextBtn.dataset.playlistId : null);
          const playlist = allPlaylists.find(pl => String(pl.id) === playlistId);

          if (!carousel || !prevBtn || !nextBtn || !playlist) return;

          const updateArrowVisibility = () => {
            const currentVideoPage = carouselVideoPages.get(playlist.id) || 1;
            const totalVideoPages = Math.ceil((playlist.videos ? playlist.videos.length : 0) / videosPerPage);
            prevBtn.style.display = currentVideoPage > 1 ? 'flex' : 'none';
            nextBtn.style.display = currentVideoPage < totalVideoPages ? 'flex' : 'none';
          };

          prevBtn.addEventListener('click', () => {
            let currentVideoPage = carouselVideoPages.get(playlist.id) || 1;
            if (currentVideoPage > 1) {
              currentVideoPage--;
              carouselVideoPages.set(playlist.id, currentVideoPage);
              renderSinglePlaylistCarousel(playlist);
            }
          });

          nextBtn.addEventListener('click', () => {
            let currentVideoPage = carouselVideoPages.get(playlist.id) || 1;
            const totalVideoPages = Math.ceil((playlist.videos ? playlist.videos.length : 0) / videosPerPage);
            if (currentVideoPage < totalVideoPages) {
              currentVideoPage++;
              carouselVideoPages.set(playlist.id, currentVideoPage);
              renderSinglePlaylistCarousel(playlist);
            }
          });
        });
      }

      function cleanupModalCache() {

        const now = Date.now();
        for (const [key, value] of modalVideoPreviewCache.entries()) {
          if (now - value.timestamp > 300000) {
            modalVideoPreviewCache.delete(key);
          }
        }

        if (modalVideoPreviewCache.size > MAX_CACHE_SIZE) {
          const entries = Array.from(modalVideoPreviewCache.entries());
          entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
          const toDelete = entries.slice(0, modalVideoPreviewCache.size - MAX_CACHE_SIZE);
          toDelete.forEach(([key]) => modalVideoPreviewCache.delete(key));
        }
      }

      function createOptimizedVideoPreviewTask(video, thumbnailElement, isModal = false) {
        return async () => {
          try {

            const cacheKey = `preview_${video.name}`;
            if (modalVideoPreviewCache.has(cacheKey)) {
              const cached = modalVideoPreviewCache.get(cacheKey);
              if (Date.now() - cached.timestamp < 300000) {
                thumbnailElement.innerHTML = `<img src="${cached.preview}" style="width:100%;height:100%;object-fit:cover;">`;
                const durationElement = document.createElement('div');
                durationElement.className = 'video-duration';
                durationElement.textContent = cached.duration;
                thumbnailElement.appendChild(durationElement);
                return;
              }
            }

            const { preview, duration } = await getPreviewAndDuration(video);

            modalVideoPreviewCache.set(cacheKey, {
              preview,
              duration,
              timestamp: Date.now()
            });

            if (modalVideoPreviewCache.size % 10 === 0) {
              cleanupModalCache();
            }

            if (preview) {
              thumbnailElement.innerHTML = `<img src="${preview}" style="width:100%;height:100%;object-fit:cover;">`;
            }
            const durationElement = document.createElement('div');
            durationElement.className = 'video-duration';
            durationElement.textContent = duration;
            thumbnailElement.appendChild(durationElement);
          } catch (e) {
            console.error('Error loading preview for', video.name, e);
            thumbnailElement.innerHTML = `
              <div class="video-duration">0:00</div>
              <div style="width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;text-align:center;padding:5px;">
                ${escapeHtml(getFileNameWithoutExtension(video.name))}
              </div>`;
          }
        };
      }

      function createVideoCardPreviewTask(video, thumbnailElement) {
        return createOptimizedVideoPreviewTask(video, thumbnailElement, false);
      }

      async function renderSinglePlaylistCarousel(playlist) {
        const videoCarousel = document.getElementById(`carousel-${playlist.id}`);
        if (!videoCarousel) return;

        videoCarousel.innerHTML = '';

        const currentVideoPage = carouselVideoPages.get(playlist.id) || 1;
        const totalVideoPages = Math.ceil((playlist.videos ? playlist.videos.length : 0) / videosPerPage);
        const videoStart = (currentVideoPage - 1) * videosPerPage;
        const videoEnd = Math.min(videoStart + videosPerPage, playlist.videos ? playlist.videos.length : 0);

        const actualVideosPerPage = 5;

        const videosToRender = (playlist.videos || []).slice(videoStart, Math.min(videoStart + actualVideosPerPage, playlist.videos.length));
        if (videosToRender.length > 0) {
          const previewTasks = [];
          for (const video of videosToRender) {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';

            const thumbLink = document.createElement('a');
            thumbLink.className = 'video-thumbnail';
            const videoUrl = window.VideoID 
                ? window.VideoID.buildVideoUrl(video.name, playlist.id)
                : `youvi_video.html?name=${encodeURIComponent(video.name)}&playlist=${encodeURIComponent(playlist.id || '')}`;
            thumbLink.href = videoUrl;
            thumbLink.innerHTML = `
              <div class="video-duration">...</div>
              <div style="width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;text-align:center;padding:5px;">
                ${escapeHtml(getFileNameWithoutExtension(video.name))}
              </div>`;

            if (!video.file || !video.handle) {
              const foundVideo = allVideos.find(av => av.name === video.name);
              if (foundVideo) {
                Object.assign(video, foundVideo);
              }
            }

            const infoElement = document.createElement('div');
            infoElement.className = 'video-info';

            const videoChannel = getVideoChannelFromTags(video);
            const channelDisplay = videoChannel ? 
              `<a href="youvi_ch_view.html?channel=${encodeURIComponent(videoChannel)}" class="playlist-channel-link">${escapeHtml(videoChannel)}</a>` : 
              `<span>${i18n.t('video.noChannel', '–ë–µ–∑ –∫–∞–Ω–∞–ª–∞')}</span>`;

            infoElement.innerHTML = `
                              <div class="video-playlist">${channelDisplay}</div>
              <div class="video-card-title"><a href="${videoUrl}" class="video-title-link" style="color:inherit;text-decoration:none;">${escapeHtml(getFileNameWithoutExtension(video.name))}</a></div>
              <div class="video-category">${playlist.categories && playlist.categories.length > 0 ? playlist.categories.map(category => `<a href="#" class="video-category-link" data-category="${escapeHtml(category)}">${escapeHtml(category)}</a>`).join(', ') : i18n.t('video.noCategory', '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')}</div>
            `;

            videoCard.appendChild(thumbLink);
            videoCard.appendChild(infoElement);
            videoCarousel.appendChild(videoCard);

            previewTasks.push(createVideoCardPreviewTask(video, thumbLink));

            videoCard.addEventListener('click', () => {
              window.open(videoUrl, '_blank');
            });
          }
          await parallelLimit(previewTasks, 3);
        } else {
          videoCarousel.innerHTML = `<div class="empty-state" style="padding: 20px; font-size: 14px;" data-i18n="playlists.noVideos">${i18n.t('playlists.noVideos')}</div>`;
        }

        const playlistSection = videoCarousel.closest('.playlist-section-carousel');
        const prevBtn = playlistSection.querySelector(`.prev-btn[data-playlist-id="${playlist.id}"]`);
        const nextBtn = playlistSection.querySelector(`.next-btn[data-playlist-id="${playlist.id}"]`);
        if (prevBtn) prevBtn.style.display = currentVideoPage > 1 ? 'flex' : 'none';
        if (nextBtn) nextBtn.style.display = currentVideoPage < totalVideoPages ? 'flex' : 'none';
      }

      async function showCreatePlaylistModal(){
        const modal = document.getElementById('createPlaylistModal');
        const videoList = document.getElementById('videoList');
        const searchInput = document.getElementById('videoSearch');
        document.getElementById('newPlaylistTitle').value = '';
        document.getElementById('newPlaylistCategories').value = '';
        searchInput.value = '';
        selectedVideoIds.clear();
        currentModalPage = 1;
        modal.style.display = 'flex';
        videoList.innerHTML = `<div class="loading" data-i18n="playlists.loadingVideos">${i18n.t('playlists.loadingVideos')}</div>`;
        if (allVideos.length === 0) await loadAllVideos();
        renderOptimizedVideoList(allVideos, 'create');
      }

      function renderVideoList(videos){
        const list = document.getElementById('videoList');
        const counter = document.getElementById('selectionCounter');
        if (!videos || videos.length === 0){
          list.innerHTML = `<div class="empty-state" data-i18n="playlists.noVideosFound">${i18n.t('playlists.noVideosFound')}</div>`;
          counter.textContent = `${i18n.t('playlists.selected')}: 0`;
          return;
        }
        list.innerHTML = '';
        const sorted = naturalSortByName(videos);
        sorted.forEach((video, i)=>{
          const item = document.createElement('div');
          item.className = 'video-list-item';
      
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = `globalVideo_${i}`;
          cb.dataset.index = String(i);
          cb.checked = selectedVideoIds.has(video.name);
          cb.addEventListener('change', (e) => {
            const videoName = video.name;
            if (e.target.checked) {
              selectedVideoIds.add(videoName);
            } else {
              selectedVideoIds.delete(videoName);
            }
            updateSelectionCounter();
          });
      
          const label = document.createElement('label');
          label.htmlFor = cb.id;
          label.textContent = getFileNameWithoutExtension(video.name);
      
          const meta = document.createElement('div');
          meta.style.cssText = 'font-size:11px;color:#666;margin-left:auto;';
          meta.textContent = `${formatFileSize(video.size)} ‚Ä¢ ${new Date(video.modified).toLocaleDateString()}`;
      
          item.appendChild(cb);
          item.appendChild(label);
          item.appendChild(meta);
          list.appendChild(item);
        });
        updateSelectionCounter();
      }


      function updateSelectionCounter(){
        const counter = document.getElementById('selectionCounter');
        const count = document.querySelectorAll('#videoList input[type="checkbox"]:checked').length;
        counter.textContent = `${i18n.t('playlists.selected')}: ${count}`;
      }

      function searchVideos(){
        const term = document.getElementById('videoSearch').value.toLowerCase();

        if (modalSearchTimeout) {
          clearTimeout(modalSearchTimeout);
        }

        modalSearchTimeout = setTimeout(() => {
          const filtered = term ? 
            allVideos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(term)) : 
            allVideos;
          
          currentModalPage = 1;
          renderOptimizedVideoList(naturalSortByName(filtered), 'create');
          updateSelectionCounter();
        }, 300);
      }

      async function createGlobalPlaylist(){
        const title = document.getElementById('newPlaylistTitle').value.trim();
        const categoriesInput = document.getElementById('newPlaylistCategories').value.trim();

        if (!title){ alert(i18n.t('playlists.enterTitle')); return; }

        const categories = categoriesInput
          ? categoriesInput.split(',').map(cat => cat.trim()).filter(cat => cat)
          : [];

        const selected = [];

        const allSelectedVideos = [];
        selectedVideoIds.forEach(videoName => {
          const video = allVideos.find(v => v.name === videoName);
          if (video) {
            allSelectedVideos.push(video);
          }
        });

        const ordered = naturalSortByName(allSelectedVideos);
        ordered.forEach(video => {
          selected.push({
            name: video.name,
            size: video.size,
            modified: video.modified,
            created: video.created || Date.now(),
            views: video.views || 0,
            likes: video.likes || 0,
            dislikes: video.dislikes || 0,
            tags: video.tags || [],
            handle: video.handle,
            file: video.file,
            dirHandle: video.dirHandle
          });
        });

        if (selected.length === 0){ alert(i18n.t('playlists.selectAtLeastOne')); return; }

        const playlist = {
          id: Date.now().toString(),
          title,
          categories,
          videos: selected,
          created: Date.now(),
          isChannelPlaylist: false
        };
        try{
          const global = await readJSONFile(videoDirectoryHandle, '.global_playlists.json', []);
          global.push(playlist);
          await writeJSONFile(videoDirectoryHandle, '.global_playlists.json', global);

          try { await savePlaylistToDB({ ...playlist, handle: null, dirHandle: null, videos: playlist.videos.map(v=>({ name:v.name, tags:v.tags })) }); } catch(e) { console.warn('cache save failed', e); }
          document.getElementById('createPlaylistModal').style.display = 'none';

          allPlaylists.unshift(playlist);
          applyFiltersAndRender();
          renderSidebarCategories();
          setTimeout(() => backgroundScanForHandles(), 50);
        }catch(e){
          console.error('createGlobalPlaylist error', e);
          alert(i18n.t('playlists.errorCreating'));
        }
      }

      function attachTagClickListeners() {
        document.querySelectorAll('.video-tag-link').forEach(tagLink => {
          tagLink.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const tag = e.target.dataset.tag;
            const playlistSearchInput = document.getElementById('playlistSearchInput');
            if (playlistSearchInput) {
              playlistSearchInput.value = tag;


              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(() => {
                currentPage = 1;
                applyFiltersAndRender();
                updatePageTitle();
              }, 0);
            }
          });
        });
      }

      function createPaginationButton(text, page){
        const btn = document.createElement('button');
        btn.className = 'btn pagination-btn';
        btn.textContent = text;
        btn.addEventListener('click', ()=>{
          currentPage = page;
          renderPlaylists();
          updatePageTitle();
        });
        return btn;
      }

      function renderPagination(totalPages){
        const container = document.getElementById('paginationContainer');
        if (totalPages <= 1){ container.innerHTML = ''; return; }

        const pag = document.createElement('div');
        pag.className = 'pagination';
        container.style.textAlign = 'center';

        const info = document.createElement('div');
        info.className = 'pagination-info';
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, filteredPlaylists.length);
        const ofTxt = typeof i18n !== 'undefined' ? i18n.t('main.of', '–∏–∑') : '–∏–∑';
        const pageTxt = typeof i18n !== 'undefined' ? i18n.t('main.page', '—Å—Ç—Ä.') : '—Å—Ç—Ä.';
        info.textContent = `${startItem}-${endItem} ${ofTxt} ${filteredPlaylists.length} (${pageTxt} ${currentPage} ${ofTxt} ${totalPages})`;
        pag.appendChild(info);

        if (currentPage > 1) pag.appendChild(createPaginationButton(`‚Üê ${i18n.t('pagination.prev')}`, currentPage - 1));

        const maxVisible = 5;
        let s = Math.max(1, currentPage - Math.floor(maxVisible/2));
        let e = Math.min(totalPages, s + maxVisible - 1);
        if (e - s + 1 < maxVisible) s = Math.max(1, e - maxVisible + 1);

        if (s > 1){
          pag.appendChild(createPaginationButton('1', 1));
          if (s > 2) pag.appendChild(document.createTextNode(' ... '));
        }
        for (let i=s;i<=e;i++){
          const b = createPaginationButton(String(i), i);
          if (i === currentPage) b.classList.add('active');
          pag.appendChild(b);
        }
        if (e < totalPages){
          if (e < totalPages - 1) pag.appendChild(document.createTextNode(' ... '));
          pag.appendChild(createPaginationButton(String(totalPages), totalPages));
        }

        if (currentPage < totalPages) pag.appendChild(createPaginationButton(`${i18n.t('pagination.next')} ‚Üí`, currentPage + 1));

        container.innerHTML = '';
        container.appendChild(pag);
      }

      function getFileNameWithoutExtension(name){ return name.replace(/\.[^/.]+$/,''); }
      function formatFileSize(b){ if (b<1024) return b+' B'; if (b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
      function formatDuration(sec){
        if (!isFinite(sec)||isNaN(sec)||sec<=0) return '0:00';
        const s = Math.round(sec);
        const h = Math.floor(s/3600);
        const m = Math.floor((s%3600)/60);
        const ss = String(s%60).padStart(2,'0');
        return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${ss}` : `${m}:${ss}`;
      }
      
      function naturalSortByName(arr) {
        return [...arr].sort((a, b) => {
          const an = getFileNameWithoutExtension(a.name) || '';
          const bn = getFileNameWithoutExtension(b.name) || '';
          return an.localeCompare(bn, undefined, { numeric: true, sensitivity: 'base' });
        });
      }
      
      function escapeHtml(text){ const d=document.createElement('div'); d.textContent = text ?? ''; return d.innerHTML; }

      function getVideoChannelFromTags(video) {
        if (!video.tags || !Array.isArray(video.tags)) return null;

        const channelTag = video.tags.find(tag => 
          typeof tag === 'string' && tag.toLowerCase().includes('(–∫–∞)')
        );
        
        if (channelTag) {

          return channelTag.replace(/\s*\(–∫–∞\)\s*$/i, '').trim();
        }
        
        return null;
      }

      function naturalSort(a, b) {
          const normalize = (s) => s.replace(/–π/g, 'y');
          
          const chunkify = (s) => {
              const match = s.match(/\D+|\d+/g);
              return match ? match.map(c => isNaN(c) ? c.toLowerCase() : parseInt(c, 10)) : [];
          };

          const aChunks = chunkify(normalize(String(a)));
          const bChunks = chunkify(normalize(String(b)));

          for (let i = 0; i < Math.min(aChunks.length, bChunks.length); i++) {
              const aChunk = aChunks[i];
              const bChunk = bChunks[i];

              if (typeof aChunk === 'number' && typeof bChunk === 'number') {
                  if (aChunk < bChunk) return -1;
                  if (aChunk > bChunk) return 1;
              } else if (typeof aChunk === 'string' && typeof bChunk === 'string') {
                  const cmp = aChunk.localeCompare(bChunk, 'ru', { numeric: false, caseFirst: 'lower' });
                  if (cmp !== 0) return cmp;
              } else if (typeof aChunk === 'number') {
                  return -1;
              } else {
                  return 1;
              }
          }

          return aChunks.length - bChunks.length;
      }

      function sortPlaylists(playlists) {
          switch (currentSort) {
              case 'new':
                  return playlists.slice().sort((a, b) => (b.created||0)-(a.created||0));
              case 'popular':
                  return playlists.slice().sort((a, b) => (b.views||0)-(a.views||0));
              case 'old':
                  return playlists.slice().sort((a, b) => (a.created||0)-(b.created||0));
              case 'alphabetical':
                  return playlists.slice().sort((a, b) => naturalSort(a.title || '', b.title || ''));
              case 'random':
                  return playlists.slice().sort(() => Math.random() - 0.5);
              default:
                  return playlists.slice().sort((a, b) => (b.created||0)-(a.created||0));
          }
      }

      function renderSidebarCategories() {
        const categoriesContainer = document.getElementById('sidebarTagsContainer');
        if (!categoriesContainer) return;
        categoriesContainer.innerHTML = '';

        const sortedCategories = Array.from(allPlaylistCategories.entries())
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 17);

        if (sortedCategories.length === 0) {
          categoriesContainer.innerHTML = `<span class="sidebar-item">${i18n.t('playlists.noCategories', '–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π')}</span>`;
          return;
        }

        sortedCategories.forEach(([category, count]) => {
          const categoryItem = document.createElement('a');
          categoryItem.href = '#';
          categoryItem.className = 'sidebar-item';
          categoryItem.textContent = `${escapeHtml(category)} (${count})`;
          categoryItem.dataset.category = category;
          categoryItem.addEventListener('click', (e) => {
            e.preventDefault();
            filterPlaylistsByCategory(category);
          });
          categoriesContainer.appendChild(categoryItem);
        });

        if (currentFilter === 'all') {
          document.getElementById('allPlaylistsLink').classList.add('active');
        }
      }

      function filterPlaylistsByCategory(category) {
        document.querySelectorAll('#sidebarTagsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
        document.getElementById('allPlaylistsLink').classList.remove('active');

        if (category === currentFilter) {
          currentFilter = 'all';
          document.getElementById('allPlaylistsLink').classList.add('active');
        } else {
          currentFilter = category;
          const clickedCategoryElement = document.querySelector(`[data-category="${category}"]`);
          if (clickedCategoryElement) {
            clickedCategoryElement.classList.add('active');
          }
        }

        updateUrlParameter('tag', currentFilter === 'all' ? null : currentFilter);
        currentPage = 1; 
        applyFiltersAndRender();
        updatePageTitle();
      }

      function applyFiltersAndRender() {
        let tempPlaylists = [...allPlaylists];

        if (currentFilter !== 'all') {
          tempPlaylists = tempPlaylists.filter(playlist => 
            playlist.categories && playlist.categories.some(cat => cat.trim().toLowerCase() === currentFilter.trim().toLowerCase())
          );
        }

        tempPlaylists = sortPlaylists(tempPlaylists);

        filteredPlaylists = tempPlaylists;
        renderPlaylists();
        updatePageTitle();

        document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
        const activeSortElement = document.getElementById(`sort${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`);
        if (activeSortElement) {
            activeSortElement.classList.add('active');
        }
      }

      function showSkeletonLoading() {
        const container = document.getElementById('playlistsContainer');
        if (!container) return;
        
        let skeletonHTML = '<div class="playlists-grid">';
        for (let i = 0; i < 12; i++) {
          skeletonHTML += `
            <div class="playlist-item skeleton-item">
              <div class="playlist-thumbnail skeleton-thumb"></div>
              <div class="playlist-info">
                <div class="skeleton-line" style="width:60%;height:12px;margin-bottom:6px"></div>
                <div class="skeleton-line" style="width:80%;height:14px;margin-bottom:4px"></div>
                <div class="skeleton-line" style="width:40%;height:10px"></div>
              </div>
            </div>
          `;
        }
        skeletonHTML += '</div>';
        container.innerHTML = skeletonHTML;
      }
      
      function hideSkeletonLoading() {
        const skeletons = document.querySelectorAll('.skeleton-item');
        skeletons.forEach(s => s.remove());
      }

      async function loadPlaylistsFromCache() {
        const cachedPlaylists = await getPlaylistsFromDB();
        if (cachedPlaylists && cachedPlaylists.length > 0) {
          log(`? Loaded ${cachedPlaylists.length} playlists from cache`);

          allPlaylists.length = 0;
          cachedPlaylists.forEach(pl => {
            allPlaylists.push({
              ...pl,
              videos: (pl.videos || []).map(v => ({ ...v, handle: null, file: null, dirHandle: null }))
            });
          });

          allPlaylists.sort((a, b) => (b.created || 0) - (a.created || 0));

          allPlaylistCategories.clear();
          allPlaylists.forEach(playlist => {
            (playlist.categories || []).forEach(category => {
              const trimmedCategory = category.trim();
              if (trimmedCategory) {
                allPlaylistCategories.set(trimmedCategory, (allPlaylistCategories.get(trimmedCategory) || 0) + 1);
              }
            });
          });
          
          return true;
        }
        return false;
      }

      async function loadVideosFromCache() {
        const cachedVideos = await getVideosFromDB();
        if (cachedVideos && cachedVideos.length > 0) {
          log(`? Loaded ${cachedVideos.length} videos from cache`);
          
          allVideos = cachedVideos.map(v => ({
            ...v,
            handle: null,
            file: null,
            dirHandle: null
          }));
          
          return true;
        }
        return false;
      }

      async function backgroundScanForHandles() {
        log('?? Starting targeted scan for visible playlist videos...');
        const scanStart = performance.now();
        const exts = ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.m4v'];

        const grid = document.getElementById('playlistsGrid');
        if (!grid) return;
        
        const visibleVideoNames = new Set();
        grid.querySelectorAll('.playlist-thumb[data-video-name]').forEach(cell => {
          const name = cell.getAttribute('data-video-name');
          if (name) visibleVideoNames.add(name);
        });
        
        log(`?? Looking for ${visibleVideoNames.size} videos`);
        if (visibleVideoNames.size === 0) return;
        
        const foundVideos = new Map();
        
        async function scan(dir, path = '') {

          if (foundVideos.size >= visibleVideoNames.size) return;
          
          try {
            for await (const [name, handle] of dir.entries()) {
              if (handle.kind === 'file' && visibleVideoNames.has(name)) {
                try {
                  const file = await handle.getFile();
                  foundVideos.set(name, { handle, file, dirHandle: dir });

                  const cachedVideo = allVideos.find(v => v.name === name);
                  if (cachedVideo) {
                    cachedVideo.handle = handle;
                    cachedVideo.file = file;
                    cachedVideo.dirHandle = dir;
                  }

                  if (foundVideos.size >= visibleVideoNames.size) return;
                } catch (e) { }
              } else if (handle.kind === 'directory' && !name.startsWith('.')) {
                await scan(handle, path + '/' + name);
              }
            }
          } catch (e) { }
        }
        
        await scan(videoDirectoryHandle);

        allPlaylists.forEach(playlist => {
          (playlist.videos || []).forEach(video => {
            const found = foundVideos.get(video.name);
            if (found) {
              video.handle = found.handle;
              video.file = found.file;
              video.dirHandle = found.dirHandle;
            }
          });
        });
        
        log(`? Found ${foundVideos.size}/${visibleVideoNames.size} videos in ${Math.round(performance.now() - scanStart)}ms`);

        loadVisiblePreviews();
      }

      function loadVisiblePreviews() {
        log('??? Loading previews for visible playlists...');
        const grid = document.getElementById('playlistsGrid');
        if (!grid) return;
        
        const thumbCells = grid.querySelectorAll('.playlist-thumb[data-video-name]');
        log(`Found ${thumbCells.length} thumbnail cells`);
        
        thumbCells.forEach(cell => {

          if (cell.querySelector('img')) return;
          
          const videoName = cell.getAttribute('data-video-name');
          if (!videoName) return;

          const video = allVideos.find(v => v.name === videoName);
          if (video && video.file) {
            getPreviewAndDuration(video).then(({preview}) => {

              if (!cell.querySelector('img')) {
                cell.innerHTML = `<img src="${preview}" style="width:100%;height:100%;object-fit:cover">`;
              }
            }).catch(() => { });
          }
        });
      }

      document.addEventListener('DOMContentLoaded', async ()=>{
        if (!supportsFS){
          document.getElementById('playlistsContainer').innerHTML = `<div class="empty-state" style="color:red"><strong>${i18n.t('errors.fsNotSupported', 'File System API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge.')}</strong></div>`;
          return;
        }
        try{
          const startTime = performance.now();

          showSkeletonLoading();
          
          db = await openDB();
          const savedHandle = await getFromDB('videoDirectoryHandle');
          if (savedHandle){
            const perm = await savedHandle.queryPermission();
            if (perm === 'granted' || (perm === 'prompt' && await savedHandle.requestPermission() === 'granted')){
              videoDirectoryHandle = savedHandle;

              renderSubscribedChannelsList();

              const hasVideoCache = await loadVideosFromCache();
              const hasPlaylistCache = await loadPlaylistsFromCache();
              
              if (hasPlaylistCache) {

                log(`? Displaying ${allPlaylists.length} cached playlists instantly`);
                currentFilter = currentFilter;
                applyFiltersAndRender();
                updatePageTitle();
                renderSidebarCategories();
                hideSkeletonLoading();

                if (currentFilter && currentFilter !== 'all') {
                  const activeTagItem = document.querySelector(`[data-category="${currentFilter}"]`);
                  if (activeTagItem) activeTagItem.classList.add('active');
                } else {
                  document.getElementById('allPlaylistsLink').classList.add('active');
                }
                
                log(`? Initial render from cache in ${Math.round(performance.now() - startTime)}ms`);

                setTimeout(() => {
                  backgroundScanForHandles().then(() => {

                    loadVisiblePreviews();
                    log(`? Previews loaded`);
                  });
                }, 50);
                
              } else {

                log('?? No cache found, starting full scan...');
                await loadAllVideos();
                await loadAllPlaylists();
                currentFilter = currentFilter;
                applyFiltersAndRender();
                updatePageTitle();
                renderSidebarCategories();
                hideSkeletonLoading();
                
                if (currentFilter && currentFilter !== 'all') {
                  const activeTagItem = document.querySelector(`[data-category="${currentFilter}"]`);
                  if (activeTagItem) activeTagItem.classList.add('active');
                } else {
                  document.getElementById('allPlaylistsLink').classList.add('active');
                }
                
                log(`? Full load completed in ${Math.round(performance.now() - startTime)}ms`);
              }

              setTimeout(async () => {
                try {
                  const searchInput = document.getElementById('globalSearch');
                  if (searchInput && typeof AutocompleteIntegration !== 'undefined' && typeof YouviAutocomplete !== 'undefined') {
                    const { videos, playlists } = typeof AutocompleteDataLoader !== 'undefined' 
                        ? await AutocompleteDataLoader.loadData() 
                        : { videos: allVideos || [], playlists: allPlaylists || [] };

                    const cacheValid = await window.autocompleteCache.isCacheValid(
                      videos.length,
                      playlists.length
                    );

                    const autocompleteIntegration = new AutocompleteIntegration();
                    await autocompleteIntegration.init(searchInput, {
                      videoDirectoryHandle: videoDirectoryHandle,
                      allVideos: cacheValid ? [] : videos,
                      allPlaylists: cacheValid ? [] : playlists
                    });
                    log('[Autocomplete] ? Initialized on youvi_playlists_list.html');
                  }
                } catch (error) {
                  console.error('[Autocomplete] Failed to initialize:', error);
                }
              }, 500);

            }else{
              document.getElementById('playlistsContainer').innerHTML = `<div class="empty-state"><strong>${i18n.t('playlists.noFolderAccess', '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ —Å –≤–∏–¥–µ–æ')}</strong></div>`;
            }
          }else{
            document.getElementById('playlistsContainer').innerHTML = `<div class="empty-state"><strong>${i18n.t('playlists.selectFolderFirst', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –≤–∏–¥–µ–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ')}</strong></div>`;
          }

          const playlistSearchInput = document.getElementById('playlistSearch');

          if (playlistSearchInput) {

            playlistSearchInput.value = currentSearchQuery;

            let searchTimeout;
            playlistSearchInput.addEventListener('input', (e) => {
              clearTimeout(searchTimeout);
              currentSearchQuery = e.target.value;
              if (currentSearchQuery === '') {
                currentPage = 1;
                updateUrlParameter('search', null);
                applyFiltersAndRender();
                updatePageTitle();
              } else {
                searchTimeout = setTimeout(() => {
                  currentPage = 1;
                  updateUrlParameter('search', currentSearchQuery);
                  applyFiltersAndRender();
                  updatePageTitle();
                }, 300);
              }
            });
          }

          const initialSortElement = document.getElementById(`sort${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`);
          if (initialSortElement) {
            initialSortElement.classList.add('active');
          }

          document.getElementById('sortNew').addEventListener('click', (e) => {
            e.preventDefault();
            currentSort = 'new';
            localStorage.setItem('playlistSort', 'new');
            updateUrlParameter('sort', 'new');
            currentPage = 1;
            applyFiltersAndRender();

            document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
            e.target.classList.add('active');
          });

          document.getElementById('sortPopular').addEventListener('click', (e) => {
            e.preventDefault();
            currentSort = 'popular';
            localStorage.setItem('playlistSort', 'popular');
            updateUrlParameter('sort', 'popular');
            currentPage = 1;
            applyFiltersAndRender();

            document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
            e.target.classList.add('active');
          });

          document.getElementById('sortOld').addEventListener('click', (e) => {
            e.preventDefault();
            currentSort = 'old';
            localStorage.setItem('playlistSort', 'old');
            updateUrlParameter('sort', 'old');
            currentPage = 1;
            applyFiltersAndRender();

            document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
            e.target.classList.add('active');
          });

          document.getElementById('sortRandom').addEventListener('click', (e) => {
            e.preventDefault();
            currentSort = 'random';
            localStorage.setItem('playlistSort', 'random');
            updateUrlParameter('sort', 'random');
            currentPage = 1;
            applyFiltersAndRender();

            document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
            e.target.classList.add('active');
          });

          document.getElementById('sortAlphabetical').addEventListener('click', (e) => {
            e.preventDefault();
            currentSort = 'alphabetical';
            localStorage.setItem('playlistSort', 'alphabetical');
            updateUrlParameter('sort', 'alphabetical');
            currentPage = 1;
            applyFiltersAndRender();

            document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
            e.target.classList.add('active');
          });
          
        }catch(e){
          console.error('FS access error', e);
          document.getElementById('playlistsContainer').innerHTML = `<div class="empty-state" style="color:red"><strong>${i18n.t('errors.fsAccessError', '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ')}</strong></div>`;
        }

            const allPlaylistsLink = document.getElementById('allPlaylistsLink');
            if (allPlaylistsLink) {
                allPlaylistsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentFilter = 'all';
                    currentPage = 1;
                    currentSearchQuery = '';
                    const headerInput = document.getElementById('globalSearch');
                    if (headerInput) headerInput.value = '';
                    updateUrlParameter('tag', null);
                    applyFiltersAndRender();

                    document.querySelectorAll('#sidebarTagsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                    allPlaylistsLink.classList.add('active');

                    document.querySelectorAll('#sortOptionsContainer .sidebar-item').forEach(item => item.classList.remove('active'));
                    const activeSortElement = document.getElementById(`sort${currentSort.charAt(0).toUpperCase() + currentSort.slice(1)}`);
                    if (activeSortElement) {
                        activeSortElement.classList.add('active');
                    }
                });
            }

            const createBtn = document.getElementById('createGlobalPlaylist'); if (createBtn) createBtn.addEventListener('click', showCreatePlaylistModal);
            const saveBtn = document.getElementById('savePlaylist'); if (saveBtn) saveBtn.addEventListener('click', createGlobalPlaylist);
            const cancelBtn = document.getElementById('cancelPlaylist'); if (cancelBtn) cancelBtn.addEventListener('click', ()=> document.getElementById('createPlaylistModal').style.display='none');
            const videoSearchEl = document.getElementById('videoSearch'); if (videoSearchEl) videoSearchEl.addEventListener('input', searchVideos);
            document.getElementById('selectAllVideos').addEventListener('click', ()=>{

              const searchTerm = document.getElementById('videoSearch').value.toLowerCase();
              let currentVideos = searchTerm ?
                allVideos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(searchTerm)) :
                allVideos;
              currentVideos = naturalSortByName(currentVideos);

              currentVideos.forEach(video => {
                selectedVideoIds.add(video.name);
              });

              document.querySelectorAll('#videoList input[type="checkbox"]').forEach((cb) => {
                cb.checked = true;
              });
              updateSelectionCounter();
            });

            document.getElementById('clearSelection').addEventListener('click', ()=>{

              const searchTerm = document.getElementById('videoSearch').value.toLowerCase();
              let currentVideos = searchTerm ?
                allVideos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(searchTerm)) :
                allVideos;
              currentVideos = naturalSortByName(currentVideos);

              currentVideos.forEach(video => {
                selectedVideoIds.delete(video.name);
              });

              document.querySelectorAll('#videoList input[type="checkbox"]').forEach((cb) => {
                cb.checked = false;
              });
              updateSelectionCounter();
            });

            const addVideosBtn = document.getElementById('addVideosToPlaylist'); if (addVideosBtn) addVideosBtn.addEventListener('click', showAddVideosModal);
            const saveEditBtn = document.getElementById('saveEditPlaylist'); if (saveEditBtn) saveEditBtn.addEventListener('click', saveEditedPlaylist);
            const cancelEditBtn = document.getElementById('cancelEditPlaylist'); if (cancelEditBtn) cancelEditBtn.addEventListener('click', ()=> document.getElementById('editPlaylistModal').style.display='none');
            const addSearchEl = document.getElementById('addVideoSearch'); if (addSearchEl) addSearchEl.addEventListener('input', searchAddVideos);
            const confirmAddBtn = document.getElementById('confirmAddVideos'); if (confirmAddBtn) confirmAddBtn.addEventListener('click', addSelectedVideosToPlaylist);
            const cancelAddBtn = document.getElementById('cancelAddVideos'); if (cancelAddBtn) cancelAddBtn.addEventListener('click', ()=> document.getElementById('addVideosModal').style.display='none');
            const selAllAddBtn = document.getElementById('selectAllAddVideos'); if (selAllAddBtn) selAllAddBtn.addEventListener('click', ()=>{
              const searchTerm = document.getElementById('addVideoSearch').value.toLowerCase();
              const existingNames = new Set((currentEditingPlaylist.videos || []).map(v => v.name));
              const availableVideos = getVideosForCurrentPlaylist().filter(v => !existingNames.has(v.name));
              let currentDisplayedVideos = searchTerm ? availableVideos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(searchTerm)) : availableVideos;
              currentDisplayedVideos = naturalSortByName(currentDisplayedVideos);

              currentDisplayedVideos.forEach(video => editingSelectedVideos.add(video.name));

              document.querySelectorAll('#addVideoList input[type="checkbox"]').forEach((cb) => {
                cb.checked = true;
              });
              updateAddSelectionCounter();
            });
            const clearAllAddBtn = document.getElementById('clearAddSelection'); if (clearAllAddBtn) clearAllAddBtn.addEventListener('click', ()=>{
              const searchTerm = document.getElementById('addVideoSearch').value.toLowerCase();
              const existingNames = new Set((currentEditingPlaylist.videos || []).map(v => v.name));
              const availableVideos = getVideosForCurrentPlaylist().filter(v => !existingNames.has(v.name));
              let currentDisplayedVideos = searchTerm ? availableVideos.filter(v => getFileNameWithoutExtension(v.name).toLowerCase().includes(searchTerm)) : availableVideos;
              currentDisplayedVideos = naturalSortByName(currentDisplayedVideos);

              currentDisplayedVideos.forEach(video => editingSelectedVideos.delete(video.name));

              document.querySelectorAll('#addVideoList input[type="checkbox"]').forEach((cb) => {
                cb.checked = false;
              });
              updateAddSelectionCounter();
            });

            document.querySelectorAll('.close-btn').forEach(btn=>{
              btn.addEventListener('click', (e)=>{
                const t = e.currentTarget.getAttribute('data-close');
                if (t === 'create') {
                  document.getElementById('createPlaylistModal').style.display='none';
                  cleanupModalCache();
                }
                if (t === 'edit') {
                  document.getElementById('editPlaylistModal').style.display='none';
                  cleanupModalCache();
                }
                if (t === 'addVideos') {
                  document.getElementById('addVideosModal').style.display='none';
                  cleanupModalCache();
                }
              });
            });

            document.querySelectorAll('.modal').forEach(modal => {
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  cleanupModalCache();
                }
              });
            });
        });

      function updateUrlParameter(param, value) {
        const url = new URL(window.location.href);
        if (value && value !== 'new') {
          url.searchParams.set(param, value);
        } else {
          url.searchParams.delete(param);
        }
        window.history.replaceState({}, '', url.toString());
      }

      function updatePageTitle() {
        let titleParts = [];
        const baseTitle = 'Youvi';

        if (currentFilter && currentFilter !== 'all') {
          titleParts.push(currentFilter);
        }

        if (currentPage > 1) {
          titleParts.push(`${i18n.t('main.pageLabel', '–°—Ç—Ä–∞–Ω–∏—Ü–∞')} ${currentPage}`);
        }

        if (titleParts.length > 0) {
          document.title = `${titleParts.join(' | ')} | ${baseTitle}`;
        } else {
          document.title = i18n.t('playlists.pageTitle', '–ü–ª–µ–π–ª–∏—Å—Ç—ã | Youvi');
        }
      }

      function searchByTag(tag) {


          log('Search by tag:', tag);

      }

      function searchPlaylists() {
          const searchInput = document.getElementById('globalSearch');
          const searchQuery = searchInput.value.trim();

          if (searchQuery) {
              currentSearchQuery = searchQuery;
              currentPage = 1;
              updateUrlParameter('search', searchQuery);
              applyFiltersAndRender();
          }
      }

      const avatarCache = new Map();

      async function loadImageFile(dirHandle, name) {
        try {
          const fileHandle = await dirHandle.getFileHandle(name);
          const file = await fileHandle.getFile();
          return URL.createObjectURL(file);
        } catch (e) {
          return null;
          }
      }

      async function loadSubscriptionsFromFile() {
          try {
              const localSubscriptions = localStorage.getItem('8site_subscriptions');
              if (localSubscriptions && localSubscriptions !== 'null' && localSubscriptions !== 'undefined') {
                  const parsed = JSON.parse(localSubscriptions);
                  if (Array.isArray(parsed)) {
                      return parsed;
                  }
              }

              if (videoDirectoryHandle) {
                  try {
                      const subscriptionsFile = await videoDirectoryHandle.getFileHandle('.subscriptions.json');
                      const file = await subscriptionsFile.getFile();
                      const text = await file.text();
                      const fileSubscriptions = JSON.parse(text);

                      if (Array.isArray(fileSubscriptions)) {
                          localStorage.setItem('8site_subscriptions', JSON.stringify(fileSubscriptions));
                          return fileSubscriptions;
                      }
                  } catch (fileError) {
                      log('Could not load from file:', fileError.message);
                  }
              }

              return [];
          } catch (e) {
              console.error('Error loading subscriptions:', e);
              return [];
          }
      }

      async function loadChannelAvatar(channelName) {

        const cacheKey = `avatar_${channelName}`;
        if (avatarCache.has(cacheKey)) {
          const cached = avatarCache.get(cacheKey);
          if (Date.now() - cached.timestamp < 300000) {
            return cached.url;
          }

          if (cached.url && cached.url.startsWith('blob:')) {
            URL.revokeObjectURL(cached.url);
          }
          avatarCache.delete(cacheKey);
        }

        try {

          const channelsDir = await videoDirectoryHandle.getDirectoryHandle('.channels', { create: true });
          const channelDir = await channelsDir.getDirectoryHandle(channelName, { create: true });

          const channelData = await readJSONFile(channelDir, 'channel.json', {});
          let avatarUrl = null;

          if (channelData.avatar) {
            avatarUrl = await loadImageFile(channelDir, channelData.avatar);
          }

          avatarCache.set(cacheKey, {
            url: avatarUrl,
            timestamp: Date.now()
          });

          return avatarUrl;
        } catch (e) {

          avatarCache.set(cacheKey, {
            url: null,
            timestamp: Date.now()
          });
          return null;
        }
      }

      async function renderSubscribedChannelsList() {
        const sidebarContainer = document.getElementById('subscribedChannelsContainer');
        if (!sidebarContainer) return;

        try {
          const savedSubscriptions = await loadSubscriptionsFromFile();
          const subscribedChannels = Array.isArray(savedSubscriptions) ? savedSubscriptions : [];

          sidebarContainer.innerHTML = '';

          if (subscribedChannels.length === 0) {
            const noSubs = document.createElement('div');
            noSubs.className = 'sidebar-item';
            noSubs.style.fontStyle = 'italic';
            noSubs.style.color = '#999';
            noSubs.textContent = i18n.t('sidebar.noSubscriptions', '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫');
            sidebarContainer.appendChild(noSubs);
                  return;
              }

          subscribedChannels.forEach((channelName, index) => {
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'sidebar-item';
            link.dataset.channel = channelName;
            link.id = `sidebar_channel_${index}`;
            link.style.display = 'flex';
            link.style.alignItems = 'center';
            link.style.gap = '8px';

            const avatar = document.createElement('div');
            avatar.style.cssText = `
              width: 20px;
              height: 20px;
              border-radius: 0;
              background: #ff69b4;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: bold;
              font-size: 10px;
              flex-shrink: 0;
              background-size: cover;
              background-position: center;
              background-repeat: no-repeat;
              cursor: pointer;
            `;
            avatar.textContent = channelName.charAt(0).toUpperCase();
            avatar.title = i18n.t('channels.goToChannel', '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–Ω–∞–ª—É');

            const textSpan = document.createElement('span');
            textSpan.textContent = channelName;
            textSpan.style.overflow = 'hidden';
            textSpan.style.textOverflow = 'ellipsis';
            textSpan.style.whiteSpace = 'nowrap';
            textSpan.style.flex = '1';

            link.appendChild(avatar);
            link.appendChild(textSpan);

            avatar.addEventListener('click', (e) => {
              e.preventDefault();
                      e.stopPropagation();
              window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
                  });

            textSpan.addEventListener('click', (e) => {
              e.preventDefault();
                      e.stopPropagation();
              window.location.href = `youvi_ch_view.html?channel=${encodeURIComponent(channelName)}`;
            });

            loadChannelAvatar(channelName).then(avatarUrl => {
              if (avatarUrl) {
                avatar.style.backgroundImage = `url(${avatarUrl})`;
                avatar.textContent = '';
              }
            }).catch(() => {

            });

            sidebarContainer.appendChild(link);
          });
          } catch (e) {
          console.error('Error loading subscriptions:', e);
          sidebarContainer.innerHTML = `<div class="sidebar-item" style="font-style: italic; color: #999;">${i18n.t('sidebar.loadingError', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏')}</div>`;
          }
      }

      document.addEventListener('DOMContentLoaded', function() {
          const searchBtn = document.getElementById('doSearch');
          const searchInput = document.getElementById('globalSearch');
          
          if (searchBtn) {
              searchBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  const q = (searchInput?.value||'').trim();
                  const params = new URLSearchParams();
                  if (q) params.set('q', q);
                  params.set('type', 'playlists');
                  window.location.href = `youvi_search.html?${params.toString()}`;
              });
          }
          
          if (searchInput) {
              searchInput.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                      e.preventDefault();
                      const q = (e.target.value||'').trim();
                      const params = new URLSearchParams();
                      if (q) params.set('q', q);
                      params.set('type', 'playlists');
                      window.location.href = `youvi_search.html?${params.toString()}`;
                  }
              });
          }
      });

      function updateDynamicI18n() {

        const selectionCounter = document.getElementById('selectionCounter');
        if (selectionCounter) {
          const count = selectedVideoIds.size;
          selectionCounter.innerHTML = `<span data-i18n="playlists.selected">${i18n.t('playlists.selected')}</span>: ${count}`;
        }
        
        const addSelectionCounter = document.getElementById('addSelectionCounter');
        if (addSelectionCounter) {
          const count = editingSelectedVideos.size;
          addSelectionCounter.innerHTML = `<span data-i18n="playlists.selected">${i18n.t('playlists.selected')}</span>: ${count}`;
        }
      }

      if (typeof i18n !== 'undefined') {
        i18n.subscribe(() => {
          updateDynamicI18n();
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        const langSwitcher = document.getElementById('langSwitcher');
        if (langSwitcher && typeof i18n !== 'undefined') {

          langSwitcher.value = i18n.getCurrentLanguage();

          langSwitcher.addEventListener('change', async (e) => {
            await i18n.setLanguage(e.target.value);

            updateDynamicI18n();

            if (typeof renderPlaylists === 'function') {
              renderPlaylists();
            }
          });
        }
      });
    </script>
    <!-- Autocomplete Module -->
    <link rel="stylesheet" href="youvi/autocomplete/autocomplete.css">
    <script src="youvi/autocomplete-data-loader.js"></script>
    <script src="youvi/autocomplete/autocomplete-cache.js"></script>
    <script src="youvi/autocomplete/autocomplete.js"></script>
    <script src="youvi/autocomplete/autocomplete-integration.js"></script>
    
    <!-- Header Script -->
    <script src="youvi/header/youvi-header.js"></script>
</body>
</html>