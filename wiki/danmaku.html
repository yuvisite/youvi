<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danmaku | Youvi Wiki</title>
    <!-- Load header CSS FIRST to prevent layout shifts -->
    <link rel="stylesheet" href="../youvi/header/youvi-header.css">
    <script>
        (function() {
            var theme = localStorage.getItem('youvi-theme');
            var sidebar = localStorage.getItem('sidebarCollapsed');
            
            var htmlClasses = [];
            if (theme === 'dark') htmlClasses.push('dark-theme');
            else if (theme === 'skeuo') htmlClasses.push('skeuo-theme');
            if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
            if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
        })();
    </script>
    <!-- Image Viewer Module -->
    <script src="../youvi/image-viewer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            width: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #111;
            max-width: 100vw;
        }

        .top-nav {
            background: #d94b88;
            border-bottom: 1px solid #c2185b;
            padding: 4px 0;
        }

        .top-nav-content {
            max-width: none !important;
            margin: 0 !important;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 0;
            transition: color 0.2s;
        }

        .top-nav a:hover {
            color: #ffd6ea;
        }

        .top-nav a.active {
            color: #ffd6ea;
            font-weight: 600;
        }

        .sidebar-collapsed .sidebar,
        html.sidebar-collapsed .sidebar {
            width: 60px !important;
            padding: 10px 8px !important;
            display: block !important;
            position: sticky !important;
            top: 40px !important;
            max-height: calc(var(--sidebar-max-height, 100vh) - 75px) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .sidebar-collapsed .sidebar-title,
        html.sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-item,
        html.sidebar-collapsed .sidebar-item {
            padding: 8px !important;
            padding-left: 5px !important;
            padding-right: 8px !important;
            justify-content: center !important;
            border-left: 3px solid transparent !important;
            border-radius: 4px;
            font-size: 0 !important;
        }

        .sidebar-collapsed .sidebar-item svg,
        html.sidebar-collapsed .sidebar-item svg {
            margin: 0 !important;
            width: 20px !important;
            height: 20px !important;
        }

        .sidebar-collapsed .container,
        html.sidebar-collapsed .container {
            padding-left: 20px;
        }

        .sidebar-collapsed .content-wrapper,
        html.sidebar-collapsed .content-wrapper {
            max-width: 1500px;
        }

        .sidebar-collapsed .sidebar-section:nth-child(3),
        .sidebar-collapsed .sidebar-section:nth-child(4),
        .sidebar-collapsed .sidebar-section:nth-child(5),
        html.sidebar-collapsed .sidebar-section:nth-child(3),
        html.sidebar-collapsed .sidebar-section:nth-child(4),
        html.sidebar-collapsed .sidebar-section:nth-child(5) {
            display: none !important;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0 20px 0 20px;
            display: flex;
            gap: 20px;
            align-items: stretch;
            min-height: calc(100vh - 200px);
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
        }

        .header {
            background: #FFE7F4;
            padding: 0;
            border-bottom: 1px solid #f2cfe1;
            min-height: 40px;
            width: 100%;
        }
        
        body.dark-theme .header {
            background: #2c1810 !important;
            border-bottom: 1px solid #444 !important;
        }

        .header-content-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            box-sizing: border-box;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 20px;
            width: 100%;
            min-height: 40px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
        }
.page-header{background:#fafafa;border:1px solid #e0e0e0;border-radius:6px;padding:16px 18px;margin-bottom:15px}
.page-title{font-size:21px;font-weight:600;color:#111;margin-bottom:6px}
.page-desc{font-size:13px;color:#666}
.tech-section{background:#fff;border:1px solid #e6e6e6;border-radius:6px;padding:16px 18px;margin-bottom:15px}
.tech-section h2{font-size:18px;margin:0 0 10px 0;color:#111}
.tech-section h3{font-size:14px;margin:14px 0 8px 0;color:#333}
.tech-section h4{font-size:13px;margin:10px 0 6px 0;color:#444}
.tech-section p{font-size:14px;color:#333;line-height:1.75;margin:8px 0;text-align:justify}
.tech-section ul{margin:8px 0 8px 20px}
.tech-section ol{margin:8px 0 8px 20px}
.tech-section li{font-size:14px;line-height:1.6;margin:6px 0;color:#333}
.tech-section code{background:#f5f5f5;padding:2px 6px;border-radius:3px;font-family:monospace;font-size:13px;color:#d94b88}
.callout{background:#fff5f9;border:1px solid #ffd6ea;border-radius:6px;padding:12px;margin:12px 0;color:#7a3c55}
.toc{background:#fafafa;border:1px dashed #e0e0e0;border-radius:6px;padding:12px;margin:12px 0}
.toc a{color:#111;text-decoration:none}
.toc a:hover{color:#ff69b4;text-decoration:underline}

        .breadcrumbs {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .breadcrumbs a {
            color: #666;
            text-decoration: none;
        }

        .breadcrumbs span {
            color: #111;
        }

.footer{background:#2c2c2c;color:#fff;padding:25px 0 15px 0;margin-top:0}
body.dark-theme{background:#0d0d0d;color:#ddd}
body.dark-theme .sidebar{background:#1a1a1a}
body.dark-theme .page-header{background:#1a1a1a;border-color:#333;color:#ddd}
body.dark-theme .page-title{color:#fff}
body.dark-theme .page-desc{color:#999}
body.dark-theme .tech-section{background:#1a1a1a;border-color:#333}
body.dark-theme .tech-section h2{color:#fff}
body.dark-theme .tech-section h3{color:#ddd}
body.dark-theme .tech-section h4{color:#ccc}
body.dark-theme .tech-section p{color:#ccc}
body.dark-theme .tech-section li{color:#ccc}
body.dark-theme .tech-section code{background:#2a2a2a;color:#ff8aba}
body.dark-theme .callout{background:#2a1a1f;border-color:#4a2a3a;color:#ffb3d9}
body.dark-theme .toc{background:#1a1a1a;border-color:#333}
body.dark-theme .toc a{color:#ddd}
body.dark-theme .toc a:hover{color:#ff8aba}
body.dark-theme .breadcrumbs{color:#999}
body.dark-theme .breadcrumbs a{color:#999}
body.dark-theme .breadcrumbs span{color:#fff}

        .kbd {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 12px;
            color: #333;
        }

        body.dark-theme .kbd {
            background: #2a2a2a;
            border-color: #444;
            color: #ccc;
        }
.footer-content{max-width:1600px;margin:0 auto;padding:0 20px;display:flex;gap:30px;align-items:flex-start}
.footer-main{display:flex;gap:30px;flex:1}
.footer-logo{flex-shrink:0;width:200px}
.footer-logo img{height:40px;width:auto}
.footer-logo p{margin-top:8px;font-size:11px;color:#ccc;line-height:1.3}
.footer-sections{display:flex;gap:30px;flex:1}
.footer-right{display:flex;gap:20px;align-items:flex-start}
.footer-mascot{flex-shrink:0}
.footer-mascot img{height:180px;width:auto}
.footer-section{flex:1}
.footer-section h3{font-size:13px;margin-bottom:10px;color:#fff;font-weight:600}
.footer-section ul{list-style:none;padding:0;margin:0}
.footer-section li{margin-bottom:6px}
.footer-section a{color:#ccc;text-decoration:none;font-size:11px;transition:color .2s}
.footer-section a:hover{color:#ff69b4}
.footer-bottom{border-top:1px solid #444;margin-top:20px;padding-top:15px;text-align:center;color:#999;font-size:10px}
        @media (min-width: 1700px) {
            .content-wrapper {
                max-width: 1500px;
            }
            
            .footer-content {
                max-width: 1700px !important;
            }
        }
        
        @media (min-width: 2000px) {
            .content-wrapper {
                max-width: 1600px;
            }
            
            .footer-content {
                max-width: 1800px !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .footer-sections {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-section {
                text-align: center;
            }
            
            .footer-mascot img {
                height: 120px;
            }
        }
    </style>
    <link rel="stylesheet" href="../youvi/sidebar.css">
    <link rel="stylesheet" href="../youvi/sidebar-scroll.css">
    <link rel="stylesheet" href="../youvi/themes/dark-theme.css">
    <link rel="stylesheet" href="../youvi/themes/skeuo-theme.css">
    <link rel="stylesheet" href="../youvi/themes/theme-dropdown.css">
    <link rel="stylesheet" href="../youvi/sticky-video.css">
</head>
<link rel="icon" href="../favicon/youvi/favicon.ico" type="image/x-icon">
<body>
    <div class="top-nav">
        <div class="top-nav-content">
            <a href="../youvi_main.html">Videos</a>
            <a href="../index.html">Management</a>
            <a href="../youvi_ch_list.html">Channels</a>
            <a href="../youvi_playlists_list.html">Playlists</a>
            <a href="../youvi_feed_all.html">Feed</a> 
            <a href="index.html" class="active">Wiki</a>
        </div>
    </div>

  <header class="header">
    <div class="header-content-wrapper">
      <div class="header-left">
        <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
        
        <div class="logo">
          <a href="../youvi_main.html">
            <img src="../images/logo_youvi_ind.png" alt="Youvi logo">
          </a>
        </div>
      </div>
      
      <div class="header-center">
        <div class="search-area">
          <input type="text" id="headerSearchInput" placeholder="Search videos..." class="search-input">
          <button id="doSearch" class="search-btn">Search</button>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-actions">
          <div class="settings-container">
            <a href="#" class="settings-btn">⚙</a>
            <div class="theme-dropdown">
              <button class="theme-dropdown-item" data-theme="light">Light</button>
              <button class="theme-dropdown-item" data-theme="dark">Dark</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

 <!-- Main Container -->
    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Navigation</div>
                <a href="../youvi_main.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="../youvi_feed_all.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M4 11a9 9 0 0 1 9 9"/>
                        <path d="M4 4a16 16 0 0 1 16 16"/>
                        <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <span>Feed</span>
                </a>

                <a href="../youvi_tags.html" class="sidebar-item nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                        <line x1="7" y1="7" x2="7.01" y2="7"/>
                    </svg>
                    <span>All Tags</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Library</div>
                <a href="../youvi_history.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    <span>History</span>
                </a>
                <a href="../youvi_fav.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span>Favorites</span>
                </a>
                <a href="../youvi_playlists_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="8" y1="8" x2="16" y2="8"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                        <line x1="8" y1="16" x2="16" y2="16"/>
                        <circle cx="6" cy="8" r="1"/>
                        <circle cx="6" cy="12" r="1"/>
                        <circle cx="6" cy="16" r="1"/>
                    </svg>
                    <span>Playlists</span>
                </a>
                <a href="../youvi_ch_list.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>Channels</span>
                </a>
                <a href="../youvi_subscriptions.html" class="sidebar-item library-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                        <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                        <polyline points="17,2 12,7 7,2"/>
                    </svg>
                    <span>Subscriptions</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Wiki</div>
                <a href="index.html" class="sidebar-item library-item">Home</a>
                <a href="player.html" class="sidebar-item library-item">Player</a>
                <a href="danmaku.html" class="sidebar-item library-item active">Danmaku</a>
                <a href="search/general.html" class="sidebar-item library-item">Search: Interface</a>
                <a href="search/operators.html" class="sidebar-item library-item">Search: Operators</a>
                <a href="tags/general.html" class="sidebar-item library-item">Tags: General</a>
                <a href="tags/allias.html" class="sidebar-item library-item">Tags: Aliases</a>
                <a href="tags/implication.html" class="sidebar-item library-item">Tags: Implications</a>
                <a href="tags/rules.html" class="sidebar-item library-item">Tags: Tagging Rules</a>
                <a href="feed.html" class="sidebar-item library-item">Feed</a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">About Site</div>
                <a href="about.html" class="sidebar-item library-item ">About Site</a>
                <a href="tech.html" class="sidebar-item library-item">Technologies</a>
                <a href="docs.html" class="sidebar-item library-item">Documentation</a>
            </div>

        </aside>
        <!-- Content Wrapper (centered) -->
        <div class="content-wrapper">
            <!-- Main Content -->
            <main class="main-content">
                <div class="breadcrumbs">
                    <a href="index.html">Wiki</a> › 
                    <span>Данмаку</span>
                </div>

      <div class="page-header">
        <div class="page-title">Danmaku</div>
        <div class="page-desc">All about Youvi site danmaku system</div>
      </div>
      
      <div style="text-align:center;margin:20px 0;">
        <img src="images/danmaku.png" alt="Данмаку на видео" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);cursor:pointer;" data-fullscreen data-fullscreen-title="Данмаку на видео">
      </div>
<div class="page-body">
        <div class="tech-section">
          <h2>Contents</h2>
          <div class="toc">
            <ul>
              <li><a href="#overview">General Overview</a></li>
              <li><a href="#sending">Sending Danmaku</a></li>
              <li><a href="#types">Danmaku Types</a></li>
              <li><a href="#display">Display</a></li>
              <li><a href="#tracks">Track System</a></li>
              <li><a href="#modes">Player Modes</a></li>
              <li><a href="#sidebar">Comments Sidebar</a></li>
              <li><a href="#hotkeys">Hotkeys</a></li>
              <li><a href="#storage">Data Storage</a></li>
              <li><a href="#optimization">Optimization</a></li>
              <li><a href="#density">Density Graph</a></li>
            </ul>
          </div>
        </div>

        <section class="tech-section" id="overview">
          <h2>General Overview</h2>
          <p>Danmaku (弾幕, danmaku) is a system of flying comments that appear over the video in real-time. Comments are synchronized with video time and create a "bullet hell" text effect.</p>
          <div class="callout">
            <strong>Important:</strong> Danmaku are saved locally in the <code>.metadata/</code> folder for each video in JSON format. All comments are tied to specific playback time.
          </div>
          <h3>Key Features</h3>
          <ul>
            <li>Three position types: scrolling (right to left), top (fixed), bottom (fixed)</li>
            <li>Three size options: small (18px), normal (25px), big (36px)</li>
            <li>Automatic scaling in fullscreen/cinema mode (up to 40-48px)</li>
            <li>Color selection from palette (white, red, pink, orange, yellow, green, cyan, blue, purple)</li>
            <li>Track system to prevent comment overlap (up to 60 tracks)</li>
            <li>7-second fixed duration for scroll danmaku</li>
            <li>Document Picture-in-Picture support</li>
            <li>Synchronization with pause and playback speed changes</li>
            <li>Density graph visualization on progress bar</li>
            <li>Sidebar with comment history and time navigation</li>
            <li>Delayed saving (debounce 500ms) for optimization</li>
          </ul>
        </section>
   
     <section class="tech-section" id="sending">
          <h2>Sending Danmaku</h2>
          
          <h3>Sending Form</h3>
          <p>The danmaku form is located under the video (in normal mode) or at the bottom of the screen (in theater/fullscreen modes).</p>
          
          <h3>Form Elements</h3>
          <ul>
            <li><strong>Input Field</strong> — comment text (max ~100 chars recommended)</li>
            <li><strong>Color</strong> — dropdown list with 9 colors</li>
            <li><strong>Size</strong> — dropdown: small, normal, big <em>(currently disabled)</em></li>
            <li><strong>Position</strong> — dropdown: scroll, top, bottom <em>(bottom currently disabled)</em></li>
            <li><strong>Send Button</strong> — send icon (pink)</li>
          </ul>
          <div class="callout">
            <strong>Note:</strong> Size selection and bottom position are currently disabled in the UI. All danmaku use normal size, and only scroll/top positions are available.
          </div>
          
          <h3>Sending Process</h3>
          <ol>
            <li>Enter comment text</li>
            <li>Select color (optional)</li>
            <li>Press the send button or <code>Enter</code></li>
            <li>The comment will appear on the video at the current moment</li>
            <li>The comment is automatically saved to the <code>.metadata/{video_name}.danmaku.json</code> file</li>
          </ol>
          
          <h3>Available Colors</h3>
          <ul>
            <li><strong>White</strong> (#FFFFFF) — default</li>
            <li><strong>Red</strong> (#FF0000)</li>
            <li><strong>Pink</strong> (#FF69B4)</li>
            <li><strong>Orange</strong> (#FFA500)</li>
            <li><strong>Yellow</strong> (#FFFF00)</li>
            <li><strong>Green</strong> (#00FF00)</li>
            <li><strong>Cyan</strong> (#00FFFF)</li>
            <li><strong>Blue</strong> (#0000FF)</li>
            <li><strong>Purple</strong> (#9400D3)</li>
          </ul>
          
          <div class="callout">
            <strong>Tip:</strong> Use different colors to highlight important moments or create visual accents.
          </div>
        </section>

        <section class="tech-section" id="types">
          <h2>Danmaku Types</h2>
          
          <h3>Scroll (Default)</h3>
          <p>Comments move from right to left across the entire screen.</p>
          <ul>
            <li><strong>Duration</strong> — 7 seconds fixed (<code>DANMAKU_DURATION_S = 7</code>)</li>
            <li><strong>Tracks</strong> — up to 60 parallel tracks (dynamically calculated based on video height)</li>
            <li><strong>Animation</strong> — Web Animations API with linear easing</li>
            <li><strong>Synchronization</strong> — animation playbackRate is tied to video playbackRate</li>
            <li><strong>Collision Detection</strong> — smart algorithm prevents overlapping using speed and position calculations</li>
          </ul>
          
          <h3>Top</h3>
          <p>Comments appear fixed at the top of the screen, centered horizontally.</p>
          <ul>
            <li><strong>Duration</strong> — 4 seconds fixed</li>
            <li><strong>Position</strong> — centered horizontally, stacked vertically by track</li>
            <li><strong>Tracks</strong> — separate track pool from scroll danmaku</li>
          </ul>
          
          <h3>Bottom</h3>
          <p>Comments appear fixed at the bottom of the screen, centered horizontally.</p>
          <ul>
            <li><strong>Duration</strong> — 4 seconds fixed</li>
            <li><strong>Position</strong> — centered horizontally, stacked upward from bottom</li>
            <li><strong>Tracks</strong> — separate track pool from scroll and top danmaku</li>
          </ul>
          
          <h3>Text Sizes</h3>
          <p>Three size options are available, with automatic scaling in fullscreen/cinema modes:</p>
          <ul>
            <li><strong>Small</strong> — 18px (normal), 32px (fullscreen/cinema)</li>
            <li><strong>Normal</strong> — 25px (normal), 40px (fullscreen/cinema)</li>
            <li><strong>Big</strong> — 36px (normal), 48-52px (fullscreen/cinema)</li>
          </ul>
          
        </section>

        <section class="tech-section" id="display">
          <h2>Display</h2>
          
          <h3>Danmaku Overlay</h3>
          <p>Danmaku are displayed in a special overlay on top of the video.</p>
          <ul>
            <li><strong>Normal Mode</strong> — <code>#danmakuOverlay</code> inside <code>.video-container</code></li>
            <li><strong>Fullscreen/Theater</strong> — <code>#fullscreen-danmaku-overlay</code> created dynamically</li>
            <li><strong>Z-index</strong> — 10 (normal), 9999 (fullscreen)</li>
            <li><strong>Pointer-events</strong> — none (danmaku do not block video clicks)</li>
          </ul>
          
          <h3>Text Styling</h3>
          <ul>
            <li><strong>Font</strong> — Arial, sans-serif</li>
            <li><strong>Weight</strong> — bold</li>
            <li><strong>Shadow</strong> — <code>text-shadow: 1px 1px 2px rgba(0,0,0,0.8)</code></li>
            <li><strong>Stroke</strong> — <code>-webkit-text-stroke: 0.8px rgba(0,0,0,0.75)</code></li>
            <li><strong>Smoothing</strong> — <code>-webkit-font-smoothing: antialiased</code></li>
          </ul>
          
          <h3>Visibility</h3>
          <p>Danmaku can be shown/hidden in several ways:</p>
          <ul>
            <li><strong>D Key</strong> — toggle visibility</li>
            <li><strong>Control Panel Button</strong> — message icon (changes to crossed out when hidden)</li>
            <li><strong>State Saved</strong> — in variable <code>window.danmakuVisible</code></li>
          </ul>
          
          <h3>Responsiveness</h3>
          <p>Danmaku automatically adapt to screen size:</p>
          <ul>
            <li><strong>Base Track Height</strong> — 26px (<code>BASE_TRACK_HEIGHT = 26</code>)</li>
            <li><strong>Track Height Scaling</strong> — <code>trackHeight = BASE_TRACK_HEIGHT * scale</code></li>
            <li><strong>Scale Factor</strong> — calculated as <code>max(0.7, min(containerHeight / 500, 2.5))</code></li>
            <li><strong>Max Tracks</strong> — <code>min(floor((videoHeight - 4) / trackHeight), 60)</code></li>
          </ul>
        </section>

        <section class="tech-section" id="tracks">
          <h2>Track System</h2>
          
          <h3>Working Principle</h3>
          <p>To prevent comment overlap, a track system is used.</p>
          
          <h3>Track Types</h3>
          <p>Three separate track pools are maintained:</p>
          <ul>
            <li><strong>Scroll tracks</strong> — for scrolling comments (right to left)</li>
            <li><strong>Top tracks</strong> — for fixed top comments</li>
            <li><strong>Bottom tracks</strong> — for fixed bottom comments</li>
          </ul>
          
          <h3>Distribution Algorithm</h3>
          <ol>
            <li>When creating a comment, the system looks for a free track</li>
            <li>A track is considered free if its <code>endTime <= currentTime</code></li>
            <li>If all tracks are busy, the track with the least remaining time is selected</li>
            <li>The track is reserved for the duration of the comment display</li>
            <li>After the comment disappears, the track is released</li>
          </ol>
          
          <h3>Duration</h3>
          <p>Danmaku display duration is fixed:</p>
          <ul>
            <li><strong>Scroll danmaku</strong> — 7 seconds (<code>DANMAKU_DURATION_S = 7</code>)</li>
            <li><strong>Top/Bottom danmaku</strong> — 4 seconds (<code>STATIC_DURATION = 4</code>)</li>
          </ul>
          
          <h3>Track Parameters</h3>
          <ul>
            <li><strong>Base Track Height</strong> — 26px (<code>BASE_TRACK_HEIGHT = 26</code>)</li>
            <li><strong>Scaled Track Height</strong> — <code>BASE_TRACK_HEIGHT * scale</code></li>
            <li><strong>Max Tracks</strong> — <code>min(floor((videoHeight - 4) / trackHeight), 60)</code></li>
          </ul>
          
          <h3>Collision Detection (Scroll)</h3>
          <p>The algorithm checks two conditions before placing a new danmaku:</p>
          <ol>
            <li><strong>Start Clear</strong> — previous danmaku has moved far enough: <code>v1 * (t2 - t1) > w1 + margin</code></li>
            <li><strong>End Clear</strong> — new danmaku won't catch up to previous one before exiting</li>
          </ol>
          <p>If no track is available, the danmaku is marked as <code>shouldSkip</code> and not displayed.</p>
          
          <h3>Optimization</h3>
          <ul>
            <li><strong>Width Caching</strong> — text width is calculated once and cached</li>
            <li><strong>Track Reservation</strong> — track is reserved in advance when creating the element</li>
            <li><strong>Track Releasing</strong> — track is released only after the comment completely disappears</li>
          </ul>
          
          <div class="callout">
            <strong>Tip:</strong> The track system automatically adapts to video size, ensuring optimal comment distribution.
          </div>
        </section>
   
     <section class="tech-section" id="modes">
          <h2>Player Modes</h2>
          
          <h3>Normal Mode</h3>
          <ul>
            <li><strong>Overlay</strong> — <code>#danmakuOverlay</code> inside <code>.video-container</code></li>
            <li><strong>Form</strong> — under the video, integrated into the page</li>
            <li><strong>Text Size</strong> — 18/25/36px (small/normal/big)</li>
            <li><strong>Duration</strong> — 7 seconds (scroll), 4 seconds (top/bottom)</li>
          </ul>
          
          <h3>Theater Mode (Cinema Mode)</h3>
          <ul>
            <li><strong>Overlay</strong> — <code>#fullscreen-danmaku-overlay</code> created dynamically</li>
            <li><strong>Form</strong> — fixed at the bottom of the screen</li>
            <li><strong>Text Size</strong> — 32/40/52px (small/normal/big)</li>
            <li><strong>Form Background</strong> — semi-transparent black (rgba(0,0,0,0.95))</li>
          </ul>
          
          <h3>Fullscreen Mode</h3>
          <ul>
            <li><strong>Overlay</strong> — <code>#fullscreen-danmaku-overlay</code> covering the entire screen</li>
            <li><strong>Form</strong> — overlay at the bottom, can be hidden via button</li>
            <li><strong>Text Size</strong> — 32/40/48px (small/normal/big)</li>
            <li><strong>Scaling</strong> — automatic based on container height</li>
            <li><strong>Form Background</strong> — semi-transparent black (rgba(0,0,0,0.9))</li>
          </ul>
          
          <h3>Document Picture-in-Picture</h3>
          <ul>
            <li><strong>Support</strong> — full danmaku support via <code>getDanmakuContext()</code></li>
            <li><strong>Context Detection</strong> — automatically detects PiP window via <code>window.documentPiPManager</code></li>
            <li><strong>Element Access</strong> — <code>getDanmakuElement()</code> and <code>getDanmakuContainer()</code> check PiP context first</li>
            <li><strong>Overlay</strong> — danmaku continue to display in PiP window</li>
          </ul>
          
          <h3>Mini-player</h3>
          <ul>
            <li><strong>Overlay</strong> — danmaku continue to display</li>
            <li><strong>Layout</strong> — uses 1280x720 virtual dimensions for consistent track calculation</li>
            <li><strong>Form</strong> — hidden (unavailable in mini-player)</li>
          </ul>
          
          <h3>Switching Between Modes</h3>
          <p>When switching modes, danmaku are automatically recreated:</p>
          <ol>
            <li>All active comments are removed</li>
            <li>Tracks are reset</li>
            <li>Overlay is moved to the new container</li>
            <li>Comments are recreated with new parameters</li>
            <li>Animations are restarted considering the current time</li>
          </ol>
        </section>

        <section class="tech-section" id="sidebar">
          <h2>Comments Sidebar</h2>
          
          <h3>Location</h3>
          <p>The right sidebar under the playlist displays a list of all danmaku comments for the current video.</p>
          
          <h3>Comment Elements</h3>
          <ul>
            <li><strong>Time</strong> — timestamp (pink color, clickable)</li>
            <li><strong>Text</strong> — comment content</li>
            <li><strong>Date</strong> — comment creation date (grey color)</li>
          </ul>
          
          <h3>Functions</h3>
          <ul>
            <li><strong>Click on Time</strong> — jump to the comment appearance moment in the video</li>
            <li><strong>Hover Effect</strong> — highlight comment on hover</li>
            <li><strong>Auto-update</strong> — list updates when a new comment is added</li>
            <li><strong>Collapsing</strong> — section can be collapsed with the arrow button</li>
          </ul>
          
          <div class="callout">
            <strong>Tip:</strong> Use the sidebar for quick navigation to interesting video moments via comments.
          </div>
        </section>
   
     <section class="tech-section" id="hotkeys">
          <h2>Hotkeys</h2>
          
          <h3>Visibility Control</h3>
          <ul>
            <li><code>D</code> — show/hide danmaku</li>
          </ul>
          
          <h3>Danmaku Panel (Expand)</h3>
          <ul>
            <li><code>Shift + C</code> — open/close danmaku panel (in widescreen, theater, or fullscreen modes)</li>
          </ul>
          
          <h3>Sending Comment</h3>
          <ul>
            <li><code>Enter</code> — send comment (when focus is in the input field)</li>
          </ul>
          
          <h3>Lock in Error State</h3>
          <p>If the video is not loaded (error state), the <code>D</code> hotkey is disabled to prevent accidental toggling.</p>
          
          <div class="callout">
            <strong>Tip:</strong> Use the <code>D</code> key to quickly toggle danmaku visibility while watching.
          </div>
        </section>
    
    <section class="tech-section" id="storage">
          <h2>Data Storage</h2>
          
          <h3>File Structure</h3>
          <p>Danmaku are saved in the <code>.metadata/</code> folder next to video files:</p>
          <ul>
            <li><code>.metadata/{video_name}.danmaku.json</code> — JSON with an array of comments</li>
          </ul>
          
          <h3>Data Format</h3>
          <pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:12px;overflow-x:auto">[
  {
    "id": "1701619200000",
    "text": "Comment Text",
    "time": 42.5,
    "color": "#FFFFFF",
    "size": "normal",
    "position": "scroll",
    "created": 1701619200000
  }
]</pre>
          
          <h3>Comment Fields</h3>
          <ul>
            <li><strong>id</strong> — unique identifier (timestamp string)</li>
            <li><strong>text</strong> — comment text</li>
            <li><strong>time</strong> — appearance time in seconds</li>
            <li><strong>color</strong> — text color (hex)</li>
            <li><strong>size</strong> — text size: "small", "normal", or "big"</li>
            <li><strong>position</strong> — display position: "scroll", "top", or "bottom"</li>
            <li><strong>created</strong> — creation timestamp (milliseconds)</li>
          </ul>
          
          <h3>Saving Mechanism</h3>
          <ul>
            <li><strong>Debounce</strong> — saving is delayed by 500ms</li>
            <li><strong>Autosave</strong> — upon adding a new comment</li>
            <li><strong>Metadata Cleanup</strong> — temporary fields (_trackIndex, _cachedWidth) are not saved</li>
          </ul>
          
          <h3>Data Loading</h3>
          <p>Danmaku are loaded automatically when opening a video:</p>
          <ol>
            <li>Checks for the existence of the file <code>.metadata/{video_name}.danmaku.json</code></li>
            <li>If the file exists, data is loaded and parsed</li>
            <li>Comments are added to the <code>danmakuData</code> array</li>
            <li>During playback, comments appear at the corresponding time</li>
          </ol>
        </section>
        
        <section class="tech-section" id="optimization">
          <h2>Optimization</h2>
          
          <h3>Performance</h3>
          <ul>
            <li><strong>CSS Containment</strong> — <code>contain: layout style paint</code> for rendering isolation</li>
            <li><strong>Will-change</strong> — <code>will-change: transform</code> for animation optimization</li>
            <li><strong>RequestAnimationFrame</strong> — for smooth updates</li>
            <li><strong>Throttling</strong> — visibility updates limited by frame rate</li>
          </ul>
          
          <h3>Caching</h3>
          <ul>
            <li><strong>Text Width</strong> — calculated once and saved in <code>item._cachedWidth</code></li>
            <li><strong>Track Position</strong> — saved in <code>item._preservedTrackY</code></li>
            <li><strong>Track Index</strong> — saved in <code>item._trackIndex</code></li>
          </ul>
          
          <h3>Memory Management</h3>
          <ul>
            <li><strong>Element Removal</strong> — comments are removed from DOM after disappearance</li>
            <li><strong>Animation Cancellation</strong> — animations are cancelled when removing elements</li>
            <li><strong>Track Clearing</strong> — tracks are released after use</li>
            <li><strong>Cache Reset</strong> — all caches are cleared when switching videos</li>
          </ul>
          
          <h3>Synchronization</h3>
          <ul>
            <li><strong>Playback rate</strong> — animation speed is tied to playback speed</li>
            <li><strong>Pause</strong> — animations stop when video is paused</li>
            <li><strong>Seeking</strong> — comments are recreated upon seeking</li>
            <li><strong>Player Modes</strong> — comments are recreated when changing modes</li>
          </ul>
          
          <h3>Rendering Optimization</h3>
          <ul>
            <li><strong>Backface-visibility</strong> — <code>backface-visibility: hidden</code> for GPU acceleration</li>
            <li><strong>Transform</strong> — using <code>transform</code> instead of <code>left/top</code></li>
            <li><strong>Opacity</strong> — smooth fade in/out via <code>opacity</code></li>
            <li><strong>Pointer-events</strong> — <code>pointer-events: none</code> for the overlay</li>
          </ul>
        </section>

        <section class="tech-section" id="density">
          <h2>Density Graph</h2>
          
          <h3>Overview</h3>
          <p>The density graph is a visual representation of danmaku distribution over the video timeline, displayed above the progress bar.</p>
          
          <h3>Features</h3>
          <ul>
            <li><strong>Location</strong> — overlaid on the video progress bar (<code>#danmakuDensity</code>)</li>
            <li><strong>Visualization</strong> — smooth curve showing comment density per time bucket</li>
            <li><strong>Auto-update</strong> — refreshes when danmaku are added or video duration changes</li>
            <li><strong>Responsive</strong> — uses ResizeObserver to redraw on container resize</li>
          </ul>
          
          <h3>Technical Details</h3>
          <ul>
            <li><strong>Rendering</strong> — Canvas 2D with device pixel ratio support for crisp display</li>
            <li><strong>Bucket Size</strong> — dynamically calculated (minimum 5px per bucket)</li>
            <li><strong>Fill</strong> — semi-transparent white (<code>rgba(255, 255, 255, 0.2)</code>)</li>
            <li><strong>Stroke</strong> — pink outline (<code>rgba(255, 105, 180, 0.6)</code>)</li>
            <li><strong>Curve</strong> — quadratic Bézier curves for smooth appearance</li>
          </ul>
          
          <h3>Visibility Sync</h3>
          <p>The density graph visibility is synchronized with video controls:</p>
          <ul>
            <li>Shows/hides with the progress bar</li>
            <li>Follows autohide behavior of video controls</li>
            <li>Respects no-transition class for instant visibility changes</li>
          </ul>
        </section>

        <section class="tech-section">
          <h2>Parameters Summary Table</h2>
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead>
              <tr style="background:#f5f5f5">
                <th style="padding:8px;text-align:left;border:1px solid #ddd">Parameter</th>
                <th style="padding:8px;text-align:left;border:1px solid #ddd">Value</th>
                <th style="padding:8px;text-align:left;border:1px solid #ddd">Description</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding:8px;border:1px solid #ddd">Scroll Duration</td><td style="padding:8px;border:1px solid #ddd">7 seconds</td><td style="padding:8px;border:1px solid #ddd">DANMAKU_DURATION_S constant</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Static Duration</td><td style="padding:8px;border:1px solid #ddd">4 seconds</td><td style="padding:8px;border:1px solid #ddd">Top/bottom danmaku</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Base Track Height</td><td style="padding:8px;border:1px solid #ddd">26px</td><td style="padding:8px;border:1px solid #ddd">BASE_TRACK_HEIGHT constant</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Max Tracks</td><td style="padding:8px;border:1px solid #ddd">60</td><td style="padding:8px;border:1px solid #ddd">Hard limit per position type</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Save Debounce</td><td style="padding:8px;border:1px solid #ddd">500 ms</td><td style="padding:8px;border:1px solid #ddd">SAVE_DEBOUNCE_MS constant</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Text Size (Normal)</td><td style="padding:8px;border:1px solid #ddd">18/25/36px</td><td style="padding:8px;border:1px solid #ddd">Small/Normal/Big</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Text Size (Fullscreen)</td><td style="padding:8px;border:1px solid #ddd">32/40/48px</td><td style="padding:8px;border:1px solid #ddd">Small/Normal/Big</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Text Size (Cinema)</td><td style="padding:8px;border:1px solid #ddd">32/40/52px</td><td style="padding:8px;border:1px solid #ddd">Small/Normal/Big</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Scale Range</td><td style="padding:8px;border:1px solid #ddd">0.7 - 2.5</td><td style="padding:8px;border:1px solid #ddd">Based on container height / 500</td></tr>
              <tr><td style="padding:8px;border:1px solid #ddd">Position Types</td><td style="padding:8px;border:1px solid #ddd">scroll, top, bottom</td><td style="padding:8px;border:1px solid #ddd">Three display modes</td></tr>
            </tbody>
          </table>
        </section>

            </div>
            </main>
        </div><!-- /content-wrapper -->
    </div>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-main">
        <div class="footer-logo">
          <img src="../images/logo_youvi_ind_ex.png" alt="Youvi" loading="lazy">
          <p>Platform for watching video content. Save, categorize and watch videos.</p>
        </div>
        <div class="footer-sections">
          <div class="footer-section">
            <h3>Sections</h3>
            <ul>
              <li><a href="../youvi_main.html">Videos</a></li>
              <li><a href="../youvi_tags.html">Tags</a></li>
              <li><a href="../youvi_feed_all.html">Feed</a></li>
              <li><a href="../index.html">Management</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>Library</h3>
            <ul>
              <li><a href="../youvi_ch_list.html">Channels</a></li>
              <li><a href="../youvi_playlists_list.html">Playlists</a></li>
              <li><a href="../youvi_subscriptions.html">Subscribes</a></li>
              <li><a href="../youvi_fav.html">Favorites</a></li>
              <li><a href="../youvi_history.html">History</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>Wiki</h3>
            <ul>
              <li><a href="index.html">Main</a></li>
              <li><a href="player.html">Player</a></li>
              <li><a href="danmaku.html">Danmaku</a></li>
              <li><a href="tags/general.html">Tags</a></li>
              <li><a href="tags/rules.html">Tagging Rules</a></li>
              <li><a href="search/general.html">Search</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>PGC</h3>
            <ul>
              <li><a href="../youvi_main.html?tag=Anime (ct)">Anime</a></li>
              <li><a href="../youvi_main.html?tag=Animation (ct)">Animation</a></li>
              <li><a href="../youvi_main.html?tag=Movies (ct)">Movies</a></li>
              <li><a href="../youvi_main.html?tag=Series (ct)">Series</a></li>
              <li><a href="../youvi_main.html?tag=Music (ct)">Music</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>UGC</h3>
            <ul>
              <li><a href="../youvi_main.html?tag=Games (ct)">Games</a></li>
              <li><a href="../youvi_main.html?tag=Technologies (ct)">Technologies</a></li>
              <li><a href="../youvi_main.html?tag=Entertainment (ct)">Entertainment</a></li>
              <li><a href="../youvi_main.html?tag=IRL (ct)">IRL</a></li>
              <li><a href="../youvi_main.html?tag=TV (ct)">TV</a></li>
              <li><a href="../youvi_main.html?tag=Education (ct)">Education</a></li>
              <li><a href="../youvi_main.html?tag=Other (ct)">Other</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>About Site</h3>
            <ul>
              <li><a href="about.html">About Site</a></li>
              <li><a href="docs.html">Documentation</a></li>
              <li><a href="tech.html">Technologies</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer-right">
        <div class="footer-mascot">
          <img src="../images/mascot1.png" alt="Yuvi" loading="lazy">
        </div>
      </div>
    </div>
  </footer>

    <script src="../youvi/sidebar-scroll.js"></script>
    <script src="../youvi/themes/theme-toggle.js"></script>
    <script>
        try {
            const toggle = document.getElementById('sidebarToggle');
            const html = document.documentElement;
            
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                html.classList.add('sidebar-collapsed');
            }
            
            if (toggle) {
                toggle.addEventListener('click', () => {
                    html.classList.toggle('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', html.classList.contains('sidebar-collapsed'));
                });
            }
        } catch(_) {}

        try {
            const input = document.querySelector('#headerSearchInput');
            const btn = document.querySelector('#doSearch');
            if (btn && input) {
                const go = () => {
                    const q = (input.value || '').trim();
                    const url = q ? `../youvi_search.html?q=${encodeURIComponent(q)}` : '../youvi_search.html';
                    location.href = url;
                };
                btn.addEventListener('click', go);
                input.addEventListener('keyup', (e) => { if (e.key === 'Enter') go(); });
            }
        } catch(_) {}

        if (window.imageViewer) {
            window.imageViewer.autoSetup();
        }
    </script>
</body>
</html>